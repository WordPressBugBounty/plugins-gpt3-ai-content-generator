(()=>{(function(){"use strict";function d(){typeof window.markdownit=="function"?(window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}),window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs}),console.log("AIPKit Chat Markdown: markdown-it initialized.")):(console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(i){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(i).replace(/\n/g,"<br>")}})}window.aipkit_initializeMarkdownParser=d})();(function(){"use strict";function d(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function i(e){return d(e)}window.aipkit_escapeHtml=d,window.aipkit_escapeAttribute=i})();(function(){"use strict";function d(i){let e=Number(i);if(!e||isNaN(e))return"";try{let t=new Date(e*1e3);if(isNaN(t.getTime()))return"";let o=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${o}:${n}:${a}`}catch(t){return console.error("Error formatting timestamp:",i,t),""}}window.aipkit_formatTimestamp=d})();(function(){"use strict";function d(i,e={},t={}){return new Promise((o,n)=>{if(!t.ajaxUrl)return n(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let a=new FormData;a.append("action",i),t.nonce?a.append("_ajax_nonce",t.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${i}".`),t.botId&&a.append("bot_id",t.botId),window.aipkit_guest_uuid&&a.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&a.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&a.append("post_id",window.aipkit_current_post_id),t.provider==="OpenAI"&&t.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&a.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&a.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&a.append("frontend_google_search_grounding_active","true"),t.activeFileContext?(t.activeFileContext.provider==="OpenAI"&&t.activeFileContext.vector_store_id&&(a.append("active_openai_vs_id",t.activeFileContext.vector_store_id),console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from config.activeFileContext: ${t.activeFileContext.vector_store_id}`)),t.activeFileContext.provider==="Pinecone"&&t.activeFileContext.index_name&&t.activeFileContext.namespace&&(a.append("active_pinecone_index_name",t.activeFileContext.index_name),a.append("active_pinecone_namespace",t.activeFileContext.namespace),console.log(`AIPKit frontendApiRequest: Sending Pinecone context from config.activeFileContext: Index: ${t.activeFileContext.index_name}, Namespace: ${t.activeFileContext.namespace}`)),t.activeFileContext.provider==="Qdrant"&&t.activeFileContext.collection_name&&t.activeFileContext.file_upload_context_id&&(a.append("active_qdrant_collection_name",t.activeFileContext.collection_name),a.append("active_qdrant_file_upload_context_id",t.activeFileContext.file_upload_context_id),console.log(`AIPKit frontendApiRequest: Sending Qdrant context from config.activeFileContext: Collection: ${t.activeFileContext.collection_name}, File Context ID: ${t.activeFileContext.file_upload_context_id}`))):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id&&console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&r!=="frontend_web_search_active"&&r!=="frontend_google_search_grounding_active"&&r!=="active_openai_vs_id"&&r!=="active_pinecone_index_name"&&r!=="active_pinecone_namespace"&&r!=="active_qdrant_collection_name"&&r!=="active_qdrant_file_upload_context_id"&&a.append(r,e[r]);fetch(t.ajaxUrl,{method:"POST",body:a,credentials:"same-origin"}).then(r=>r.json()).then(r=>{if(r.success)o(r.data);else{let c=r.data&&typeof r.data=="object"&&r.data.message?r.data.message:"Unknown frontend API error (data or data.message missing/invalid)";n(new Error(c))}}).catch(r=>{console.error(`AIPKit Frontend AJAX Error (Action: ${i}):`,r),n(r)})})}window.aipkit_frontendApiRequest=d})();(function(){"use strict";function d(i){return`aipkit-client-msg-${String(i||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=d})();(function(){"use strict";function d(i){if(!i||typeof i.style>"u")return;i.style.height="auto";let e=i.scrollHeight,t=window.getComputedStyle(i),o=parseInt(t.minHeight,10)||0,n=parseInt(t.maxHeight,10)||1/0,a=Math.max(o,e);a=Math.min(a,n),i.style.height=`${a}px`,a>=n?(i.style.overflowY="auto",i.classList.add("aipkit-textarea-scrollable")):(i.style.overflowY="hidden",i.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=d})();(function(){"use strict";function d(i,e,t){let{webSearchToggleButton:o}=i,n=e.allowWebSearchTool&&e.provider==="OpenAI";!o||!n||(t.webSearchToolActive=!t.webSearchToolActive,o.classList.toggle("aipkit_active",t.webSearchToolActive),o.title=t.webSearchToolActive?e.text?.webSearchActive||"Web Search Active":e.text?.webSearchInactive||"Web Search Inactive",o.setAttribute("aria-pressed",t.webSearchToolActive.toString()),console.log(`AIPKit Chat UI Main (${e.botId}): OpenAI Web Search tool toggled to: ${t.webSearchToolActive}`))}window.aipkit_toggleWebSearchAction=d})();(function(){"use strict";function d(i,e,t){let{googleSearchGroundingToggleButton:o}=i,n=e.allowGoogleSearchGrounding&&e.provider==="Google";!o||!n||(t.googleSearchGroundingActive=!t.googleSearchGroundingActive,o.classList.toggle("aipkit_active",t.googleSearchGroundingActive),o.title=t.googleSearchGroundingActive?e.text?.googleSearchGroundingActive||"Google Search Grounding Active":e.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",o.setAttribute("aria-pressed",t.googleSearchGroundingActive.toString()),console.log(`AIPKit Chat UI Main (${e.botId}): Google Search Grounding tool toggled to: ${t.googleSearchGroundingActive}`))}window.aipkit_toggleGoogleSearchGroundingAction=d})();(function(){"use strict";function d(i,e){let t=e.botId||"unknown",o=i.querySelector(".aipkit_chat_header"),n=i.querySelector(".aipkit_chat_main"),a=n?n.querySelector(".aipkit_chat_messages"):null,r=n?n.querySelector(".aipkit_chat_footer"):null,c=n?n.querySelector(".aipkit_chat_input"):null,u=c?c.querySelector(".aipkit_chat_input_field"):null,s=c?c.querySelector(".aipkit_chat_input_wrapper"):null,l=s?s.querySelector(".aipkit_chat_input_actions_bar"):null,p=i.querySelector(".aipkit_chat_image_preview_container"),_=i.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&c&&s){if(p||(p=document.createElement("div"),p.className="aipkit_chat_image_preview_container"),!s.contains(p)){let U=s.querySelector(".aipkit_chat_input_field");U?s.insertBefore(p,U):s.appendChild(p)}_||(_=document.createElement("input"),_.type="file",_.className="aipkit_chat_image_upload_input",_.style.display="none",_.setAttribute("aria-hidden","true"),c.appendChild(_))}let f=c?c.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&c&&(f||(f=document.createElement("input"),f.type="file",f.className="aipkit_chat_file_upload_input",f.style.display="none",f.setAttribute("aria-hidden","true"),c.appendChild(f)));let w=l?l.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,m=c?c.querySelector(".aipkit_input_action_menu"):null,g=l?l.querySelector(".aipkit_voice_input_btn"):null,h=l?l.querySelector(".aipkit_web_search_toggle"):null,I=l?l.querySelector(".aipkit_google_search_grounding_toggle"):null,b=l?l.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,y=b?b.querySelector(".aipkit_send_icon"):null,k=b?b.querySelector(".aipkit_clear_icon"):null,S=b?b.querySelector(".aipkit_spinner"):null,A=n?n.querySelector(".aipkit_conversation_starters"):null,v=o?o.querySelector(".aipkit_sidebar_toggle_btn"):null,P=o?o.querySelector(".aipkit_fullscreen_btn"):null,x=o?o.querySelector(".aipkit_download_btn"):null,E=o?o.querySelector(".aipkit_close_btn"):null,C=i.querySelector(".aipkit_chat_sidebar"),T=C?C.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!n||!a||!u||!b||!y||!k||!S?(console.error(`AIPKit Chat FindElements (${t}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!A&&console.warn(`AIPKit Chat FindElements (${t}): Starters enabled but container not found.`),e.enableSidebar&&(!C||!v)&&console.warn(`AIPKit Chat FindElements (${t}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!w&&console.warn(`AIPKit Chat FindElements (${t}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&e.provider==="OpenAI"&&!h&&console.warn(`AIPKit Chat FindElements (${t}): OpenAI Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!I&&console.warn(`AIPKit Chat FindElements (${t}): Google Search Grounding allowed but toggle button missing.`),{container:i,headerEl:o,mainContentEl:n,messagesEl:a,footerEl:r,inputArea:c,inputField:u,inputWrapper:s,actionsBar:l,imageUploadInput:_,imagePreviewContainer:p,fileUploadInput:f,inputActionButton:w,inputActionMenu:m,voiceInputButton:g,webSearchToggleButton:h,googleSearchGroundingToggleButton:I,actionButton:b,sendIcon:y,clearIcon:k,spinner:S,startersContainer:A,sidebarToggleBtn:v,fullscreenButton:P,downloadButton:x,closeButton:E,sidebarEl:C,newChatBtn:T})}window.aipkit_chatUI_findElements=d})();(function(){"use strict";function d(i,e=!1){i&&requestAnimationFrame(()=>{let t=i.scrollHeight-i.scrollTop-i.clientHeight<100;(e||t)&&(i.scrollTop=i.scrollHeight,setTimeout(()=>{i&&(i.scrollTop=i.scrollHeight)},50))})}window.aipkit_chatUI_scrollToBottom=d})();(function(){"use strict";function d(i,e=null){if(!i)return;if(e&&e.parentNode===i){try{i.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",r)}return}let o=`aipkit-typing-indicator-${i.closest(".aipkit_chat_container")?.dataset.botId||i.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,n=i.querySelector(`#${CSS.escape(o)}`);if(n)try{i.removeChild(n)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",r)}let a=i.querySelector(".aipkit_typing-indicator");if(a)try{i.removeChild(a)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeTypingIndicator=d})();(function(){"use strict";function d(i,e=null){if(!i)return;if(e&&e.parentNode===i){try{i.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",r)}return}let o=`aipkit-image-loading-indicator-${i.closest(".aipkit_chat_container")?.dataset.botId||i.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,n=i.querySelector(`#${CSS.escape(o)}`);if(n)try{i.removeChild(n)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",r)}let a=i.querySelector(".aipkit_image_loading_indicator");if(a)try{i.removeChild(a)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeImageLoadingIndicator=d})();(function(){"use strict";function d(i,e){if(!i||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(i),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(i);let o=`aipkit-typing-indicator-${e.botId||"default"}`,n=document.createElement("div");return n.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",n.id=o,n.innerHTML=`
            <div class="aipkit_chat_bubble">
                <span class="aipkit_typing-dot"></span>
                <span class="aipkit_typing-dot"></span>
                <span class="aipkit_typing-dot"></span>
            </div>`,i.appendChild(n),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0),n}window.aipkit_chatUI_showTypingIndicator=d})();(function(){"use strict";function d(i,e){if(!i||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(i),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(i);let o=`aipkit-image-loading-indicator-${e.botId||"default"}`,n=document.createElement("div");return n.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",n.id=o,n.innerHTML=`
        <div class="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail">
            <span class="dashicons dashicons-format-image"></span>
        </div>`,i.appendChild(n),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0),n}window.aipkit_chatUI_showImageLoadingIndicator=d})();(function(){"use strict";function d(i,e,t,o,n=!1,a=!1,r=null,c=!1,u=null){if(!i||!o)return;let s=window.aipkit_escapeHtml||function(w){return w},l=document.createElement("div"),p=t==="user"?"user":"bot";l.className=`aipkit_chat_message aipkit_chat_message-${p}`,n&&l.classList.add("aipkit_chat_message-error"),a&&l.classList.add("aipkit_initial_greeting"),r&&(l.id=r,l.setAttribute("data-message-id",r));let _=document.createElement("div");_.className="aipkit_chat_bubble";let f="";if(p==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let w=document.createElement("img");w.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,w.alt=e.text||"User uploaded image",w.className="aipkit_user_sent_image_thumbnail",_.appendChild(w)}if(e.text&&e.text.trim()!==""){let w=document.createElement("div");w.className="aipkit_user_message_text_content",w.textContent=e.text,_.appendChild(w),f=e.text}else!e.text&&e.user_image&&(f="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let w=e.images[0],m=e.prompt||"Generated image",g=w.revised_prompt,h="";if(w.media_library_url?h=`<a href="${s(w.media_library_url)}" target="_blank" rel="noopener noreferrer"><img src="${s(w.media_library_url)}" alt="${s(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.url?h=`<a href="${s(w.url)}" target="_blank" rel="noopener noreferrer"><img src="${s(w.url)}" alt="${s(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.b64_json?h=`<img src="data:image/png;base64,${w.b64_json}" alt="${s(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;">`:h=`<p style="font-style: italic;">${s(e.content||o.text?.noImageData||"Image data unavailable.")}</p>`,_.innerHTML=h,_.style.padding="5px",_.style.maxWidth="60%",_.title=`Prompt: ${s(m)}`,f=`Image generated for prompt: ${s(m)}`,g){let I=document.createElement("p");I.style.fontSize="11px",I.style.fontStyle="italic",I.style.marginTop="5px",I.style.textAlign="center",I.style.color="inherit",I.textContent=`Revised: ${s(g)}`,_.appendChild(I),f+=`. Revised prompt: ${s(g)}`}}else if(typeof e=="string")if(f=e,(p==="bot"||a)&&!n&&window.aipkit_md)_.innerHTML=window.aipkit_md.render(e);else{let w=e.split(`
`);w.forEach((m,g)=>{_.appendChild(document.createTextNode(m)),g<w.length-1&&_.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),_.textContent=s("[Invalid Content]"),f="Invalid Content";if(_.setAttribute("data-raw-text",f),l.appendChild(_),p==="bot"&&!a&&!n)if(l.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let w=window.aipkit_chatUI_createActionsContainerHTML(o);w&&l.insertAdjacentHTML("beforeend",w)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(p==="bot"&&!n&&u&&u.searchEntryPoint&&u.searchEntryPoint.renderedContent){let w=document.createElement("div");w.className="aipkit_grounding_widget",w.innerHTML=u.searchEntryPoint.renderedContent,l.appendChild(w)}i.appendChild(l),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,c)}window.aipkit_chatUI_appendMessage=d})();(function(){"use strict";function d(i,e){let t=i.querySelector(`.${e}`);t?t.parentNode&&t.parentNode.removeChild(t):(t=document.createElement("span"),t.className=e);let o=a=>{let r=Array.from(a.childNodes);for(let c=r.length-1;c>=0;c--){let u=r[c];if(u.nodeType===Node.TEXT_NODE&&u.textContent.trim()!==""){let s=document.createElement("span"),l=document.createTextNode(u.textContent);return s.appendChild(l),a.replaceChild(s,u),s.appendChild(t),!0}if(u.nodeType===Node.ELEMENT_NODE&&u.offsetParent!==null&&!u.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(u.tagName))return u.childNodes.length>0&&o(u)||(u.nextSibling?a.insertBefore(t,u.nextSibling):a.appendChild(t)),!0}return!1};o(i)||i.appendChild(t)}window.positionStreamingIndicator=d})();(function(){"use strict";function d(i,e,t,o,n,a=!1,r=!1,c=null){if(!i||!n||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:i,messageId:e,config:n});return}let u=window.aipkit_escapeHtml||function(w){return w},s=i.querySelector(`#${CSS.escape(e)}`),l,p="",_="aipkit_stream_indicator",f=o==="user"?"user":"bot";if(!s)s=document.createElement("div"),s.id=e,s.setAttribute("data-message-id",e),s.className=`aipkit_chat_message aipkit_chat_message-${f}`,r&&s.classList.add("aipkit_chat_message-error"),l=document.createElement("div"),l.className="aipkit_chat_bubble",l.dataset.aipkitFullContent="",l.setAttribute("data-raw-text",""),s.appendChild(l),i.appendChild(s);else{if(l=s.querySelector(".aipkit_chat_bubble"),!l)return;r&&!s.classList.contains("aipkit_chat_message-error")&&s.classList.add("aipkit_chat_message-error")}if(l.dataset.aipkitFullContent===void 0&&(l.dataset.aipkitFullContent=""),l.getAttribute("data-raw-text")===null&&l.setAttribute("data-raw-text",""),l.dataset.aipkitFullContent+=t,l.setAttribute("data-raw-text",l.getAttribute("data-raw-text")+t),p=l.dataset.aipkitFullContent,r?l.textContent=p:l.innerHTML=window.aipkit_md?window.aipkit_md.render(p):p.replace(/\n/g,"<br>"),s.classList.remove("aipkit_message_streaming"),!a&&!r){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(l,_);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let w=l.querySelector(`.${_}`);w||(w=document.createElement("span"),w.className=_,l.appendChild(w))}s.classList.add("aipkit_message_streaming")}else{let w=l.querySelector(`.${_}`);if(w&&w.parentNode&&w.parentNode.removeChild(w),a&&!r&&f==="bot"&&!s.querySelector(".aipkit_message_actions")){if(s.classList.remove("aipkit_message_streaming"),s.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let m=window.aipkit_chatUI_createActionsContainerHTML(n);m&&s.insertAdjacentHTML("beforeend",m)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(c&&c.searchEntryPoint&&c.searchEntryPoint.renderedContent){let m=document.createElement("div");m.className="aipkit_grounding_widget",m.innerHTML=c.searchEntryPoint.renderedContent,s.appendChild(m)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,a||r)}window.aipkit_chatUI_appendOrUpdateMessage=d})();(function(){"use strict";function d(i,e,t,o=null){if(!i||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let n=window.aipkit_escapeHtml||function(p){return p},a=t.botId||"default",r=document.createElement("div");if(r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",o)r.id=o,r.setAttribute("data-message-id",o);else{let p=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(a):`form-msg-${Date.now()}`;r.id=p,r.setAttribute("data-message-id",p)}let c=document.createElement("div");c.className="aipkit_chat_bubble";let u=document.createElement("div");if(u.className="aipkit_chat_form_wrapper",u.dataset.formId=e.form_id,e.title){let p=document.createElement("h5");p.className="aipkit_chat_form_title",p.textContent=n(e.title),u.appendChild(p)}let s=document.createElement("form");s.className="aipkit_chat_form",s.dataset.formId=e.form_id,e.elements.forEach(p=>{let _=document.createElement("div");_.className="aipkit_chat_form_element";let f;switch(p.type){case"text_input":case"textarea":if(p.label){let m=document.createElement("label");m.setAttribute("for",`form-${n(e.form_id)}-${n(p.id)}`),m.textContent=n(p.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=p.type==="textarea"?document.createElement("textarea"):document.createElement("input"),p.type==="text_input"&&(f.type="text"),p.type==="textarea"&&(f.rows=p.rows||3),f.id=`form-${n(e.form_id)}-${n(p.id)}`,f.name=n(p.id),f.className="aipkit_form-input",p.placeholder&&(f.placeholder=n(p.placeholder)),p.required&&(f.required=!0),p.default_value!==void 0&&(f.value=n(String(p.default_value))),_.appendChild(f);break;case"dropdown":if(p.label){let m=document.createElement("label");m.setAttribute("for",`form-${n(e.form_id)}-${n(p.id)}`),m.textContent=n(p.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=document.createElement("select"),f.id=`form-${n(e.form_id)}-${n(p.id)}`,f.name=n(p.id),f.className="aipkit_form-input",p.required&&(f.required=!0),Array.isArray(p.options)&&p.options.forEach(m=>{let g=document.createElement("option");g.value=n(m.value),g.textContent=n(m.text),p.default_value===m.value&&(g.selected=!0),f.appendChild(g)}),_.appendChild(f);break;case"checkbox_group":case"radio_group":let w=document.createElement("fieldset");if(p.label){let m=document.createElement("legend");m.textContent=n(p.label),m.className="aipkit_chat_form_label_text",w.appendChild(m)}Array.isArray(p.options)&&p.options.forEach(m=>{let g=document.createElement("div");g.className=p.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let h=document.createElement("input");h.type=p.type==="checkbox_group"?"checkbox":"radio",h.id=`form-${n(e.form_id)}-${n(p.id)}-${n(m.value)}`,h.name=n(p.id)+(p.type==="checkbox_group"?"[]":""),h.value=n(m.value),(p.type==="checkbox_group"&&Array.isArray(p.default_value)&&p.default_value.includes(m.value)||p.type==="radio_group"&&p.default_value===m.value)&&(h.checked=!0);let I=document.createElement("label");I.setAttribute("for",h.id),I.textContent=n(m.text),g.appendChild(h),g.appendChild(I),w.appendChild(g)}),_.appendChild(w);break;case"heading":f=document.createElement(p.level||"h5"),f.className="aipkit_chat_form_element_heading",f.textContent=n(p.label||""),_.appendChild(f);break;case"label":f=document.createElement("p"),f.className="aipkit_chat_form_element_label_only",f.textContent=n(p.label||""),_.appendChild(f);break}if(p.help_text){let w=document.createElement("p");w.className="aipkit_form_help_text",w.textContent=n(p.help_text),_.appendChild(w)}s.appendChild(_)});let l=document.createElement("button");l.type="submit",l.className="aipkit_btn aipkit_chat_form_submit_btn",l.textContent=n(e.submit_button_text||"Submit"),s.appendChild(l),s.addEventListener("submit",p=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let _=i.closest(".aipkit_chat_container")||i.closest(".aipkit_popup_wrapper"),f=null,w=null;_&&window.aipkitChatInstances&&window.aipkitChatInstances[_.id]?(f=window.aipkitChatInstances[_.id].elements,w=window.aipkitChatInstances[_.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(f=window.aipkit_chat_ui_elements,w=window.aipkit_chat_ui_actions),f&&w?window.aipkit_chatUI_handleChatFormSubmission(p,t,f,w):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),alert("Error submitting form: Chat context not found."))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),alert("Error submitting form: Submission handler missing.")}),u.appendChild(s),c.appendChild(u),r.appendChild(c),i.appendChild(r),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0),console.log(`AIPKit RenderChatForm: Form ${e.form_id} rendered.`)}window.aipkit_chatUI_renderChatForm=d})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(d,i)=>{},onRecordingErrorCallback:d=>{}}})();(function(){"use strict";function d(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=d})();(function(){"use strict";function d(i,e,t){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof i=="function"?i:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof t=="function"?t:()=>{}}window.aipkit_setRecordingCallbacks=d})();(function(){"use strict";async function d(i={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("AIPKit STT Start: Microphone access granted.");let t=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],o="";for(let a of t)if(MediaRecorder.isTypeSupported(a)){o=a;break}if(!o&&MediaRecorder.isTypeSupported(""))o="";else if(!o)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let n=o?{mimeType:o}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,n),e.currentMimeType=e.mediaRecorder.mimeType||o||"application/octet-stream",console.log("AIPKit STT Start: Using mimeType:",e.currentMimeType),e.mediaRecorder.ondataavailable=a=>{a.data.size>0&&e.audioChunks.push(a.data)},e.mediaRecorder.onstop=()=>{if(console.log("AIPKit STT Start (onstop): Recording stopped."),e.audioChunks.length>0){let a=new Blob(e.audioChunks,{type:e.currentMimeType});console.log("AIPKit STT Start (onstop): Audio Blob created, size:",a.size,"type:",a.type),e.onRecordingStopCallback&&e.onRecordingStopCallback(a,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),console.log("AIPKit STT Start (onstop): Microphone stream stopped.")}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=a=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",a.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(a.error),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),console.log("AIPKit STT Start: Recording started."),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(t){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",t),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(t),e.audioStream&&(e.audioStream.getTracks().forEach(o=>o.stop()),e.audioStream=null)}}window.aipkit_startRecording=d})();(function(){"use strict";function d(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let i=window.aipkitSttState;i.mediaRecorder&&(i.mediaRecorder.state==="recording"||i.mediaRecorder.state==="paused")?(console.log("AIPKit STT Stop: Stopping recording..."),i.mediaRecorder.stop()):(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),i.audioStream&&(i.audioStream.getTracks().forEach(e=>e.stop()),i.audioStream=null))}window.aipkit_stopRecording=d})();(function(){"use strict";function d(i,e,t){let{elements:o,config:n,state:a,setButtonStateAction:r,sendMessageAction:c}=t,{inputField:u,voiceInputButton:s}=o;if(!i||!e||!o||!n||!a||!r||!c){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",t),alert("Failed to process audio: Configuration error."),s){s.disabled=n.requireConsentCompliance&&!a.consentGiven,s.classList.remove("aipkit_loading");let p=s.querySelector(".dashicons");p&&(p.style.display="")}return}let l=new FileReader;l.readAsDataURL(i),l.onloadend=function(){let p=l.result,_=e.split(";")[0].split("/")[1]||"webm";if(s){s.disabled=!0,s.classList.add("aipkit_loading");let w=s.querySelector(".dashicons");w&&(w.style.display="none")}let f={audio_data:p,audio_format:_};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",f,n).then(w=>{if(w&&w.transcription)u.value=w.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(u),r("send",!0,a),c(w.transcription);else throw new Error("Invalid transcription response from server.")}).catch(w=>{console.error(`AIPKit STT UI (${n.botId}): Transcription AJAX error:`,w),alert(`Transcription failed: ${w.message||"Unknown error"}`)}).finally(()=>{if(s){s.disabled=n.requireConsentCompliance&&!a.consentGiven,s.classList.remove("aipkit_loading");let w=s.querySelector(".dashicons");w&&(w.style.display="")}})},l.onerror=function(p){console.error("AIPKit STT UI: Error reading audio Blob as Data URL:",p),alert("Failed to process recorded audio."),s&&(s.disabled=n.requireConsentCompliance&&!a.consentGiven)}}window.aipkit_chatUI_transcribeAudio=d})();(function(){"use strict";function d(i,e,t,o,n){let{inputField:a,voiceInputButton:r,actionButton:c,inputActionButton:u}=i,s=e.botId;if(o&&typeof o.showConsentBoxIfNeeded=="function"&&o.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${s}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!t.consentGiven){console.warn(`AIPKit Chat UI Main (${s}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),alert("Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){alert("Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}t.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{t.isRecording=!0,r.classList.add("aipkit_recording"),r.setAttribute("aria-label","Stop recording"),r.title="Stop recording",a.disabled=!0,c.disabled=!0,u&&(u.disabled=!0),console.log(`AIPKit STT (${s}): Recording started.`)},(l,p)=>{t.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",a.disabled=e.requireConsentCompliance&&!t.consentGiven,c.disabled=a.value.trim()==="",u&&(u.disabled=!1),console.log(`AIPKit STT (${s}): Recording stopped. Blob size: ${l.size}`),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(l,p,{elements:i,config:e,state:t,setButtonStateAction:n.setButtonStateAction,sendMessageAction:n.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),alert("Error processing recorded audio."))},l=>{t.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",a.disabled=e.requireConsentCompliance&&!t.consentGiven,c.disabled=a.value.trim()==="",u&&(u.disabled=!1),console.error(`AIPKit STT (${s}): Recording error:`,l),alert(`Recording failed: ${l.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=d})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function d(i){let e=window.aipkitImageUploadConstants;return e?i?e.ALLOWED_IMAGE_TYPES.includes(i.type)?i.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=d})();(function(){"use strict";function d(i){return new Promise((e,t)=>{let o=new FileReader;o.onload=()=>e(o.result),o.onerror=n=>t(n),o.readAsDataURL(i)})}window.aipkit_convertFileToBase64=d})();(function(){"use strict";function d(i){let e;i&&i.parentNode&&(e=i.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(t=>t.remove())}window.aipkit_clearImageUploadError=d})();(function(){"use strict";function d(i,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let t=document.createElement("div");if(t.className="chat-image-upload-error",t.textContent=i,e&&e.parentNode)e.parentNode.insertBefore(t,e.nextSibling);else{let o=document.querySelector(".aipkit_chat_input");o?o.appendChild(t):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=d})();(function(){"use strict";function d(i,e){let t=window.aipkitImageUploadState;if(!t){console.error("Image Upload Reset: State object not found.");return}t.currentImageFile=null,t.currentImageBase64=null,i&&(i.hasChildNodes()?(i.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{i&&(i.innerHTML="",i.style.display="none",i.classList.remove("aipkit-image-preview-fade-out"))},300)):(i.innerHTML="",i.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(i||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=d})();(function(){"use strict";function d(i,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let t=document.createElement("div");t.className="chat-image-thumbnail-wrapper";let o=document.createElement("img");o.src=i,o.alt="Image preview",o.className="chat-image-thumbnail";let n=document.createElement("button");n.className="chat-image-remove-button",n.innerHTML="\xD7",n.setAttribute("aria-label","Remove image"),n.type="button",n.onclick=()=>{let a=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,a):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},t.appendChild(o),t.appendChild(n),e.appendChild(t)}window.aipkit_renderImagePreview=d})();(function(){"use strict";function d(){let i=window.aipkitImageUploadState;return i?i.currentImageFile&&i.currentImageBase64?{mime_type:i.currentImageFile.type,base64_data:i.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=d})();(function(){"use strict";function d(){let i=window.aipkitImageUploadConstants;return i?i.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=d})();(function(){"use strict";function d(){let i=window.aipkitImageUploadConstants;return i?i.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=d})();(function(){"use strict";function d(i,e){let t=window.aipkitImageUploadState,o=window.aipkitImageUploadConstants;if(!t||!o){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!i||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}i.setAttribute("accept",o.ALLOWED_IMAGE_EXTENSIONS.join(",")),i.dataset.aipkitUploadListenerAttached!=="true"&&(i.addEventListener("change",async n=>{window.aipkit_clearImageUploadError(e);let a=n.target.files[0];if(!a){window.aipkit_resetImageUpload(e,i);return}let r=window.aipkit_validateImage(a);if(!r.isValid){window.aipkit_displayImageUploadError(r.error,e),window.aipkit_resetImageUpload(e,i),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:r.error}}));return}try{let c=await window.aipkit_convertFileToBase64(a);t.currentImageBase64=c,t.currentImageFile=a,window.aipkit_renderImagePreview(t.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:t.currentImageBase64.split(",")[1],mime_type:t.currentImageFile.type}}))}catch(c){console.error("Error processing image:",c),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,i),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),i.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:d,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(i,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(i,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:2,MAX_FILE_SIZE_BYTES:2*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function d(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=d;function i(e,t){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&t&&window.aipkit_clearChatFileUploadStatus(t),console.log("File Upload UI Reset.")}window.aipkit_resetChatFileUploadUI=i})();(function(){"use strict";function d(i){let e=window.aipkitFileUploadConstants;return e?i?e.ALLOWED_FILE_TYPES.includes(i.type)?i.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=d})();(function(){"use strict";function d(i){if(!i)return;let e=i.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=d})();(function(){"use strict";function d(i,e="info",t){if(!t)return;let o=t.querySelector(".aipkit_chat_file_upload_status");if(!o){o=document.createElement("div"),o.className="aipkit_chat_file_upload_status";let n=t.querySelector(".aipkit_chat_input_wrapper");n?t.insertBefore(o,n):t.appendChild(o)}o.textContent=i,o.className="aipkit_chat_file_upload_status",o.classList.add(`aipkit_status-${e}`),o.style.display="block"}window.aipkit_displayChatFileUploadStatus=d})();(function(){"use strict";function d(){let i=window.aipkitFileUploadConstants;return i?i.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=d})();(function(){"use strict";function d(){let i=window.aipkitFileUploadConstants;return i?i.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=d})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let d=window.aipkit_escapeHtml||function(e){return e};async function i(e,t,o,n){let a=window.aipkitFileUploadState,r=window.aipkitFileUploadConstants;if(!a||!r)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",o),null;let c=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let l of c)if(typeof window[l]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${l}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",o),null;window.aipkit_clearChatFileUploadStatus(o);let u=window.aipkit_validateChatFile(e);if(!u.isValid)return window.aipkit_displayChatFileUploadStatus(u.error,"error",o),window.aipkit_resetChatFileUploadUI(t,o),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;a.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${d(a.currentFile.name)}"...`,"processing",o);let s=new FormData;s.append("action","aipkit_frontend_chat_upload_file"),s.append("file_to_upload",a.currentFile),s.append("bot_id",n.botId),s.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&s.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&s.append("post_id",window.aipkit_current_post_id),s.append("upload_provider",n.vectorStoreProvider),s.append("_ajax_nonce",n.nonce);try{let l=await fetch(n.ajaxUrl,{method:"POST",body:s,credentials:"same-origin"}),p=await l.json();if(!l.ok||!p.success){let _=p.data?.message||p.message||"File upload failed on server.";throw new Error(_)}if(p.data&&p.data.file_context){let _=p.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(_)),console.log(`AIPKit File Upload: Stored file context for conv ${window.aipkit_current_conversation_uuid} in localStorage. Provider: ${_.provider}`)}catch(w){console.error("AIPKit File Upload: Error saving file context to localStorage:",w)}window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let f=(n.text?.fileContextActive||"Chatting with: %s").replace("%s",d(a.currentFile.name));return window.aipkit_displayChatFileUploadStatus(f,"success",o),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(l){return console.error("File Upload Processing Error:",l),window.aipkit_displayChatFileUploadStatus(`Error: ${l.message||"Upload failed."}`,"error",o),window.aipkit_resetChatFileUploadUI(t,o),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:i,resetUI:function(e,t){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,t)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function d(i,e,t,o,n=!1){let{inputField:a,actionButton:r,sendIcon:c,clearIcon:u,spinner:s,voiceInputButton:l,inputActionButton:p,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=e,w=t.text||{};if(!r||!c||!u||!s||!a)return console.error("AIPKit SetButtonState: Missing required elements."),null;s.style.display="none",c.style.display="none",u.style.display="none",r.disabled=!1,r.classList.remove("aipkit_btn-clear-state");let m=i;switch(i){case"sending":case"streaming":a.disabled=!0,r.disabled=!0,l&&(l.disabled=!0),p&&(p.disabled=!0),_&&(_.disabled=!0),f&&(f.disabled=!0),s.style.display="inline-block";let g=i==="streaming"?w.streaming||"Streaming...":w.sending||"Sending...";r.setAttribute("aria-label",g),r.setAttribute("title",g);break;case"clear":a.disabled=t.requireConsentCompliance&&!o.consentGiven,u.style.display="inline-block",r.classList.add("aipkit_btn-clear-state"),r.setAttribute("aria-label",w.clearChat||"Clear Chat"),r.setAttribute("title",w.clearChat||"Clear Chat"),r.disabled=!1,l&&(l.disabled=t.requireConsentCompliance&&!o.consentGiven),p&&(p.disabled=t.requireConsentCompliance&&!o.consentGiven),_&&(_.disabled=t.requireConsentCompliance&&!o.consentGiven),f&&(f.disabled=t.requireConsentCompliance&&!o.consentGiven);break;case"send":default:m="send",a.disabled=t.requireConsentCompliance&&!o.consentGiven,c.style.display="inline-block",r.setAttribute("aria-label",w.sendMessage||"Send Message"),r.setAttribute("title",w.sendMessage||"Send Message"),r.disabled=!n&&a.value.trim()==="",t.requireConsentCompliance&&!o.consentGiven&&(r.disabled=!0),l&&(l.disabled=t.requireConsentCompliance&&!o.consentGiven),p&&(p.disabled=t.requireConsentCompliance&&!o.consentGiven),_&&(_.disabled=t.requireConsentCompliance&&!o.consentGiven),f&&(f.disabled=t.requireConsentCompliance&&!o.consentGiven);break}return m}window.aipkit_chatUI_setButtonStateAction=d})();(function(){"use strict";function d(i,e,t){if(!i)return;let o=i.closest("#aipkit_admin_chat_preview_container"),n=window.innerWidth<=760;e.requireConsentCompliance&&!t.consentGiven||e.popupEnabled&&!t.isPopupOpen||((o||!n||t.userInitiatedAction)&&setTimeout(()=>{i&&typeof i.focus=="function"&&i.focus()},50),t.userInitiatedAction&&(t.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=d})();(function(){"use strict";function d(i,e,t,o,n,a){let{inputField:r,messagesEl:c,container:u,voiceInputButton:s,inputActionButton:l,webSearchToggleButton:p,googleSearchGroundingToggleButton:_}=t;n.isSending=!1,n.currentStreamId=null,n.currentStreamMessageId=null,r.disabled=o.requireConsentCompliance&&!n.consentGiven,s&&(s.disabled=o.requireConsentCompliance&&!n.consentGiven),l&&(l.disabled=o.requireConsentCompliance&&!n.consentGiven),p&&o.allowWebSearchTool&&o.provider==="OpenAI"&&(p.disabled=o.requireConsentCompliance&&!n.consentGiven),_&&o.allowGoogleSearchGrounding&&o.provider==="Google"&&(_.disabled=o.requireConsentCompliance&&!n.consentGiven);let f=r.value.trim()==="",w=c.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;n.buttonState=a.setButtonStateAction(f&&w?"clear":"send",!1,n),a.focusInputAction(),u.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:i,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),o.ttsEnabled&&o.ttsAutoPlay&&i&&setTimeout(()=>{let g=c.querySelector(`#${CSS.escape(i)}`)?.querySelector(".aipkit_play_btn");g&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(g):o.ttsEnabled&&o.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${o.botId}): Could not find play button for message ${i} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=d})();(function(){"use strict";function d(i,e,t=!0,o,n,a,r){let{messagesEl:c,inputField:u,container:s,voiceInputButton:l,inputActionButton:p,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=o,w=n.botId;a.isSending=!1,a.currentStreamId=null,a.currentStreamMessageId=null;let m=window.aipkit_generateClientMessageId(w);window.aipkit_chatUI_appendMessage(c,i,"bot",n,!0,!1,m,t),window.aipkit_chatUI_removeTypingIndicator(c),u.disabled=n.requireConsentCompliance&&!a.consentGiven,l&&(l.disabled=n.requireConsentCompliance&&!a.consentGiven),p&&(p.disabled=n.requireConsentCompliance&&!a.consentGiven),_&&n.allowWebSearchTool&&n.provider==="OpenAI"&&(_.disabled=n.requireConsentCompliance&&!a.consentGiven),f&&n.allowGoogleSearchGrounding&&n.provider==="Google"&&(f.disabled=n.requireConsentCompliance&&!a.consentGiven),a.buttonState=r.setButtonStateAction("send",!1,a),r.focusInputAction(),s.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:m,error:i}}))}window.aipkit_chatUI_handleError=d})();(function(){"use strict";function d(i){if(!i)return;i.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{i.removeChild(t)}catch(o){o.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",o)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0)}window.aipkit_chatUI_clearMessages=d})();(function(){"use strict";function d(i,e,t,o){let{messagesEl:n,inputField:a,imagePreviewContainer:r,imageUploadInput:c,fileUploadInput:u,inputArea:s}=i;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(n);let l=n.querySelector(".aipkit_initial_greeting");if(!l&&typeof window.aipkit_chatUI_appendMessage=="function"){let _=e?.text?.initialGreeting||"Hello!";typeof window.aipkit_generateClientMessageId=="function"?(window.aipkit_chatUI_appendMessage(n,_,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)),console.log("AIPKit Clear Action: Re-appended initial greeting.")):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else l||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");a&&(a.value="",a.disabled=e.requireConsentCompliance&&!t.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(a)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?i.imagePreviewContainer&&i.imageUploadInput?(window.chatImageUpload.reset(i.imagePreviewContainer,i.imageUploadInput),console.log("AIPKit Clear Action: Image upload UI reset.")):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?i.fileUploadInput&&i.inputArea?(window.aipkitChatFileUpload.resetUI(i.fileUploadInput,i.inputArea),console.log("AIPKit Clear Action: File upload UI reset.")):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof o.setButtonStateAction=="function"?t.buttonState=o.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided."),t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof o.focusInputAction=="function"&&(!e.requireConsentCompliance||t.consentGiven)?o.focusInputAction():typeof o.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let p=n.closest(".aipkit_chat_container")||n.closest(".aipkit_popup_wrapper");p&&p.dispatchEvent(new CustomEvent("aipkit:chatCleared")),console.log(`AIPKit Chat (${e.botId}): Chat cleared.`)}window.aipkit_chatUI_clearChatAction=d})();(function(){"use strict";async function d(i,e,t,o,n=null){let{inputField:a,messagesEl:r,container:c,inputArea:u}=i,s=e.botId,l=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let y=!1,k=window.aipkit_active_file_context_data;(k.provider==="OpenAI"&&k.vector_store_id||k.provider==="Pinecone"&&k.index_name&&k.namespace||k.provider==="Qdrant"&&k.collection_name&&k.file_upload_context_id)&&(y=!0),y?(l={...k},console.log(`SendMessageAction (${s}): Using activeFileContext from window object:`,JSON.stringify(l))):(console.warn(`SendMessageAction (${s}): File context data found on window object, but missing required fields for provider: ${k.provider||"unknown"}. Context ignored. Data:`,k),l=null)}else console.log(`SendMessageAction (${s}): No valid activeFileContext found on window object for this message.`);let p=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(p=window.chatImageUpload.getImageData(),p&&i.imagePreviewContainer&&i.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(i.imagePreviewContainer,i.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&i.fileUploadInput&&u){let y=window.aipkitFileUploadState;(l||y&&y.currentFile)&&(console.log("SendMessageAction: Resetting general file upload UI because a file context was active or a file was pending."),window.aipkitChatFileUpload.resetUI(i.fileUploadInput,u))}let _=t.consentUIInstance;if(_&&typeof _.showConsentBoxIfNeeded=="function"&&_.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${s}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!t.consentGiven){console.warn(`AIPKit SendMessage (${s}): Consent required but not given.`);return}let f=n!==null?n.trim():a.value.trim();if(t.isSending||!f&&!p&&!l||n===null&&(t.buttonState!=="send"||i.actionButton.disabled))return;let w=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(l={...window.aipkit_active_file_context_data},console.log(`SendMessageAction (${s}): Re-captured activeFileContext after UUID regeneration for new chat + potential immediate file upload:`,JSON.stringify(l))))),w=!0);let m=window.aipkit_generateClientMessageId(s),g=f;p&&(g={text:f,user_image:p}),window.aipkit_chatUI_appendMessage(r,g,"user",e,!1,!1,m,!0),n===null&&(a.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(a)),w&&(window.aipkit_is_fresh_session=!1,console.log(`AIPKit SendMessageAction (${s}): Marked session as NOT fresh after initiating first message of new conversation.`));let h=(e.imageTriggers||"/image").toLowerCase().split(",").map(y=>y.trim()).filter(y=>y.length>0&&y.startsWith("/")),I=f.toLowerCase(),b=null;for(let y of h)if(I.startsWith(y+" ")||I===y){b=y;break}if(b){let y=f.substring(b.length).trim();if(!y&&I!==b){let k=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",b);o.handleError(k,!1,!0),n===null&&(t.buttonState=o.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(y,f,m,w,{state:t,elements:i,config:e,...o}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),o.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let y=window.aipkit_checkMessageModeration(f,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(y){let k=window.aipkit_generateClientMessageId(s);window.aipkit_chatUI_appendMessage(r,y.message,"bot",e,!0,!1,k),t.buttonState=o.setButtonStateAction("send",!1),o.focusInputAction(),c.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:k,reason:y.type,content:f,...y.word&&{word:y.word},...y.ip&&{ip:y.ip}}}));return}}if(t.isSending=!0,a.disabled=!0,i.voiceInputButton&&(i.voiceInputButton.disabled=!0),i.inputActionButton&&(i.inputActionButton.disabled=!0),i.webSearchToggleButton&&(i.webSearchToggleButton.disabled=!0),i.googleSearchGroundingToggleButton&&(i.googleSearchGroundingToggleButton.disabled=!0),t.buttonState=o.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),c.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:m}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")console.log(`SendMessageAction (${s}): Preparing for SSE stream. Passing activeFileContext:`,JSON.stringify(l)),window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_streamMessage(f,s,e,r,o.handleError,()=>o.handleCompletion(t.currentStreamMessageId,w),t.webSearchToolActive,t.googleSearchGroundingActive,p,l,m);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")console.log(`SendMessageAction (${s}): Preparing for AJAX call. Passing activeFileContext:`,JSON.stringify(l)),window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_sendMessage(f,s,e,i,(y,k,S,A)=>{window.aipkit_chatUI_removeTypingIndicator(r),window.aipkit_chatUI_appendMessage(r,y,"bot",e,!1,!1,k,!0,A),o.handleCompletion(k,w)},o.handleError,()=>{},t.webSearchToolActive,t.googleSearchGroundingActive,p,l,m);else{let y=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${s}): Required send function not available.`),o.handleError(y,!1)}}window.aipkit_chatUI_sendMessageAction=d})();(function(){"use strict";function d(i,e){if(!i||typeof e!="object"||Object.keys(e).length===0)return;let t=i.dataset.botId||"unknown",o=0;for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&e[n]!==""&&e[n]!==null){let a=`--aipkit-chat-${n.replace(/_/g,"-")}`,r=e[n];n==="container_max_height"||n==="popup_max_height"?r=e[n]+"vh":n==="container_max_width"||n==="popup_width"||n==="container_height"||n==="container_min_height"||n==="popup_height"||n==="popup_min_height"?r=e[n]+"px":(n==="bubble_border_radius"||n==="container_border_radius")&&typeof r=="number"?r=r===0?"0":`${r}px`:(n==="bubble_border_radius"||n==="container_border_radius")&&typeof r=="string"&&/^\d+$/.test(r)&&(r=r==="0"?"0":`${r}px`),i.style.setProperty(a,r),o++}console.log(`AIPKit Chat Theme (${t}): Applied ${o} custom theme variables.`)}window.aipkit_chatUI_applyCustomThemeStyles=d})();(function(){"use strict";function d(i){let t=`aipkit_chatbot_consent_given_${i.botId||"default"}`;return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:localStorage.getItem(t)==="true",isRecording:!1,webSearchToolActive:!1,googleSearchGroundingActive:!1}}window.aipkit_chatUI_initState=d})();(function(){"usegistrict";function d(i,e){if(!i||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let t=e.botId||"default";if(i.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(n=>{try{i.removeChild(n)}catch{}}),!i.querySelector(".aipkit_initial_greeting")){let n=e.text.initialGreeting||"Hello!";if(typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(i,n,"bot",e,!1,!0,window.aipkit_generateClientMessageId(t));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let a=document.createElement("div");a.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",a.innerHTML=`<div class="aipkit_chat_bubble">${n.replace(/\n/g,"<br>")}</div>`,i.appendChild(a)}}}window.aipkit_chatUI_displayInitialMessage=d})();(function(){"use strict";function d(i,e,t,o){let{inputField:n,messagesEl:a,container:r}=i,c=e.botId;t.buttonState=o.setButtonStateAction("send",!1,t),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(n),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),n.disabled=e.requireConsentCompliance&&!t.consentGiven,i.voiceInputButton&&(i.voiceInputButton.disabled=e.requireConsentCompliance&&!t.consentGiven),i.inputActionButton&&(i.inputActionButton.disabled=e.requireConsentCompliance&&!t.consentGiven),i.webSearchToggleButton&&e.allowWebSearchTool&&e.provider==="OpenAI"&&(i.webSearchToggleButton.disabled=e.requireConsentCompliance&&!t.consentGiven),i.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(i.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!t.consentGiven),r.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:c}})),console.log(`AIPKit FinalizeSetup (${c}): Instance setup finalized.`)}window.aipkit_chatUI_finalizeSetup=d})();(function(){"use strict";function d(i,e,t,o){if(!i||!t||!o||o.isPopupOpen)return;i.classList.add("aipkit-popup-open"),i.setAttribute("aria-hidden","false"),o.isPopupOpen=!0,typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(e):console.error("AIPKit Popup Open: scrollToBottom function not found.");let n=i.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=760)||n)&&setTimeout(()=>{t&&typeof t.focus=="function"&&t.focus()},50)}window.aipkit_chatUI_openPopup=d})();(function(){"use strict";function d(i,e){!i||!e||!e.isPopupOpen||(i.classList.remove("aipkit-popup-open"),i.setAttribute("aria-hidden","true"),e.isPopupOpen=!1)}window.aipkit_chatUI_closePopup=d})();(function(){"use strict";function d(i,e,t,o,n,a){if(!i||!e||!a){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, or stateRef).");return}if(t||console.warn("AIPKit Chat Popup Handlers: Close button not found. Popup cannot be closed via button."),typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}e.addEventListener("click",r=>{r.stopPropagation(),a.isPopupOpen?window.aipkit_chatUI_closePopup(i,a):window.aipkit_chatUI_openPopup(i,o,n,a)}),t&&t.addEventListener("click",r=>{r.stopPropagation(),window.aipkit_chatUI_closePopup(i,a)}),document.addEventListener("keydown",r=>{r.key==="Escape"&&a.isPopupOpen&&window.aipkit_chatUI_closePopup(i,a)})}window.aipkit_chatUI_setupPopupHandlers=d})();(function(){"use strict";function d(i,e){let t=new Date,o=`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${String(t.getHours()).padStart(2,"0")}${String(t.getMinutes()).padStart(2,"0")}`;return`chat-${i.botId||"transcript"}-${o}.${e}`}window.aipkit_chatUI_generateDownloadFilename=d})();(function(){"use strict";function d(i,e){let t=document.createElement("a");if(typeof t.download=="string")t.href=URL.createObjectURL(i),t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href),console.log("AIPKit Chat Download: Triggered download for",e);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let o=URL.createObjectURL(i);window.open(o,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=d})();(function(){"use strict";function d(i,e){let{messagesEl:t}=i;if(!t||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let o="",n=t.querySelectorAll(".aipkit_chat_message"),a=e?.headerName||"Bot",r=e.text.userPrefix||"User",c=e.text.errorPrefix||"Error";if(n.forEach(l=>{let p=l.querySelector(".aipkit_chat_bubble");if(!p)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),o+=`Error: Could not extract text.
`;return}let _=window.aipkit_chatUI_extractTextFromBubble(p),f="";l.classList.contains("aipkit_chat_message-user")?f=`[${r}]:`:l.classList.contains("aipkit_chat_message-bot")?f=`[${a}]:`:l.classList.contains("aipkit_chat_message-error")&&(f=`[${c}]:`),f&&_&&(o+=`${f}
${_}

`)}),o=o.trim(),!o){console.warn("AIPKit Chat Download TXT: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let u=new Blob([o],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),alert("Error: Could not prepare download.");return}let s=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(u,s)}window.aipkit_chatUI_downloadTranscriptActionTxt=d})();(function(){"use strict";let d="aipkit_sidebar_state_";function i(e){return`${d}${e||"default"}`}window.aipkit_sidebar_getStorageKey=i})();(function(){"use strict";function d(i,e){if(!e||!i)return;let t=i.querySelector(".aipkit_chat_footer");if(!t){e.style.display="none";return}if(window.getComputedStyle(t).display!=="none"&&window.getComputedStyle(t).visibility!=="hidden"&&t.offsetHeight>0){let n=t.offsetHeight;n>0&&(e.style.height=`${n}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=d})();(function(){"use strict";function i(e,t,o,n,a){let r=window.innerWidth<=760;a.mobileOverlayHandler&&(document.removeEventListener("click",a.mobileOverlayHandler,!0),a.mobileOverlayHandler=null),e&&r&&(a.mobileOverlayHandler=n,setTimeout(()=>{document.addEventListener("click",a.mobileOverlayHandler,{capture:!0,once:!1})},50))}window.aipkit_sidebar_manageMobileOverlayListener=i})();(function(){"use strict";function d(i,e,t,o,n,a,r,c,u,s){!e||!t||(e.classList.toggle("aipkit-sidebar-state-open",i),e.classList.toggle("aipkit-sidebar-state-closed",!i),t.setAttribute("aria-expanded",i.toString()),localStorage.setItem(o,i?"open":"closed"),typeof n=="function"&&r&&n(e,r.querySelector(".aipkit_sidebar_footer")),typeof a=="function"&&r&&a(i,r,t,u,c))}window.aipkit_sidebar_applyCurrentState=d})();(function(){"use strict";function d(i,e,t){let o=i.isSidebarOpen;i.isSidebarOpen=!i.isSidebarOpen,!o&&i.isSidebarOpen&&typeof t=="function"&&t()}window.aipkit_sidebar_toggleSidebar=d})();(function(){"use strict";function i(e,t,o,n){let a=e.config?.botId||"unknown";if(console.log(`AIPKit Sidebar (${a}): New Chat clicked.`),typeof e.clearChatAction=="function"){e.clearChatAction();let r=t?t.querySelector(".aipkit_conversation_item.aipkit_active"):null;r&&r.classList.remove("aipkit_active"),window.innerWidth<=760&&o.isSidebarOpen&&typeof n=="function"&&n()}else console.error(`AIPKit Sidebar (${a}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=i})();(function(){"use strict";function d(i,e,t){let o=e.botId||"unknown";if(!i||!e||!t){console.error(`AIPKit Sidebar (${o}): Missing elements or functions for fetchConversationList.`),i&&(i.innerHTML='<p style="text-align:center; color:red;">Error: Cannot load list.</p>');return}if(!e.nonce){i.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${e.text.historyGuests||"History unavailable."}</p>`;return}i.innerHTML='<p style="text-align:center; padding:10px;"><span class="aipkit_spinner" style="display:inline-block;width:16px;height:16px;"></span></p>',window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(n=>{typeof t=="function"?t(n.conversations||[]):(console.error(`AIPKit Sidebar (${o}): renderConversationListFunc is not a function.`),i.innerHTML='<p style="text-align:center; color:red;">Error: Cannot display list.</p>')}).catch(n=>{console.error(`AIPKit Sidebar (${o}): Error fetching conversation list:`,n),i.innerHTML=`<p style="text-align:center; color:red;">Error loading list: ${n.message||"Unknown error"}</p>`})}window.aipkit_sidebar_fetchConversationList=d})();(function(){"use strict";function i(e,t,o,n,a,r,c){let u=o.botId||"unknown";if(!t||!o||!n||typeof a!="function"||typeof r!="function"||typeof c!="function"){console.error(`AIPKit Sidebar (${u}): Missing elements or functions for renderConversationList.`),t&&(t.innerHTML='<p style="text-align:center; color:red;">Error: Cannot render list.</p>');return}if(!e||e.length===0){t.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${o.text.historyEmpty||"No past conversations."}</p>`;return}t.innerHTML="";let s=window.aipkit_current_conversation_uuid||null;e.forEach(l=>{let p=document.createElement("div");p.className="aipkit_conversation_item",p.setAttribute("data-conversation-id",l.id);let _=document.createElement("span");_.textContent=l.title||l.id.substring(0,8),_.title=`${l.title||l.id.substring(0,8)} (ID: ${l.id})`,p.appendChild(_);let f=document.createElement("button");f.type="button",f.className="aipkit_conversation_item_delete_btn",f.setAttribute("aria-label",`Delete conversation: ${_.title}`),f.innerHTML='<span class="dashicons dashicons-no-alt"></span>',f.title="Delete Conversation",p.appendChild(f);let w=document.createElement("span");w.className="aipkit_conversation_item_spinner aipkit_spinner",p.appendChild(w),s&&l.id===s&&p.classList.add("aipkit_active"),p.addEventListener("click",m=>{m.target.closest(".aipkit_conversation_item_delete_btn")||n.isDeletingId===l.id||(a(l.id),window.innerWidth<=760&&n.isSidebarOpen&&c())}),f.addEventListener("click",m=>{m.stopPropagation(),!n.isDeletingId&&r(l.id,p)}),t.appendChild(p)})}window.aipkit_sidebar_renderConversationList=i})();(function(){"use strict";function d(i,e,t,o,n,a){let r=o.botId||"unknown";if(n.isDeletingId)return;n.isDeletingId=i;let c=e.querySelector(".aipkit_conversation_item_delete_btn"),u=e.querySelector(".aipkit_conversation_item_spinner");c&&(c.style.display="none"),u&&(u.style.display="inline-block"),e.style.opacity="0.6";let s={bot_id:r,conversation_uuid:i};window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",s,o).then(l=>{e.style.transition="opacity 0.3s ease-out, max-height 0.3s ease-out",e.style.opacity="0",e.style.maxHeight="0",e.style.padding="0",e.style.marginBottom="0",e.style.overflow="hidden",setTimeout(()=>{e.parentNode&&e.remove(),t&&t.childElementCount===0&&(t.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${o.text.historyEmpty||"No past conversations."}</p>`)},300),window.aipkit_current_conversation_uuid===i&&(typeof a.clearChatAction=="function"?a.clearChatAction():console.error(`AIPKit Sidebar (${r}): clearChatAction is not a function in actions object.`))}).catch(l=>{alert(`Error deleting conversation: ${l.message||"Unknown error"}`),c&&(c.style.display="inline-flex"),u&&(u.style.display="none"),e.style.opacity="1"}).finally(()=>{n.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=d})();(function(){"use strict";function i(e,t,o,n,a,r,c){let u=n.botId||"unknown";if(!e||a.isDeletingId===e)return;console.log(`AIPKit Sidebar (${u}): Loading existing conversation: ${e}`),sessionStorage.setItem("aipkit_current_conversation_uuid",e),window.aipkit_current_conversation_uuid=e,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let l=localStorage.getItem(`aipkit_file_context_${e}`);if(l){let p=JSON.parse(l),_=!1;p&&p.provider&&(p.provider==="OpenAI"&&p.vector_store_id||p.provider==="Pinecone"&&p.index_name&&p.namespace||p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id)&&(_=!0),_?(window.aipkit_active_file_context_provider=p.provider,window.aipkit_active_file_context_data=p,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:p})),console.log(`AIPKit Sidebar (${u}): Restored file context for conv ${e} from localStorage:`,p)):(console.warn(`AIPKit Sidebar (${u}): Invalid file context data in localStorage for conv ${e}. Clearing. Data:`,p),localStorage.removeItem(`aipkit_file_context_${e}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Sidebar (${u}): No file context found in localStorage for conv ${e}. Global context cleared.`)}catch(l){console.error("AIPKit Sidebar: Error handling localStorage for file context:",l),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(t?t.querySelectorAll(".aipkit_conversation_item"):[]).forEach(l=>{l.classList.remove("aipkit_active"),l.getAttribute("data-conversation-id")===e&&l.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"?(window.aipkit_chatUI_clearMessages(o),o.innerHTML='<div class="aipkit_detail_spinner" style="margin: 20px auto; display: block;"><span class="aipkit_spinner"></span></div>'):o.innerHTML="",window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},n).then(l=>{o.innerHTML="";let p=l.history||[];if(p.length===0)typeof window.aipkit_chatUI_appendMessage=="function"&&n.text.initialGreeting?typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(o,n.text.initialGreeting,"bot",n,!1,!0,window.aipkit_generateClientMessageId(u)):o.innerHTML=`<p style="text-align:center; font-style: italic; padding: 20px;">${n.text.historyEmpty||"No past messages."}</p>`;else{let f=null;p.forEach(w=>{let m=w.role==="assistant"||w.role==="bot"?"bot":"user",g=w.content||"";w.response_data&&w.response_data.type==="image"&&w.response_data.images&&w.response_data.images.length>0&&(g={type:"image",images:w.response_data.images,prompt:w.request_payload?.prompt||w.content}),w.response_data&&w.response_data.type==="user_image_upload"&&w.response_data.images&&w.response_data.images.length>0&&(g={text:w.content||"",user_image:w.response_data.images[0]}),window.aipkit_chatUI_appendMessage(o,g,m,n,w.role==="bot"&&(w.content||"").startsWith("Error:"),!1,w.message_id||null,!1,w.grounding_metadata||null),(m==="bot"||m==="assistant")&&w.openai_response_id&&(f=w.openai_response_id)}),f&&(window.aipkit_current_openai_response_id=f,sessionStorage.setItem("aipkit_current_openai_response_id",f),console.log(`AIPKit Sidebar (${u}): Set OpenAI Response ID from history: ${f}`)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0)}typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1),typeof r.focusInputAction=="function"&&r.focusInputAction();let _=o.closest(".aipkit_chat_container");_&&_.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:e}}))}).catch(l=>{o.innerHTML=`<p style="color:red;text-align:center;">Error loading history: ${l.message||"Unknown error"}</p>`,typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=i})();(function(){"use strict";function i(e,t,o,n){let{sidebarToggleBtn:a,sidebarEl:r,newChatBtn:c}=t,u=e.querySelector(".aipkit_chat_messages"),s=e.querySelector(".aipkit_chat_main"),l=r?r.querySelector(".aipkit_sidebar_content"):null,p=r?r.querySelector(".aipkit_sidebar_footer"):null;if(!e||!a||!r||!l||!u||!s){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:a,sidebarEl:r,sidebarContentEl:l,messagesEl:u,mainContentEl:s});return}let _=o.botId;if(!_){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),a.disabled=!0,c&&(c.disabled=!0),l.innerHTML='<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">Configuration Error</p>';return}let f={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null},w=window.aipkit_sidebar_getStorageKey(_),m=localStorage.getItem(w);f.isSidebarOpen=m==="open";let g=A=>{f.isSidebarOpen&&window.innerWidth<=760&&!r.contains(A.target)&&!a.contains(A.target)&&k()},h=A=>window.aipkit_sidebar_applyCurrentState(f.isSidebarOpen,e,a,w,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,r,f,g,A),I=()=>window.aipkit_sidebar_fetchConversationList(l,o,A=>window.aipkit_sidebar_renderConversationList(A,l,o,f,b,y,k)),b=A=>window.aipkit_sidebar_loadConversation(A,l,u,o,f,n,k),y=(A,v)=>window.aipkit_sidebar_handleDeleteConversation(A,v,l,o,f,n),k=()=>{window.aipkit_sidebar_toggleSidebar(f,h,I),h(f.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,p),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,p)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),h(!1),a.addEventListener("click",k),c&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof n.clearChatAction=="function"?(c.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(n,l,f,k)),c.disabled=!1):c&&(c.disabled=!0,console.warn(`AIPKit Sidebar (${_}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{f.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(f.isSidebarOpen,r,a,g,f)}),(f.isSidebarOpen||!o.nonce)&&I();let S=A=>{A.detail&&A.detail.newConversation&&f.isSidebarOpen&&I()};e.addEventListener("aipkit:messageReceived",S),console.log(`AIPKit Sidebar (${_}): Orchestrator initialized. Initial state: ${f.isSidebarOpen?"open":"closed"}`)}window.aipkit_initConversationSidebar=i})();(function(){"use strict";function d(i){if(!i)return"";let e="",t=i.childNodes;function o(n){if(n.nodeType===Node.TEXT_NODE)return n.textContent;if(n.nodeName==="BR")return`
`;if(n.nodeType===Node.ELEMENT_NODE){let a="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(n.tagName)&&(a+=`
`),n.tagName==="LI"&&(a+="- "),n.childNodes.forEach(r=>{a+=o(r)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(n.tagName)&&(a+=`
`),a}return""}return t.forEach(n=>{e+=o(n)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=d})();(function(){"use strict";function d(i,e=1500){let t=i.querySelector(".dashicons");if(!t){console.warn("AIPKit showSuccessIcon: Icon element not found inside button:",i);return}i.dataset.originalIconClass||(i.dataset.originalIconClass=t.className);let o="dashicons dashicons-yes-alt";if(i.dataset.successTimeoutId||i.disabled||t.className===o)return;t.className=o,t.style.color="var(--aipkit_status-success, #38A169)",i.dataset.successTimeoutId&&clearTimeout(parseInt(i.dataset.successTimeoutId,10));let n=setTimeout(()=>{let a=i.querySelector(".dashicons"),r=i.dataset.originalIconClass;a&&a.className===o&&r&&(a.className=r,a.style.color="",delete i.dataset.originalIconClass),delete i.dataset.successTimeoutId},e);i.dataset.successTimeoutId=n.toString()}window.aipkit_chatUI_showSuccessIcon=d})();(function(){"use strict";function d(i,e){let t=i.target.closest(".aipkit_copy_btn");if(!t||t.disabled||t.dataset.successTimeoutId)return;let o=t.closest(".aipkit_chat_message"),n=o?o.querySelector(".aipkit_chat_bubble"):null;if(!o||!n){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let a=window.aipkit_chatUI_extractTextFromBubble(n);if(!a){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(a).then(()=>{window.aipkit_chatUI_showSuccessIcon(t)}).catch(r=>{console.error("AIPKit Message Actions: Clipboard API failed:",r)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let r=document.createElement("textarea");r.value=a,r.style.position="fixed",r.style.top="-9999px",r.style.left="-9999px",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select();let c=document.execCommand("copy");if(document.body.removeChild(r),c)window.aipkit_chatUI_showSuccessIcon(t);else throw new Error("execCommand failed")}catch(r){console.error("AIPKit Message Actions: Fallback copy method failed:",r)}}}window.aipkit_chatUI_handleCopyAction=d})();(function(){"use strict";function d(i,e){let t=i.target.closest(".aipkit_feedback_btn");if(!t||t.disabled||t.classList.contains("aipkit_feedback_selected"))return;let o=t.getAttribute("data-feedback"),n=t.closest(".aipkit_chat_message"),a=n?n.getAttribute("data-message-id"):null,r=t.closest(".aipkit_message_actions");if(!a||!o||!r){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}console.log(`AIPKit Feedback (${e.botId}): Type=${o}, MessageID=${a}`);let c=r.querySelectorAll(".aipkit_feedback_btn");if(c.forEach(s=>{s.disabled=!0,s===t?s.classList.add("aipkit_feedback_selected"):(s.classList.remove("aipkit_feedback_selected"),s.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),c.forEach(s=>{s.disabled=!1,s.classList.remove("aipkit_feedback_selected"),s.style.opacity="1"});return}let u={message_id:a,feedback_type:o};window.aipkit_frontendApiRequest("aipkit_store_feedback",u,e).then(s=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${a}.`,s)}).catch(s=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${a}:`,s),c.forEach(l=>{l.disabled=!1,l.classList.remove("aipkit_feedback_selected"),l.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=d})();(function(){"use strict";function d(i){let e="",t=i.text||{};if(i.ttsEnabled){let o=t.playActionLabel||"Play audio";e+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${o}" aria-label="${o}"><span class="dashicons dashicons-controls-play"></span></button>`}if(i.enableCopyButton){let o=t.copyActionLabel||"Copy response";e+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${o}" aria-label="${o}"><span class="dashicons dashicons-admin-page"></span></button>`}if(i.enableFeedback){let o=t.feedbackLikeLabel||"Like response",n=t.feedbackDislikeLabel||"Dislike response";e+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${o}" aria-label="${o}" data-feedback="up"><span class="dashicons dashicons-thumbs-up"></span></button>`,e+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${n}" aria-label="${n}" data-feedback="down"><span class="dashicons dashicons-thumbs-down"></span></button>`}return e?`<div class="aipkit_message_actions">${e}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=d})();(function(){"use strict";function d(i,e){if(!i){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}if(i.dataset.aipkitMessageActionsListenerAttached==="true"){console.log("AIPKit Init Message Actions: Listener already attached.");return}i.dataset.aipkitMessageActionsListenerAttached="true",i.addEventListener("click",function(t){if(t.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(t,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(t.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(t,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}),console.log("AIPKit Init Message Actions: Event listeners for copy/feedback attached to messages container.")}window.aipkit_chatUI_initMessageActions=d})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function d(i=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null,console.log("AIPKit TTS StopAudio: Audio stopped and resources released.")),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),console.log("AIPKit TTS StopAudio: Revoked Blob URL:",e.currentBlobUrl),e.currentBlobUrl=null),i&&e.currentlyPlayingButton){console.log("AIPKit TTS StopAudio: Resetting button state for:",e.currentlyPlayingButton),e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let t=e.currentlyPlayingButton.querySelector(".dashicons");if(t){let o=e.currentlyPlayingButton.getAttribute("data-original-icon-class");t.className=o||"dashicons dashicons-controls-play",e.currentlyPlayingButton.removeAttribute("data-original-icon-class")}e.currentlyPlayingButton=null}else!i&&e.currentlyPlayingButton&&console.log("AIPKit TTS StopAudio: Called without forcing button reset (button might be reset by error handler).")}window.aipkit_tts_stopCurrentAudio=d})();(function(){"use strict";function d(){let o=window.aipkitTtsState;if(!o||!o.currentAudio||!o.currentlyPlayingButton)return;console.log("AIPKit TTS Handler: Audio ready to play."),o.currentlyPlayingButton.classList.remove("aipkit_loading"),o.currentlyPlayingButton.classList.add("aipkit_playing"),o.currentlyPlayingButton.disabled=!1;let n=o.currentlyPlayingButton.querySelector(".dashicons");n&&(o.currentlyPlayingButton.hasAttribute("data-original-icon-class")||o.currentlyPlayingButton.setAttribute("data-original-icon-class",n.className),n.className="dashicons dashicons-controls-pause"),o.currentAudio.play().catch(a=>{console.error("AIPKit TTS Handler: Error starting playback:",a),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(a)})}function i(){console.log("AIPKit TTS Handler: Audio finished playing."),typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function e(){let o=window.aipkitTtsState;!o||!o.currentAudio||(console.log("AIPKit TTS Handler: Audio paused. Stopping."),typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function t(o){let n=window.aipkitTtsState;if(!n)return;console.error("AIPKit TTS Handler: Error playing audio.",o);let a=n.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),a){a.classList.remove("aipkit_loading","aipkit_playing"),a.classList.add("aipkit_error"),a.disabled=!1;let r=a.querySelector(".dashicons");if(r){let c=a.getAttribute("data-original-icon-class");r.className=c||"dashicons dashicons-controls-play",a.removeAttribute("data-original-icon-class")}}n.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=d,window.aipkit_tts_handleAudioEnded=i,window.aipkit_tts_handleAudioPaused=e,window.aipkit_tts_handleAudioError=t})();(function(){"use strict";function d(i,e,t){let o=window.aipkitTtsState;if(!o){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let n=atob(i),a=new Array(n.length);for(let u=0;u<n.length;u++)a[u]=n.charCodeAt(u);let r=new Uint8Array(a),c=new Blob([r],{type:e});o.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(o.currentBlobUrl),o.currentBlobUrl=URL.createObjectURL(c),console.log("AIPKit TTS PlayFromBase64: Created Blob URL:",o.currentBlobUrl),o.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),o.currentAudio=new Audio(o.currentBlobUrl),o.currentlyPlayingButton=t,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&o.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&o.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&o.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?o.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),console.log("AIPKit TTS PlayFromBase64: Loading audio source from Blob URL"),o.currentAudio.load()}catch(n){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",n),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(n)}}window.aipkit_tts_playAudioFromBase64=d})();(function(){"use strict";async function d(i){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),i&&(i.classList.remove("aipkit_loading"),i.classList.add("aipkit_error"),i.disabled=!1);return}let t=i.closest(".aipkit_chat_message"),o=t?t.querySelector(".aipkit_chat_bubble"):null,n=i.closest(".aipkit_chat_container[data-config]");n||(n=i.closest(".aipkit_popup_wrapper[data-config]"));let a=n?n.getAttribute("data-config"):null,r=null;if(!o||!n||!a){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),i&&(i.classList.remove("aipkit_loading"),i.classList.add("aipkit_error"),i.disabled=!1);return}try{r=JSON.parse(a)}catch(s){console.error("AIPKit TTS PlayAction: Failed to parse config.",s);return}let c=o.getAttribute("data-raw-text")||"",u=r.botId;if(!c){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!u){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(i===e.currentlyPlayingButton){console.log("AIPKit TTS PlayAction: Clicked the currently playing/loading button. Stopping."),typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),i.classList.remove("aipkit_error","aipkit_playing"),i.classList.add("aipkit_loading"),i.disabled=!0;try{let s={text:c};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let l=await window.aipkit_frontendApiRequest("aipkit_generate_speech",s,r);if(l&&l.audio_data_base64&&l.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(l.audio_data_base64,l.mime_type,i);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",l),new Error("Invalid response received from speech generation.")}catch(s){if(console.error("AIPKit TTS PlayAction: Error generating speech:",s),i){i.classList.remove("aipkit_loading","aipkit_playing"),i.classList.add("aipkit_error"),i.disabled=!1;let l=i.querySelector(".dashicons");if(l){let p=i.getAttribute("data-original-icon-class");l.className=p||"dashicons dashicons-controls-play",i.removeAttribute("data-original-icon-class")}}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=d})();(function(){"use strict";function d(i,e,t,o,n){return new Promise((a,r)=>{if(!e.ajaxUrl)return r(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return r(new Error("Missing nonce in config for SSE cache."));let c=new FormData;c.append("action","aipkit_cache_sse_message"),c.append("message",i),c.append("_ajax_nonce",e.nonce),t&&c.append("image_inputs",JSON.stringify([t])),n&&c.append("user_client_message_id",n);let u=o;if(!u&&window.aipkit_current_conversation_uuid)try{let s=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);s&&(u=JSON.parse(s),console.log(`CacheSSE: Loaded file context for conv ${window.aipkit_current_conversation_uuid} from localStorage to augment request:`,JSON.stringify(u)))}catch(s){console.error("CacheSSE: Error reading file context from localStorage:",s)}u&&(u.provider==="OpenAI"&&u.vector_store_id&&(c.append("active_openai_vs_id",u.vector_store_id),console.log(`AIPKit Cache SSE: Sending active_openai_vs_id: ${u.vector_store_id}`)),u.provider==="Pinecone"&&u.index_name&&u.namespace&&(c.append("active_pinecone_index_name",u.index_name),c.append("active_pinecone_namespace",u.namespace),console.log(`AIPKit Cache SSE: Sending Pinecone context: Index: ${u.index_name}, Namespace: ${u.namespace}`)),u.provider==="Qdrant"&&u.collection_name&&u.file_upload_context_id&&(c.append("active_qdrant_collection_name",u.collection_name),c.append("active_qdrant_file_upload_context_id",u.file_upload_context_id),console.log(`AIPKit Cache SSE: Sending Qdrant context: Collection: ${u.collection_name}, File Context ID: ${u.file_upload_context_id}`))),fetch(e.ajaxUrl,{method:"POST",body:c}).then(s=>s.ok?s.json():s.json().then(l=>{throw new Error(l?.data?.message||`HTTP error ${s.status} caching message.`)}).catch(()=>{throw new Error(`HTTP error ${s.status} caching message (non-JSON response).`)})).then(s=>{s.success&&s.data?.cache_key?a(s.data.cache_key):r(new Error(s.data?.message||"Failed to cache message for streaming."))}).catch(s=>{console.error("AIPKit SSE Cache Request Error:",s),r(s)})})}window.aipkit_chatUI_cacheSseMessage=d})();(function(){"use strict";function d(i,e,t,o,n,a,r,c,u,s){if(!t.ajaxUrl||!t.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let l=new URL(t.ajaxUrl);l.searchParams.append("action","aipkit_frontend_chat_stream"),l.searchParams.append("cache_key",i),l.searchParams.append("bot_id",e),l.searchParams.append("session_id",o||""),l.searchParams.append("conversation_uuid",n),a>0&&l.searchParams.append("post_id",a),t.provider==="OpenAI"&&t.enableOpenAIConversationState&&r&&l.searchParams.append("previous_openai_response_id",r),c&&t.provider==="OpenAI"&&t.allowWebSearchTool&&l.searchParams.append("frontend_web_search_active","true"),u&&t.provider==="Google"&&t.allowGoogleSearchGrounding&&l.searchParams.append("frontend_google_search_grounding_active","true"),s&&(s.provider==="OpenAI"&&s.vector_store_id&&(l.searchParams.append("active_openai_vs_id",s.vector_store_id),console.log(`AIPKit CreateEventSource: Added active_openai_vs_id to stream URL: ${s.vector_store_id}`)),s.provider==="Pinecone"&&s.index_name&&s.namespace&&(l.searchParams.append("active_pinecone_index_name",s.index_name),l.searchParams.append("active_pinecone_namespace",s.namespace),console.log(`AIPKit CreateEventSource: Added Pinecone context to stream URL: Index: ${s.index_name}, Namespace: ${s.namespace}`)),s.provider==="Qdrant"&&s.collection_name&&s.file_upload_context_id&&(l.searchParams.append("active_qdrant_collection_name",s.collection_name),l.searchParams.append("active_qdrant_file_upload_context_id",s.file_upload_context_id),console.log(`AIPKit CreateEventSource: Added Qdrant context to stream URL: Collection: ${s.collection_name}, File Context ID: ${s.file_upload_context_id}`))),l.searchParams.append("_ajax_nonce",t.nonce);try{let p=new EventSource(l.toString());return console.log(`[AIPKit Stream CreateEventSource (${e})] EventSource created for URL: ${l.toString()}`),p}catch(p){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,p),p}}window.aipkit_chatUI_createEventSource=d})();(function(){"use strict";function d(i,e,t,o){try{let n=JSON.parse(i.data),a=n.message_id;if(a){if(t.currentStreamMessageId&&t.currentStreamMessageId!==a&&o){let r=o.querySelector(`#${CSS.escape(t.currentStreamMessageId)}`);if(r){let c=r.querySelector(".aipkit_chat_bubble");if(c){let u=c.querySelector(".aipkit_stream_indicator");u&&u.parentNode&&u.parentNode.removeChild(u)}r.classList.remove("aipkit_message_streaming"),r.classList.add("aipkit_message_complete"),console.log(`[AIPKit Stream HandleMessageStart] Cleaned up previous stream indicator for message ID: ${t.currentStreamMessageId}`)}}t.currentStreamMessageId=a,console.log(`[AIPKit Stream HandleMessageStart] Received message_start with ID: ${t.currentStreamMessageId}`)}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&n.openai_response_id&&(window.aipkit_current_openai_response_id=n.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",n.openai_response_id),console.log(`[AIPKit Stream HandleMessageStart] Stored new OpenAI Response ID: ${n.openai_response_id}`))}catch(n){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",i.data,n)}}window.aipkit_chatUI_handleMessageStartEvent=d})();(function(){"use strict";function d(i,e){try{let t=JSON.parse(i.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.id&&(window.aipkit_current_openai_response_id=t.id,sessionStorage.setItem("aipkit_current_openai_response_id",t.id),console.log(`[AIPKit Stream HandleOpenAIResponseId] Stored new OpenAI Response ID: ${t.id}`))}catch(t){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",i.data,t)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=d})();(function(){"use strict";function d(i,e){try{let t=JSON.parse(i.data);e.accumulatedGroundingMetadata=t,console.log("[AIPKit Stream HandleGroundingMetadata] Received event:",t)}catch(t){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",i.data,t)}}window.aipkit_chatUI_handleGroundingMetadataEvent=d})();(function(){"use strict";function d(i,e,t,o,n){try{let a=JSON.parse(i.data),r=a.delta;if(r!==void 0&&n.currentStreamMessageId)if(n.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(o,n.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0);else{n.dataReceived=!0;let c=`aipkit-typing-indicator-${e}`,u=o.querySelector(`#${CSS.escape(c)}`);if(u){let s=u.querySelector(".aipkit_chat_bubble");if(s){u.id=n.currentStreamMessageId,u.setAttribute("data-message-id",n.currentStreamMessageId),u.classList.remove("aipkit_typing-indicator"),s.dataset.aipkitFullContent=r,s.innerHTML=window.aipkit_md?window.aipkit_md.render(r):r.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(s,"aipkit_stream_indicator");let l=typeof window.createActionsContainerHTML=="function"?window.createActionsContainerHTML(t):"";l&&!u.querySelector(".aipkit_message_actions")&&u.insertAdjacentHTML("beforeend",l),window.aipkit_chatUI_scrollToBottom(o,!0)}else window.aipkit_chatUI_removeTypingIndicator(o,u),window.aipkit_chatUI_appendOrUpdateMessage(o,n.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(o,n.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,a)}catch(a){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,i.data,a)}}window.aipkit_chatUI_handleOnMessageEvent=d})();(function(){"use strict";function d(i,e,t,o,n,a,r){console.log(`[AIPKit Stream HandleDone (${e})] Received 'done' event.`),typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&r.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(o,r.currentStreamMessageId,"","bot",t,!0,!1,r.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),typeof n=="function"&&n(),a.current&&(a.current.close(),a.current=null)}window.aipkit_chatUI_handleDoneEvent=d})();(function(){"use strict";function d(i,e,t,o,n){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,i.data),n.dataReceived||(n.dataReceived=!0);try{let a=JSON.parse(i.data);a.error&&n.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(o,n.currentStreamMessageId,`

*${a.error}*`,"bot",t,!1,!0,null),window.aipkit_chatUI_scrollToBottom(o,!0))}catch(a){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,i.data,a)}}window.aipkit_chatUI_handleWarningEvent=d})();(function(){"use strict";function d(i,e,t,o,n,a,r){window.aipkit_chatUI_removeTypingIndicator(o);let c=t.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,i);let u=null;if(i.data)try{let l=JSON.parse(i.data);l.error&&(u=l.error)}catch{typeof i.data=="string"&&i.data.length>0&&i.data.length<200&&(u=i.data)}else i.target&&i.target.readyState===EventSource.CLOSED?u="Connection was closed.":i.message&&(u=i.message);let s="";u?s=`${c.errorPrefix||"Error:"} ${u}`:s=r.dataReceived?c.streamError||"Stream error. Please try again.":c.connError||"Connection error. Please check setup or try again.",typeof n=="function"&&n(s,!1,!0),r.currentStreamMessageId=null,a.current&&(a.current.close(),a.current=null)}window.aipkit_chatUI_handleErrorEvent=d})();(function(){"use strict";function d(i,e,t,o,n){console.log(`[AIPKit Stream HandleDisplayForm (${e})] Received 'display_form_event'. Data:`,i.data),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);try{let r=JSON.parse(i.data).form_definition;if(typeof r!="object"||r===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let c=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(o,r,t,c);let u=o.closest(".aipkit_chat_container");u&&u.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:r.form_id,messageId:c}}))}catch(a){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,a,"Raw event data:",i.data)}}window.aipkit_chatUI_handleDisplayFormEvent=d})();(function(){"use strict";async function d(i,e,t,o,n,a,r,c,u,s,l){let p=t.text||{},_={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},f={current:null},w=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let k of w)if(typeof window[k]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${k}`),typeof n=="function"&&n(`${p.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);return}let m=window.aipkit_current_conversation_uuid,g=window.aipkit_guest_uuid,h=window.aipkit_current_post_id,I=window.aipkit_current_openai_response_id;if(!m){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof n=="function"&&n(p.errorPrefix+" "+(p.connError||"Configuration error (Conv ID)."),!1);return}let b=null;try{console.log(`[AIPKit Stream Orchestrator (${e})] Caching message before starting stream... activeFileContext being passed to cache:`,JSON.stringify(s)),b=await window.aipkit_chatUI_cacheSseMessage(i,t,u,s,l),console.log(`[AIPKit Stream Orchestrator (${e})] Message cached successfully. Cache Key: ${b}`)}catch(k){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,k.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,k),typeof n=="function"){let S=`${p.errorPrefix||"Error:"} Failed to prepare message for streaming.`;k&&typeof k=="object"&&k.code?S+=` (Code: ${k.code})`:k&&k.message?S+=` (${k.message})`:S+=" (Unknown error)",n(S)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);return}console.log(`[AIPKit Stream Orchestrator (${e})] Attempting connection... Guest: ${g||"N/A"}, Conversation: ${m}, PostID: ${h}, PrevOpenAIRespID: ${I||"N/A"}, OpenAIWebSearchActive: ${r}, GoogleGroundingActive: ${c}`),console.log(`[AIPKit Stream Orchestrator (${e})] Active File Context for EventSource:`,JSON.stringify(s));let y=window.aipkit_chatUI_createEventSource(b,e,t,g,m,h,I,r,c,s);if(y instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,y),typeof n=="function"&&n(p.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(o);return}f.current=y,f.current.onopen=function(k){console.log(`[AIPKit Stream Orchestrator (${e})] Connection opened.`,k)},f.current.addEventListener("message_start",k=>window.aipkit_chatUI_handleMessageStartEvent(k,t,_,o)),f.current.addEventListener("openai_response_id",k=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(k,t)),f.current.addEventListener("grounding_metadata",k=>window.aipkit_chatUI_handleGroundingMetadataEvent(k,_)),f.current.addEventListener("display_form_event",k=>window.aipkit_chatUI_handleDisplayFormEvent(k,e,t,o,_)),f.current.onmessage=k=>window.aipkit_chatUI_handleOnMessageEvent(k,e,t,o,_),f.current.addEventListener("done",k=>window.aipkit_chatUI_handleDoneEvent(k,e,t,o,a,f,_)),f.current.addEventListener("warning",k=>window.aipkit_chatUI_handleWarningEvent(k,e,t,o,_)),f.current.onerror=k=>window.aipkit_chatUI_handleErrorEvent(k,e,t,o,n,f,_)}window.aipkit_chatUI_streamMessage=d})();(function(){"use strict";async function d(i,e,t,o){i.preventDefault();let n=i.target;if(!n)return;let a=n.dataset.formId;if(!a){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let r=new FormData(n),c={};for(let[p,_]of r.entries())if(p.endsWith("[]")){let f=p.slice(0,-2);c[f]||(c[f]=[]),c[f].push(_)}else c[p]=_;console.log(`AIPKit Chat Form (${e.botId}): Form "${a}" submitted with data:`,c);let u=n.querySelector('button[type="submit"]');u&&(u.disabled=!0);let s=n.closest(".aipkit_chat_form_wrapper"),l={form_id:a,submitted_data:JSON.stringify(c)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let p=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",l,e);if(u&&(u.disabled=!1),p.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t.messagesEl,p.message_to_user,"bot",e,!1,!1,p.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):p.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(t.messagesEl,p.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),s){let _=s.closest(".aipkit_chat_message");_&&(_.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(t.messagesEl,!0))}}catch(p){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${a}":`,p),u&&(u.disabled=!1),typeof o.handleError=="function"?o.handleError(p.message||"Failed to submit form.",!1,!0):alert(p.message||"Failed to submit form.")}}window.aipkit_chatUI_handleChatFormSubmission=d})();(function(){"use strict";let d=!1,i=null,e=null;function t(){i&&(i.classList.remove("aipkit_active"),i=null,d=!1,e&&(document.removeEventListener("click",e),e=null))}window.aipkit_chatUI_closeActiveDownloadMenu=t,window.aipkit_chatUI_setActiveDownloadMenu=function(o,n,a){i=o,d=n,e=a},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:d,activeMenu:i,handler:e}}})();(function(){"use strict";function d(i,e){if(!i||!e)return;let{inputActionButton:t,inputActionMenu:o}=i;e.activeInputActionMenu&&e.activeInputActionTrigger&&(o&&(o.classList.remove("aipkit-action-menu-open"),o.setAttribute("aria-hidden","true"),setTimeout(()=>{o&&!o.classList.contains("aipkit-action-menu-open")&&(o.style.display="none")},200)),t&&(t.classList.remove("aipkit_active"),t.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=d})();(function(){"use strict";function d(i,e,t){let{inputActionButton:o,inputActionMenu:n,imageUploadInput:a,fileUploadInput:r}=i,{fileUploadEnabledUI:c,imageUploadEnabledUI:u}=e;if(!o){n&&(n.style.display="none");return}o.onclick=null;let s=window.aipkit_chatUI_closeActiveDownloadMenu,l=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof s!="function"||typeof l!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let p="dashicons-paperclip",_=e.text?.attachTools||"Attach or use tools",f="true";if(c&&!u)p="dashicons-media-document aipkit-icon-pdf",_=e.text?.uploadFile||"Upload File (TXT, PDF)",f="false";else if(!c&&u)p="dashicons-format-image aipkit-icon-image",_=e.text?.uploadImage||"Upload Image",f="false";else if(!c&&!u){o.style.display="none",n&&(n.style.display="none");return}let w=o.querySelector(".dashicons");w&&(w.className=`dashicons ${p}`),o.setAttribute("aria-label",_),f==="true"?(o.setAttribute("aria-haspopup","true"),o.setAttribute("aria-expanded","false")):(o.removeAttribute("aria-haspopup"),o.removeAttribute("aria-expanded")),c&&u?(n&&(n.style.display="none"),o.onclick=m=>{m.stopPropagation(),s(),!t.isActionMenuOpen?(n&&(n.style.display="flex",requestAnimationFrame(()=>{n&&n.classList.add("aipkit-action-menu-open")}),n.setAttribute("aria-hidden","false")),o.classList.add("aipkit_active"),o.setAttribute("aria-expanded","true"),t.isActionMenuOpen=!0,t.activeInputActionMenu=n,t.activeInputActionTrigger=o,setTimeout(()=>{t.closeActionMenuHandler=h=>{h.type==="click"&&(!t.activeInputActionMenu||!t.activeInputActionTrigger||t.activeInputActionMenu.contains(h.target)||t.activeInputActionTrigger.contains(h.target))||h.type==="keydown"&&h.key!=="Escape"||l(i,t)},document.addEventListener("click",t.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",t.closeActionMenuHandler,{capture:!0,once:!1})},0)):l(i,t)}):c?(n&&(n.style.display="none"),o.onclick=m=>{m.stopPropagation(),s(),r?r.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),alert("File upload feature not properly initialized."))}):u?(n&&(n.style.display="none"),o.onclick=m=>{m.stopPropagation(),s(),a?a.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),alert("Image upload feature not properly initialized."))}):(o.style.display="none",n&&(n.style.display="none"))}window.aipkit_chatUI_setupInputActionButton=d})();(function(){"use strict";function d(i,e,t,o){let{actionButton:n}=i;n&&n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",()=>{t.buttonState==="send"&&!n.disabled?o.sendMessageAction():t.buttonState==="clear"&&o.clearChatAction()}),n.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=d})();(function(){"use strict";function d(i,e,t,o){let{inputField:n,messagesEl:a,actionButton:r}=i;n&&n.dataset.listenerAttached!=="true"&&(n.addEventListener("keydown",c=>{c.key==="Enter"&&!t.isActionMenuOpen&&(c.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(n)},0):(c.preventDefault(),t.buttonState==="send"&&!r.disabled&&o.sendMessageAction()))}),n.addEventListener("input",()=>{let c=n.value.trim()==="",u=a.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;c?u&&t.buttonState!=="sending"&&t.buttonState!=="streaming"?t.buttonState=o.setButtonStateAction("clear",!1,t):t.buttonState!=="sending"&&t.buttonState!=="streaming"&&(t.buttonState=o.setButtonStateAction("send",!1,t)):t.buttonState=o.setButtonStateAction("send",!1,t),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(n)}),n.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=d})();(function(){"use strict";function d(i,e,t,o){let{fullscreenButton:n}=i;n&&typeof o.toggleFullscreenAction=="function"?n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",o.toggleFullscreenAction),n.dataset.listenerAttached="true"):n&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=d})();(function(){"use strict";function d(i,e,t,o){let{closeButton:n,container:a}=i;n?n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(i,t),t.isFullscreen?typeof o.toggleFullscreenAction=="function"?(o.toggleFullscreenAction(),e.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"&&!t.isPopupOpen&&setTimeout(()=>window.aipkit_chatUI_openPopup(a,i.messagesEl,i.inputField,t),50)):console.warn("AIPKit Chat Events: toggleFullscreen action missing for close button while in fullscreen."):e.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"&&window.aipkit_chatUI_closePopup(a,t)}),n.dataset.listenerAttached="true"):e.popupEnabled}window.aipkit_chatUI_attachCloseButtonListener=d})();(function(){"use strict";function d(i,e,t,o){let{webSearchToggleButton:n}=i,a=e.allowWebSearchTool&&e.provider==="OpenAI";n&&a?n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(i,t),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(i,e,t):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),n.dataset.listenerAttached="true"):n&&(n.style.display="none")}window.aipkit_chatUI_attachWebSearchToggleListener=d})();(function(){"use strict";function d(i,e,t,o){let{googleSearchGroundingToggleButton:n}=i,a=e.allowGoogleSearchGrounding&&e.provider==="Google";n&&a?n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(i,t),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(i,e,t):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),n.dataset.listenerAttached="true"):n&&(n.style.display="none")}window.aipkit_chatUI_attachGoogleGroundingToggleListener=d})();(function(){"use strict";function d(i,e,t,o){let{downloadButton:n}=i;if(n&&e.enableDownload){let a=n.closest(".aipkit_download_wrapper"),r=a?a.querySelector(".aipkit_download_menu"):null,c=e.pdfDownloadActive===!0;n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",u=>{if(u.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(i,t),c&&r){let s=window.aipkit_chatUI_getDownloadMenuState?window.aipkit_chatUI_getDownloadMenuState():{isOpen:!1,activeMenu:null};if(s.isOpen&&s.activeMenu===r)typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu();else if(typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),r.classList.add("aipkit_active"),typeof window.aipkit_chatUI_setActiveDownloadMenu=="function"){let l=p=>{a.contains(p.target)||typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()};window.aipkit_chatUI_setActiveDownloadMenu(r,!0,l),setTimeout(()=>{document.addEventListener("click",l,{once:!0})},0)}}else typeof o.downloadTranscriptTxtAction=="function"?o.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),n.dataset.listenerAttached="true"),r&&r.dataset.listenerAttached!=="true"&&(r.addEventListener("click",u=>{let s=u.target.closest(".aipkit_download_menu_item");if(s){let l=s.getAttribute("data-format");l==="txt"?typeof o.downloadTranscriptTxtAction=="function"?o.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):l==="pdf"&&(typeof o.downloadTranscriptPdfAction=="function"?o.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()}}),r.dataset.listenerAttached="true")}}window.aipkit_chatUI_attachDownloadMenuListeners=d})();(function(){"use strict";function d(i,e,t,o){let{inputActionMenu:n}=i;n&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&n.dataset.itemClickListenerAttached!=="true"&&(n.addEventListener("click",a=>{let r=a.target.closest(".aipkit_input_action_menu_item");if(!r)return;a.preventDefault();let c=r.getAttribute("aria-label");c&&c.toLowerCase().includes("image")?i.imageUploadInput?i.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),alert("Image upload feature not properly initialized.")):c&&(c.toLowerCase().includes("pdf")||c.toLowerCase().includes("file"))&&(i.fileUploadInput?i.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),alert("File upload feature not properly initialized."))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(i,t)}),n.dataset.itemClickListenerAttached="true")}window.aipkit_chatUI_attachInputActionMenuListener=d})();(function(){"use strict";function d(i,e,t,o){let{voiceInputButton:n}=i;n&&e.enableVoiceInputUI&&n.dataset.listenerAttached!=="true"&&(n.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(i,e,t,t.consentUIInstance,o):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),alert("Voice input unavailable (script error)."))}),n.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=d})();(function(){"use strict";function d(i,e,t,o){let{fileUploadInput:n}=i;n&&e.fileUploadEnabledUI&&n.dataset.listenerAttached!=="true"&&(n.addEventListener("change",async a=>{let r=a.target.files[0];if(r&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let c=i.inputArea||n.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(r,n,c,e)}else r&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",i.inputArea))}),n.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=d})();(function(){"use strict";function d(i,e,t,o){let{messagesEl:n}=i;n&&typeof o.handlePlayAction=="function"?n.dataset.playListenerAttached!=="true"&&(n.addEventListener("click",function(a){let r=a.target.closest(".aipkit_play_btn");r&&!r.disabled&&o.handlePlayAction(r)}),n.dataset.playListenerAttached="true"):n&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=d})();(function(){"use strict";function d(i,e,t,o){typeof t.isActionMenuOpen>"u"&&(t.isActionMenuOpen=!1,t.activeInputActionMenu=null,t.activeInputActionTrigger=null,t.closeActionMenuHandler=null);let n=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachCloseButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],a=!0;if(n.forEach(r=>{typeof window[r]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${r}.`),a=!1)}),!a){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(i,e,t,o),window.aipkit_chatUI_attachInputFieldListeners(i,e,t,o),window.aipkit_chatUI_attachFullscreenButtonListener(i,e,t,o),window.aipkit_chatUI_attachCloseButtonListener(i,e,t,o),window.aipkit_chatUI_attachWebSearchToggleListener(i,e,t,o),window.aipkit_chatUI_attachGoogleGroundingToggleListener(i,e,t,o),window.aipkit_chatUI_attachDownloadMenuListeners(i,e,t,o),window.aipkit_chatUI_attachInputActionMenuListener(i,e,t,o),window.aipkit_chatUI_attachVoiceInputButtonListener(i,e,t,o),window.aipkit_chatUI_attachFileUploadInputListener(i,e,t,o),window.aipkit_chatUI_attachPlayButtonListener(i,e,t,o),console.log(`AIPKit Chat Events Orchestrator (${e.botId}): All event listeners attached.`)}window.aipkit_chatUI_attachEventListeners=d})();(function(){"use strict";function d(i,e,t,o,n,a,r,c,u,s,l,p){console.log("AIPKit Chat AJAX (sender): Received activeFileContext:",JSON.stringify(l));let{messagesEl:_}=o,f=t.text||{};if(!t.ajaxUrl||!e||!t.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof a=="function"&&a(f.errorPrefix+" "+(f.connError||"Configuration error (API)."),!1),typeof r=="function"&&r();return}let w={message:i};c&&t.provider==="OpenAI"&&t.allowWebSearchTool&&(w.frontend_web_search_active=!0),u&&t.provider==="Google"&&t.allowGoogleSearchGrounding&&(w.frontend_google_search_grounding_active=!0),s&&(w.image_inputs=JSON.stringify([s]),console.log("AIPKit Chat AJAX: Sending image_inputs to backend."));let m={...t};if(l&&(m.activeFileContext=l,l.provider==="OpenAI"&&l.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${l.vector_store_id}`):l.provider==="Pinecone"&&l.index_name&&l.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${l.index_name}, Namespace: ${l.namespace}`):l.provider==="Qdrant"&&l.collection_name&&l.file_upload_context_id&&console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${l.collection_name}, Context ID: ${l.file_upload_context_id}`)),window.aipkit_chatUI_showTypingIndicator(_,t),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof a=="function"&&a("Internal script error.",!1),typeof r=="function"&&r();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",w,m).then(g=>{if(window.aipkit_chatUI_removeTypingIndicator(_),g?.reply)t.provider==="OpenAI"&&t.enableOpenAIConversationState&&g.openai_response_id&&(window.aipkit_current_openai_response_id=g.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",g.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${g.openai_response_id}`)),typeof n=="function"&&(n(g.reply,g.message_id||null,g.openai_response_id||null,g.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(_,!0));else{let h=g?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,h,g),typeof a=="function"&&a(`${f.errorPrefix||"Error:"} ${h}`,!1)}}).catch(g=>{window.aipkit_chatUI_removeTypingIndicator(_);let h=`${f.errorPrefix||"Error:"} ${f.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,g),typeof a=="function"&&a(h+(g.message?` (${g.message})`:""),!0)}).finally(()=>{typeof r=="function"&&r()})}window.aipkit_chatUI_sendMessage=d})();(function(){"use strict";function d(i,e,t){let{container:o,fullscreenButton:n,messagesEl:a,inputField:r}=i,c=t.text||{};if(!o||!n){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}if(e.isFullscreen=!e.isFullscreen,e.isFullscreen){if(!e.fullscreenPlaceholder){let l=document.createElement("div");l.id=`aipkit_fs_placeholder_${o.id}`,l.style.display="none",o.parentNode.insertBefore(l,o),e.fullscreenPlaceholder=l}document.body.appendChild(o),o.classList.add("aipkit-fullscreen")}else o.classList.remove("aipkit-fullscreen"),e.fullscreenPlaceholder&&e.fullscreenPlaceholder.parentNode?(e.fullscreenPlaceholder.parentNode.insertBefore(o,e.fullscreenPlaceholder),e.fullscreenPlaceholder.remove(),e.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position.");let u=o.closest(".aipkit_popup_wrapper");u&&u.classList.toggle("aipkit-fullscreen-wrapper",e.isFullscreen);let s=n.querySelector(".dashicons");s&&(s.className=e.isFullscreen?"dashicons dashicons-editor-contract":"dashicons dashicons-editor-expand"),n.title=e.isFullscreen?c.exitFullscreen||"Exit Fullscreen":c.fullscreen||"Fullscreen",n.setAttribute("aria-label",n.title),n.setAttribute("aria-expanded",e.isFullscreen.toString()),e.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),r&&setTimeout(()=>r.focus(),50),console.log("AIPKit Chat: Fullscreen toggled:",e.isFullscreen)}window.aipkit_chatUI_toggleFullscreen=d})();(function(){"use strict";function d(i,e,t,o,n){let{state:a,elements:r,config:c,setButtonStateAction:u,handleError:s,generateClientMessageId:l,focusInputAction:p}=n,{inputField:_,voiceInputButton:f,messagesEl:w,container:m}=r;a.isSending=!0,_.disabled=!0,f&&(f.disabled=!0),u("sending",!0,a);let g=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?g=window.aipkit_chatUI_showImageLoadingIndicator(w,c):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(w,c));let h={prompt:i,original_user_text:e,user_message_id:t};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),s("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(w,g),a.isSending=!1,_.disabled=c.requireConsentCompliance&&!a.consentGiven,f&&(f.disabled=c.requireConsentCompliance&&!a.consentGiven),u("send",!1,a),(!c.requireConsentCompliance||a.consentGiven)&&p();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",h,c).then(I=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,g):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),I?.type==="image"&&I.images&&I.images.length>0){let b={type:"image",images:I.images,prompt:i};window.aipkit_chatUI_appendMessage(w,b,"bot",c,!1,!1,I.message_id,!0),m?m.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:I.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:o}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let b=I?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${b}`,I),s(`Image generation failed: ${b}`,!1,!0)}}).catch(I=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,g):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),s("Image generation failed: "+(I.message||"Unknown error"),!1,!0)}).finally(()=>{a.isSending=!1,_.disabled=c.requireConsentCompliance&&!a.consentGiven,f&&(f.disabled=c.requireConsentCompliance&&!a.consentGiven),u("send",!1,a),(!c.requireConsentCompliance||a.consentGiven)&&p()})}window.aipkit_chatUI_handleImageGeneration=d})();(function(){"use strict";function d(i,e,t,o){let n=i.toLowerCase(),a=t&&t.ipsList?t.ipsList.split(",").map(c=>c.trim()).filter(c=>c!==""):[];if(e&&a.length>0&&a.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:t.message||"Access from your IP address has been blocked."};let r=o&&o.wordsList?o.wordsList.toLowerCase().split(",").map(c=>c.trim()).filter(c=>c!==""):[];if(r.length>0){let c=r.find(u=>n.includes(u));if(c)return console.warn(`AIPKit Moderation: Banned word detected: "${c}"`),{type:"banned_word",message:o.message||"Sorry, your message could not be sent as it contains prohibited words.",word:c}}return null}window.aipkit_checkMessageModeration=d})();(function(){"use strict";function d(o){return o?o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function i(o){o&&o.classList.add("aipkit_hidden")}function e(o){o&&o.classList.remove("aipkit_hidden")}function t(o,n,a,r,c,u){let{startersContainer:s,messagesEl:l,inputField:p}=a,_=n.botId,f=n.starters||[];if(!o||!n||!s||!l||!p){console.error(`AIPKit Starters (${_}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof r!="function"){console.error(`AIPKit Starters (${_}): sendMessageActionCallback is not a function.`),i(s);return}if(typeof u!="function"){console.error(`AIPKit Starters (${_}): isConsentGivenFunc is not a function.`),i(s);return}if(f.length===0){console.log(`AIPKit Starters (${_}): No starter prompts configured or found.`),i(s);return}s.innerHTML="",f.forEach(g=>{if(typeof g=="string"&&g.trim()!==""){let h=document.createElement("button");h.type="button",h.className="aipkit_starter_btn",h.textContent=g.trim(),h.addEventListener("click",I=>{if(I.preventDefault(),c&&!u()){console.warn(`AIPKit Starters (${_}): Starter clicked, but consent not given.`);return}let b=h.textContent;console.log(`AIPKit Starters (${_}): Starter clicked: "${b}"`),r(b),i(s)}),s.appendChild(h)}});let w=()=>{if(c&&!u()){i(s),console.log(`AIPKit Starters (${_}): Hiding starters because consent is required but not given.`);return}d(l)?e(s):i(s)},m=()=>i(s);o.addEventListener("aipkit:messageSent",m),o.addEventListener("aipkit:messageReceived",m),o.addEventListener("aipkit:messageError",m),o.addEventListener("aipkit:chatCleared",w),o.addEventListener("aipkit:chatLoaded",w),o.addEventListener("aipkit:consentGiven",()=>{console.log(`AIPKit Starters (${_}): Received consentGiven event. Checking visibility.`),w()}),w(),console.log(`AIPKit Starters (${_}): Initialized with ${f.length} starters. Consent Required: ${c}`)}window.aipkit_initConversationStarters=t})();function M(d,i){let e=window.aipkit_chatUI_findElements(d,i);if(!e){let a=d.querySelector(".aipkit_chat_container")||d;return a&&(a.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot UI error (DOM elements missing).</p>'),null}let t=i.botId,o=window.aipkit_chatUI_initState(i);o.consentUIInstance=null,i.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?o.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,i,o,()=>{e.inputField.disabled=!1,n.setButtonStateAction("send",!1),n.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):i.requireConsentCompliance&&console.error(`AIPKit Chat Main (${t}): Consent required, but aipkit_initConsentUI function not found.`);let n={setButtonStateAction:(a,r=!1)=>window.aipkit_chatUI_setButtonStateAction(a,e,i,o,r),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,i,o),sendMessageAction:(a=null)=>window.aipkit_chatUI_sendMessageAction(e,i,o,n,a),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,i,o,n),handleError:(a,r,c=!0)=>window.aipkit_chatUI_handleError(a,r,c,e,i,o,n),handleCompletion:(a,r=!1)=>window.aipkit_chatUI_handleCompletion(a,r,e,i,o,n),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,o,i),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,i),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,i),handlePlayAction:a=>window.aipkit_handlePlayAction(a)};if(i.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${t}): Image Upload UI enabled, but dynamic input or preview elements missing.`):i.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${t}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,i,o):(console.error(`AIPKit Chat Main (${t}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.style.display="none"),e.inputActionMenu&&(e.inputActionMenu.style.display="none")),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,i,o,n):console.error(`AIPKit Chat Main (${t}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,i):console.warn(`AIPKit Chat Main (${t}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),i.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let a=o.consentUIInstance?o.consentUIInstance.isConsentGiven:()=>!i.requireConsentCompliance||o.consentGiven;window.aipkit_initConversationStarters(d,i,e,n.sendMessageAction,i.requireConsentCompliance,a)}else i.enableStarters&&console.warn(`AIPKit Chat Main (${t}): Starters enabled but container or init function missing.`);return i.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(d,e,i,n):i.enableSidebar&&console.warn(`AIPKit Chat Main (${t}): Sidebar enabled but elements or init function missing.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,i):console.error(`AIPKit Chat Main (${t}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,i,o,n):console.error(`AIPKit Chat Main (${t}): finalizeSetup function not found.`),{publicApi:{openPopup:i.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(d,e.messagesEl,e.inputField,o):()=>{},closePopup:i.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(d,o):()=>{},setupPopupHandlers:i.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?(a,r)=>window.aipkit_chatUI_setupPopupHandlers(d,a,r,e.messagesEl,e.inputField,o):()=>{},isPopupOpen:()=>o.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:n.sendMessageAction,clearChat:n.clearChatAction,toggleFullscreen:n.toggleFullscreenAction},internalElements:e,internalActions:n}}window.aipkit_setupChatInstanceUI=M;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let d=localStorage.getItem("aipkit_guest_uuid");d?console.log("AIPKit Chat Init: Using existing guest UUID:",d):(d=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",d),console.log("AIPKit Chat Init: Generated new guest UUID:",d)),window.aipkit_guest_uuid=d,window.aipkit_regenerateConversationUUID=function(){let t=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,o=>(o^crypto.getRandomValues(new Uint8Array(1))[0]&15>>o/4).toString(16));return console.log("AIPKit Chat Init: Regenerated conversation UUID:",t),sessionStorage.setItem("aipkit_current_conversation_uuid",t),window.aipkit_current_conversation_uuid=t,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),console.log("AIPKit Chat Init: OpenAI response ID reset for new chat."),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),console.log("AIPKit Chat Init (regenerateUUID): Active file context (window/session) reset for new chat."),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),t},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(t){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(n){return typeof n!="string"?"":n.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,"&quot;").replace(/'/g,"'")})(t).replace(/\n/g,"<br>")}});function i(t){if(!t||t.classList.contains("aipkit-initializing")||t.classList.contains("aipkit-initialized"))return;t.classList.add("aipkit-initializing");let o=t.getAttribute("data-bot-id"),n=t.getAttribute("data-config"),a=null;try{n&&(a=JSON.parse(n),o&&(a.botId=o))}catch(s){console.error(`AIPKit Chat Init (${o||"Unknown"}): Failed to parse configuration.`,s,n);let l=t.querySelector(".aipkit_chat_container")||t;l.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',t.classList.remove("aipkit-initializing");return}if(!a){console.error(`AIPKit Chat Init (${o||"Unknown"}): Config object is null after parse attempt.`,t);let s=t.querySelector(".aipkit_chat_container")||t;s.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot config load error.</p>',t.classList.remove("aipkit-initializing");return}if(!a.botId&&o&&(a.botId=o),window.aipkit_current_post_id=a.postId||0,a.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): Sidebar enabled. Resetting CURRENT conversation & file context state for this instance.`);else{let s=sessionStorage.getItem("aipkit_current_conversation_uuid"),l=sessionStorage.getItem("aipkit_current_openai_response_id");if(s){window.aipkit_current_conversation_uuid=s,window.aipkit_is_fresh_session=!1,console.log(`AIPKit Chat Init (${a.botId}): Sidebar disabled. Loaded conversation UUID from session: ${s}`),window.aipkit_current_openai_response_id=l||null,window.aipkit_current_openai_response_id&&console.log(`AIPKit Chat Init (${a.botId}): Loaded OpenAI Response ID from session: ${window.aipkit_current_openai_response_id}`);try{let p=localStorage.getItem(`aipkit_file_context_${s}`);if(p){let _=JSON.parse(p),f=!1;_&&_.provider&&(_.provider==="OpenAI"&&_.vector_store_id||_.provider==="Pinecone"&&_.index_name&&_.namespace||_.provider==="Qdrant"&&_.collection_name&&_.file_upload_context_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:_})),console.log(`AIPKit Chat Init (${a.botId}): Loaded file context for conv ${s} from localStorage:`,_)):(console.warn(`AIPKit Chat Init (${a.botId}): Invalid file context data in localStorage for conv ${s}. Clearing.`),localStorage.removeItem(`aipkit_file_context_${s}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): No file context in localStorage for conv ${s}.`)}catch(p){console.error("AIPKit Chat Init: Error loading file context from localStorage:",p),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): Sidebar disabled. No conversation UUID in session. Starting fresh, file context reset.`)}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${a.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let s=t.querySelector(".aipkit_chat_container")||t;s.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot script error.</p>',t.classList.remove("aipkit-initializing");return}let r=t.classList.contains("aipkit_chat_container")?t:t.querySelector(".aipkit_chat_container");if(!r){console.error(`AIPKit Chat Init (${a.botId}): Chat container element not found within wrapper.`,t),t.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot structure error.</p>',t.classList.remove("aipkit-initializing");return}if(a.guestUUID=window.aipkit_guest_uuid,a.conversationUUID=window.aipkit_current_conversation_uuid,a.previousOpenAIResponseId=window.aipkit_current_openai_response_id,a.activeFileContextProvider=window.aipkit_active_file_context_provider,a.activeFileContextData=window.aipkit_active_file_context_data,!a.botId||!a.ajaxUrl||!a.text||!a.guestUUID){console.error(`AIPKit Chat Init (${a.botId||"Unknown"}): Missing essential configuration.`,a,t);let s=t.querySelector(".aipkit_chat_container")||t;s.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',t.classList.remove("aipkit-initializing");return}typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&a.theme==="custom"&&a.customThemeSettings&&Object.keys(a.customThemeSettings).length>0?window.aipkit_chatUI_applyCustomThemeStyles(r,a.customThemeSettings):a.theme==="custom"&&console.warn(`AIPKit Chat Init (${a.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let c=aipkit_setupChatInstanceUI(r,a);if(!c||!c.publicApi||!c.internalElements||!c.internalActions){console.error(`AIPKit Chat Init (${a.botId}): Failed to set up UI instance or get all necessary parts.`),t.classList.remove("aipkit-initializing");return}let u=c.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[r.id]={instance:u,elements:c.internalElements,actions:c.internalActions},a.popupEnabled){let s=t.querySelector(".aipkit_popup_trigger"),l=r.querySelector(".aipkit_chat_header"),p=l?l.querySelector(".aipkit_close_btn"):null;if(!s){console.error(`AIPKit Chat Init (${a.botId}): Popup trigger button not found.`),t.classList.remove("aipkit-initializing");return}if(u.setupPopupHandlers){u.setupPopupHandlers(s,p);let _=a.popupDelay;_>0&&!t.dataset.aipkitAutoOpened&&(t.dataset.aipkitAutoOpened="true",setTimeout(()=>{u&&u.isPopupOpen&&!u.isPopupOpen()?(console.log(`AIPKit Chat Init (${o}): Auto-opening popup after ${_}s.`),u.openPopup()):console.log(`AIPKit Chat Init (${o}): Popup already open or instance unavailable, skipping auto-open.`)},_*1e3))}else console.error(`AIPKit Chat Init (${a.botId}): setupPopupHandlers method missing in UI instance.`)}t.classList.remove("aipkit-initializing"),t.classList.add("aipkit-initialized"),console.log(`AIPKit Chat Init (${a.botId}): Initialized successfully. Sidebar: ${a.enableSidebar}, PostID: ${window.aipkit_current_post_id}, Fresh Session: ${window.aipkit_is_fresh_session}, ConvID: ${window.aipkit_current_conversation_uuid||"None"}, OpenAIRespID: ${window.aipkit_current_openai_response_id||"None"}. File Context Provider: ${window.aipkit_active_file_context_provider||"None"}`)}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(n=>{n.closest(".aipkit_popup_wrapper")||i(n)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(i)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let t=new MutationObserver(o=>{let n=!1;o.forEach(a=>{a.addedNodes&&a.addedNodes.forEach(r=>{r.nodeType===1&&(r.matches&&(r.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||r.matches(".aipkit_popup_wrapper"))||r.querySelector&&r.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper"))&&(n=!0)})}),n&&(clearTimeout(t.scanTimeout),t.scanTimeout=setTimeout(e,50))});t.observe(document.body,{childList:!0,subtree:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=i})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function d(i,e,t){let o=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:u=>u,n=new FormData;n.append("action","aipkit_cache_sse_message"),n.append("_ajax_nonce",t);let a={stream_context:"ai_forms",form_id:i,user_input_values:e};n.append("message",JSON.stringify(a));let r=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:n,credentials:"same-origin"});if(!r.ok){let u=await r.json().catch(()=>({}));throw new Error(u?.data?.message||`HTTP error ${r.status}`)}let c=await r.json();if(c.success&&c.data?.cache_key)return c.data.cache_key;throw new Error(c.data?.message||o("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=d})();(function(){"use strict";function d(i,e){let t=window.aipkitAIFormsPublicState,o=i?i.closest(".aipkit-ai-form-wrapper"):null,n=i?i.querySelector(".aipkit_btn-text"):null,a=i?i.querySelector(".aipkit_spinner"):null,r=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:l=>l,c=null,u=()=>{i&&(i.disabled=!1,i.classList.remove("aipkit_btn-danger"),i.classList.add("aipkit_btn-primary"),n&&(n.textContent=e),c&&(i.removeEventListener("click",c),c=null)),a&&(a.style.display="none")};return{restoreGenerateButton:u,setupStopButton:()=>{i&&(i.disabled=!1,i.classList.remove("aipkit_btn-primary"),i.classList.add("aipkit_btn-danger"),n&&(n.textContent=o.dataset.labelStopButton||r("Stop","gpt3-ai-content-generator")),c=l=>{l.preventDefault(),l.stopPropagation(),t.currentAIFormEventSource&&(t.currentAIFormEventSource.close(),t.currentAIFormEventSource=null),u()},i.addEventListener("click",c,{once:!0}))}}}window.aipkitForms_createSseUiManager=d})();(function(){"use strict";function d(i){let e=i.elements,t=!1,o=null,n={};for(let a of e){if(a.type!=="checkbox"&&a.type!=="radio"&&a.type!=="submit"&&a.type!=="button")a.style.borderColor="";else{let s=a.closest("fieldset");if(s){let l=s.querySelector("legend");l&&(l.style.color="")}else{let l=a.closest("label");l&&(l.style.color="")}}let r=a.name.match(/aipkit_form_field\[(.*?)\]/);if(!r||!r[1])continue;let c=r[1];a.type==="checkbox"?n[c]=a.checked?"1":"0":a.type==="radio"?a.checked&&(n[c]=a.value):n[c]=a.value;let u=!1;if(a.required)if(a.type==="checkbox")u=!a.checked;else if(a.type==="radio"){let s=i.querySelectorAll(`input[type="radio"][name="${a.name}"]`);Array.from(s).some(l=>l.checked)||(u=!0)}else(a.classList.contains("aipkit-file-hidden-content")||a.type!=="file"&&a.type!=="submit"&&a.type!=="button")&&(u=a.value.trim()==="");u&&(t=!0,o||(a.classList.contains("aipkit-file-hidden-content")?o=i.querySelector(`.aipkit-file-upload-input[data-field-id="${c}"]`):a.type==="radio"?o=a.closest("fieldset"):o=a))}return{isValid:!t,userInputs:n,firstInvalidField:o}}window.aipkitForms_validateSseInputs=d})();(function(){"use strict";let d=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function i(e,t){let o=window.aipkitAIFormsPublicState,n="",a=!0,r='<div class="aipkit-ai-form-results-top-actions"></div>',c='<div class="aipkit-ai-form-results-footer-actions"></div>',u=_=>`<div class="aipkit-ai-form-results-content">${_}</div>`;return{onMessageHandler:_=>{a&&(e.style.display="block",e.innerHTML=r+u("")+c,a=!1);let f=JSON.parse(_.data),w=e.querySelector(".aipkit-ai-form-results-content");f.delta&&w&&(n+=f.delta,o.mdInstanceAIForms?w.innerHTML=o.mdInstanceAIForms.render(n):w.innerHTML=n.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:_=>{o.currentAIFormEventSource&&(o.currentAIFormEventSource.close(),o.currentAIFormEventSource=null),t();let f=e.querySelector(".aipkit-ai-form-results-content");o.mdInstanceAIForms&&f?f.innerHTML=o.mdInstanceAIForms.render(n):f&&(f.innerHTML=n.replace(/\n/g,"<br />"));let w=e.querySelector(".aipkit-ai-form-results-top-actions"),m=e.querySelector(".aipkit-ai-form-results-footer-actions");if(n.trim()!==""&&w&&m){let g=e.closest(".aipkit-ai-form-wrapper"),h=g.dataset.showSaveButton==="true",I=g.dataset.pdfDownloadEnabled==="true",b=g.dataset.showCopyButton==="true",y=window.aipkit_ai_forms_public_config||{},k=y.is_user_logged_in,S=document.createElement("button");if(S.type="button",S.className="aipkit-copy-results-btn",S.title=d("Copy Results","gpt3-ai-content-generator"),S.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&S.addEventListener("click",window.aipkitForms_handleCopyAction),w.appendChild(S),S.style.display="inline-flex",h&&k){let A=g.dataset.labelSaveButton||y.text?.saveAsPost||d("Save","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&v.addEventListener("click",window.aipkitForms_handleSaveAsPost),m.appendChild(v),v.style.display="inline-flex"}if(I&&typeof window.aipkitForms_handleDownloadPdf=="function"){let A=g.dataset.labelDownloadButton||d("Download","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span>`,v.addEventListener("click",window.aipkitForms_handleDownloadPdf),m.appendChild(v),v.style.display="inline-flex"}if(b){let A=g.dataset.labelCopyButton||d("Copy","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&v.addEventListener("click",window.aipkitForms_handleCopyAction),m.appendChild(v),v.style.display="inline-flex"}}},onErrorHandler:_=>{if(o.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",_);let f=d(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(_.data)try{let w=JSON.parse(_.data);w.error&&(f=w.error)}catch{}e.style.display="block",e.innerHTML=`<p style="color:red;">${f}</p>`,o.currentAIFormEventSource&&(o.currentAIFormEventSource.close(),o.currentAIFormEventSource=null),t()}}}window.aipkitForms_createSseEventHandlers=i})();(function(){"use strict";async function d(i,e,t,o,n){let a=window.aipkitAIFormsPublicState,r=await window.aipkit_cacheAIFormMessage(i,e,t),c=new URL(aipkit_ai_forms_public_config.ajaxUrl);c.searchParams.append("action","aipkit_frontend_chat_stream"),c.searchParams.append("cache_key",r),c.searchParams.append("_ajax_nonce",t),window.aipkit_guest_uuid&&c.searchParams.append("session_id",window.aipkit_guest_uuid),a.currentAIFormEventSource=new EventSource(c.toString());let{onMessageHandler:u,onDoneHandler:s,onErrorHandler:l}=window.aipkitForms_createSseEventHandlers(o,n);a.currentAIFormEventSource.onmessage=u,a.currentAIFormEventSource.addEventListener("done",s),a.currentAIFormEventSource.onerror=l}window.aipkitForms_setupAndStartEventSource=d})();(function(){"use strict";function d(t,o,n="info"){if(!t)return;let a=window.aipkit_escapeHtml||function(r){return r};t.innerHTML=a(o),t.className=`aipkit-file-upload-status aipkit-status-${n}`}function i(t){if(!t)return;let o=t.querySelector(".aipkit-file-upload-input"),n=t.querySelector(".aipkit-file-upload-status"),a=t.querySelector(".aipkit-file-remove-btn"),r=t.querySelector(".aipkit-file-hidden-content"),c=t.querySelector(".aipkit-file-status-wrapper");o&&(o.value="",o.style.display="block"),n&&(n.innerHTML="",n.className="aipkit-file-upload-status"),a&&(a.style.display="none"),c&&(c.style.display="none"),r&&(r.value="",r.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(t){let o=t.target,n=o.closest(".aipkit_form-group-file-upload");if(!n)return;let a=o.files[0],r=n.querySelector(".aipkit-file-status-wrapper"),c=n.querySelector(".aipkit-file-upload-status"),u=n.querySelector(".aipkit-file-remove-btn"),s=n.querySelector(".aipkit-file-hidden-content"),l=o.closest("form").querySelector('button[type="submit"]'),p=n.dataset.nonce,_=window.aipkit_ai_forms_public_config.ajaxUrl,f=window.wp?.i18n?.__||(h=>h),w=window.aipkit_escapeHtml||function(h){return h};if(!a){i(n);return}if(!["text/plain","application/pdf"].includes(a.type)){d(c,f("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),i(n);return}if(a.size>2*1024*1024){d(c,f("File is too large (max 2MB).","gpt3-ai-content-generator"),"error"),i(n);return}d(c,f("Uploading & processing...","gpt3-ai-content-generator"),"info"),r&&(r.style.display="flex"),l&&(l.disabled=!0);let g=new FormData;g.append("action","aipkit_ai_form_upload_and_parse_file"),g.append("_ajax_nonce",p),g.append("file",a);try{let h=await fetch(_,{method:"POST",body:g,credentials:"same-origin"}),I=await h.json();if(!h.ok||!I.success)throw new Error(I.data?.message||f("Failed to process file.","gpt3-ai-content-generator"));if(typeof I.data.text=="string")s.value=I.data.text,s.dispatchEvent(new Event("change",{bubbles:!0})),d(c,`\u2705 ${w(a.name)}`,"success"),o.style.display="none",u&&(u.style.display="inline-flex"),r&&(r.style.display="flex"),l&&(l.disabled=!1);else throw new Error(f("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(h){d(c,h.message,"error"),i(n),l&&(l.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=i})();(function(){"use strict";function d(t){let o=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',t.disabled=!0,setTimeout(()=>{t.innerHTML=o,t.disabled=!1},1500)}function i(t){let o=t.currentTarget,n=o.closest(".aipkit-ai-form-results");if(!n)return;let a=n.cloneNode(!0),r=a.querySelector(".aipkit-copy-results-btn");r&&r.remove();let c=a.innerText||a.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(c).then(()=>{d(o)}).catch(u=>{console.error("Failed to copy text using Clipboard API: ",u),e(c,o)}):e(c,o)}function e(t,o){let n=document.createElement("textarea");n.value=t,n.style.position="fixed",n.style.top="-9999px",n.style.left="-9999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),d(o)}catch(a){console.error("Fallback copy failed: ",a),alert("Failed to copy content.")}document.body.removeChild(n)}window.aipkitForms_handleCopyAction=i})();(function(){"use strict";async function d(i){let e=i.currentTarget,t=e.closest(".aipkit-ai-form-wrapper");if(!t)return;let o=t.querySelector(".aipkit-ai-form-results"),n=t.querySelector("h5.aipkit-ai-form-title"),a=t.dataset.saveAsPostNonce,r=o?o.querySelector(".aipkit-ai-form-results-content"):null;if(!r||!n){console.error("AI Forms Save: Missing results content container or title element.");return}let c=window.aipkit_ai_forms_public_config||{},u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:f=>f,s=n.textContent.trim(),l=r.innerHTML,p=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let _={action:"aipkit_ai_form_save_as_post",_ajax_nonce:a,post_title:s,post_content:l};try{let f=new FormData;for(let h in _)f.append(h,_[h]);let w=await fetch(c.ajaxUrl,{method:"POST",body:f,credentials:"same-origin"}),m=await w.json();if(!w.ok||!m.success)throw new Error(m.data?.message||u("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let g=null;m.data.edit_link&&(g=document.createElement("a"),g.href=m.data.edit_link,g.innerHTML='<span class="dashicons dashicons-external"></span>',g.title=u("Edit Post","gpt3-ai-content-generator"),g.target="_blank",g.rel="noopener noreferrer",g.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),g.style.marginLeft="10px",e.parentNode.insertBefore(g,e.nextSibling)),setTimeout(()=>{e.innerHTML=p,e.disabled=!1,g&&g.parentNode&&g.remove()},5e3)}catch(f){console.error("Failed to save post:",f),alert(`${u("Error saving post:","gpt3-ai-content-generator")} ${f.message}`),e.innerHTML=p,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=d})();(function(){"use strict";async function d(i){i.preventDefault(),i.stopPropagation();let e=window.aipkitAIFormsPublicState,t=i.target,o=t.closest(".aipkit-ai-form-wrapper");if(!o)return;let n=o.dataset.formId,a=aipkit_ai_forms_public_config.ajaxNonce,r=o.querySelector(".aipkit-ai-form-results"),c=t.querySelector('button[type="submit"]'),u=c?c.querySelector(".aipkit_spinner"):null,s=c?c.querySelector(".aipkit_btn-text"):null,l=o.dataset.labelGenerateButton||"Generate",p=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:m=>m;if(!n||!a||!r||!c){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),r&&(r.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:_,setupStopButton:f}=window.aipkitForms_createSseUiManager(c,l);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),r.innerHTML="",r.style.display="none",c&&(c.disabled=!0),u&&(u.style.display="inline-block");let w=window.aipkitForms_validateSseInputs(t);if(!w.isValid){if(w.firstInvalidField)if(w.firstInvalidField.type!=="checkbox")w.firstInvalidField.style.borderColor="red";else{let m=w.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");m&&(m.style.color="red")}r.style.display="block",r.innerHTML=`<p style="color:orange;">${p("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,c&&(c.disabled=!1),u&&(u.style.display="none");return}f();try{await window.aipkitForms_setupAndStartEventSource(n,w.userInputs,a,r,_)}catch(m){console.error("AI Form Submission Error (SSE Setup):",m),r.innerHTML=`<p style="color:red;">${m.message||p(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,_()}}window.aipkit_handleFormSubmitSSE=d})();(function(){"use strict";function d(t,o){let n=window.aipkit_ai_forms_models||{},a=window.aipkit_ai_forms_public_config||{},r=t.toLowerCase(),c=n[r]||[],u=o.dataset.currentValue||"";if(a.allowed_models&&a.allowed_models.trim()!==""){let l=new Set(a.allowed_models.split(",").map(p=>p.trim()));if(Array.isArray(c))c=c.filter(p=>l.has(p.id));else{let p={};for(let _ in c){let f=c[_].filter(w=>l.has(w.id));f.length>0&&(p[_]=f)}c=p}}if(o.innerHTML="",!c||Array.isArray(c)&&c.length===0||!Array.isArray(c)&&Object.keys(c).length===0){let l=new Option("No models available for this provider.","");o.appendChild(l);return}let s=!1;if(Array.isArray(c))c.forEach(l=>{let p=new Option(l.name,l.id);l.id===u&&(p.selected=!0,s=!0),o.appendChild(p)});else{let l=["GPT-4o","GPT-4 Turbo","GPT-4","GPT-3.5","Fine-tuned","Other"],p=Object.keys(c);l.filter(f=>p.includes(f)).concat(p.filter(f=>!l.includes(f)).sort()).forEach(f=>{let w=document.createElement("optgroup");w.label=f,c[f].forEach(m=>{let g=new Option(m.name,m.id);m.id===u&&(g.selected=!0,s=!0),w.appendChild(g)}),o.appendChild(w)})}if(!s&&u){let l=new Option(`${u} (Manual)`,u,!1,!0);o.insertBefore(l,o.firstChild)}if(o.selectedIndex===-1&&o.options.length>0){let l=o.querySelector("optgroup");l&&l.options.length>0?o.value=l.options[0].value:o.options[0].value&&(o.selectedIndex=0)}}function i(t){let o=t.querySelector(".aipkit_aiform_provider_select"),n=t.querySelector(".aipkit_aiform_model_select");if(n)if(o)d(o.value,n),o.addEventListener("change",function(){d(this.value,n)});else{let a=n.dataset.provider;a?d(a,n):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let t=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(n=>{i(n);let a=n.querySelector("form.aipkit-ai-form-main");a&&!a.dataset.sseInitialized&&(a.addEventListener("submit",window.aipkit_handleFormSubmitSSE),a.dataset.sseInitialized="true"),a&&!a.dataset.fileUploadInitialized&&(a.addEventListener("change",r=>{r.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(r)}),a.addEventListener("click",r=>{if(r.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let c=r.target.closest(".aipkit_form-group-file-upload");c&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(c)}}),a.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?t.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),t.mdInstanceAIForms={render:function(n){return(window.aipkit_escapeHtml||function(r){return r})(n).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function d(i,e,t){let o=i.querySelector(`#${e}`);if(o&&o.offsetParent!==null)return o.value;{let n=i.querySelector(`input[type="hidden"][name="${t}"]`);return n?n.value:null}}window.aipkit_getSettingValue=d})();(function(){"use strict";function d(i,e,t){if(!e)return;e.innerHTML="";let o=[],n=window.aipkit_image_generator_config_public||{},a=i.toLowerCase(),r=t?new Set(t.split(",").map(c=>c.trim())):null;if(a==="openai"&&n.openai_models?o=n.openai_models||[]:a==="google"&&n.google_models?o=n.google_models||[]:a==="replicate"&&n.replicate_models&&(o=n.replicate_models||[]),r&&Array.isArray(o)&&(o=o.filter(c=>r.has(c.id))),o.length===0)e.appendChild(new Option("(No models available)","")),e.disabled=!0;else{if(a==="openai")o.sort((c,u)=>{let s={"gpt-image-1":1,"dall-e-3":2,"dall-e-2":3};return(s[c.id]||99)-(s[u.id]||99)}),o.forEach(c=>{e.appendChild(new Option(c.name,c.id))});else if(a==="google")o.sort((c,u)=>{let s={"gemini-2.0-flash-preview-image-generation":1,"imagen-3.0-generate-002":2};return(s[c.id]||99)-(s[u.id]||99)}),o.forEach(c=>{e.appendChild(new Option(c.name,c.id))});else if(a==="replicate"){let c={};o.forEach(s=>{if(s&&s.name){let l=s.name.split("/"),p=l.length>1?l[0]:"other";c[p]||(c[p]=[]),c[p].push(s)}}),Object.keys(c).sort().forEach(s=>{let l=document.createElement("optgroup");l.label=s,c[s].sort((p,_)=>(p.name||"").localeCompare(_.name||"")),c[s].forEach(p=>{let _=p.name.replace(s+"/",""),f=new Option(_,p.id);l.appendChild(f)}),e.appendChild(l)})}e.disabled=!1,e.selectedIndex===-1&&(e.selectedIndex=0)}}window.aipkit_populatePublicModelsForProvider=d})();(function(){"use strict";function d(i){let e=i.target.closest(".aipkit-image-history-delete-btn");if(!e)return;i.preventDefault(),i.stopPropagation();let t=e.dataset.attachmentId;if(!t)return;let n=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,a=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!n||!a){alert("Error: Cannot delete image. Configuration missing.");return}let r=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let c=new FormData;c.append("action","aipkit_delete_generated_image"),c.append("_ajax_nonce",a),c.append("attachment_id",t),fetch(n,{method:"POST",body:c,credentials:"same-origin"}).then(u=>u.json()).then(u=>{if(!u.success)throw new Error(u.data?.message||"Deletion failed.");let s=e.closest(".aipkit-image-history-item");s&&(s.style.transition="opacity 0.3s",s.style.opacity="0",setTimeout(()=>{s.remove();let l=document.querySelector(".aipkit-image-history-grid"),p=document.querySelector(".aipkit_image_history_section");if(l&&p&&l.children.length===0){let _=document.createElement("p");_.className="aipkit-image-history-empty",_.textContent="You have not generated any images yet.",p.appendChild(_),l.remove()}},300))}).catch(u=>{alert("Error deleting image: "+u.message),e.innerHTML=r,e.disabled=!1})}window.aipkit_handleDeleteImage=d})();(function(){"use strict";function d(){let i=document.getElementById("aipkit_public_image_generator");if(!i)return;let e=i.querySelector("#aipkit_public_image_prompt"),t=i.querySelector("#aipkit_public_image_results"),o=i.querySelector("#aipkit_public_generate_image_btn"),n=i.querySelector("#aipkit_image_generator_public_nonce"),a=window.aipkit_image_generator_config_public||{},r=a.text||{},c=a.ajaxUrl||window.aipkit_dashboard?.ajaxurl,u=n?n.value:null,s=window.aipkit_escapeHtml||function(h){return h};if(!e||!t||!o||!c||!u){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Configuration missing.</p>',t.style.display="grid";return}let l=window.aipkit_getSettingValue(i,"aipkit_public_image_provider","image_provider"),p=window.aipkit_getSettingValue(i,"aipkit_public_image_model","image_model"),_=e.value.trim();if(!_){console.log("AIPKit Image Gen (Public): Prompt is empty, doing nothing.");return}if(!l||!p){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:l,model:p}),t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Missing required image generation settings.</p>',t.style.display="grid";return}o.disabled=!0;let f=o.querySelector(".aipkit_btn-text"),w=o.querySelector(".aipkit_spinner"),m=f?f.textContent:r.generateButton||"Generate Image";f&&(f.textContent=r.generating||"Generating..."),w&&(w.style.display="inline-block"),t.style.display="grid",t.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span></p>';let g=new FormData;g.append("action","aipkit_generate_image"),g.append("_ajax_nonce",u),g.append("prompt",_),g.append("provider",l),g.append("model",p),l.toLowerCase()==="openai"&&(p==="dall-e-3"?(g.append("quality","standard"),g.append("style","vivid")):p==="gpt-image-1"&&g.append("output_format","png"),p!=="gpt-image-1"&&g.append("response_format","url")),fetch(c,{method:"POST",body:g,credentials:"same-origin"}).then(h=>h.json()).then(h=>{if(!h.success){let I=h.data&&h.data.message?h.data.message:"Unknown generation error";throw new Error(I)}h.data&&h.data.images&&h.data.images.length>0?(t.innerHTML="",h.data.images.forEach(I=>{let b=document.createElement("div");b.className="aipkit_image_result";let y="",k=I.media_library_url||I.url||null,S=r.viewFullImage||"Click to view full image",A=I.url||(I.b64_json?`data:image/png;base64,${I.b64_json}`:null);if(A){let v=`<img src="${s(A)}" alt="${s(_)}">`;k?y=`<a href="${s(k)}" target="_blank" rel="noopener noreferrer" title="${s(S)}">${v}</a>`:y=v}else y='<p class="aipkit_image_results_message aipkit_message-error">Error: No image data found.</p>';if(b.innerHTML=y,I.revised_prompt){let v=document.createElement("p");v.style.fontSize="11px",v.style.fontStyle="italic",v.style.marginTop="5px",v.textContent=`Revised: ${I.revised_prompt}`,b.appendChild(v)}t.appendChild(b)})):t.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${r.initialPlaceholder||"No images returned. Try a different prompt."}</p>`}).catch(h=>{console.error("AIPKit Image Generation Error (Public):",h),t.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${r.error||"Error generating image:"} ${s(h.message||"Unknown error")}</p>`}).finally(()=>{o.disabled=!1,f&&(f.textContent=m),w&&(w.style.display="none")})}window.aipkit_handlePublicImageGeneration=d})();(function(){"use strict";function d(i){let e=i.currentTarget;if(e.disabled)return;let t=e.closest("#aipkit_public_image_generator");if(!t)return;let n=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,a=t.querySelector("#aipkit_image_generator_public_nonce")?.value,r=t.querySelector(".aipkit-image-history-grid");if(!n||!a||!r){console.error("Image History Load More: Missing required elements or config.");return}let c=parseInt(e.dataset.currentPage,10)||1,u=parseInt(e.dataset.maxPages,10)||1,s=c+1;if(s>u)return;let l=e.querySelector(".aipkit_btn-icon-content"),p=e.querySelector(".aipkit_spinner");l&&(l.style.display="none"),p&&(p.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",a),_.append("page",s),fetch(n,{method:"POST",body:_,credentials:"same-origin"}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.data?.message||"Failed to load more images.");f.data.html&&r.insertAdjacentHTML("beforeend",f.data.html),e.dataset.currentPage=s,f.data.has_more||(e.style.display="none")}).catch(f=>{console.error("Image History Load More Error:",f)}).finally(()=>{l&&(l.style.display="inline-block"),p&&(p.style.display="none"),s<u?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=d})();(function(){"use strict";function d(){let i=document.getElementById("aipkit_public_image_generator");if(!i)return;console.log("AIPKit Image Generator: Initializing Public UI...");let e=i.querySelector("#aipkit_public_generate_image_btn"),t=i.querySelector("#aipkit_public_image_results"),o=i.querySelector("#aipkit_public_image_provider"),n=i.querySelector("#aipkit_public_image_model"),a=i.dataset.allowedModels||"",r=i.querySelector(".aipkit-image-history-grid"),c=i.querySelector(".aipkit-image-history-load-more-btn");if(!e||!t){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),t&&(t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Core UI elements missing.</p>'),t.style.display="grid";return}o&&n&&typeof window.aipkit_populatePublicModelsForProvider=="function"&&(window.aipkit_populatePublicModelsForProvider(o.value,n,a),o.addEventListener("change",()=>{window.aipkit_populatePublicModelsForProvider(o.value,n,a)})),e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",window.aipkit_handlePublicImageGeneration),e.dataset.listenerAttached="true"),r&&r.addEventListener("click",window.aipkit_handleDeleteImage),c&&c.addEventListener("click",window.aipkit_handleLoadMoreHistory),t&&(t.style.display="none",t.innerHTML=""),console.log("AIPKit Image Generator (Public): UI Initialized. Results container hidden.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d(),window.aipkit_initPublicImageGenerator=d})();(function(){"use strict";function d(t,o,n,a){let r=window.aipkit_token_usage_config||{},c=r.text||{},u=document.createElement("div");u.className="aipkit-usage-details-table-container";let s=document.createElement("div");s.className="aipkit-usage-details-pagination-container",a.appendChild(u),a.appendChild(s),u.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${c.loadingDetails||"Loading details..."}</p>`;let l={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:t,context_id:o,page:n},p=new FormData;for(let _ in l)p.append(_,l[_]);fetch(r.ajaxUrl,{method:"POST",body:p,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");i(_.data.items,u),e(_.data.pagination,s,t,o,a)}).catch(_=>{console.error("Error fetching token usage details:",_),u.innerHTML=`<p style="color:red;text-align:center;">${c.errorLoading||"Error loading details."} (${_.message})</p>`})}function i(t,o){if(!t||t.length===0){o.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let n='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';t.forEach(a=>{let c=new Date(a.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});n+=`<tr><td>${c}</td><td>${a.tokens.toLocaleString()}</td></tr>`}),n+="</tbody></table>",o.innerHTML=n}function e(t,o,n,a,r){let{currentPage:c,totalPages:u}=t,s=window.aipkit_token_usage_config?.text||{};if(o.innerHTML="",u<=1)return;let l=document.createElement("button");l.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",l.textContent=s.previous||"Previous",l.disabled=c<=1,l.addEventListener("click",()=>d(n,a,c-1,r)),o.appendChild(l);let p=document.createElement("span");p.className="aipkit_pagination-current",p.textContent=`${s.pageLabel||"Page"} ${c} ${s.ofLabel||"of"} ${u}`,o.appendChild(p);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=s.next||"Next",_.disabled=c>=u,_.addEventListener("click",()=>d(n,a,c+1,r)),o.appendChild(_)}document.addEventListener("click",function(t){let o=t.target.closest(".aipkit-usage-details-btn");if(!o||o.disabled)return;let n=o.closest("tr.aipkit-usage-main-row");if(!n)return;let a=n.nextElementSibling,r=a&&a.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(c=>{if(c!==a){let u=c.previousElementSibling.querySelector(".aipkit-usage-details-btn");u&&u.classList.remove("aipkit-active"),c.remove()}}),r)a.remove(),o.classList.remove("aipkit-active");else{o.classList.add("aipkit-active");let c=document.createElement("tr");c.className="aipkit-usage-details-row";let u=document.createElement("td");u.colSpan=n.cells.length,u.className="aipkit-usage-details-cell";let s=document.createElement("div");s.className="aipkit-usage-details-content",u.appendChild(s),c.appendChild(u),n.parentNode.insertBefore(c,n.nextSibling);let l=o.dataset.module,p=o.dataset.contextId;d(l,p,1,s)}}),document.addEventListener("click",function(t){let o=t.target.closest(".aipkit_toggle_purchase_history");if(!o)return;t.preventDefault();let n=document.getElementById("aipkit_purchase_history_details");if(!n)return;o.getAttribute("aria-expanded")==="true"?(n.style.display="none",o.setAttribute("aria-expanded","false")):(n.style.display="block",o.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function d(e){e.preventDefault();let t=e.target,o=t.querySelector(".aipkit_semantic_search_input"),n=t.querySelector(".aipkit_semantic_search_button"),a=t.closest(".aipkit_semantic_search_wrapper"),r=a.querySelector(".aipkit_semantic_search_results");if(!o||!n||!a||!r){console.error("Semantic Search: Missing required form elements.");return}let c=o.value.trim();if(!c)return;let u=window.aipkit_semantic_search_config||{},s=u.text||{};n.disabled=!0;let l=n.querySelector(".aipkit_spinner");l&&(l.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let p={query:c};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",p,u).then(_=>{r.innerHTML=_.html||`<p>${u.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),r.innerHTML=`<p class="aipkit-search-error">${s.error||"An error occurred while searching."}</p>`}).finally(()=>{n.disabled=!1,l&&(l.style.display="none")})}function i(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(t=>{t.dataset.listenerAttached!=="true"&&(t.addEventListener("submit",d),t.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",i),document.addEventListener("aipkit:contentLoaded",i)})();(function(){"use strict";function d(i,e,t){if(!i)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let o=i.querySelector(".aipkit_consent_overlay");if(!o){o=document.createElement("div"),o.className="aipkit_consent_overlay",o.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `;let n=i.querySelector(".aipkit_chat_input");n?i.insertBefore(o,n):i.appendChild(o);let a=o.querySelector(".aipkit_consent_agree_btn");a&&typeof t=="function"&&a.addEventListener("click",t)}return o.classList.remove("aipkit_hidden"),console.log(`AIPKit ShowConsentBox (${e.botId}): Showing consent box.`),o}window.aipkit_chatUI_showConsentBox=d})();(function(){"use strict";function d(i){i&&(i.classList.add("aipkit_hidden"),console.log("AIPKit HideConsentBox: Hiding consent box."))}window.aipkit_chatUI_hideConsentBox=d})();(function(){"use strict";function d(i,e,t,o,n,a){i.consentGiven=!0,localStorage.setItem(e,"true"),typeof n=="function"&&a&&n(a);let r=o.closest("[data-bot-id]")?.dataset.botId||"unknown";console.log(`AIPKit HandleConsentAgree (${r}): Consent given and stored.`),typeof t=="function"&&t();let c=o.closest(".aipkit_chat_container");c&&c.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=d})();(function(){"use strict";function d(i,e,t,o){let n=e.botId,a=`aipkit_chatbot_consent_given_${n}`;t.consentGiven=localStorage.getItem(a)==="true";let r=null;function c(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(t,a,o,i,s,r):console.error(`AIPKit Consent UI Init (${n}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function u(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(i,e,c):console.error(`AIPKit Consent UI Init (${n}): aipkit_chatUI_showConsentBox helper function not found.`)}function s(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${n}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!t.consentGiven&&u(),console.log(`AIPKit Consent UI Init (${n}): Initialized. Required: ${e.requireConsentCompliance}, Given: ${t.consentGiven}`),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!t.consentGiven?(u(),!0):!1,isConsentGiven:()=>t.consentGiven}}window.aipkit_initConsentUI=d})();(function(){"use strict";function d(i,e){let{messagesEl:t}=i;if(!t||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:o}=window.jspdf,n=new o,a=t.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",c=e.text.userPrefix||"User",u=e.text.errorPrefix||"Error",s=10,l=n.internal.pageSize.height,p=10,_=6,f=l-p*2,w=!1;if(n.setFontSize(16),n.text(`Chat Transcript - ${r}`,p,s),s+=_*2,n.setFontSize(12),a.forEach(g=>{let h=g.querySelector(".aipkit_chat_bubble");if(!h)return;let I=window.aipkit_chatUI_extractTextFromBubble(h),b="";if(g.classList.contains("aipkit_chat_message-user")?(b=`${c}:`,n.setFont(void 0,"bold")):g.classList.contains("aipkit_chat_message-bot")?(b=`${r}:`,n.setFont(void 0,"normal")):g.classList.contains("aipkit_chat_message-error")?(b=`${u}:`,n.setFont(void 0,"italic")):n.setFont(void 0,"normal"),b&&I){w=!0;let y=b,k=`${I}`;s+_>f+p&&(n.addPage(),s=p),n.text(y,p,s),s+=_,n.splitTextToSize(k,n.internal.pageSize.width-p*2).forEach(A=>{s+_>f+p&&(n.addPage(),s=p),n.text(A,p,s),s+=_}),s+=_/2,n.setFont(void 0,"normal")}}),!w){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let m=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{n.save(m),console.log("AIPKit Chat Download: PDF generated and download triggered for",m)}catch(g){console.error("AIPKit Download PDF: Error calling doc.save()",g),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=d})();(function(){"use strict";function d(i){let t=i.currentTarget.closest(".aipkit-ai-form-wrapper"),o=t?t.querySelector(".aipkit-ai-form-results-content"):null,n=t?t.dataset.formId:"unknown";if(!o){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:a}=window.jspdf,r=new a,c=o.innerText||o.textContent||"";if(!c.trim()){alert("Nothing to export.");return}let u=r.internal.pageSize.height,s=10,l=6,p=u-s*2,_=s;r.setFontSize(12),r.splitTextToSize(c,r.internal.pageSize.width-s*2).forEach(h=>{_+l>p+s&&(r.addPage(),_=s),r.text(h,s,_),_+=l});let w=new Date,m=`${w.getFullYear()}${String(w.getMonth()+1).padStart(2,"0")}${String(w.getDate()).padStart(2,"0")}`,g=`aiform-${n}-result-${m}.pdf`;r.save(g)}window.aipkitForms_handleDownloadPdf=d})();console.log("AIPKit Public Main Bundle Loaded (imports all public scripts).");})();
