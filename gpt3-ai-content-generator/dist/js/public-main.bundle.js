(()=>{(function(){"use strict";function l(){if(typeof window.markdownit=="function"){window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"});let n=window.aipkit_md.renderer.rules.link_open||function(e,i,a,t,o){return o.renderToken(e,i,a)};window.aipkit_md.renderer.rules.link_open=function(e,i,a,t,o){let r=e[i],s=r.attrIndex("target");s<0?r.attrPush(["target","_blank"]):r.attrs[s][1]="_blank";let u=r.attrIndex("rel");if(u<0)r.attrPush(["rel","noopener noreferrer"]);else{let c=(r.attrs[u][1]||"").split(/\s+/).filter(Boolean);c.includes("noopener")||c.push("noopener"),c.includes("noreferrer")||c.push("noreferrer"),r.attrs[u][1]=c.join(" ")}return n(e,i,a,t,o)},window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs})}else console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(n){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(i){return typeof i!="string"?"":i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(n).replace(/\n/g,"<br>")}}}window.aipkit_initializeMarkdownParser=l})();(function(){"use strict";function l(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function n(e){return l(e)}window.aipkit_escapeHtml=l,window.aipkit_escapeAttribute=n})();(function(){"use strict";function l(n){let e=Number(n);if(!e||isNaN(e))return"";try{let i=new Date(e*1e3);if(isNaN(i.getTime()))return"";let a=String(i.getHours()).padStart(2,"0"),t=String(i.getMinutes()).padStart(2,"0"),o=String(i.getSeconds()).padStart(2,"0");return`${a}:${t}:${o}`}catch(i){return console.error("Error formatting timestamp:",n,i),""}}window.aipkit_formatTimestamp=l})();(function(){"use strict";function l(n,e={},i={}){return new Promise((a,t)=>{if(!i.ajaxUrl)return t(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let o=new FormData;o.append("action",n),i.nonce?o.append("_ajax_nonce",i.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${n}".`),i.botId&&o.append("bot_id",i.botId),window.aipkit_guest_uuid&&o.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&o.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&o.append("post_id",window.aipkit_current_post_id),i.provider==="OpenAI"&&i.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&o.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&o.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&o.append("frontend_google_search_grounding_active","true"),i.activeFileContext?(i.activeFileContext.provider==="OpenAI"&&i.activeFileContext.vector_store_id&&o.append("active_openai_vs_id",i.activeFileContext.vector_store_id),i.activeFileContext.provider==="Pinecone"&&i.activeFileContext.index_name&&i.activeFileContext.namespace&&(o.append("active_pinecone_index_name",i.activeFileContext.index_name),o.append("active_pinecone_namespace",i.activeFileContext.namespace)),i.activeFileContext.provider==="Qdrant"&&i.activeFileContext.collection_name&&i.activeFileContext.file_upload_context_id&&(o.append("active_qdrant_collection_name",i.activeFileContext.collection_name),o.append("active_qdrant_file_upload_context_id",i.activeFileContext.file_upload_context_id)),i.activeFileContext.provider==="Claude"&&i.activeFileContext.file_id&&o.append("active_claude_file_id",i.activeFileContext.file_id)):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id?console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`):e.active_claude_file_id&&console.log(`AIPKit frontendApiRequest: Sending Claude file context from data object: File ID: ${e.active_claude_file_id}`);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&r!=="frontend_web_search_active"&&r!=="frontend_google_search_grounding_active"&&r!=="active_openai_vs_id"&&r!=="active_pinecone_index_name"&&r!=="active_pinecone_namespace"&&r!=="active_qdrant_collection_name"&&r!=="active_qdrant_file_upload_context_id"&&r!=="active_claude_file_id"&&(r==="audio_file"&&e[r]instanceof Blob?o.append(r,e[r],"speech."+(e.audio_format||"webm")):o.append(r,e[r]));fetch(i.ajaxUrl,{method:"POST",body:o,credentials:"same-origin"}).then(r=>r.json()).then(r=>{if(r.success)a(r.data);else{let s=r.data&&typeof r.data=="object"&&r.data.message?r.data.message:"Unknown frontend API error (data or data.message missing/invalid)";t(new Error(s))}}).catch(r=>{console.error(`AIPKit Frontend AJAX Error (Action: ${n}):`,r),t(r)})})}window.aipkit_frontendApiRequest=l})();(function(){"use strict";function l(n){return`aipkit-client-msg-${String(n||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=l})();(function(){"use strict";function l(n){if(!n||typeof n.style>"u")return;n.style.height="auto";let e=n.scrollHeight,i=window.getComputedStyle(n),a=parseInt(i.minHeight,10)||0,t=parseInt(i.maxHeight,10)||1/0,o=Math.max(a,e);o=Math.min(o,t),n.style.height=`${o}px`,o>=t?(n.style.overflowY="auto",n.classList.add("aipkit-textarea-scrollable")):(n.style.overflowY="hidden",n.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=l})();(function(){"use strict";function l(n,e,i){let{webSearchToggleButton:a}=n,t=e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter");!a||!t||(i.webSearchToolActive=!i.webSearchToolActive,a.classList.toggle("aipkit_active",i.webSearchToolActive),a.title=i.webSearchToolActive?e.text?.webSearchActive||"Web Search Active":e.text?.webSearchInactive||"Web Search Inactive",a.setAttribute("aria-pressed",i.webSearchToolActive.toString()))}window.aipkit_toggleWebSearchAction=l})();(function(){"use strict";function l(n,e,i){let{googleSearchGroundingToggleButton:a}=n,t=e.allowGoogleSearchGrounding&&e.provider==="Google";!a||!t||(i.googleSearchGroundingActive=!i.googleSearchGroundingActive,a.classList.toggle("aipkit_active",i.googleSearchGroundingActive),a.title=i.googleSearchGroundingActive?e.text?.googleSearchGroundingActive||"Google Search Grounding Active":e.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",a.setAttribute("aria-pressed",i.googleSearchGroundingActive.toString()))}window.aipkit_toggleGoogleSearchGroundingAction=l})();(function(){"use strict";function l(n,e){let i=e.botId||"unknown",a=n.querySelector(".aipkit_chat_header"),t=n.querySelector(".aipkit_chat_main"),o=t?t.querySelector(".aipkit_chat_messages"):null,r=t?t.querySelector(".aipkit_chat_footer"):null,s=t?t.querySelector(".aipkit_chat_input"):null,u=s?s.querySelector(".aipkit_chat_input_field"):null,p=s?s.querySelector(".aipkit_chat_input_wrapper"):null,c=p?p.querySelector(".aipkit_chat_input_actions_bar"):null,d=n.querySelector(".aipkit_chat_image_preview_container"),_=n.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&s&&p){if(d||(d=document.createElement("div"),d.className="aipkit_chat_image_preview_container"),!p.contains(d)){let B=p.querySelector(".aipkit_chat_input_field");B?p.insertBefore(d,B):p.appendChild(d)}_||(_=document.createElement("input"),_.type="file",_.className="aipkit_chat_image_upload_input",_.style.display="none",_.setAttribute("aria-hidden","true"),s.appendChild(_))}let f=s?s.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&s&&(f||(f=document.createElement("input"),f.type="file",f.className="aipkit_chat_file_upload_input",f.style.display="none",f.setAttribute("aria-hidden","true"),s.appendChild(f)));let w=c?c.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,h=s?s.querySelector(".aipkit_input_action_menu"):null,m=c?c.querySelector(".aipkit_voice_input_btn"):null,g=c?c.querySelector(".aipkit_web_search_toggle"):null,k=c?c.querySelector(".aipkit_google_search_grounding_toggle"):null,b=c?c.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,y=b?b.querySelector(".aipkit_send_icon"):null,I=b?b.querySelector(".aipkit_clear_icon"):null,A=b?b.querySelector(".aipkit_spinner"):null,S=t?t.querySelector(".aipkit_conversation_starters"):null,v=a?a.querySelector(".aipkit_sidebar_toggle_btn"):null,x=a?a.querySelector(".aipkit_fullscreen_btn"):null,U=a?a.querySelector(".aipkit_download_btn"):null,M=n.querySelector(".aipkit_chat_sidebar"),F=M?M.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!t||!o||!u||!b||!y||!I||!A?(console.error(`AIPKit Chat FindElements (${i}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!S&&console.warn(`AIPKit Chat FindElements (${i}): Starters enabled but container not found.`),e.enableSidebar&&(!M||!v)&&console.warn(`AIPKit Chat FindElements (${i}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!w&&console.warn(`AIPKit Chat FindElements (${i}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&!g&&console.warn(`AIPKit Chat FindElements (${i}): Provider Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!k&&console.warn(`AIPKit Chat FindElements (${i}): Google Search Grounding allowed but toggle button missing.`),{container:n,headerEl:a,mainContentEl:t,messagesEl:o,footerEl:r,inputArea:s,inputField:u,inputWrapper:p,actionsBar:c,imageUploadInput:_,imagePreviewContainer:d,fileUploadInput:f,inputActionButton:w,inputActionMenu:h,voiceInputButton:m,webSearchToggleButton:g,googleSearchGroundingToggleButton:k,actionButton:b,sendIcon:y,clearIcon:I,spinner:A,startersContainer:S,sidebarToggleBtn:v,fullscreenButton:x,downloadButton:U,sidebarEl:M,newChatBtn:F})}window.aipkit_chatUI_findElements=l})();(function(){"use strict";function l(n,e=!1){n&&requestAnimationFrame(()=>{let i=n.scrollHeight-n.scrollTop-n.clientHeight<100;(e||i)&&(n.scrollTop=n.scrollHeight,setTimeout(()=>{n&&(n.scrollTop=n.scrollHeight)},50)),typeof window.aipkit_chatUI_updateScrollToBottomButton=="function"&&window.aipkit_chatUI_updateScrollToBottomButton(n)})}window.aipkit_chatUI_scrollToBottom=l})();(function(){"use strict";function l(n){if(!n)return;let e=n.style.animation;n.style.animation="none",n.offsetHeight,e?n.style.animation=e:n.style.removeProperty("animation")}window.aipkit_chatUI_triggerMessageAnimation=l})();(function(){"use strict";let l="aipkit_scroll_to_bottom_btn",n="aipkit-scroll-visible",a=window.requestAnimationFrame||function(d){return window.setTimeout(d,16)};function t(d,_=48){return d?d.scrollHeight-d.scrollTop-d.clientHeight<=_:!0}function o(d){return d?d.scrollHeight>d.clientHeight+4:!1}function r(d){if(!d||!d._aipkitScrollToBottomButton)return;let _=d._aipkitScrollToBottomButton,f=o(d)&&!t(d);_.classList.toggle(n,f),_.setAttribute("aria-hidden",f?"false":"true")}function s(d,_,f){if(!d)return;let w=_?Math.round(_.getBoundingClientRect().height):0,h=f?Math.round(f.getBoundingClientRect().height):0,g=Math.max(96,w+h+12);d.style.setProperty("--aipkit-chat-scroll-button-bottom-offset",`${g}px`)}function u(d){let _=d.querySelector(`.${l}`);return _||(_=document.createElement("button"),_.type="button",_.className=l,_.setAttribute("aria-label","Scroll to bottom"),_.setAttribute("aria-hidden","true"),_.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 13l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',d.appendChild(_),_)}function p(d){if(!d||!d.mainContentEl||!d.messagesEl||d.mainContentEl.dataset.aipkitScrollButtonInit==="1")return;d.mainContentEl.dataset.aipkitScrollButtonInit="1";let{mainContentEl:_,messagesEl:f,inputArea:w,footerEl:h}=d,m=u(_);f._aipkitScrollToBottomButton=m,f._aipkitScrollToBottomUpdate=()=>r(f);let g=()=>{a(()=>r(f))};if(f.addEventListener("scroll",g,{passive:!0}),typeof MutationObserver<"u"&&new MutationObserver(g).observe(f,{childList:!0,subtree:!0}),typeof ResizeObserver<"u"){let k=new ResizeObserver(()=>{s(_,w,h),g()});k.observe(f),w&&k.observe(w),h&&k.observe(h)}else window.addEventListener("resize",()=>{s(_,w,h),g()});m.addEventListener("click",()=>{typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(f,!0):f&&f.scrollTo({top:f.scrollHeight,behavior:"smooth"}),g()}),s(_,w,h),g()}function c(d){!d||!d._aipkitScrollToBottomUpdate||d._aipkitScrollToBottomUpdate()}window.aipkit_chatUI_initScrollToBottomButton=p,window.aipkit_chatUI_updateScrollToBottomButton=c})();(function(){"use strict";function l(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-typing-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_typing-indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeTypingIndicator=l})();(function(){"use strict";function l(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-image-loading-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_image_loading_indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeImageLoadingIndicator=l})();(function(){"use strict";function l(n,e){if(!n||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-typing-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",t.id=a;let o=(e.customTypingText||"").trim(),r=document.createElement("div");if(r.className="aipkit_chat_bubble",o!==""){let s=(window.aipkit_escapeHtml||(u=>String(u)))(o);r.innerHTML=`
        <span class="aipkit_typing-text">${s}</span>
        <span class="aipkit_typing-ellipsis-text" aria-hidden="true"><span>.</span><span>.</span><span>.</span></span>
      `}else r.innerHTML=`
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
      `;return t.appendChild(r),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showTypingIndicator=l})();(function(){"use strict";function l(n,e){if(!n||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-image-loading-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",t.id=a;let o=document.createElement("div");return o.className="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail",o.innerHTML='<span class="dashicons dashicons-format-image"></span>',t.appendChild(o),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showImageLoadingIndicator=l})();(function(){"use strict";let l='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>';function n(o){if(!o)return"";let r=o.querySelector("code");return r?r.textContent:o.textContent}function e(o,r){if(o){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(o).then(r).catch(()=>{i(o,r)});return}i(o,r)}}function i(o,r){try{let s=document.createElement("textarea");s.value=o,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s),s.select();let u=document.execCommand("copy");document.body.removeChild(s),u&&r()}catch(s){console.error("AIPKit Code Copy: Fallback copy failed.",s)}}function a(o,r){if(!o||r&&r.enableCopyButton===!1)return;let s=o.querySelectorAll("pre");if(!s.length)return;let u=r&&r.text&&r.text.copyCodeLabel||"Copy code";s.forEach(p=>{if(p.classList.contains("aipkit_code_block"))return;let c=document.createElement("button");c.type="button",c.className="aipkit_code_copy_btn",c.setAttribute("aria-label",u),c.setAttribute("title",u),c.innerHTML=l,p.classList.add("aipkit_code_block"),p.insertBefore(c,p.firstChild)})}function t(o){let r=o.target.closest(".aipkit_code_copy_btn");if(!r)return;o.preventDefault();let s=r.closest("pre"),u=n(s);u&&e(u,()=>{typeof window.aipkit_chatUI_showSuccessIcon=="function"&&window.aipkit_chatUI_showSuccessIcon(r)})}document.addEventListener("click",t),window.aipkit_chatUI_attachCodeCopyButtons=a})();(function(){"use strict";function l(n,e,i,a,t=!1,o=!1,r=null,s=!1,u=null){if(!n||!a)return;let p=window.aipkit_escapeHtml||function(w){return w};o||n.querySelectorAll(".aipkit_initial_greeting").forEach(h=>h.remove());let c=document.createElement("div"),d=i==="user"?"user":"bot";c.className=`aipkit_chat_message aipkit_chat_message-${d}`,t&&c.classList.add("aipkit_chat_message-error"),o&&c.classList.add("aipkit_initial_greeting"),r&&(c.id=r,c.setAttribute("data-message-id",r));let _=document.createElement("div");_.className="aipkit_chat_bubble";let f="";if(d==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let w=document.createElement("img");w.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,w.alt=e.text||"User uploaded image",w.className="aipkit_user_sent_image_thumbnail",_.appendChild(w)}if(e.text&&e.text.trim()!==""){let w=document.createElement("div");w.className="aipkit_user_message_text_content",w.textContent=e.text,_.appendChild(w),f=e.text}else!e.text&&e.user_image&&(f="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let w=e.images[0],h=e.prompt||"Generated image",m=w.revised_prompt,g="";if(w.media_library_url?g=`<a href="${p(w.media_library_url)}" target="_blank" rel="noopener noreferrer"><img src="${p(w.media_library_url)}" alt="${p(h)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.url?g=`<a href="${p(w.url)}" target="_blank" rel="noopener noreferrer"><img src="${p(w.url)}" alt="${p(h)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.b64_json?g=`<img src="data:image/png;base64,${w.b64_json}" alt="${p(h)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;">`:g=`<p style="font-style: italic;">${p(e.content||a.text?.noImageData||"Image data unavailable.")}</p>`,_.innerHTML=g,_.style.padding="5px",_.style.maxWidth="60%",_.title=`Prompt: ${p(h)}`,f=`Image generated for prompt: ${p(h)}`,m){let k=document.createElement("p");k.style.fontSize="11px",k.style.fontStyle="italic",k.style.marginTop="5px",k.style.textAlign="center",k.style.color="inherit",k.textContent=`Revised: ${p(m)}`,_.appendChild(k),f+=`. Revised prompt: ${p(m)}`}}else if(typeof e=="string")if(f=e,(d==="bot"||o)&&!t&&window.aipkit_md)_.innerHTML=window.aipkit_md.render(e),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(_,a);else{let w=e.split(`
`);w.forEach((h,m)=>{_.appendChild(document.createTextNode(h)),m<w.length-1&&_.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),_.textContent=p("[Invalid Content]"),f="Invalid Content";if(_.setAttribute("data-raw-text",f),c.appendChild(_),d==="bot"&&!o&&!t)if(c.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let w=window.aipkit_chatUI_createActionsContainerHTML(a);w&&c.insertAdjacentHTML("beforeend",w)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(d==="bot"&&!t&&u&&u.searchEntryPoint&&u.searchEntryPoint.renderedContent){let w=document.createElement("div");w.className="aipkit_grounding_widget",w.innerHTML=u.searchEntryPoint.renderedContent,c.appendChild(w)}n.appendChild(c),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(c),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,s)}window.aipkit_chatUI_appendMessage=l})();(function(){"use strict";function l(n,e){let i=n.querySelector(`.${e}`);i?i.parentNode&&i.parentNode.removeChild(i):(i=document.createElement("span"),i.className=e);let a=o=>{let r=Array.from(o.childNodes);for(let s=r.length-1;s>=0;s--){let u=r[s];if(u.nodeType===Node.TEXT_NODE&&u.textContent.trim()!==""){let p=document.createElement("span"),c=document.createTextNode(u.textContent);return p.appendChild(c),o.replaceChild(p,u),p.appendChild(i),!0}if(u.nodeType===Node.ELEMENT_NODE&&u.offsetParent!==null&&!u.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(u.tagName))return u.childNodes.length>0&&a(u)||(u.nextSibling?o.insertBefore(i,u.nextSibling):o.appendChild(i)),!0}return!1};a(n)||n.appendChild(i)}window.positionStreamingIndicator=l})();(function(){"use strict";function l(n,e,i,a,t,o=!1,r=!1,s=null){if(!n||!t||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:n,messageId:e,config:t});return}let u=window.aipkit_escapeHtml||function(w){return w},p=n.querySelector(`#${CSS.escape(e)}`),c,d="",_="aipkit_stream_indicator",f=a==="user"?"user":"bot";if(!p)n.querySelectorAll(".aipkit_initial_greeting").forEach(h=>h.remove()),p=document.createElement("div"),p.id=e,p.setAttribute("data-message-id",e),p.className=`aipkit_chat_message aipkit_chat_message-${f}`,r&&p.classList.add("aipkit_chat_message-error"),c=document.createElement("div"),c.className="aipkit_chat_bubble",c.dataset.aipkitFullContent="",c.setAttribute("data-raw-text",""),p.appendChild(c),n.appendChild(p),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(p);else{if(c=p.querySelector(".aipkit_chat_bubble"),!c)return;r&&!p.classList.contains("aipkit_chat_message-error")&&p.classList.add("aipkit_chat_message-error")}if(c.dataset.aipkitFullContent===void 0&&(c.dataset.aipkitFullContent=""),c.getAttribute("data-raw-text")===null&&c.setAttribute("data-raw-text",""),c.dataset.aipkitFullContent+=i,c.setAttribute("data-raw-text",c.getAttribute("data-raw-text")+i),d=c.dataset.aipkitFullContent,r?c.textContent=d:(c.innerHTML=window.aipkit_md?window.aipkit_md.render(d):d.replace(/\n/g,"<br>"),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(c,t)),p.classList.remove("aipkit_message_streaming"),!o&&!r){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(c,_);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let w=c.querySelector(`.${_}`);w||(w=document.createElement("span"),w.className=_,c.appendChild(w))}p.classList.add("aipkit_message_streaming")}else{let w=c.querySelector(`.${_}`);if(w&&w.parentNode&&w.parentNode.removeChild(w),o&&!r&&f==="bot"&&!p.querySelector(".aipkit_message_actions")){if(p.classList.remove("aipkit_message_streaming"),p.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let h=window.aipkit_chatUI_createActionsContainerHTML(t);h&&p.insertAdjacentHTML("beforeend",h)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(s&&s.searchEntryPoint&&s.searchEntryPoint.renderedContent){let h=document.createElement("div");h.className="aipkit_grounding_widget",h.innerHTML=s.searchEntryPoint.renderedContent,p.appendChild(h)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,o||r)}window.aipkit_chatUI_appendOrUpdateMessage=l})();(function(){"use strict";function l(n,e,i,a=null){if(!n||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let t=window.aipkit_escapeHtml||function(d){return d},o=i.botId||"default",r=document.createElement("div");if(r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",a)r.id=a,r.setAttribute("data-message-id",a);else{let d=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(o):`form-msg-${Date.now()}`;r.id=d,r.setAttribute("data-message-id",d)}let s=document.createElement("div");s.className="aipkit_chat_bubble";let u=document.createElement("div");if(u.className="aipkit_chat_form_wrapper",u.dataset.formId=e.form_id,e.title){let d=document.createElement("h5");d.className="aipkit_chat_form_title",d.textContent=t(e.title),u.appendChild(d)}let p=document.createElement("form");p.className="aipkit_chat_form",p.dataset.formId=e.form_id,e.elements.forEach(d=>{let _=document.createElement("div");_.className="aipkit_chat_form_element";let f;switch(d.type){case"text_input":case"textarea":if(d.label){let h=document.createElement("label");h.setAttribute("for",`form-${t(e.form_id)}-${t(d.id)}`),h.textContent=t(d.label),h.className="aipkit_chat_form_label_text",_.appendChild(h)}f=d.type==="textarea"?document.createElement("textarea"):document.createElement("input"),d.type==="text_input"&&(f.type="text"),d.type==="textarea"&&(f.rows=d.rows||3),f.id=`form-${t(e.form_id)}-${t(d.id)}`,f.name=t(d.id),f.className="aipkit_form-input",d.placeholder&&(f.placeholder=t(d.placeholder)),d.required&&(f.required=!0),d.default_value!==void 0&&(f.value=t(String(d.default_value))),_.appendChild(f);break;case"dropdown":if(d.label){let h=document.createElement("label");h.setAttribute("for",`form-${t(e.form_id)}-${t(d.id)}`),h.textContent=t(d.label),h.className="aipkit_chat_form_label_text",_.appendChild(h)}f=document.createElement("select"),f.id=`form-${t(e.form_id)}-${t(d.id)}`,f.name=t(d.id),f.className="aipkit_form-input",d.required&&(f.required=!0),Array.isArray(d.options)&&d.options.forEach(h=>{let m=document.createElement("option");m.value=t(h.value),m.textContent=t(h.text),d.default_value===h.value&&(m.selected=!0),f.appendChild(m)}),_.appendChild(f);break;case"checkbox_group":case"radio_group":let w=document.createElement("fieldset");if(d.label){let h=document.createElement("legend");h.textContent=t(d.label),h.className="aipkit_chat_form_label_text",w.appendChild(h)}Array.isArray(d.options)&&d.options.forEach(h=>{let m=document.createElement("div");m.className=d.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let g=document.createElement("input");g.type=d.type==="checkbox_group"?"checkbox":"radio",g.id=`form-${t(e.form_id)}-${t(d.id)}-${t(h.value)}`,g.name=t(d.id)+(d.type==="checkbox_group"?"[]":""),g.value=t(h.value),(d.type==="checkbox_group"&&Array.isArray(d.default_value)&&d.default_value.includes(h.value)||d.type==="radio_group"&&d.default_value===h.value)&&(g.checked=!0);let k=document.createElement("label");k.setAttribute("for",g.id),k.textContent=t(h.text),m.appendChild(g),m.appendChild(k),w.appendChild(m)}),_.appendChild(w);break;case"heading":f=document.createElement(d.level||"h5"),f.className="aipkit_chat_form_element_heading",f.textContent=t(d.label||""),_.appendChild(f);break;case"label":f=document.createElement("p"),f.className="aipkit_chat_form_element_label_only",f.textContent=t(d.label||""),_.appendChild(f);break}if(d.help_text){let w=document.createElement("p");w.className="aipkit_form_help_text",w.textContent=t(d.help_text),_.appendChild(w)}p.appendChild(_)});let c=document.createElement("button");c.type="submit",c.className="aipkit_btn aipkit_chat_form_submit_btn",c.textContent=t(e.submit_button_text||"Submit"),p.appendChild(c),p.addEventListener("submit",d=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let _=n.closest(".aipkit_chat_container")||n.closest(".aipkit_popup_wrapper"),f=null,w=null;_&&window.aipkitChatInstances&&window.aipkitChatInstances[_.id]?(f=window.aipkitChatInstances[_.id].elements,w=window.aipkitChatInstances[_.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(f=window.aipkit_chat_ui_elements,w=window.aipkit_chat_ui_actions),f&&w?window.aipkit_chatUI_handleChatFormSubmission(d,i,f,w):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),alert("Error submitting form: Chat context not found."))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),alert("Error submitting form: Submission handler missing.")}),u.appendChild(p),s.appendChild(u),r.appendChild(s),n.appendChild(r),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_renderChatForm=l})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(l,n)=>{},onRecordingErrorCallback:l=>{}}})();(function(){"use strict";function l(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=l})();(function(){"use strict";function l(n,e,i){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof n=="function"?n:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof i=="function"?i:()=>{}}window.aipkit_setRecordingCallbacks=l})();(function(){"use strict";async function l(n={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});let i=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],a="";for(let o of i)if(MediaRecorder.isTypeSupported(o)){a=o;break}if(!a&&MediaRecorder.isTypeSupported(""))a="";else if(!a)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let t=a?{mimeType:a}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,t),e.currentMimeType=e.mediaRecorder.mimeType||a||"application/octet-stream",e.mediaRecorder.ondataavailable=o=>{o.data.size>0&&e.audioChunks.push(o.data)},e.mediaRecorder.onstop=()=>{if(e.audioChunks.length>0){let o=new Blob(e.audioChunks,{type:e.currentMimeType});e.onRecordingStopCallback&&e.onRecordingStopCallback(o,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null)}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(o=>o.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=o=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",o.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(o.error),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(i){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",i),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(i),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null)}}window.aipkit_startRecording=l})();(function(){"use strict";function l(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let n=window.aipkitSttState;n.mediaRecorder&&(n.mediaRecorder.state==="recording"||n.mediaRecorder.state==="paused")?n.mediaRecorder.stop():(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),n.audioStream&&(n.audioStream.getTracks().forEach(e=>e.stop()),n.audioStream=null))}window.aipkit_stopRecording=l})();(function(){"use strict";function l(n,e,i){let{elements:a,config:t,state:o,setButtonStateAction:r,sendMessageAction:s}=i,{inputField:u,voiceInputButton:p}=a;if(!n||!e||!a||!t||!o||!r||!s){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",i),alert("Failed to process audio: Configuration error."),p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="")}return}if(p){p.disabled=!0,p.classList.add("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="none")}let c=(e||"").split(";")[0].split("/")[1]||"webm",d={audio_file:n,audio_format:c};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",d,t).then(_=>{if(_&&_.transcription)u.value=_.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(u),r("send",!0,o),s(_.transcription);else throw new Error("Invalid transcription response from server.")}).catch(_=>{console.error(`AIPKit STT UI (${t.botId}): Transcription AJAX error:`,_),alert(`Transcription failed: ${_.message||"Unknown error"}`)}).finally(()=>{if(p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="")}})}window.aipkit_chatUI_transcribeAudio=l})();(function(){"use strict";function l(n,e,i,a,t){let{inputField:o,voiceInputButton:r,actionButton:s,inputActionButton:u}=n,p=e.botId;if(a&&typeof a.showConsentBoxIfNeeded=="function"&&a.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${p}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit Chat UI Main (${p}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),alert("Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){let c=window.location.protocol==="https:",d=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";alert(!c&&!d?"Voice recording requires HTTPS connection for security. Please access this site using HTTPS or contact the administrator to enable SSL.":"Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}i.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{i.isRecording=!0,r.classList.add("aipkit_recording"),r.setAttribute("aria-label","Stop recording"),r.title="Stop recording",o.disabled=!0,s.disabled=!0,u&&(u.disabled=!0)},(c,d)=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=o.value.trim()==="",u&&(u.disabled=!1),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(c,d,{elements:n,config:e,state:i,setButtonStateAction:t.setButtonStateAction,sendMessageAction:t.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),alert("Error processing recorded audio."))},c=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=o.value.trim()==="",u&&(u.disabled=!1),console.error(`AIPKit STT (${p}): Recording error:`,c),alert(`Recording failed: ${c.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=l})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function l(n){let e=window.aipkitImageUploadConstants;return e?n?e.ALLOWED_IMAGE_TYPES.includes(n.type)?n.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=l})();(function(){"use strict";function l(n){return new Promise((e,i)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t=>i(t),a.readAsDataURL(n)})}window.aipkit_convertFileToBase64=l})();(function(){"use strict";function l(n){let e;n&&n.parentNode&&(e=n.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(i=>i.remove())}window.aipkit_clearImageUploadError=l})();(function(){"use strict";function l(n,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let i=document.createElement("div");if(i.className="chat-image-upload-error",i.textContent=n,e&&e.parentNode)e.parentNode.insertBefore(i,e.nextSibling);else{let a=document.querySelector(".aipkit_chat_input");a?a.appendChild(i):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=l})();(function(){"use strict";function l(n,e){let i=window.aipkitImageUploadState;if(!i){console.error("Image Upload Reset: State object not found.");return}i.currentImageFile=null,i.currentImageBase64=null,n&&(n.hasChildNodes()?(n.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{n&&(n.innerHTML="",n.style.display="none",n.classList.remove("aipkit-image-preview-fade-out"))},300)):(n.innerHTML="",n.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(n||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=l})();(function(){"use strict";function l(n,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let i=document.createElement("div");i.className="chat-image-thumbnail-wrapper";let a=document.createElement("img");a.src=n,a.alt="Image preview",a.className="chat-image-thumbnail";let t=document.createElement("button");t.className="chat-image-remove-button",t.innerHTML="\xD7",t.setAttribute("aria-label","Remove image"),t.type="button",t.onclick=()=>{let o=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,o):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},i.appendChild(a),i.appendChild(t),e.appendChild(i)}window.aipkit_renderImagePreview=l})();(function(){"use strict";function l(){let n=window.aipkitImageUploadState;return n?n.currentImageFile&&n.currentImageBase64?{mime_type:n.currentImageFile.type,base64_data:n.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=l})();(function(){"use strict";function l(){let n=window.aipkitImageUploadConstants;return n?n.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=l})();(function(){"use strict";function l(){let n=window.aipkitImageUploadConstants;return n?n.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=l})();(function(){"use strict";function l(n,e){let i=window.aipkitImageUploadState,a=window.aipkitImageUploadConstants;if(!i||!a){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!n||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}n.setAttribute("accept",a.ALLOWED_IMAGE_EXTENSIONS.join(",")),n.dataset.aipkitUploadListenerAttached!=="true"&&(n.addEventListener("change",async t=>{window.aipkit_clearImageUploadError(e);let o=t.target.files[0];if(!o){window.aipkit_resetImageUpload(e,n);return}let r=window.aipkit_validateImage(o);if(!r.isValid){window.aipkit_displayImageUploadError(r.error,e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:r.error}}));return}try{let s=await window.aipkit_convertFileToBase64(o);i.currentImageBase64=s,i.currentImageFile=o,window.aipkit_renderImagePreview(i.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:i.currentImageBase64.split(",")[1],mime_type:i.currentImageFile.type}}))}catch(s){console.error("Error processing image:",s),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),n.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:l,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(n,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(n,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:20,MAX_FILE_SIZE_BYTES:20*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function l(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=l;function n(e,i){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&i&&window.aipkit_clearChatFileUploadStatus(i)}window.aipkit_resetChatFileUploadUI=n})();(function(){"use strict";function l(n){let e=window.aipkitFileUploadConstants;return e?n?e.ALLOWED_FILE_TYPES.includes(n.type)?n.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=l})();(function(){"use strict";function l(n){if(!n)return;let e=n.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=l})();(function(){"use strict";function l(n,e="info",i){if(!i)return;let a=i.querySelector(".aipkit_chat_file_upload_status");if(!a){a=document.createElement("div"),a.className="aipkit_chat_file_upload_status";let t=i.querySelector(".aipkit_chat_input_wrapper");t?i.insertBefore(a,t):i.appendChild(a)}if(a.textContent=n,a.className="aipkit_chat_file_upload_status",a.classList.add(`aipkit_status-${e}`),a.style.display="block",e==="error")try{let t=i.closest(".aipkit_chat_container");if(!t)return;let o=window.aipkitChatInstances&&t.id?window.aipkitChatInstances[t.id]:null,r=null,s=null;if(o&&o.internalElements&&o.internalElements.messagesEl&&o.internalActions){r=o.internalElements.messagesEl;let f=t.getAttribute("data-config");if(f)try{s=JSON.parse(f)}catch{}}else{r=t.querySelector(".aipkit_chat_messages");let f=t.getAttribute("data-config");if(f)try{s=JSON.parse(f)}catch{}}if(!r)return;s||(s={botId:t.dataset.botId||"default",text:{errorPrefix:"Error:"}});let u=s.text&&s.text.errorPrefix?s.text.errorPrefix:"Error:",p=String(n||"").trim(),d=p.toLowerCase().startsWith(u.toLowerCase())?p:`${u} ${p}`,_=typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_generateClientMessageId(s.botId):null;typeof window.aipkit_chatUI_appendMessage=="function"&&window.aipkit_chatUI_appendMessage(r,d,"bot",s,!0,!1,_,!0)}catch(t){console.error("AIPKit Chat File Upload: Failed to append error to chat window:",t)}}window.aipkit_displayChatFileUploadStatus=l})();(function(){"use strict";function l(){let n=window.aipkitFileUploadConstants;return n?n.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=l})();(function(){"use strict";function l(){let n=window.aipkitFileUploadConstants;return n?n.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=l})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let l=window.aipkit_escapeHtml||function(e){return e};async function n(e,i,a,t){let o=window.aipkitFileUploadState,r=window.aipkitFileUploadConstants;if(!o||!r)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",a),null;let s=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let c of s)if(typeof window[c]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${c}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",a),null;window.aipkit_clearChatFileUploadStatus(a);let u=window.aipkit_validateChatFile(e);if(!u.isValid)return window.aipkit_displayChatFileUploadStatus(u.error,"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;if(t.vectorStoreProvider==="claude_files"&&t.provider!=="Claude")return window.aipkit_displayChatFileUploadStatus('Claude Files requires the chatbot "Provider" to be Claude.',"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;o.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${l(o.currentFile.name)}"...`,"processing",a);let p=new FormData;p.append("action","aipkit_frontend_chat_upload_file"),p.append("file_to_upload",o.currentFile),p.append("bot_id",t.botId),p.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&p.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&p.append("post_id",window.aipkit_current_post_id),p.append("upload_provider",t.vectorStoreProvider),p.append("_ajax_nonce",t.nonce);try{let c=await fetch(t.ajaxUrl,{method:"POST",body:p,credentials:"same-origin"}),d=await c.json();if(!c.ok||!d.success){let _=d.data?.message||d.message||"File upload failed on server.";throw new Error(_)}if(d.data&&d.data.file_context){let _=d.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(_))}catch(w){console.error("AIPKit File Upload: Error saving file context to localStorage:",w)}window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let f=(t.text?.fileContextActive||"Chatting with: %s").replace("%s",l(o.currentFile.name));return window.aipkit_displayChatFileUploadStatus(f,"success",a),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(c){return console.error("File Upload Processing Error:",c),window.aipkit_displayChatFileUploadStatus(`Error: ${c.message||"Upload failed."}`,"error",a),window.aipkit_resetChatFileUploadUI(i,a),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:n,resetUI:function(e,i){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,i)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function l(n,e,i,a,t=!1){let{inputField:o,actionButton:r,sendIcon:s,clearIcon:u,spinner:p,voiceInputButton:c,inputActionButton:d,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=e,w=i.text||{};if(!r||!s||!u||!p||!o)return console.error("AIPKit SetButtonState: Missing required elements."),null;p.style.display="none",s.style.display="none",u.style.display="none",r.disabled=!1,r.classList.remove("aipkit_btn-clear-state");let h=n;switch(n){case"sending":case"streaming":o.disabled=!0,r.disabled=!0,c&&(c.disabled=!0),d&&(d.disabled=!0),_&&(_.disabled=!0),f&&(f.disabled=!0),p.style.display="inline-block";let m=n==="streaming"?w.streaming||"Streaming...":w.sending||"Sending...";r.setAttribute("aria-label",m),r.setAttribute("title",m);break;case"clear":o.disabled=i.requireConsentCompliance&&!a.consentGiven,u.style.display="inline-block",r.classList.add("aipkit_btn-clear-state"),r.setAttribute("aria-label",w.clearChat||"Clear Chat"),r.setAttribute("title",w.clearChat||"Clear Chat"),r.disabled=!1,c&&(c.disabled=i.requireConsentCompliance&&!a.consentGiven),d&&(d.disabled=i.requireConsentCompliance&&!a.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!a.consentGiven),f&&(f.disabled=i.requireConsentCompliance&&!a.consentGiven);break;case"send":default:h="send",o.disabled=i.requireConsentCompliance&&!a.consentGiven,s.style.display="inline-block",r.setAttribute("aria-label",w.sendMessage||"Send Message"),r.setAttribute("title",w.sendMessage||"Send Message"),r.disabled=!t&&o.value.trim()==="",i.requireConsentCompliance&&!a.consentGiven&&(r.disabled=!0),c&&(c.disabled=i.requireConsentCompliance&&!a.consentGiven),d&&(d.disabled=i.requireConsentCompliance&&!a.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!a.consentGiven),f&&(f.disabled=i.requireConsentCompliance&&!a.consentGiven);break}return h}window.aipkit_chatUI_setButtonStateAction=l})();(function(){"use strict";function l(n,e,i){if(!n)return;let a=n.closest("#aipkit_admin_chat_preview_container"),t=window.innerWidth<=760;e.requireConsentCompliance&&!i.consentGiven||e.popupEnabled&&!i.isPopupOpen||((a||!t||i.userInitiatedAction)&&setTimeout(()=>{n&&typeof n.focus=="function"&&n.focus()},50),i.userInitiatedAction&&(i.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=l})();(function(){"use strict";function l(n,e,i,a,t,o){let{inputField:r,messagesEl:s,container:u,voiceInputButton:p,inputActionButton:c,webSearchToggleButton:d,googleSearchGroundingToggleButton:_}=i;t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,r.disabled=a.requireConsentCompliance&&!t.consentGiven,p&&(p.disabled=a.requireConsentCompliance&&!t.consentGiven),c&&(c.disabled=a.requireConsentCompliance&&!t.consentGiven),d&&a.allowWebSearchTool&&(a.provider==="OpenAI"||a.provider==="Claude"||a.provider==="OpenRouter")&&(d.disabled=a.requireConsentCompliance&&!t.consentGiven),_&&a.allowGoogleSearchGrounding&&a.provider==="Google"&&(_.disabled=a.requireConsentCompliance&&!t.consentGiven);let f=r.value.trim()==="",w=s.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;t.buttonState=o.setButtonStateAction(f&&w?"clear":"send",!1,t),o.focusInputAction(),u.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:n,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),a.ttsEnabled&&a.ttsAutoPlay&&n&&setTimeout(()=>{let m=s.querySelector(`#${CSS.escape(n)}`)?.querySelector(".aipkit_play_btn");m&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(m):a.ttsEnabled&&a.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${a.botId}): Could not find play button for message ${n} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=l})();(function(){"use strict";function l(n,e,i=!0,a,t,o,r){let{messagesEl:s,inputField:u,container:p,voiceInputButton:c,inputActionButton:d,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=a,w=t.botId;o.isSending=!1,o.currentStreamId=null,o.currentStreamMessageId=null;let h=window.aipkit_generateClientMessageId(w);window.aipkit_chatUI_appendMessage(s,n,"bot",t,!0,!1,h,i),window.aipkit_chatUI_removeTypingIndicator(s),u.disabled=t.requireConsentCompliance&&!o.consentGiven,c&&(c.disabled=t.requireConsentCompliance&&!o.consentGiven),d&&(d.disabled=t.requireConsentCompliance&&!o.consentGiven),_&&t.allowWebSearchTool&&(t.provider==="OpenAI"||t.provider==="Claude"||t.provider==="OpenRouter")&&(_.disabled=t.requireConsentCompliance&&!o.consentGiven),f&&t.allowGoogleSearchGrounding&&t.provider==="Google"&&(f.disabled=t.requireConsentCompliance&&!o.consentGiven),o.buttonState=r.setButtonStateAction("send",!1,o),r.focusInputAction(),p.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:h,error:n}}))}window.aipkit_chatUI_handleError=l})();(function(){"use strict";function l(n){if(!n)return;n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(i=>{try{n.removeChild(i)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",a)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_clearMessages=l})();(function(){"use strict";function l(n,e,i,a){let{messagesEl:t,inputField:o,imagePreviewContainer:r,imageUploadInput:s,fileUploadInput:u,inputArea:p}=n;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(t),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(t);let c=t.querySelector(".aipkit_initial_greeting");if(!c&&typeof window.aipkit_chatUI_appendMessage=="function"){let _=(e?.text?.initialGreeting||"Hello there!").trim(),f=(e?.text?.initialSubgreeting||"").trim(),w=_;f&&(w=_?`${_}

${f}`:f),typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t,w,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else c||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");o&&(o.value="",o.disabled=e.requireConsentCompliance&&!i.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?n.imagePreviewContainer&&n.imageUploadInput?window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?n.fileUploadInput&&n.inputArea?window.aipkitChatFileUpload.resetUI(n.fileUploadInput,n.inputArea):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof a.setButtonStateAction=="function"?i.buttonState=a.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided."),i.isSending=!1,i.currentStreamId=null,i.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof a.focusInputAction=="function"&&(!e.requireConsentCompliance||i.consentGiven)?a.focusInputAction():typeof a.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let d=t.closest(".aipkit_chat_container")||t.closest(".aipkit_popup_wrapper");d&&d.dispatchEvent(new CustomEvent("aipkit:chatCleared"))}window.aipkit_chatUI_clearChatAction=l})();(function(){"use strict";async function l(n,e,i,a,t=null){let{inputField:o,messagesEl:r,container:s,inputArea:u}=n,p=e.botId,c=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let y=!1,I=window.aipkit_active_file_context_data;(I.provider==="OpenAI"&&I.vector_store_id||I.provider==="Pinecone"&&I.index_name&&I.namespace||I.provider==="Qdrant"&&I.collection_name&&I.file_upload_context_id||I.provider==="Claude"&&I.file_id)&&(y=!0),y?c={...I}:(console.warn(`SendMessageAction (${p}): File context data found on window object, but missing required fields for provider: ${I.provider||"unknown"}. Context ignored. Data:`,I),c=null)}let d=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(d=window.chatImageUpload.getImageData(),d&&n.imagePreviewContainer&&n.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&n.fileUploadInput&&u){let y=window.aipkitFileUploadState;(c||y&&y.currentFile)&&window.aipkitChatFileUpload.resetUI(n.fileUploadInput,u)}let _=i.consentUIInstance;if(_&&typeof _.showConsentBoxIfNeeded=="function"&&_.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${p}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit SendMessage (${p}): Consent required but not given.`);return}let f=t!==null?t.trim():o.value.trim();if(i.isSending||!f&&!d&&!c||t===null&&(i.buttonState!=="send"||n.actionButton.disabled))return;let w=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(c={...window.aipkit_active_file_context_data}))),w=!0);let h=window.aipkit_generateClientMessageId(p),m=f;d&&(m={text:f,user_image:d}),window.aipkit_chatUI_appendMessage(r,m,"user",e,!1,!1,h,!0),t===null&&(o.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),w&&(window.aipkit_is_fresh_session=!1);let g=(e.imageTriggers||"/image").toLowerCase().split(",").map(y=>y.trim()).filter(y=>y.length>0&&y.startsWith("/")),k=f.toLowerCase(),b=null;for(let y of g)if(k.startsWith(y+" ")||k===y){b=y;break}if(b){let y=f.substring(b.length).trim();if(!y&&k!==b){let I=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",b);a.handleError(I,!1,!0),t===null&&(i.buttonState=a.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(y,f,h,w,{state:i,elements:n,config:e,...a}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),a.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let y=window.aipkit_checkMessageModeration(f,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(y){let I=window.aipkit_generateClientMessageId(p);window.aipkit_chatUI_appendMessage(r,y.message,"bot",e,!0,!1,I),i.buttonState=a.setButtonStateAction("send",!1),a.focusInputAction(),s.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:I,reason:y.type,content:f,...y.word&&{word:y.word},...y.ip&&{ip:y.ip}}}));return}}if(i.isSending=!0,o.disabled=!0,n.voiceInputButton&&(n.voiceInputButton.disabled=!0),n.inputActionButton&&(n.inputActionButton.disabled=!0),n.webSearchToggleButton&&(n.webSearchToggleButton.disabled=!0),n.googleSearchGroundingToggleButton&&(n.googleSearchGroundingToggleButton.disabled=!0),i.buttonState=a.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),s.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:h}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_streamMessage(f,p,e,r,a.handleError,()=>a.handleCompletion(i.currentStreamMessageId,w),i.webSearchToolActive,i.googleSearchGroundingActive,d,c,h);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_sendMessage(f,p,e,n,(y,I,A,S)=>{window.aipkit_chatUI_removeTypingIndicator(r),window.aipkit_chatUI_appendMessage(r,y,"bot",e,!1,!1,I,!0,S),a.handleCompletion(I,w)},a.handleError,()=>{},i.webSearchToolActive,i.googleSearchGroundingActive,d,c,h);else{let y=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${p}): Required send function not available.`),a.handleError(y,!1)}}window.aipkit_chatUI_sendMessageAction=l})();(function(){"use strict";let l=new Set(["primary_color","secondary_color","auto_text_contrast","accent_color","app_bg_color","surface_color","text_color","border_color"]),n=new Set(["font_family","bubble_border_radius","container_border_radius"]),e=new Set(["container_max_width","popup_width","container_height","container_min_height","container_max_height","popup_height","popup_min_height","popup_max_height"]),i=new Set([...l,...n,...e]);function a(m,g,k){return Number.isNaN(m)?g:Math.min(Math.max(m,g),k)}function t(m){if(!m||typeof m!="string")return null;let g=m.trim().toLowerCase();if(g==="transparent")return{r:0,g:0,b:0,a:0};if(g[0]==="#"){let x=g.slice(1);if(x.length===3&&(x=x.split("").map(M=>M+M).join("")),x.length!==6)return null;let U=parseInt(x,16);return Number.isNaN(U)?null:{r:U>>16&255,g:U>>8&255,b:U&255,a:1}}let k=g.match(/^rgba?\((.+)\)$/);if(!k)return null;let b=k[1].split(",").map(x=>x.trim());if(b.length<3)return null;let y=x=>{if(x.endsWith("%")){let M=parseFloat(x);return Number.isNaN(M)?null:a(Math.round(255*M/100),0,255)}let U=parseFloat(x);return Number.isNaN(U)?null:a(Math.round(U),0,255)},I=y(b[0]),A=y(b[1]),S=y(b[2]);if(I===null||A===null||S===null)return null;let v=1;if(b[3]!==void 0){let x=parseFloat(b[3]);Number.isNaN(x)||(v=a(x,0,1))}return{r:I,g:A,b:S,a:v}}function o(m){if(!m)return"";if(typeof m=="string")return m;let g=a(Math.round(m.r),0,255),k=a(Math.round(m.g),0,255),b=a(Math.round(m.b),0,255),y=m.a===void 0?1:a(m.a,0,1);if(y>=1)return`rgb(${g}, ${k}, ${b})`;let I=Math.round(y*1e3)/1e3;return`rgba(${g}, ${k}, ${b}, ${I})`}function r(m,g,k){let b=a(k,0,1);return{r:m.r*(1-b)+g.r*b,g:m.g*(1-b)+g.g*b,b:m.b*(1-b)+g.b*b,a:1}}function s(m,g){return{r:m.r,g:m.g,b:m.b,a:a(g,0,1)}}function u(m,g){if(!m||!g)return!1;let k=m.a===void 0?1:m.a,b=g.a===void 0?1:g.a;return Math.round(m.r)===Math.round(g.r)&&Math.round(m.g)===Math.round(g.g)&&Math.round(m.b)===Math.round(g.b)&&Math.abs(k-b)<.01}function p(m){let g=m/255;return g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)}function c(m){return .2126*p(m.r)+.7152*p(m.g)+.0722*p(m.b)}function d(m,g){let k=c(m),b=c(g),y=Math.max(k,b),I=Math.min(k,b);return(y+.05)/(I+.05)}function _(m,g,k){let b=d(m,g),y=d(m,k);return b>=y?g:k}function f(m){let g={primary:"#0F766E",secondary:"#ECFEFF",legacyAccent:"#111111",legacyAppBg:"#FFFFFF",legacySurface:"#FFFFFF",legacyText:"#111111",legacyBorder:"#E5E5E5",botBubble:"#F3F3F3"},k={primary:t(g.primary),secondary:t(g.secondary),legacyAccent:t(g.legacyAccent),legacyAppBg:t(g.legacyAppBg),legacySurface:t(g.legacySurface),legacyText:t(g.legacyText),legacyBorder:t(g.legacyBorder),botBubble:t(g.botBubble)},b=t(m.primary_color),y=t(m.secondary_color),I=t(m.accent_color),A=t(m.app_bg_color),S=t(m.surface_color),v=I&&!u(I,k.legacyAccent),x=S&&!u(S,k.legacySurface)||A&&!u(A,k.legacyAppBg),U=null;b&&(!u(b,k.primary)||!v)?U=b:v?U=I:b?U=b:U=k.primary;let M=null;y&&(!u(y,k.secondary)||!x)?M=y:S&&!u(S,k.legacySurface)?M=S:A&&!u(A,k.legacyAppBg)?M=A:y?M=y:M=k.secondary;let F=m.auto_text_contrast!=="0",B={r:255,g:255,b:255,a:1},T={r:17,g:17,b:17,a:1},q=t(m.text_color),K=q&&!u(q,k.legacyText),C=!F&&K?q:_(M,B,T),P=c(M)<.5,E=M,O=r(E,C,P?.12:.06),H=t(m.border_color),L=H&&!u(H,k.legacyBorder)?H:r(E,C,P?.22:.12),$=r(C,E,P?.35:.18),G=r(C,E,P?.5:.35),j=t(m.bot_bubble_bg_color)||r(O,C,P?.18:.08),V=t(m.user_bubble_bg_color)||U,R=F?_(U,B,T):C,te=F&&d(U,O)>=3?U:C,ie=F?_(j,B,T):C,ne=F?_(V,B,T):C,N=r(E,C,P?.18:.08),W=r(E,U,P?.22:.12),oe=r(E,C,P?.12:.04),X=r(C,E,P?.3:.12),ae=F?_(W,B,T):C,J=E,Y=N,re=F?_(J,B,T):C,se=F?_(Y,B,T):C,ce=c(U)<.5,z=r(U,ce?B:T,.12),le=U,Q=s(U,.2),Z=r(E,U,P?.2:.12),de=s(R,.3);return{container_bg_color:o(O),container_text_color:o(C),container_border_color:o(L),border_color:o(L),bg_color_secondary:o(E),bg_color_hover:o(N),text_color_link:o(X),primary_color_dark:o(C),header_bg_color:o(E),header_text_color:o($),header_border_color:o(L),messages_bg_color:o(O),messages_scrollbar_thumb_color:o(L),messages_scrollbar_track_color:"transparent",greeting_text_color:o(te),bot_bubble_bg_color:o(j),bot_bubble_text_color:o(ie),user_bubble_bg_color:o(V),user_bubble_text_color:o(ne),subgreeting_text_color:o($),input_area_bg_color:o(O),input_area_border_color:o(L),input_wrapper_bg_color:o(E),input_wrapper_border_color:o(L),input_text_color:o(C),input_placeholder_color:o(G),input_focus_border_color:o(U),input_focus_shadow_color:o(Q),send_button_bg_color:o(U),send_button_text_color:o(R),send_button_border_color:o(U),send_button_hover_bg_color:o(z),send_button_hover_border_color:o(z),send_button_disabled_bg_color:o(Z),send_button_disabled_border_color:o(Z),send_button_spinner_base_color:o(de),send_button_spinner_accent_color:o(R),action_button_bg_color:o(E),action_button_color:o($),action_button_border_color:o(L),action_button_hover_bg_color:o(N),action_button_hover_color:o(C),action_button_hover_border_color:o(le),mic_hover_bg_color:o(N),footer_bg_color:o(E),footer_text_color:o($),footer_border_color:o(L),sidebar_bg_color:o(oe),sidebar_text_color:o(X),sidebar_border_color:o(L),sidebar_active_bg_color:o(W),sidebar_active_text_color:o(ae),sidebar_hover_bg_color:o(N),sidebar_hover_text_color:o(C),action_menu_bg_color:o(E),action_menu_border_color:o(L),action_menu_item_text_color:o(C),action_menu_item_hover_bg_color:o(N),action_menu_item_hover_text_color:o(C),starter_bg_color:o(J),starter_text_color:o(re),starter_border_color:o(L),starter_hover_bg_color:o(Y),starter_hover_text_color:o(se),pdf_icon_color:o(U),image_icon_color:o($),consent_overlay_bg_color:o(s(O,.95)),consent_overlay_border_color:o(L),consent_title_color:o(C),consent_message_color:o($),consent_button_bg_color:o(U),consent_button_text_color:o(R),form_title_color:o(C),form_label_color:o(C),form_help_text_color:o($),form_input_bg:o(E),form_input_text:o(C),form_input_border:o(L),form_input_focus_border:o(U),form_input_focus_shadow:o(Q),form_submit_button_bg:o(U),form_submit_button_text:o(R),form_submit_button_hover_bg:o(z)}}function w(m){let g=f(m),k=Object.assign({},g);return n.forEach(b=>{let y=m[b];y!==""&&y!==null&&y!==void 0&&(k[b]=y)}),e.forEach(b=>{let y=m[b];y!==""&&y!==null&&y!==void 0&&(k[b]=y)}),k}function h(m,g){if(!m||typeof g!="object"||Object.keys(g).length===0)return;let k=w(g),b=I=>{if(I)for(let A in k){if(!Object.prototype.hasOwnProperty.call(k,A)||k[A]===""||k[A]===null)continue;let S=`--aipkit-chat-${A.replace(/_/g,"-")}`,v=k[A];A==="container_max_height"||A==="popup_max_height"?v=k[A]+"vh":A==="container_max_width"||A==="popup_width"||A==="container_height"||A==="container_min_height"||A==="popup_height"||A==="popup_min_height"?v=k[A]+"px":(A==="bubble_border_radius"||A==="container_border_radius")&&typeof v=="number"?v=v===0?"0":`${v}px`:(A==="bubble_border_radius"||A==="container_border_radius")&&typeof v=="string"&&/^\d+$/.test(v)&&(v=v==="0"?"0":`${v}px`),I.style.setProperty(S,v)}};b(m);let y=m.closest(".aipkit_popup_wrapper");y&&b(y)}window.aipkit_chatUI_applyCustomThemeStyles=h})();(function(){"use strict";function l(n){let i=`aipkit_chatbot_consent_given_${n.botId||"default"}`;return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:localStorage.getItem(i)==="true",isRecording:!1,webSearchToolActive:!1,googleSearchGroundingActive:!1}}window.aipkit_chatUI_initState=l})();(function(){"usegistrict";function l(n,e){if(!n||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let i=e.botId||"default";if(n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{n.removeChild(t)}catch{}}),!n.querySelector(".aipkit_initial_greeting")){let t=(e.text.initialGreeting||"Hello there!").trim(),o=(e.text.initialSubgreeting||"").trim(),r=t;if(o&&(r=t?`${t}

${o}`:o),typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(n,r,"bot",e,!1,!0,window.aipkit_generateClientMessageId(i));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let s=document.createElement("div");s.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",s.innerHTML=`<div class="aipkit_chat_bubble">${r.replace(/\n/g,"<br>")}</div>`,n.appendChild(s),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(s)}}}window.aipkit_chatUI_displayInitialMessage=l})();(function(){"use strict";function l(n,e,i,a){let{inputField:t,messagesEl:o,container:r}=n,s=e.botId;i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),t.disabled=e.requireConsentCompliance&&!i.consentGiven,n.voiceInputButton&&(n.voiceInputButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.inputActionButton&&(n.inputActionButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.webSearchToggleButton&&e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&(n.webSearchToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(n.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),r.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:s}}))}window.aipkit_chatUI_finalizeSetup=l})();(function(){"use strict";function l(n,e,i,a){if(!n||!i||!a||a.isPopupOpen)return;try{n._aipkitHint&&(typeof n._aipkitHint.hideHint=="function"&&n._aipkitHint.hideHint(),typeof n._aipkitHint.markSeen=="function"&&n._aipkitHint.markSeen())}catch{}n.classList.add("aipkit-popup-open"),n.setAttribute("aria-hidden","false"),a.isPopupOpen=!0;let t=n.closest(".aipkit_popup_wrapper");if(t){t.classList.add("aipkit-popup-open");let s=t.querySelector(".aipkit_popup_trigger");s&&s.setAttribute("aria-expanded","true")}typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(e):console.error("AIPKit Popup Open: scrollToBottom function not found.");let o=n.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=760)||o)&&setTimeout(()=>{i&&typeof i.focus=="function"&&i.focus()},50)}window.aipkit_chatUI_openPopup=l})();(function(){"use strict";function l(n,e){if(!n||!e||!e.isPopupOpen)return;n.classList.remove("aipkit-popup-open"),n.setAttribute("aria-hidden","true"),e.isPopupOpen=!1;let i=n.closest(".aipkit_popup_wrapper");if(i){i.classList.remove("aipkit-popup-open");let a=i.querySelector(".aipkit_popup_trigger");a&&a.setAttribute("aria-expanded","false")}}window.aipkit_chatUI_closePopup=l})();(function(){"use strict";function l(n,e,i,a,t,o){if(!n||!e||!t||!o){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, stateRef, or config).");return}try{let u=n.closest(".aipkit_popup_wrapper"),p=u?u.querySelector(".aipkit_popup_hint"):null,c=window.innerWidth<=760,d=!!n.closest("#aipkit_admin_chat_preview_container"),_=o.popupLabelVersion&&String(o.popupLabelVersion).trim()||"v1",f=`aipkit_popup_hint_seen_${o.botId}_${_}`,w=`aipkit_popup_hint_dismissed_${o.botId}_${_}`,h=d?"always":o.popupLabelFrequency||"once_per_visitor",m=o.popupLabelMode||"on_delay",g=(o.popupLabelDelaySeconds>0?o.popupLabelDelaySeconds:0)*1e3,k=(o.popupLabelAutoHideSeconds>0?o.popupLabelAutoHideSeconds:0)*1e3,b=!!o.popupLabelDismissible,y=h==="once_per_session"?sessionStorage:localStorage,I=T=>{try{return y.getItem(T)}catch{return null}},A=()=>h==="always"?!0:m==="on_delay"||m==="until_open"?!I(f):m==="until_dismissed"?!I(w):!0,S=()=>{if(h!=="always")try{y.setItem(f,"1")}catch{}},v=()=>{if(h!=="always")try{y.setItem(w,"1")}catch{}},x=null,U=null,M=()=>{p&&(p.classList.add("aipkit-visible"),p.setAttribute("aria-hidden","false"))},F=()=>{p&&(p.classList.remove("aipkit-visible"),p.setAttribute("aria-hidden","true"),U&&(clearTimeout(U),U=null))},B=()=>{p&&(!o.popupLabelEnabled||!o.popupLabelText||c&&!o.popupLabelShowOnMobile||!c&&!o.popupLabelShowOnDesktop||A()&&(x&&(clearTimeout(x),x=null),x=setTimeout(()=>{M(),m==="on_delay"&&(S(),k>0&&(U=setTimeout(F,k)))},g)))};if(p&&b){let T=p.querySelector(".aipkit_popup_hint_close");T&&T.addEventListener("click",q=>{q.stopPropagation(),F(),m==="until_dismissed"?v():S()})}if(p)try{let T=window.getComputedStyle(n),q=n.querySelector(".aipkit_chat_header"),K=q?window.getComputedStyle(q):null,C="",P="";if(K){let D=K.getPropertyValue("background-color").trim(),L=K.getPropertyValue("color").trim();D&&(C=D),L&&(P=L)}C||(C=T.getPropertyValue("--aipkit-chat-header-bg-color").trim()),C||(C=T.getPropertyValue("--aipkit_brand-primary").trim()),C||(C="#4a6fa5"),P||(P=T.getPropertyValue("--aipkit-chat-header-text-color").trim()),P||(P="#ffffff");let E=u||n;C&&E.style.setProperty("--aipkit-chat-popup-hint-bg",C);let O=T.getPropertyValue("--aipkit-chat-bot-bubble-text-color").trim(),H="";if(O)H=O;else if(P)H=P;else if(C){let D=C.match(/rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);if(D){let L=parseInt(D[1],10),$=parseInt(D[2],10),G=parseInt(D[3],10);H=(L*299+$*587+G*114)/1e3>200?"#2d3748":"#ffffff"}else H="#2d3748"}else H="#2d3748";H&&E.style.setProperty("--aipkit-chat-popup-hint-text-color",H)}catch{}B(),n._aipkitHint={scheduleShow:B,hideHint:F,markSeen:S}}catch(u){console.warn("AIPKit Popup Hint: setup error",u)}if(typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}let r=()=>{window.aipkit_chatUI_closePopup(n,t),typeof e.blur=="function"&&e.blur(),n._aipkitHint&&o.popupLabelEnabled&&o.popupLabelFrequency==="always"&&n._aipkitHint.scheduleShow()},s=n.querySelector(".aipkit_popup_close_btn");s&&s.addEventListener("click",u=>{u.stopPropagation(),t.isPopupOpen&&r()}),!o.directVoiceMode&&(e.addEventListener("click",u=>{u.stopPropagation(),t.isPopupOpen?r():(n._aipkitHint&&(n._aipkitHint.hideHint?.(),o.popupLabelMode==="until_open"&&n._aipkitHint.markSeen?.()),window.aipkit_chatUI_openPopup(n,i,a,t))}),document.addEventListener("keydown",u=>{u.key==="Escape"&&t.isPopupOpen&&r()}))}window.aipkit_chatUI_setupPopupHandlers=l})();(function(){"use strict";function l(n,e){let i=new Date,a=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`;return`chat-${n.botId||"transcript"}-${a}.${e}`}window.aipkit_chatUI_generateDownloadFilename=l})();(function(){"use strict";function l(n,e){let i=document.createElement("a");if(typeof i.download=="string")i.href=URL.createObjectURL(n),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let a=URL.createObjectURL(n);window.open(a,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=l})();(function(){"use strict";function l(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let a="",t=i.querySelectorAll(".aipkit_chat_message"),o=e?.headerName||"Bot",r=e.text.userPrefix||"User",s=e.text.errorPrefix||"Error";if(t.forEach(c=>{let d=c.querySelector(".aipkit_chat_bubble");if(!d)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),a+=`Error: Could not extract text.
`;return}let _=window.aipkit_chatUI_extractTextFromBubble(d),f="";c.classList.contains("aipkit_chat_message-user")?f=`[${r}]:`:c.classList.contains("aipkit_chat_message-bot")?f=`[${o}]:`:c.classList.contains("aipkit_chat_message-error")&&(f=`[${s}]:`),f&&_&&(a+=`${f}
${_}

`)}),a=a.trim(),!a){console.warn("AIPKit Chat Download TXT: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let u=new Blob([a],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),alert("Error: Could not prepare download.");return}let p=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(u,p)}window.aipkit_chatUI_downloadTranscriptActionTxt=l})();(function(){"use strict";let l="aipkit_sidebar_state_";function n(e){return`${l}${e||"default"}`}window.aipkit_sidebar_getStorageKey=n})();(function(){"use strict";function l(n,e){if(!e||!n)return;let i=n.querySelector(".aipkit_chat_footer");if(!i){e.style.display="none";return}if(window.getComputedStyle(i).display!=="none"&&window.getComputedStyle(i).visibility!=="hidden"&&i.offsetHeight>0){let t=i.offsetHeight;t>0&&(e.style.height=`${t}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=l})();(function(){"use strict";function n(e,i,a,t,o){let r=window.innerWidth<=760;o.mobileOverlayHandler&&(document.removeEventListener("click",o.mobileOverlayHandler,!0),o.mobileOverlayHandler=null),e&&r&&(o.mobileOverlayHandler=t,setTimeout(()=>{document.addEventListener("click",o.mobileOverlayHandler,{capture:!0,once:!1})},50))}window.aipkit_sidebar_manageMobileOverlayListener=n})();(function(){"use strict";function l(n,e,i,a,t,o,r,s,u,p){!e||!i||(e.classList.toggle("aipkit-sidebar-state-open",n),e.classList.toggle("aipkit-sidebar-state-closed",!n),i.setAttribute("aria-expanded",n.toString()),localStorage.setItem(a,n?"open":"closed"),typeof t=="function"&&r&&t(e,r.querySelector(".aipkit_sidebar_footer")),typeof o=="function"&&r&&o(n,r,i,u,s))}window.aipkit_sidebar_applyCurrentState=l})();(function(){"use strict";function l(n,e,i){let a=n.isSidebarOpen;n.isSidebarOpen=!n.isSidebarOpen,!a&&n.isSidebarOpen&&typeof i=="function"&&i()}window.aipkit_sidebar_toggleSidebar=l})();(function(){"use strict";function n(e,i,a,t){let o=e.config?.botId||"unknown";if(typeof e.clearChatAction=="function"){e.clearChatAction();let r=i?i.querySelector(".aipkit_conversation_item.aipkit_active"):null;r&&r.classList.remove("aipkit_active"),window.innerWidth<=760&&a.isSidebarOpen&&typeof t=="function"&&t()}else console.error(`AIPKit Sidebar (${o}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=n})();(function(){"use strict";function l(n,e,i){let a=e.botId||"unknown";if(!n||!e||!i){console.error(`AIPKit Sidebar (${a}): Missing elements or functions for fetchConversationList.`),n&&(n.innerHTML='<p style="text-align:center; color:red;">Error: Cannot load list.</p>');return}if(!e.nonce){n.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${e.text.historyGuests||"History unavailable."}</p>`;return}n.innerHTML='<p style="text-align:center; padding:10px;"><span class="aipkit_spinner" style="display:inline-block;width:16px;height:16px;"></span></p>',window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(t=>{typeof i=="function"?i(t.conversations||[]):(console.error(`AIPKit Sidebar (${a}): renderConversationListFunc is not a function.`),n.innerHTML='<p style="text-align:center; color:red;">Error: Cannot display list.</p>')}).catch(t=>{console.error(`AIPKit Sidebar (${a}): Error fetching conversation list:`,t),n.innerHTML=`<p style="text-align:center; color:red;">Error loading list: ${t.message||"Unknown error"}</p>`})}window.aipkit_sidebar_fetchConversationList=l})();(function(){"use strict";function n(e,i,a,t,o,r,s){let u=a.botId||"unknown",p='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>';if(!i||!a||!t||typeof o!="function"||typeof r!="function"||typeof s!="function"){console.error(`AIPKit Sidebar (${u}): Missing elements or functions for renderConversationList.`),i&&(i.innerHTML='<p style="text-align:center; color:red;">Error: Cannot render list.</p>');return}if(!e||e.length===0){i.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${a.text.historyEmpty||"No past conversations."}</p>`;return}i.innerHTML="";let c=window.aipkit_current_conversation_uuid||null;e.forEach(d=>{let _=document.createElement("div");_.className="aipkit_conversation_item",_.setAttribute("data-conversation-id",d.id);let f=document.createElement("span");f.className="aipkit_conversation_item_title",f.textContent=d.title||d.id.substring(0,8),f.title=`${d.title||d.id.substring(0,8)} (ID: ${d.id})`,_.appendChild(f);let w=document.createElement("button");w.type="button",w.className="aipkit_conversation_item_delete_btn",w.setAttribute("aria-label",`Delete conversation: ${f.title}`),w.innerHTML=p,w.title="Delete Conversation",_.appendChild(w);let h=document.createElement("span");h.className="aipkit_conversation_item_spinner aipkit_spinner",_.appendChild(h),c&&d.id===c&&_.classList.add("aipkit_active"),_.addEventListener("click",m=>{m.target.closest(".aipkit_conversation_item_delete_btn")||t.isDeletingId===d.id||(o(d.id),window.innerWidth<=760&&t.isSidebarOpen&&s())}),w.addEventListener("click",m=>{m.stopPropagation(),!t.isDeletingId&&r(d.id,_)}),i.appendChild(_)})}window.aipkit_sidebar_renderConversationList=n})();(function(){"use strict";function l(n,e,i,a,t,o){let r=a.botId||"unknown";if(t.isDeletingId)return;t.isDeletingId=n;let s=e.querySelector(".aipkit_conversation_item_delete_btn"),u=e.querySelector(".aipkit_conversation_item_spinner");s&&(s.style.display="none"),u&&(u.style.display="inline-block"),e.style.opacity="0.6";let p={bot_id:r,conversation_uuid:n};window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",p,a).then(c=>{e.style.transition="opacity 0.3s ease-out, max-height 0.3s ease-out",e.style.opacity="0",e.style.maxHeight="0",e.style.padding="0",e.style.marginBottom="0",e.style.overflow="hidden",setTimeout(()=>{e.parentNode&&e.remove(),i&&i.childElementCount===0&&(i.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${a.text.historyEmpty||"No past conversations."}</p>`)},300),window.aipkit_current_conversation_uuid===n&&(typeof o.clearChatAction=="function"?o.clearChatAction():console.error(`AIPKit Sidebar (${r}): clearChatAction is not a function in actions object.`))}).catch(c=>{alert(`Error deleting conversation: ${c.message||"Unknown error"}`),s&&(s.style.display="inline-flex"),u&&(u.style.display="none"),e.style.opacity="1"}).finally(()=>{t.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=l})();(function(){"use strict";function n(e,i,a,t,o,r,s){let u=t.botId||"unknown",p=a?a.closest(".aipkit_chat_container"):null,c=p?p.querySelector(".aipkit_conversation_starters"):null;if(!e||o.isDeletingId===e)return;c&&(c.classList.add("aipkit_hidden"),c.classList.remove("aipkit_starters_ready")),sessionStorage.setItem("aipkit_current_conversation_uuid",e),window.aipkit_current_conversation_uuid=e,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let _=localStorage.getItem(`aipkit_file_context_${e}`);if(_){let f=JSON.parse(_),w=!1;f&&f.provider&&(f.provider==="OpenAI"&&f.vector_store_id||f.provider==="Pinecone"&&f.index_name&&f.namespace||f.provider==="Qdrant"&&f.collection_name&&f.file_upload_context_id||f.provider==="Claude"&&f.file_id)&&(w=!0),w?(window.aipkit_active_file_context_provider=f.provider,window.aipkit_active_file_context_data=f,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:f}))):(console.warn(`AIPKit Sidebar (${u}): Invalid file context data in localStorage for conv ${e}. Clearing. Data:`,f),localStorage.removeItem(`aipkit_file_context_${e}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(_){console.error("AIPKit Sidebar: Error handling localStorage for file context:",_),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(i?i.querySelectorAll(".aipkit_conversation_item"):[]).forEach(_=>{_.classList.remove("aipkit_active"),_.getAttribute("data-conversation-id")===e&&_.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"?(window.aipkit_chatUI_clearMessages(a),a.innerHTML='<div class="aipkit_detail_spinner" style="margin: 20px auto; display: block;"><span class="aipkit_spinner"></span></div>'):a.innerHTML="",window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},t).then(_=>{a.innerHTML="";let f=_.history||[];if(f.length===0)if(typeof window.aipkit_chatUI_appendMessage=="function"&&t.text.initialGreeting){let w=(t.text.initialGreeting||"").trim(),h=(t.text.initialSubgreeting||"").trim(),m=w;h&&(m=w?`${w}

${h}`:h),typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(a,m,"bot",t,!1,!0,window.aipkit_generateClientMessageId(u))}else a.innerHTML=`<p style="text-align:center; font-style: italic; padding: 20px;">${t.text.historyEmpty||"No past messages."}</p>`;else{let w=null;f.forEach(h=>{let m=h.role==="assistant"||h.role==="bot"?"bot":"user",g=h.content||"";h.response_data&&h.response_data.type==="image"&&h.response_data.images&&h.response_data.images.length>0&&(g={type:"image",images:h.response_data.images,prompt:h.request_payload?.prompt||h.content}),h.response_data&&h.response_data.type==="user_image_upload"&&h.response_data.images&&h.response_data.images.length>0&&(g={text:h.content||"",user_image:h.response_data.images[0]}),window.aipkit_chatUI_appendMessage(a,g,m,t,h.role==="bot"&&(h.content||"").startsWith("Error:"),!1,h.message_id||null,!1,h.grounding_metadata||null),(m==="bot"||m==="assistant")&&h.openai_response_id&&(w=h.openai_response_id)}),w&&(window.aipkit_current_openai_response_id=w,sessionStorage.setItem("aipkit_current_openai_response_id",w)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0)}typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1),typeof r.focusInputAction=="function"&&r.focusInputAction(),p&&p.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:e}}))}).catch(_=>{a.innerHTML=`<p style="color:red;text-align:center;">Error loading history: ${_.message||"Unknown error"}</p>`,typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=n})();(function(){"use strict";function n(e,i,a,t){let{sidebarToggleBtn:o,sidebarEl:r,newChatBtn:s}=i,u=e.querySelector(".aipkit_chat_messages"),p=e.querySelector(".aipkit_chat_main"),c=r?r.querySelector(".aipkit_sidebar_content"):null,d=r?r.querySelector(".aipkit_sidebar_footer"):null;if(!e||!o||!r||!c||!u||!p){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:o,sidebarEl:r,sidebarContentEl:c,messagesEl:u,mainContentEl:p});return}let _=a.botId;if(!_){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),o.disabled=!0,s&&(s.disabled=!0),c.innerHTML='<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">Configuration Error</p>';return}let f={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null},w=window.aipkit_sidebar_getStorageKey(_),h=localStorage.getItem(w);f.isSidebarOpen=h==="open";let m=S=>{f.isSidebarOpen&&window.innerWidth<=760&&!r.contains(S.target)&&!o.contains(S.target)&&I()},g=S=>window.aipkit_sidebar_applyCurrentState(f.isSidebarOpen,e,o,w,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,r,f,m,S),k=()=>window.aipkit_sidebar_fetchConversationList(c,a,S=>window.aipkit_sidebar_renderConversationList(S,c,a,f,b,y,I)),b=S=>window.aipkit_sidebar_loadConversation(S,c,u,a,f,t,I),y=(S,v)=>window.aipkit_sidebar_handleDeleteConversation(S,v,c,a,f,t),I=()=>{window.aipkit_sidebar_toggleSidebar(f,g,k),g(f.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,d),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,d)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),g(!1),o.addEventListener("click",I),s&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof t.clearChatAction=="function"?(s.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(t,c,f,I)),s.disabled=!1):s&&(s.disabled=!0,console.warn(`AIPKit Sidebar (${_}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{f.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(f.isSidebarOpen,r,o,m,f)}),(f.isSidebarOpen||!a.nonce)&&k();let A=S=>{S.detail&&S.detail.newConversation&&f.isSidebarOpen&&k()};e.addEventListener("aipkit:messageReceived",A)}window.aipkit_initConversationSidebar=n})();(function(){"use strict";function l(n){if(!n)return"";let e="",i=n.childNodes;function a(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent;if(t.nodeName==="BR")return`
`;if(t.nodeType===Node.ELEMENT_NODE){let o="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(t.tagName)&&(o+=`
`),t.tagName==="LI"&&(o+="- "),t.childNodes.forEach(r=>{o+=a(r)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(t.tagName)&&(o+=`
`),o}return""}return i.forEach(t=>{e+=a(t)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=l})();(function(){"use strict";function l(n,e=1500){let i=n;if(!i){console.warn("AIPKit showSuccessIcon: Button element not found:",n);return}i.dataset.originalIconHtml||(i.dataset.originalIconHtml=i.innerHTML);let a='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>';if(n.dataset.successTimeoutId||n.disabled)return;i.innerHTML=a;let t=i.querySelector("svg");t&&(t.style.color="var(--aipkit_status-success, #38A169)"),n.dataset.successTimeoutId&&clearTimeout(parseInt(n.dataset.successTimeoutId,10));let o=setTimeout(()=>{let r=i.dataset.originalIconHtml;r&&(i.innerHTML=r),delete i.dataset.originalIconHtml,delete n.dataset.successTimeoutId},e);n.dataset.successTimeoutId=o.toString()}window.aipkit_chatUI_showSuccessIcon=l})();(function(){"use strict";function l(n,e){let i=n.target.closest(".aipkit_copy_btn");if(!i||i.disabled||i.dataset.successTimeoutId)return;let a=i.closest(".aipkit_chat_message"),t=a?a.querySelector(".aipkit_chat_bubble"):null;if(!a||!t){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let o=window.aipkit_chatUI_extractTextFromBubble(t);if(!o){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(o).then(()=>{window.aipkit_chatUI_showSuccessIcon(i)}).catch(r=>{console.error("AIPKit Message Actions: Clipboard API failed:",r)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let r=document.createElement("textarea");r.value=o,r.style.position="fixed",r.style.top="-9999px",r.style.left="-9999px",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select();let s=document.execCommand("copy");if(document.body.removeChild(r),s)window.aipkit_chatUI_showSuccessIcon(i);else throw new Error("execCommand failed")}catch(r){console.error("AIPKit Message Actions: Fallback copy method failed:",r)}}}window.aipkit_chatUI_handleCopyAction=l})();(function(){"use strict";function l(n,e){let i=n.target.closest(".aipkit_feedback_btn");if(!i||i.disabled||i.classList.contains("aipkit_feedback_selected"))return;let a=i.getAttribute("data-feedback"),t=i.closest(".aipkit_chat_message"),o=t?t.getAttribute("data-message-id"):null,r=i.closest(".aipkit_message_actions");if(!o||!a||!r){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}let s=r.querySelectorAll(".aipkit_feedback_btn");if(s.forEach(p=>{p.disabled=!0,p===i?p.classList.add("aipkit_feedback_selected"):(p.classList.remove("aipkit_feedback_selected"),p.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),s.forEach(p=>{p.disabled=!1,p.classList.remove("aipkit_feedback_selected"),p.style.opacity="1"});return}let u={message_id:o,feedback_type:a};window.aipkit_frontendApiRequest("aipkit_store_feedback",u,e).then(p=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${o}.`,p)}).catch(p=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${o}:`,p),s.forEach(c=>{c.disabled=!1,c.classList.remove("aipkit_feedback_selected"),c.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=l})();(function(){"use strict";function l(n){let e='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>',i='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>',a='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3" /></svg>',t='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-down"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" /></svg>',o="",r=n.text||{};if(n.ttsEnabled){let s=r.playActionLabel||"Play audio";o+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${s}" aria-label="${s}">${e}</button>`}if(n.enableCopyButton){let s=r.copyActionLabel||"Copy response";o+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${s}" aria-label="${s}">${i}</button>`}if(n.enableFeedback){let s=r.feedbackLikeLabel||"Like response",u=r.feedbackDislikeLabel||"Dislike response";o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${s}" aria-label="${s}" data-feedback="up">${a}</button>`,o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${u}" aria-label="${u}" data-feedback="down">${t}</button>`}return o?`<div class="aipkit_message_actions">${o}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=l})();(function(){"use strict";function l(n,e){if(!n){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}n.dataset.aipkitMessageActionsListenerAttached!=="true"&&(n.dataset.aipkitMessageActionsListenerAttached="true",n.addEventListener("click",function(i){if(i.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(i,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(i.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(i,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}))}window.aipkit_chatUI_initMessageActions=l})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function l(n=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),e.currentBlobUrl=null),n&&e.currentlyPlayingButton){e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let i=e.currentlyPlayingButton.getAttribute("data-original-icon-html");i&&(e.currentlyPlayingButton.innerHTML=i),e.currentlyPlayingButton.removeAttribute("data-original-icon-html"),e.currentlyPlayingButton=null}}window.aipkit_tts_stopCurrentAudio=l})();(function(){"use strict";let l='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>';function n(){let t=window.aipkitTtsState;!t||!t.currentAudio||!t.currentlyPlayingButton||(t.currentlyPlayingButton.classList.remove("aipkit_loading"),t.currentlyPlayingButton.classList.add("aipkit_playing"),t.currentlyPlayingButton.disabled=!1,t.currentlyPlayingButton.hasAttribute("data-original-icon-html")||t.currentlyPlayingButton.setAttribute("data-original-icon-html",t.currentlyPlayingButton.innerHTML),t.currentlyPlayingButton.innerHTML=l,t.currentAudio.play().catch(o=>{console.error("AIPKit TTS Handler: Error starting playback:",o),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(o)}))}function e(){typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function i(){let t=window.aipkitTtsState;!t||!t.currentAudio||(typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function a(t){let o=window.aipkitTtsState;if(!o)return;console.error("AIPKit TTS Handler: Error playing audio.",t);let r=o.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),r){r.classList.remove("aipkit_loading","aipkit_playing"),r.classList.add("aipkit_error"),r.disabled=!1;let s=r.getAttribute("data-original-icon-html");s&&(r.innerHTML=s),r.removeAttribute("data-original-icon-html")}o.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=n,window.aipkit_tts_handleAudioEnded=e,window.aipkit_tts_handleAudioPaused=i,window.aipkit_tts_handleAudioError=a})();(function(){"use strict";function l(n,e,i){let a=window.aipkitTtsState;if(!a){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let t=atob(n),o=new Array(t.length);for(let u=0;u<t.length;u++)o[u]=t.charCodeAt(u);let r=new Uint8Array(o),s=new Blob([r],{type:e});a.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(a.currentBlobUrl),a.currentBlobUrl=URL.createObjectURL(s),a.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),a.currentAudio=new Audio(a.currentBlobUrl),a.currentlyPlayingButton=i,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&a.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&a.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&a.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?a.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),a.currentAudio.load()}catch(t){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",t),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(t)}}window.aipkit_tts_playAudioFromBase64=l})();(function(){"use strict";async function l(n){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}let i=n.closest(".aipkit_chat_message"),a=i?i.querySelector(".aipkit_chat_bubble"):null,t=n.closest(".aipkit_chat_container[data-config]");t||(t=n.closest(".aipkit_popup_wrapper[data-config]"));let o=t?t.getAttribute("data-config"):null,r=null;if(!a||!t||!o){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}try{r=JSON.parse(o)}catch(p){console.error("AIPKit TTS PlayAction: Failed to parse config.",p);return}let s=a.getAttribute("data-raw-text")||"",u=r.botId;if(!s){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!u){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(n===e.currentlyPlayingButton){typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),n.classList.remove("aipkit_error","aipkit_playing"),n.classList.add("aipkit_loading"),n.disabled=!0;try{let p={text:s};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let c=await window.aipkit_frontendApiRequest("aipkit_generate_speech",p,r);if(c&&c.audio_data_base64&&c.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(c.audio_data_base64,c.mime_type,n);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",c),new Error("Invalid response received from speech generation.")}catch(p){if(console.error("AIPKit TTS PlayAction: Error generating speech:",p),n){n.classList.remove("aipkit_loading","aipkit_playing"),n.classList.add("aipkit_error"),n.disabled=!1;let c=n.getAttribute("data-original-icon-html");c&&(n.innerHTML=c),n.removeAttribute("data-original-icon-html")}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=l})();(function(){"use strict";function l(n,e,i,a,t){return new Promise((o,r)=>{if(!e.ajaxUrl)return r(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return r(new Error("Missing nonce in config for SSE cache."));let s=new FormData;s.append("action","aipkit_cache_sse_message"),s.append("message",n),s.append("_ajax_nonce",e.nonce),e.botId&&s.append("bot_id",e.botId),i&&s.append("image_inputs",JSON.stringify([i])),t&&s.append("user_client_message_id",t);let u=a;if(!u&&window.aipkit_current_conversation_uuid)try{let d=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);d&&(u=JSON.parse(d))}catch(d){console.error("CacheSSE: Error reading file context from localStorage:",d)}u&&(u.provider==="OpenAI"&&u.vector_store_id&&s.append("active_openai_vs_id",u.vector_store_id),u.provider==="Pinecone"&&u.index_name&&u.namespace&&(s.append("active_pinecone_index_name",u.index_name),s.append("active_pinecone_namespace",u.namespace)),u.provider==="Qdrant"&&u.collection_name&&u.file_upload_context_id&&(s.append("active_qdrant_collection_name",u.collection_name),s.append("active_qdrant_file_upload_context_id",u.file_upload_context_id)),u.provider==="Claude"&&u.file_id&&s.append("active_claude_file_id",u.file_id));let p=()=>fetch(e.ajaxUrl,{method:"POST",body:s}).then(d=>d.ok?d.json():d.text().then(_=>{try{let f=JSON.parse(_);if(f?.data?.code==="embed_not_available")throw new Error("The embed feature is not available with your current plan. Please upgrade to use embedded chatbots.");if(f?.data?.code==="cors_denied")throw new Error("This domain is not permitted to access the chatbot. Please check your embed settings.");if(f?.data?.code==="nonce_failure_cache_sse")return c(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(w=>w.ok?w.json():w.text().then(h=>{throw new Error(h||`HTTP error ${w.status} caching message.`)}));throw new Error(f?.data?.message||`HTTP error ${d.status} caching message.`)}catch{if(d.status===403)return c(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(w=>w.ok?w.json():w.text().then(h=>{throw new Error(h||`HTTP error ${w.status} caching message.`)}));throw new Error(`Failed to prepare message for streaming. Please check your internet connection and try again. (HTTP ${d.status})`)}})).then(d=>{d.success&&d.data?.cache_key?o(d.data.cache_key):r(new Error(d.data?.message||"Failed to cache message for streaming."))}).catch(d=>{console.error("AIPKit SSE Cache Request Error:",d),r(d)});function c(d){return new Promise((_,f)=>{try{if(!d||!d.ajaxUrl)return f(new Error("No ajaxUrl for nonce refresh"));let w=new FormData;w.append("action",typeof window.aipkit_getChatNonceAction=="string"&&window.aipkit_getChatNonceAction?window.aipkit_getChatNonceAction:"aipkit_get_frontend_chat_nonce"),d.botId&&w.append("bot_id",d.botId),fetch(d.ajaxUrl,{method:"POST",body:w,credentials:"same-origin"}).then(h=>h.json()).then(h=>{h&&h.success&&h.data&&h.data.nonce?(d.nonce=h.data.nonce,_(h.data.nonce)):f(new Error("Nonce refresh failed"))}).catch(()=>f(new Error("Nonce refresh network error")))}catch(w){f(w)}})}p()})}window.aipkit_chatUI_cacheSseMessage=l})();(function(){"use strict";function l(n,e,i,a,t,o,r,s,u,p){if(!i.ajaxUrl||!i.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let c=new URL(i.ajaxUrl);c.searchParams.append("action","aipkit_frontend_chat_stream"),c.searchParams.append("cache_key",n),c.searchParams.append("bot_id",e),c.searchParams.append("session_id",a||""),c.searchParams.append("conversation_uuid",t),o>0&&c.searchParams.append("post_id",o);try{c.searchParams.append("_ts",Date.now().toString())}catch{}i.provider==="OpenAI"&&i.enableOpenAIConversationState&&r&&c.searchParams.append("previous_openai_response_id",r),s&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&c.searchParams.append("frontend_web_search_active","true"),u&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&c.searchParams.append("frontend_google_search_grounding_active","true"),p&&(p.provider==="OpenAI"&&p.vector_store_id&&c.searchParams.append("active_openai_vs_id",p.vector_store_id),p.provider==="Pinecone"&&p.index_name&&p.namespace&&(c.searchParams.append("active_pinecone_index_name",p.index_name),c.searchParams.append("active_pinecone_namespace",p.namespace)),p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id&&(c.searchParams.append("active_qdrant_collection_name",p.collection_name),c.searchParams.append("active_qdrant_file_upload_context_id",p.file_upload_context_id)),p.provider==="Claude"&&p.file_id&&c.searchParams.append("active_claude_file_id",p.file_id)),c.searchParams.append("_ajax_nonce",i.nonce);try{return new EventSource(c.toString())}catch(d){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,d),d}}window.aipkit_chatUI_createEventSource=l})();(function(){"use strict";function l(n,e,i,a){try{let t=JSON.parse(n.data),o=t.message_id;if(o){if(i.currentStreamMessageId&&i.currentStreamMessageId!==o&&a){let r=a.querySelector(`#${CSS.escape(i.currentStreamMessageId)}`);if(r){let s=r.querySelector(".aipkit_chat_bubble");if(s){let u=s.querySelector(".aipkit_stream_indicator");u&&u.parentNode&&u.parentNode.removeChild(u)}r.classList.remove("aipkit_message_streaming"),r.classList.add("aipkit_message_complete")}}i.currentStreamMessageId=o}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.openai_response_id&&(window.aipkit_current_openai_response_id=t.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",t.openai_response_id))}catch(t){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",n.data,t)}}window.aipkit_chatUI_handleMessageStartEvent=l})();(function(){"use strict";function l(n,e){try{let i=JSON.parse(n.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&i.id&&(window.aipkit_current_openai_response_id=i.id,sessionStorage.setItem("aipkit_current_openai_response_id",i.id))}catch(i){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=l})();(function(){"use strict";function l(n,e){try{let i=JSON.parse(n.data);e.accumulatedGroundingMetadata=i}catch(i){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleGroundingMetadataEvent=l})();(function(){"use strict";function l(n,e,i,a,t){try{let o=JSON.parse(n.data),r=o.delta;if(r!==void 0&&t.currentStreamMessageId)if(t.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0);else{t.dataReceived=!0;let s=`aipkit-typing-indicator-${e}`,u=a.querySelector(`#${CSS.escape(s)}`);if(u){let p=u.querySelector(".aipkit_chat_bubble");if(p){u.id=t.currentStreamMessageId,u.setAttribute("data-message-id",t.currentStreamMessageId),u.classList.remove("aipkit_typing-indicator"),p.dataset.aipkitFullContent=r,p.innerHTML=window.aipkit_md?window.aipkit_md.render(r):r.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(p,"aipkit_stream_indicator");let c=typeof window.createActionsContainerHTML=="function"?window.createActionsContainerHTML(i):"";c&&!u.querySelector(".aipkit_message_actions")&&u.insertAdjacentHTML("beforeend",c),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_removeTypingIndicator(a,u),window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,o)}catch(o){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,n.data,o)}}window.aipkit_chatUI_handleOnMessageEvent=l})();(function(){"use strict";function l(n,e,i,a,t,o,r){typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&r.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(a,r.currentStreamMessageId,"","bot",i,!0,!1,r.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),typeof t=="function"&&t(),o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleDoneEvent=l})();(function(){"use strict";function l(n,e,i,a,t){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,n.data),t.dataReceived||(t.dataReceived=!0);try{let o=JSON.parse(n.data);o.error&&t.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,`

*${o.error}*`,"bot",i,!1,!0,null),window.aipkit_chatUI_scrollToBottom(a,!0))}catch(o){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,n.data,o)}}window.aipkit_chatUI_handleWarningEvent=l})();(function(){"use strict";function l(n,e,i,a,t,o,r){window.aipkit_chatUI_removeTypingIndicator(a);let s=i.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,n);let u=null;if(n.data)try{let c=JSON.parse(n.data);c.error&&(u=c.error)}catch{typeof n.data=="string"&&n.data.length>0&&n.data.length<200&&(u=n.data)}else n.target&&n.target.readyState===EventSource.CLOSED?u="Connection was closed.":n.message&&(u=n.message);let p="";u?p=`${s.errorPrefix||"Error:"} ${u}`:p=r.dataReceived?s.streamError||"Stream error. Please try again.":s.connError||"Connection error. Please check setup or try again.",typeof t=="function"&&t(p,!1,!0),r.currentStreamMessageId=null,o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleErrorEvent=l})();(function(){"use strict";function l(n,e,i,a,t){typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);try{let r=JSON.parse(n.data).form_definition;if(typeof r!="object"||r===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let s=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(a,r,i,s);let u=a.closest(".aipkit_chat_container");u&&u.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:r.form_id,messageId:s}}))}catch(o){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,o,"Raw event data:",n.data)}}window.aipkit_chatUI_handleDisplayFormEvent=l})();(function(){"use strict";async function l(n,e,i,a,t,o,r,s,u,p,c){let d=i.text||{},_={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},f={current:null},w=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let I of w)if(typeof window[I]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${I}`),typeof t=="function"&&t(`${d.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let h=window.aipkit_current_conversation_uuid,m=window.aipkit_guest_uuid,g=window.aipkit_current_post_id,k=window.aipkit_current_openai_response_id;if(!h){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof t=="function"&&t(d.errorPrefix+" "+(d.connError||"Configuration error (Conv ID)."),!1);return}let b=null;try{b=await window.aipkit_chatUI_cacheSseMessage(n,i,u,p,c)}catch(I){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,I.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,I),typeof t=="function"){let A=`${d.errorPrefix||"Error:"} Failed to prepare message for streaming.`;I&&typeof I=="object"&&I.code?A+=` (Code: ${I.code})`:I&&I.message?A+=` (${I.message})`:A+=" (Unknown error)",t(A)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let y=window.aipkit_chatUI_createEventSource(b,e,i,m,h,g,k,r,s,p);if(y instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,y),typeof t=="function"&&t(d.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(a);return}f.current=y,f.current.addEventListener("message_start",I=>window.aipkit_chatUI_handleMessageStartEvent(I,i,_,a)),f.current.addEventListener("openai_response_id",I=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(I,i)),f.current.addEventListener("grounding_metadata",I=>window.aipkit_chatUI_handleGroundingMetadataEvent(I,_)),f.current.addEventListener("display_form_event",I=>window.aipkit_chatUI_handleDisplayFormEvent(I,e,i,a,_)),f.current.onmessage=I=>window.aipkit_chatUI_handleOnMessageEvent(I,e,i,a,_),f.current.addEventListener("done",I=>window.aipkit_chatUI_handleDoneEvent(I,e,i,a,o,f,_)),f.current.addEventListener("warning",I=>window.aipkit_chatUI_handleWarningEvent(I,e,i,a,_)),f.current.onerror=I=>window.aipkit_chatUI_handleErrorEvent(I,e,i,a,t,f,_)}window.aipkit_chatUI_streamMessage=l})();(function(){"use strict";async function l(n,e,i,a){n.preventDefault();let t=n.target;if(!t)return;let o=t.dataset.formId;if(!o){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let r=new FormData(t),s={};for(let[d,_]of r.entries())if(d.endsWith("[]")){let f=d.slice(0,-2);s[f]||(s[f]=[]),s[f].push(_)}else s[d]=_;let u=t.querySelector('button[type="submit"]');u&&(u.disabled=!0);let p=t.closest(".aipkit_chat_form_wrapper"),c={form_id:o,submitted_data:JSON.stringify(s)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let d=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",c,e);if(u&&(u.disabled=!1),d.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(i.messagesEl,d.message_to_user,"bot",e,!1,!1,d.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):d.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i.messagesEl,d.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),p){let _=p.closest(".aipkit_chat_message");_&&(_.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i.messagesEl,!0))}}catch(d){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${o}":`,d),u&&(u.disabled=!1),typeof a.handleError=="function"?a.handleError(d.message||"Failed to submit form.",!1,!0):alert(d.message||"Failed to submit form.")}}window.aipkit_chatUI_handleChatFormSubmission=l})();(function(){"use strict";let l=!1,n=null,e=null;function i(){n&&(n.classList.remove("aipkit_active"),n=null,l=!1,e&&(document.removeEventListener("click",e),e=null))}window.aipkit_chatUI_closeActiveDownloadMenu=i,window.aipkit_chatUI_setActiveDownloadMenu=function(a,t,o){n=a,l=t,e=o},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:l,activeMenu:n,handler:e}}})();(function(){"use strict";function l(n,e){if(!n||!e)return;let{inputActionButton:i,inputActionMenu:a}=n;e.activeInputActionMenu&&e.activeInputActionTrigger&&(a&&(a.classList.remove("aipkit-action-menu-open"),a.setAttribute("aria-hidden","true"),setTimeout(()=>{a&&!a.classList.contains("aipkit-action-menu-open")&&(a.style.display="none")},200)),i&&(i.classList.remove("aipkit_active"),i.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=l})();(function(){"use strict";function l(n,e,i){let{inputActionButton:a,inputActionMenu:t,imageUploadInput:o,fileUploadInput:r}=n,{fileUploadEnabledUI:s,imageUploadEnabledUI:u}=e;if(!a){t&&(t.style.display="none");return}let p='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" /></svg>',c='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-photo-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8h.01" /><path d="M12.5 21h-6.5a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v6.5" /><path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l3.5 3.5" /><path d="M14 14l1 -1c.679 -.653 1.473 -.829 2.214 -.526" /><path d="M19 22v-6" /><path d="M22 19l-3 -3l-3 3" /></svg>',d='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-upload"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9.5 13.5l2.5 -2.5l2.5 2.5" /></svg>';a.onclick=null;let _=window.aipkit_chatUI_closeActiveDownloadMenu,f=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof _!="function"||typeof f!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let w=p,h=e.text?.attachTools||"Attach or use tools",m="true";if(s&&!u)w=d,h=e.text?.uploadFile||"Upload File (TXT, PDF)",m="false";else if(!s&&u)w=c,h=e.text?.uploadImage||"Upload Image",m="false";else if(!s&&!u){a.style.display="none",t&&(t.style.display="none");return}a.innerHTML=w,a.setAttribute("aria-label",h),m==="true"?(a.setAttribute("aria-haspopup","true"),a.setAttribute("aria-expanded","false")):(a.removeAttribute("aria-haspopup"),a.removeAttribute("aria-expanded")),s&&u?(t&&(t.style.display="none"),a.onclick=g=>{g.stopPropagation(),_(),!i.isActionMenuOpen?(t&&(t.style.display="flex",requestAnimationFrame(()=>{t&&t.classList.add("aipkit-action-menu-open")}),t.setAttribute("aria-hidden","false")),a.classList.add("aipkit_active"),a.setAttribute("aria-expanded","true"),i.isActionMenuOpen=!0,i.activeInputActionMenu=t,i.activeInputActionTrigger=a,setTimeout(()=>{i.closeActionMenuHandler=b=>{b.type==="click"&&(!i.activeInputActionMenu||!i.activeInputActionTrigger||i.activeInputActionMenu.contains(b.target)||i.activeInputActionTrigger.contains(b.target))||b.type==="keydown"&&b.key!=="Escape"||f(n,i)},document.addEventListener("click",i.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",i.closeActionMenuHandler,{capture:!0,once:!1})},0)):f(n,i)}):s?(t&&(t.style.display="none"),a.onclick=g=>{g.stopPropagation(),_(),r?r.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),alert("File upload feature not properly initialized."))}):u?(t&&(t.style.display="none"),a.onclick=g=>{g.stopPropagation(),_(),o?o.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),alert("Image upload feature not properly initialized."))}):(a.style.display="none",t&&(t.style.display="none"))}window.aipkit_chatUI_setupInputActionButton=l})();(function(){"use strict";function l(n,e,i,a){let{actionButton:t}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{i.buttonState==="send"&&!t.disabled?a.sendMessageAction():i.buttonState==="clear"&&a.clearChatAction()}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=l})();(function(){"use strict";function l(n,e,i,a){let{inputField:t,messagesEl:o,actionButton:r}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("keydown",s=>{s.key==="Enter"&&!i.isActionMenuOpen&&(s.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)},0):(s.preventDefault(),i.buttonState==="send"&&!r.disabled&&a.sendMessageAction()))}),t.addEventListener("input",()=>{let s=t.value.trim()==="",u=o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;s?u&&i.buttonState!=="sending"&&i.buttonState!=="streaming"?i.buttonState=a.setButtonStateAction("clear",!1,i):i.buttonState!=="sending"&&i.buttonState!=="streaming"&&(i.buttonState=a.setButtonStateAction("send",!1,i)):i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=l})();(function(){"use strict";function l(n,e,i,a){let{fullscreenButton:t}=n;t&&typeof a.toggleFullscreenAction=="function"?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a.toggleFullscreenAction),t.dataset.listenerAttached="true"):t&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=l})();(function(){"use strict";function l(n,e,i,a){let{webSearchToggleButton:t}=n,o=e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter");t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.style.display="none")}window.aipkit_chatUI_attachWebSearchToggleListener=l})();(function(){"use strict";function l(n,e,i,a){let{googleSearchGroundingToggleButton:t}=n,o=e.allowGoogleSearchGrounding&&e.provider==="Google";t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.style.display="none")}window.aipkit_chatUI_attachGoogleGroundingToggleListener=l})();(function(){"use strict";function l(n,e,i,a){let{downloadButton:t}=n;if(t&&e.enableDownload){let o=t.closest(".aipkit_download_wrapper"),r=o?o.querySelector(".aipkit_download_menu"):null,s=e.pdfDownloadActive===!0;t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",u=>{if(u.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),s&&r){let p=window.aipkit_chatUI_getDownloadMenuState?window.aipkit_chatUI_getDownloadMenuState():{isOpen:!1,activeMenu:null};if(p.isOpen&&p.activeMenu===r)typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu();else if(typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),r.classList.add("aipkit_active"),typeof window.aipkit_chatUI_setActiveDownloadMenu=="function"){let c=d=>{o.contains(d.target)||typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()};window.aipkit_chatUI_setActiveDownloadMenu(r,!0,c),setTimeout(()=>{document.addEventListener("click",c,{once:!0})},0)}}else typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),t.dataset.listenerAttached="true"),r&&r.dataset.listenerAttached!=="true"&&(r.addEventListener("click",u=>{let p=u.target.closest(".aipkit_download_menu_item");if(p){let c=p.getAttribute("data-format");c==="txt"?typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):c==="pdf"&&(typeof a.downloadTranscriptPdfAction=="function"?a.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()}}),r.dataset.listenerAttached="true")}}window.aipkit_chatUI_attachDownloadMenuListeners=l})();(function(){"use strict";function l(n,e,i,a){let{inputActionMenu:t}=n;t&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&t.dataset.itemClickListenerAttached!=="true"&&(t.addEventListener("click",o=>{let r=o.target.closest(".aipkit_input_action_menu_item");if(!r)return;o.preventDefault();let s=r.getAttribute("aria-label");s&&s.toLowerCase().includes("image")?n.imageUploadInput?n.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),alert("Image upload feature not properly initialized.")):s&&(s.toLowerCase().includes("pdf")||s.toLowerCase().includes("file"))&&(n.fileUploadInput?n.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),alert("File upload feature not properly initialized."))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i)}),t.dataset.itemClickListenerAttached="true")}window.aipkit_chatUI_attachInputActionMenuListener=l})();(function(){"use strict";function l(n,e,i,a){let{voiceInputButton:t}=n;t&&e.enableVoiceInputUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(n,e,i,i.consentUIInstance,a):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),alert("Voice input unavailable (script error)."))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=l})();(function(){"use strict";function l(n,e,i,a){let{fileUploadInput:t}=n;t&&e.fileUploadEnabledUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("change",async o=>{let r=o.target.files[0];if(r&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let s=n.inputArea||t.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(r,t,s,e)}else r&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",n.inputArea))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=l})();(function(){"use strict";function l(n,e,i,a){let{messagesEl:t}=n;t&&typeof a.handlePlayAction=="function"?t.dataset.playListenerAttached!=="true"&&(t.addEventListener("click",function(o){let r=o.target.closest(".aipkit_play_btn");r&&!r.disabled&&a.handlePlayAction(r)}),t.dataset.playListenerAttached="true"):t&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=l})();(function(){"use strict";function l(n,e,i,a){typeof i.isActionMenuOpen>"u"&&(i.isActionMenuOpen=!1,i.activeInputActionMenu=null,i.activeInputActionTrigger=null,i.closeActionMenuHandler=null);let t=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],o=!0;if(t.forEach(r=>{typeof window[r]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${r}.`),o=!1)}),!o){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(n,e,i,a),window.aipkit_chatUI_attachInputFieldListeners(n,e,i,a),window.aipkit_chatUI_attachFullscreenButtonListener(n,e,i,a),window.aipkit_chatUI_attachWebSearchToggleListener(n,e,i,a),window.aipkit_chatUI_attachGoogleGroundingToggleListener(n,e,i,a),window.aipkit_chatUI_attachDownloadMenuListeners(n,e,i,a),window.aipkit_chatUI_attachInputActionMenuListener(n,e,i,a),window.aipkit_chatUI_attachVoiceInputButtonListener(n,e,i,a),window.aipkit_chatUI_attachFileUploadInputListener(n,e,i,a),window.aipkit_chatUI_attachPlayButtonListener(n,e,i,a)}window.aipkit_chatUI_attachEventListeners=l})();(function(){"use strict";function l(n,e,i,a,t,o,r,s,u,p,c,d){let{messagesEl:_}=a,f=i.text||{};if(!i.ajaxUrl||!e||!i.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof o=="function"&&o(f.errorPrefix+" "+(f.connError||"Configuration error (API)."),!1),typeof r=="function"&&r();return}let w={message:n};s&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&(w.frontend_web_search_active=!0),u&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&(w.frontend_google_search_grounding_active=!0),p&&(w.image_inputs=JSON.stringify([p]));let h={...i};if(c&&(h.activeFileContext=c,c.provider==="OpenAI"&&c.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${c.vector_store_id}`):c.provider==="Pinecone"&&c.index_name&&c.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${c.index_name}, Namespace: ${c.namespace}`):c.provider==="Qdrant"&&c.collection_name&&c.file_upload_context_id?console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${c.collection_name}, Context ID: ${c.file_upload_context_id}`):c.provider==="Claude"&&c.file_id&&console.log(`AIPKit Chat AJAX (sender): Adding Claude file context to request config: File ID: ${c.file_id}`)),window.aipkit_chatUI_showTypingIndicator(_,i),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof o=="function"&&o("Internal script error.",!1),typeof r=="function"&&r();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",w,h).then(m=>{if(window.aipkit_chatUI_removeTypingIndicator(_),m?.reply)i.provider==="OpenAI"&&i.enableOpenAIConversationState&&m.openai_response_id&&(window.aipkit_current_openai_response_id=m.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",m.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${m.openai_response_id}`)),typeof t=="function"&&(t(m.reply,m.message_id||null,m.openai_response_id||null,m.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(_,!0));else{let g=m?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,g,m),typeof o=="function"&&o(`${f.errorPrefix||"Error:"} ${g}`,!1)}}).catch(m=>{window.aipkit_chatUI_removeTypingIndicator(_);let g=`${f.errorPrefix||"Error:"} ${f.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,m),typeof o=="function"&&o(g+(m.message?` (${m.message})`:""),!0)}).finally(()=>{typeof r=="function"&&r()})}window.aipkit_chatUI_sendMessage=l})();(function(){"use strict";function l(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t===0&&(i.dataset.aipkitScrollLockOverflow=i.style.overflow||"",i.dataset.aipkitScrollLockOverflowX=i.style.overflowX||"",i.dataset.aipkitScrollLockOverflowY=i.style.overflowY||"",i.dataset.aipkitScrollLockHtmlOverflow=a.style.overflow||"",i.dataset.aipkitScrollLockHtmlOverflowX=a.style.overflowX||"",i.dataset.aipkitScrollLockHtmlOverflowY=a.style.overflowY||"",i.style.overflow="hidden",i.style.overflowX="hidden",i.style.overflowY="hidden",a.style.overflow="hidden",a.style.overflowX="hidden",a.style.overflowY="hidden"),i.dataset.aipkitScrollLockCount=String(t+1)}function n(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t<=1?(i.style.overflow=i.dataset.aipkitScrollLockOverflow||"",i.style.overflowX=i.dataset.aipkitScrollLockOverflowX||"",i.style.overflowY=i.dataset.aipkitScrollLockOverflowY||"",a.style.overflow=i.dataset.aipkitScrollLockHtmlOverflow||"",a.style.overflowX=i.dataset.aipkitScrollLockHtmlOverflowX||"",a.style.overflowY=i.dataset.aipkitScrollLockHtmlOverflowY||"",delete i.dataset.aipkitScrollLockOverflow,delete i.dataset.aipkitScrollLockOverflowX,delete i.dataset.aipkitScrollLockOverflowY,delete i.dataset.aipkitScrollLockHtmlOverflow,delete i.dataset.aipkitScrollLockHtmlOverflowX,delete i.dataset.aipkitScrollLockHtmlOverflowY,delete i.dataset.aipkitScrollLockCount):i.dataset.aipkitScrollLockCount=String(t-1)}function e(i,a,t){let{container:o,fullscreenButton:r,messagesEl:s,inputField:u,startersContainer:p}=i,c=t.text||{};if(!o||!r){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}a.isFullscreen=!a.isFullscreen;let d=!!o.closest("#aipkit_admin_chat_preview_container");if(a.isFullscreen){if(!a.fullscreenPlaceholder){let h=document.createElement("div");h.id=`aipkit_fs_placeholder_${o.id}`,h.style.display="none",o.parentNode.insertBefore(h,o),a.fullscreenPlaceholder=h}document.body.appendChild(o),o.classList.add("aipkit-fullscreen"),d||l()}else o.classList.remove("aipkit-fullscreen"),a.fullscreenPlaceholder&&a.fullscreenPlaceholder.parentNode?(a.fullscreenPlaceholder.parentNode.insertBefore(o,a.fullscreenPlaceholder),a.fullscreenPlaceholder.remove(),a.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position."),d||n();let _=o.closest(".aipkit_popup_wrapper");_&&_.classList.toggle("aipkit-fullscreen-wrapper",a.isFullscreen);let f='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-maximize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 4l4 0l0 4" /><path d="M14 10l6 -6" /><path d="M8 20l-4 0l0 -4" /><path d="M4 20l6 -6" /><path d="M16 20l4 0l0 -4" /><path d="M14 14l6 6" /><path d="M8 4l-4 0l0 4" /><path d="M4 4l6 6" /></svg>',w='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-minimize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9l4 0l0 -4" /><path d="M3 3l6 6" /><path d="M5 15l4 0l0 4" /><path d="M3 21l6 -6" /><path d="M19 9l-4 0l0 -4" /><path d="M15 9l6 -6" /><path d="M19 15l-4 0l0 4" /><path d="M15 15l6 6" /></svg>';if(r.innerHTML=a.isFullscreen?w:f,r.title=a.isFullscreen?c.exitFullscreen||"Exit Fullscreen":c.fullscreen||"Fullscreen",r.setAttribute("aria-label",r.title),r.setAttribute("aria-expanded",a.isFullscreen.toString()),a.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(s,!0),u&&setTimeout(()=>u.focus(),50),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&s){let h=s.querySelector(".aipkit_initial_greeting");h&&window.aipkit_chatUI_triggerMessageAnimation(h)}typeof window.aipkit_chatUI_refreshStartersAnimation=="function"&&p&&window.aipkit_chatUI_refreshStartersAnimation(p)}window.aipkit_chatUI_toggleFullscreen=e})();(function(){"use strict";function l(n,e,i,a,t){let{state:o,elements:r,config:s,setButtonStateAction:u,handleError:p,generateClientMessageId:c,focusInputAction:d}=t,{inputField:_,voiceInputButton:f,messagesEl:w,container:h}=r;o.isSending=!0,_.disabled=!0,f&&(f.disabled=!0),u("sending",!0,o);let m=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?m=window.aipkit_chatUI_showImageLoadingIndicator(w,s):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(w,s));let g={prompt:n,original_user_text:e,user_message_id:i};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),p("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(w,m),o.isSending=!1,_.disabled=s.requireConsentCompliance&&!o.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!o.consentGiven),u("send",!1,o),(!s.requireConsentCompliance||o.consentGiven)&&d();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",g,s).then(k=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,m):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),k?.type==="image"&&k.images&&k.images.length>0){let b={type:"image",images:k.images,prompt:n};window.aipkit_chatUI_appendMessage(w,b,"bot",s,!1,!1,k.message_id,!0),h?h.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:k.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:a}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let b=k?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${b}`,k),p(`Image generation failed: ${b}`,!1,!0)}}).catch(k=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,m):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),p("Image generation failed: "+(k.message||"Unknown error"),!1,!0)}).finally(()=>{o.isSending=!1,_.disabled=s.requireConsentCompliance&&!o.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!o.consentGiven),u("send",!1,o),(!s.requireConsentCompliance||o.consentGiven)&&d()})}window.aipkit_chatUI_handleImageGeneration=l})();(function(){"use strict";function l(n,e,i,a){let t=n.toLowerCase(),o=i&&i.ipsList?i.ipsList.split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(e&&o.length>0&&o.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:i.message||"Access from your IP address has been blocked."};let r=a&&a.wordsList?a.wordsList.toLowerCase().split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(r.length>0){let s=r.find(u=>t.includes(u));if(s)return console.warn(`AIPKit Moderation: Banned word detected: "${s}"`),{type:"banned_word",message:a.message||"Sorry, your message could not be sent as it contains prohibited words.",word:s}}return null}window.aipkit_checkMessageModeration=l})();(function(){"use strict";function l(t){return t?t.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function n(t){t&&(t.classList.add("aipkit_hidden"),t.classList.remove("aipkit_starters_ready"))}function e(t){t&&(t.classList.remove("aipkit_hidden"),i(t))}function i(t){!t||t.classList.contains("aipkit_hidden")||(t.classList.remove("aipkit_starters_ready"),t.offsetHeight,requestAnimationFrame(()=>{t.classList.contains("aipkit_hidden")||t.classList.add("aipkit_starters_ready")}))}function a(t,o,r,s,u,p){let{startersContainer:c,messagesEl:d,inputField:_}=r,f=o.botId,w=o.starters||[];if(!t||!o||!c||!d||!_){console.error(`AIPKit Starters (${f}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof s!="function"){console.error(`AIPKit Starters (${f}): sendMessageActionCallback is not a function.`),n(c);return}if(typeof p!="function"){console.error(`AIPKit Starters (${f}): isConsentGivenFunc is not a function.`),n(c);return}if(w.length===0){n(c);return}c.innerHTML="",w.forEach((g,k)=>{if(typeof g=="string"&&g.trim()!==""){let b=document.createElement("button");b.type="button",b.className="aipkit_starter_btn",b.textContent=g.trim(),b.style.setProperty("--aipkit-starter-index",String(k)),b.addEventListener("click",y=>{if(y.preventDefault(),u&&!p()){console.warn(`AIPKit Starters (${f}): Starter clicked, but consent not given.`);return}let I=b.textContent;s(I),n(c)}),c.appendChild(b)}});let h=()=>{if(u&&!p()){n(c);return}l(d)?e(c):n(c)},m=()=>n(c);t.addEventListener("aipkit:messageSent",m),t.addEventListener("aipkit:messageReceived",m),t.addEventListener("aipkit:messageError",m),t.addEventListener("aipkit:chatCleared",h),t.addEventListener("aipkit:chatLoaded",h),t.addEventListener("aipkit:consentGiven",()=>{h()}),h()}window.aipkit_initConversationStarters=a,window.aipkit_chatUI_refreshStartersAnimation=i})();function pe(l,n){let e=window.aipkit_chatUI_findElements(l,n);if(!e){let r=l.querySelector(".aipkit_chat_container")||l;return r&&(r.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot UI error (DOM elements missing).</p>'),null}let i=n.botId,a=window.aipkit_chatUI_initState(n);a.consentUIInstance=null;let t={setButtonStateAction:(r,s=!1)=>window.aipkit_chatUI_setButtonStateAction(r,e,n,a,s),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,n,a),sendMessageAction:(r=null)=>window.aipkit_chatUI_sendMessageAction(e,n,a,t,r),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,n,a,t),handleError:(r,s,u=!0)=>window.aipkit_chatUI_handleError(r,s,u,e,n,a,t),handleCompletion:(r,s=!1)=>window.aipkit_chatUI_handleCompletion(r,s,e,n,a,t),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,a,n),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,n),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,n),handlePlayAction:r=>window.aipkit_handlePlayAction(r)};if(n.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?a.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,n,a,()=>{e.inputField.disabled=!1,t.setButtonStateAction("send",!1),t.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):n.requireConsentCompliance&&console.error(`AIPKit Chat Main (${i}): Consent required, but aipkit_initConsentUI function not found.`),n.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but input or preview elements were not found/created by findElements.`):n.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,n,a):(console.error(`AIPKit Chat Main (${i}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.style.display="none"),e.inputActionMenu&&(e.inputActionMenu.style.display="none")),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,n,a,t):console.error(`AIPKit Chat Main (${i}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,n):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),typeof window.aipkit_chatUI_initScrollToBottomButton=="function"?window.aipkit_chatUI_initScrollToBottomButton(e,n,a):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initScrollToBottomButton missing; scroll button won't render.`),n.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let r=a.consentUIInstance?a.consentUIInstance.isConsentGiven:()=>!n.requireConsentCompliance||a.consentGiven;window.aipkit_initConversationStarters(l,n,e,t.sendMessageAction,n.requireConsentCompliance,r)}else n.enableStarters&&console.warn(`AIPKit Chat Main (${i}): Starters enabled but container or init function missing.`);n.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(l,e,n,t):n.enableSidebar&&console.warn(`AIPKit Chat Main (${i}): Sidebar enabled but elements or init function missing.`);let o={openPopup:n.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(l,e.messagesEl,e.inputField,a):()=>{},closePopup:n.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(l,a):()=>{},setupPopupHandlers:n.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?r=>window.aipkit_chatUI_setupPopupHandlers(l,r,e.messagesEl,e.inputField,a,n):()=>{},isPopupOpen:()=>a.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:t.sendMessageAction,clearChat:t.clearChatAction,toggleFullscreen:t.toggleFullscreenAction};return n.enableRealtimeVoiceUI&&typeof window.aipkit_initRealtimeVoiceAgent=="function"?window.aipkit_initRealtimeVoiceAgent(e,n,a,t,o):n.enableRealtimeVoiceUI&&console.error(`AIPKit Chat Main (${i}): Realtime Voice enabled but aipkit_initRealtimeVoiceAgent function not found.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,n):console.error(`AIPKit Chat Main (${i}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,n,a,t):console.error(`AIPKit Chat Main (${i}): finalizeSetup function not found.`),{publicApi:o,internalElements:e,internalActions:t}}window.aipkit_setupChatInstanceUI=pe;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let l=localStorage.getItem("aipkit_guest_uuid");l||(l=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,i=>(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",l)),window.aipkit_guest_uuid=l,window.aipkit_regenerateConversationUUID=function(){let i=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16));return sessionStorage.setItem("aipkit_current_conversation_uuid",i),window.aipkit_current_conversation_uuid=i,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),i},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(i){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'\\"').replace(/'/g,"'")})(i).replace(/\n/g,"<br>")}});function n(i){if(!i||i.classList.contains("aipkit-initializing")||i.classList.contains("aipkit-initialized"))return;i.classList.add("aipkit-initializing");let a=i.getAttribute("data-bot-id"),t=i.getAttribute("data-config"),o=null;try{t&&(o=JSON.parse(t),a&&(o.botId=a))}catch(p){console.error(`AIPKit Chat Init (${a||"Unknown"}): Failed to parse configuration.`,p,t);let c=i.querySelector(".aipkit_chat_container")||i;c.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',i.classList.remove("aipkit-initializing");return}if(!o){console.error(`AIPKit Chat Init (${a||"Unknown"}): Config object is null after parse attempt.`,i);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot config load error.</p>',i.classList.remove("aipkit-initializing");return}if(!o.botId&&a&&(o.botId=a),window.aipkit_current_post_id=o.postId||0,o.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"));else{let p=sessionStorage.getItem("aipkit_current_conversation_uuid"),c=sessionStorage.getItem("aipkit_current_openai_response_id");if(p){if(window.aipkit_current_conversation_uuid=p,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=c||null,window.aipkit_current_openai_response_id)try{let d=localStorage.getItem(`aipkit_file_context_${p}`);if(d){let _=JSON.parse(d),f=!1;_&&_.provider&&(_.provider==="OpenAI"&&_.vector_store_id||_.provider==="Pinecone"&&_.index_name&&_.namespace||_.provider==="Qdrant"&&_.collection_name&&_.file_upload_context_id||_.provider==="Claude"&&_.file_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:_}))):(console.warn(`AIPKit Chat Init (${o.botId}): Invalid file context data in localStorage for conv ${p}. Clearing. Data:`,_),localStorage.removeItem(`aipkit_file_context_${p}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(d){console.error("AIPKit Chat Init: Error loading file context from localStorage:",d),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${o.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot script error.</p>',i.classList.remove("aipkit-initializing");return}let r=i.classList.contains("aipkit_chat_container")?i:i.querySelector(".aipkit_chat_container");if(!r){console.error(`AIPKit Chat Init (${o.botId}): Chat container element not found within wrapper.`,i),i.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot structure error.</p>',i.classList.remove("aipkit-initializing");return}if(o.guestUUID=window.aipkit_guest_uuid,o.conversationUUID=window.aipkit_current_conversation_uuid,o.previousOpenAIResponseId=window.aipkit_current_openai_response_id,o.activeFileContextProvider=window.aipkit_active_file_context_provider,o.activeFileContextData=window.aipkit_active_file_context_data,!o.botId||!o.ajaxUrl||!o.text||!o.guestUUID){console.error(`AIPKit Chat Init (${o.botId||"Unknown"}): Missing essential configuration.`,o,i);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',i.classList.remove("aipkit-initializing");return}typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&o.theme==="custom"&&o.customThemeSettings&&Object.keys(o.customThemeSettings).length>0?window.aipkit_chatUI_applyCustomThemeStyles(r,o.customThemeSettings):o.theme==="custom"&&console.warn(`AIPKit Chat Init (${o.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let s=aipkit_setupChatInstanceUI(r,o);if(!s||!s.publicApi||!s.internalElements||!s.internalActions){console.error(`AIPKit Chat Init (${o.botId}): Failed to set up UI instance or get all necessary parts.`),i.classList.remove("aipkit-initializing");return}let u=s.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[r.id]={instance:u,elements:s.internalElements,actions:s.internalActions},o.popupEnabled){let p=i.querySelector(".aipkit_popup_trigger");if(!p){console.error(`AIPKit Chat Init (${o.botId}): Popup trigger button not found.`),i.classList.remove("aipkit-initializing");return}if(u.setupPopupHandlers){u.setupPopupHandlers(p);let c=o.popupDelay;c>0&&!o.directVoiceMode&&!i.dataset.aipkitAutoOpened&&(i.dataset.aipkitAutoOpened="true",setTimeout(()=>{u&&u.isPopupOpen&&!u.isPopupOpen()&&u.openPopup()},c*1e3))}else console.error(`AIPKit Chat Init (${o.botId}): setupPopupHandlers method missing in UI instance.`)}i.classList.remove("aipkit-initializing"),i.classList.add("aipkit-initialized")}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(t=>{t.closest(".aipkit_popup_wrapper")||n(t)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(n)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let i=new MutationObserver(a=>{let t=!1;a.forEach(o=>{o.addedNodes&&o.addedNodes.forEach(r=>{r.nodeType===1&&(r.matches&&(r.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||r.matches(".aipkit_popup_wrapper")||r.matches('[id^="aipkit-chatbot-container-"]'))||r.querySelector&&r.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper, [id^='aipkit-chatbot-container-']"))&&(t=!0)})}),t&&(i.scanTimeout&&clearTimeout(i.scanTimeout),i.scanTimeout=setTimeout(e,50))});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=n})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function l(n,e,i){let a=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:u=>u,t=new FormData;t.append("action","aipkit_cache_sse_message"),t.append("_ajax_nonce",i);let o={stream_context:"ai_forms",form_id:n,user_input_values:e};t.append("message",JSON.stringify(o));let r=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"});if(!r.ok){let u=await r.json().catch(()=>({}));throw new Error(u?.data?.message||`HTTP error ${r.status}`)}let s=await r.json();if(s.success&&s.data?.cache_key)return s.data.cache_key;throw new Error(s.data?.message||a("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=l})();(function(){"use strict";function l(n,e){let i=window.aipkitAIFormsPublicState,a=n?n.closest(".aipkit-ai-form-wrapper"):null,t=n?n.querySelector(".aipkit_btn-text"):null,o=n?n.querySelector(".aipkit_spinner"):null,r=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:c=>c,s=null,u=()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-danger"),n.classList.add("aipkit_btn-primary"),t&&(t.textContent=e),s&&(n.removeEventListener("click",s),s=null)),o&&(o.style.display="none")};return{restoreGenerateButton:u,setupStopButton:()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-primary"),n.classList.add("aipkit_btn-danger"),t&&(t.textContent=a.dataset.labelStopButton||r("Stop","gpt3-ai-content-generator")),s=c=>{c.preventDefault(),c.stopPropagation(),i.currentAIFormEventSource&&(i.currentAIFormEventSource.close(),i.currentAIFormEventSource=null),u()},n.addEventListener("click",s,{once:!0}))}}}window.aipkitForms_createSseUiManager=l})();(function(){"use strict";function l(n){let e=n.elements,i=!1,a=null,t={},o={};for(let r of e){if(!r.name)continue;let s=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!s||!s[1])continue;let u=s[1];s[2]==="[]"?(t[u]||(t[u]=[]),r.checked&&t[u].push(r.value)):r.type==="radio"?r.checked&&(t[u]=r.value):t[u]=r.value}for(let r of e){let s=r.closest("fieldset");if(s){let _=s.querySelector("legend");_&&(_.style.color="")}else r.style.borderColor="";if(!(r.required||r.dataset&&r.dataset.isRequired==="true"))continue;let p=!1,c=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!c||!c[1])continue;let d=c[1];if(!o[d]&&(r.type==="checkbox"?(p=!t[d]||t[d].length===0,o[d]=!0):r.type==="radio"?(p=!t[d],o[d]=!0):(r.classList.contains("aipkit-file-hidden-content")||r.type!=="file"&&r.type!=="submit"&&r.type!=="button")&&(p=r.value.trim()===""),p)){i=!0;let _=r;if(r.type==="radio"||r.type==="checkbox"?_=r.closest("fieldset"):r.classList.contains("aipkit-file-hidden-content")&&(_=n.querySelector(`.aipkit-file-upload-input[data-field-id="${d}"]`)),a||(a=_),_?.type!=="checkbox"&&_?.type!=="radio"&&_)_.style.borderColor="red";else if(_){let f=_.querySelector("legend");f&&(f.style.color="red")}}}return{isValid:!i,userInputs:t,firstInvalidField:a}}window.aipkitForms_validateSseInputs=l})();(function(){"use strict";let l=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function n(e,i){let a=window.aipkitAIFormsPublicState,t="",o=!0,r='<div class="aipkit-ai-form-results-top-actions"></div>',s='<div class="aipkit-ai-form-results-footer-actions"></div>',u=_=>`<div class="aipkit-ai-form-results-content">${_}</div>`;return{onMessageHandler:_=>{o&&(e.style.display="block",e.innerHTML=r+u("")+s,o=!1);let f=JSON.parse(_.data),w=e.querySelector(".aipkit-ai-form-results-content");f.delta&&w&&(t+=f.delta,a.mdInstanceAIForms?w.innerHTML=a.mdInstanceAIForms.render(t):w.innerHTML=t.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:_=>{a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i();let f=e.querySelector(".aipkit-ai-form-results-content");a.mdInstanceAIForms&&f?f.innerHTML=a.mdInstanceAIForms.render(t):f&&(f.innerHTML=t.replace(/\n/g,"<br />"));let w=e.querySelector(".aipkit-ai-form-results-top-actions"),h=e.querySelector(".aipkit-ai-form-results-footer-actions");if(t.trim()!==""&&w&&h){let m=e.closest(".aipkit-ai-form-wrapper"),g=m.dataset.showSaveButton==="true",k=m.dataset.pdfDownloadEnabled==="true",b=m.dataset.showCopyButton==="true",y=window.aipkit_ai_forms_public_config||{},I=y.is_user_logged_in,A=document.createElement("button");if(A.type="button",A.className="aipkit-copy-results-btn",A.title=l("Copy Results","gpt3-ai-content-generator"),A.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&A.addEventListener("click",window.aipkitForms_handleCopyAction),w.appendChild(A),A.style.display="inline-flex",g&&I){let S=m.dataset.labelSaveButton||y.text?.saveAsPost||l("Save","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",v.innerHTML=`<span class="aipkit_btn-text">${S}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&v.addEventListener("click",window.aipkitForms_handleSaveAsPost),h.appendChild(v),v.style.display="inline-flex"}if(k&&typeof window.aipkitForms_handleDownloadPdf=="function"){let S=m.dataset.labelDownloadButton||l("Download","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",v.innerHTML=`<span class="aipkit_btn-text">${S}</span>`,v.addEventListener("click",window.aipkitForms_handleDownloadPdf),h.appendChild(v),v.style.display="inline-flex"}if(b){let S=m.dataset.labelCopyButton||l("Copy","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",v.innerHTML=`<span class="aipkit_btn-text">${S}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&v.addEventListener("click",window.aipkitForms_handleCopyAction),h.appendChild(v),v.style.display="inline-flex"}}},onErrorHandler:_=>{if(a.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",_);let f=l(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(_.data)try{let h=JSON.parse(_.data);h.error&&(f=h.error)}catch{}if(e.style.display="block",t.trim()!==""){let h=e.querySelector(".aipkit-ai-form-error");if(!h){h=document.createElement("div"),h.className="aipkit-ai-form-error";let m=e.querySelector(".aipkit-ai-form-results-footer-actions");m&&m.parentNode?m.parentNode.insertBefore(h,m.nextSibling):e.appendChild(h)}h.textContent=f}else e.innerHTML=`<p style="color:red;">${f}</p>`;a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i()}}}window.aipkitForms_createSseEventHandlers=n})();(function(){"use strict";async function l(n,e,i,a,t){let o=window.aipkitAIFormsPublicState,r=await window.aipkit_cacheAIFormMessage(n,e,i),s=new URL(aipkit_ai_forms_public_config.ajaxUrl);s.searchParams.append("action","aipkit_frontend_chat_stream"),s.searchParams.append("cache_key",r),s.searchParams.append("_ajax_nonce",i),window.aipkit_guest_uuid&&s.searchParams.append("session_id",window.aipkit_guest_uuid),o.currentAIFormEventSource=new EventSource(s.toString());let{onMessageHandler:u,onDoneHandler:p,onErrorHandler:c}=window.aipkitForms_createSseEventHandlers(a,t);o.currentAIFormEventSource.onmessage=u,o.currentAIFormEventSource.addEventListener("done",p),o.currentAIFormEventSource.onerror=c}window.aipkitForms_setupAndStartEventSource=l})();(function(){"use strict";function l(i,a,t="info"){if(!i)return;let o=window.aipkit_escapeHtml||function(r){return r};i.innerHTML=o(a),i.className=`aipkit-file-upload-status aipkit-status-${t}`}function n(i){if(!i)return;let a=i.querySelector(".aipkit-file-upload-input"),t=i.querySelector(".aipkit-file-upload-status"),o=i.querySelector(".aipkit-file-remove-btn"),r=i.querySelector(".aipkit-file-hidden-content"),s=i.querySelector(".aipkit-file-status-wrapper");a&&(a.value="",a.style.display="block"),t&&(t.innerHTML="",t.className="aipkit-file-upload-status"),o&&(o.style.display="none"),s&&(s.style.display="none"),r&&(r.value="",r.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(i){let a=i.target,t=a.closest(".aipkit_form_group-file-upload");if(!t)return;let o=a.files[0],r=t.querySelector(".aipkit-file-status-wrapper"),s=t.querySelector(".aipkit-file-upload-status"),u=t.querySelector(".aipkit-file-remove-btn"),p=t.querySelector(".aipkit-file-hidden-content"),c=a.closest("form").querySelector('button[type="submit"]'),d=t.dataset.nonce,_=window.aipkit_ai_forms_public_config.ajaxUrl,f=window.wp?.i18n?.__||(g=>g),w=window.aipkit_escapeHtml||function(g){return g};if(!o){n(t);return}if(!["text/plain","application/pdf"].includes(o.type)){l(s,f("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),n(t);return}if(o.size>20*1024*1024){l(s,f("File is too large (max 20MB).","gpt3-ai-content-generator"),"error"),n(t);return}l(s,f("Uploading & processing...","gpt3-ai-content-generator"),"info"),r&&(r.style.display="flex"),c&&(c.disabled=!0);let m=new FormData;m.append("action","aipkit_ai_form_upload_and_parse_file"),m.append("_ajax_nonce",d),m.append("file",o);try{let g=await fetch(_,{method:"POST",body:m,credentials:"same-origin"}),k=await g.json();if(!g.ok||!k.success)throw new Error(k.data?.message||f("Failed to process file.","gpt3-ai-content-generator"));if(typeof k.data.text=="string")p.value=k.data.text,p.dispatchEvent(new Event("change",{bubbles:!0})),l(s,`\u2705 ${w(o.name)}`,"success"),a.style.display="none",u&&(u.style.display="inline-flex"),r&&(r.style.display="flex"),c&&(c.disabled=!1);else throw new Error(f("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(g){l(s,g.message,"error"),n(t),c&&(c.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=n})();(function(){"use strict";function l(i){let a=i.innerHTML;i.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',i.disabled=!0,setTimeout(()=>{i.innerHTML=a,i.disabled=!1},1500)}function n(i){let a=i.currentTarget,t=a.closest(".aipkit-ai-form-results");if(!t)return;let o=t.cloneNode(!0),r=o.querySelector(".aipkit-copy-results-btn");r&&r.remove();let s=o.innerText||o.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s).then(()=>{l(a)}).catch(u=>{console.error("Failed to copy text using Clipboard API: ",u),e(s,a)}):e(s,a)}function e(i,a){let t=document.createElement("textarea");t.value=i,t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),l(a)}catch(o){console.error("Fallback copy failed: ",o),alert("Failed to copy content.")}document.body.removeChild(t)}window.aipkitForms_handleCopyAction=n})();(function(){"use strict";async function l(n){let e=n.currentTarget,i=e.closest(".aipkit-ai-form-wrapper");if(!i)return;let a=i.querySelector(".aipkit-ai-form-results"),t=i.querySelector("h5.aipkit-ai-form-title"),o=i.dataset.saveAsPostNonce,r=a?a.querySelector(".aipkit-ai-form-results-content"):null;if(!r||!t){console.error("AI Forms Save: Missing results content container or title element.");return}let s=window.aipkit_ai_forms_public_config||{},u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:f=>f,p=t.textContent.trim(),c=r.innerHTML,d=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let _={action:"aipkit_ai_form_save_as_post",_ajax_nonce:o,post_title:p,post_content:c};try{let f=new FormData;for(let g in _)f.append(g,_[g]);let w=await fetch(s.ajaxUrl,{method:"POST",body:f,credentials:"same-origin"}),h=await w.json();if(!w.ok||!h.success)throw new Error(h.data?.message||u("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let m=null;h.data.edit_link&&(m=document.createElement("a"),m.href=h.data.edit_link,m.innerHTML='<span class="dashicons dashicons-external"></span>',m.title=u("Edit Post","gpt3-ai-content-generator"),m.target="_blank",m.rel="noopener noreferrer",m.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),m.style.marginLeft="10px",e.parentNode.insertBefore(m,e.nextSibling)),setTimeout(()=>{e.innerHTML=d,e.disabled=!1,m&&m.parentNode&&m.remove()},5e3)}catch(f){console.error("Failed to save post:",f),alert(`${u("Error saving post:","gpt3-ai-content-generator")} ${f.message}`),e.innerHTML=d,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=l})();(function(){"use strict";async function l(n){n.preventDefault(),n.stopPropagation();let e=window.aipkitAIFormsPublicState,i=n.target,a=i.closest(".aipkit-ai-form-wrapper");if(!a)return;let t=a.dataset.formId,o=aipkit_ai_forms_public_config.ajaxNonce,r=a.querySelector(".aipkit-ai-form-results"),s=i.querySelector('button[type="submit"]'),u=s?s.querySelector(".aipkit_spinner"):null,p=s?s.querySelector(".aipkit_btn-text"):null,c=a.dataset.labelGenerateButton||"Generate",d=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:h=>h;if(!t||!o||!r||!s){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),r&&(r.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:_,setupStopButton:f}=window.aipkitForms_createSseUiManager(s,c);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),r.innerHTML="",r.style.display="none",s&&(s.disabled=!0),u&&(u.style.display="inline-block");let w=window.aipkitForms_validateSseInputs(i);if(!w.isValid){if(w.firstInvalidField)if(w.firstInvalidField.type!=="checkbox")w.firstInvalidField.style.borderColor="red";else{let h=w.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");h&&(h.style.color="red")}r.style.display="block",r.innerHTML=`<p style="color:orange;">${d("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,s&&(s.disabled=!1),u&&(u.style.display="none");return}f();try{await window.aipkitForms_setupAndStartEventSource(t,w.userInputs,o,r,_)}catch(h){console.error("AI Form Submission Error (SSE Setup):",h),r.innerHTML=`<p style="color:red;">${h.message||d(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,_()}}window.aipkit_handleFormSubmitSSE=l})();(function(){"use strict";function l(i,a){let t=window.aipkit_ai_forms_models||{},o=window.aipkit_ai_forms_public_config||{},r=i.toLowerCase(),s=t[r]||[],u=a.dataset.currentValue||"";if(o.allowed_models&&o.allowed_models.trim()!==""){let c=new Set(o.allowed_models.split(",").map(d=>d.trim()));if(Array.isArray(s))s=s.filter(d=>c.has(d.id));else{let d={};for(let _ in s){let f=s[_].filter(w=>c.has(w.id));f.length>0&&(d[_]=f)}s=d}}if(a.innerHTML="",!s||Array.isArray(s)&&s.length===0||!Array.isArray(s)&&Object.keys(s).length===0){let c=new Option("No models available for this provider.","");a.appendChild(c);return}let p=!1;if(Array.isArray(s))s.forEach(c=>{let d=new Option(c.name,c.id);c.id===u&&(d.selected=!0,p=!0),a.appendChild(d)});else{let c=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],d=Object.keys(s);c.filter(f=>d.includes(f)).concat(d.filter(f=>!c.includes(f)).sort()).forEach(f=>{let w=document.createElement("optgroup");w.label=f,s[f].forEach(h=>{let m=new Option(h.name,h.id);h.id===u&&(m.selected=!0,p=!0),w.appendChild(m)}),a.appendChild(w)})}if(!p&&u){let c=new Option(`${u} (Manual)`,u,!1,!0);a.insertBefore(c,a.firstChild)}if(a.selectedIndex===-1&&a.options.length>0){let c=a.querySelector("optgroup");c&&c.options.length>0?a.value=c.options[0].value:a.options[0].value&&(a.selectedIndex=0)}}function n(i){let a=i.querySelector(".aipkit_aiform_provider_select"),t=i.querySelector(".aipkit_aiform_model_select");if(t)if(a)l(a.value,t),a.addEventListener("change",function(){l(this.value,t)});else{let o=t.dataset.provider;o?l(o,t):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let i=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(t=>{n(t);let o=t.querySelector("form.aipkit-ai-form-main");o&&!o.dataset.sseInitialized&&(o.addEventListener("submit",window.aipkit_handleFormSubmitSSE),o.dataset.sseInitialized="true"),o&&!o.dataset.fileUploadInitialized&&(o.addEventListener("change",r=>{r.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(r)}),o.addEventListener("click",r=>{if(r.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let s=r.target.closest(".aipkit_form_group-file-upload");s&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(s)}}),o.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?i.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),i.mdInstanceAIForms={render:function(t){return(window.aipkit_escapeHtml||function(r){return r})(t).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function l(n,e,i){let a=n.querySelector(`#${e}`);if(a&&a.offsetParent!==null)return a.value;{let t=n.querySelector(`input[type="hidden"][name="${i}"]`);return t?t.value:null}}window.aipkit_getSettingValue=l})();(function(){"use strict";let l={image_output:!0,image_generation:!0};function n(i){if(!i||typeof i!="object")return!1;let a=i.capabilities;if(!a||typeof a!="object")return!0;let t={...l,...a};return!!(t.image_output||t.image_generation)}function e(i,a,t){if(!a)return;a.innerHTML="";let o=[],r=window.aipkit_image_generator_config_public||{},s=i.toLowerCase(),u=t?new Set(t.split(",").map(c=>c.trim().toLowerCase())):null;if(s==="openai"&&r.openai_models?o=r.openai_models||[]:s==="openrouter"&&r.openrouter_image_models?o=(r.openrouter_image_models||[]).filter(c=>n(c)):s==="google"&&r.google_models?o=r.google_models||{}:s==="azure"&&r.azure_models?o=r.azure_models||[]:s==="replicate"&&r.replicate_models&&(o=r.replicate_models||[]),u&&!u.has(s))if(o.image||o.video){let c={};o.image&&Array.isArray(o.image)&&(c.image=o.image.filter(d=>u.has(d.id))),o.video&&Array.isArray(o.video)&&(c.video=o.video.filter(d=>u.has(d.id))),o=c}else Array.isArray(o)&&(o=o.filter(c=>u.has(c.id)));else u&&u.has(s);if(o.image&&o.image.length>0||o.video&&o.video.length>0||Array.isArray(o)&&o.length>0){if(s==="openai")o.sort((c,d)=>{let _={"gpt-image-1.5":1,"gpt-image-1":2,"gpt-image-1-mini":3,"dall-e-3":4,"dall-e-2":5};return(_[c.id]||99)-(_[d.id]||99)}),o.forEach(c=>{a.appendChild(new Option(c.name,c.id))});else if(s==="openrouter")o.sort((c,d)=>(c.name||c.id||"").localeCompare(d.name||d.id||"")),o.forEach(c=>{let d=new Option(c.name||c.id,c.id);c.capabilities&&typeof c.capabilities=="object"&&(d.dataset.capabilities=JSON.stringify(c.capabilities)),a.appendChild(d)});else if(s==="azure")o.forEach(c=>{let d=c.name||c.id;a.appendChild(new Option(d,c.id))});else if(s==="google"){if(o.image&&o.image.length>0){let c=document.createElement("optgroup");c.label="Image Models",o.image.sort((d,_)=>{let f=(d.name||d.id||"").toString().toLowerCase(),w=(_.name||_.id||"").toString().toLowerCase();return f.localeCompare(w)}),o.image.forEach(d=>{c.appendChild(new Option(d.name,d.id))}),a.appendChild(c)}if(o.video&&o.video.length>0){let c=document.createElement("optgroup");c.label="Video Models",o.video.forEach(d=>{c.appendChild(new Option(d.name,d.id))}),a.appendChild(c)}}else if(s==="replicate"){let c={};o.forEach(_=>{if(_&&_.name){let f=_.name.split("/"),w=f.length>1?f[0]:"other";c[w]||(c[w]=[]),c[w].push(_)}}),Object.keys(c).sort().forEach(_=>{let f=document.createElement("optgroup");f.label=_,c[_].sort((w,h)=>(w.name||"").localeCompare(h.name||"")),c[_].forEach(w=>{let h=w.name.replace(_+"/",""),m=new Option(h,w.id);f.appendChild(m)}),a.appendChild(f)})}a.disabled=!1,a.selectedIndex===-1&&(a.selectedIndex=0)}else{let c=s==="openrouter"?"(No image-capable OpenRouter models found)":"(No models available)";a.appendChild(new Option(c,"")),a.disabled=!0}}window.aipkit_populatePublicModelsForProvider=e})();(function(){"use strict";function l(n){let e=n.target.closest(".aipkit-image-history-delete-btn");if(!e)return;n.preventDefault(),n.stopPropagation();let i=e.dataset.attachmentId;if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,o=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!t||!o){alert("Error: Cannot delete image. Configuration missing.");return}let r=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let s=new FormData;s.append("action","aipkit_delete_generated_image"),s.append("_ajax_nonce",o),s.append("attachment_id",i),fetch(t,{method:"POST",body:s,credentials:"same-origin"}).then(u=>u.json()).then(u=>{if(!u.success)throw new Error(u.data?.message||"Deletion failed.");let p=e.closest(".aipkit-image-history-item");p&&(p.style.transition="opacity 0.3s",p.style.opacity="0",setTimeout(()=>{p.remove();let c=p.closest(".aipkit_image_history_section"),d=c?c.querySelector(".aipkit-image-history-grid"):null;if(d&&c&&d.children.length===0){let _=c.querySelector(".aipkit-image-history-load-more-btn"),f=!1;if(_){let w=parseInt(_.dataset.currentPage,10)||1,h=parseInt(_.dataset.maxPages,10)||1;f=!(_.style.display==="none")&&w<h}f||c.remove()}},300))}).catch(u=>{alert("Error deleting image: "+u.message),e.innerHTML=r,e.disabled=!1})}window.aipkit_handleDeleteImage=l})();(function(){"use strict";let l={image_output:!0,image_generation:!0};function n(o,r){let s=Array.isArray(o?.openrouter_image_models)?o.openrouter_image_models:[],u=String(r||"").trim().toLowerCase();if(!u)return l;let p=s.find(c=>(c&&c.id?String(c.id).trim().toLowerCase():"")===u);return!p||typeof p.capabilities!="object"?l:{...l,...p.capabilities}}function e(o,r){let s=n(o,r);return!!(s.image_output||s.image_generation)}function i(){let o=document.getElementById("aipkit_public_image_generator");if(!o)return;let r=o.querySelector("#aipkit_public_image_prompt"),s=o.querySelector("#aipkit_public_image_results"),u=o.querySelector("#aipkit_public_generate_image_btn"),p=o.querySelector("#aipkit_image_generator_public_nonce"),c=window.aipkit_image_generator_config_public||{},d=c.text||{},_=c.ajaxUrl||window.aipkit_dashboard?.ajaxurl,f=p?p.value:null,w=window.aipkit_escapeHtml||function(v){return v};if(!r||!s||!u||!_||!f){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),s.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Configuration missing.</p>',s.style.display="grid";return}let h=window.aipkit_getSettingValue(o,"aipkit_public_image_provider","image_provider"),m=window.aipkit_getSettingValue(o,"aipkit_public_image_model","image_model"),g=r.value.trim(),k=!1,b=c.google_models&&typeof c.google_models=="object"?c.google_models:{};if(h.toLowerCase()==="google"&&b.video&&Array.isArray(b.video)?k=b.video.some(v=>v&&v.id===m):k=m.includes("veo"),!g)return;if(!h||!m){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:h,model:m}),s.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Missing required image generation settings.</p>',s.style.display="grid";return}if(h.toLowerCase()==="openrouter"&&!e(c,m)){s.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${w(d.openrouterModelUnsupported||"Selected OpenRouter model does not support image generation.")}</p>`,s.style.display="grid";return}u.disabled=!0;let y=u.querySelector(".aipkit_btn-text"),I=u.querySelector(".aipkit_spinner"),A=y?y.textContent:d.generateButton||(k?"Generate Video":"Generate Image");y&&(y.textContent=d.generating||(k?"Generating Video...":"Generating...")),I&&(I.style.display="inline-block"),s.style.display="grid",s.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span></p>';let S=new FormData;if(S.append("action","aipkit_generate_image"),S.append("_ajax_nonce",f),S.append("prompt",g),S.append("provider",h),S.append("model",m),h.toLowerCase()==="openai"){let v=m.startsWith("gpt-image-1");m==="dall-e-3"?(S.append("quality","standard"),S.append("style","vivid")):v&&S.append("output_format","png"),v||S.append("response_format","url")}else h.toLowerCase()==="google"&&k&&(S.append("aspect_ratio","16:9"),S.append("person_generation","allow_all"));fetch(_,{method:"POST",body:S,credentials:"same-origin"}).then(v=>v.json()).then(v=>{if(!v.success){let x=v.data&&v.data.message?v.data.message:"Unknown generation error";throw new Error(x)}if(v.data.status==="processing"&&v.data.operation_name){a(v.data.operation_name,m,f,u,s,y,I,A,k,g,d,w);return}t(v.data,u,s,y,I,A,k,g,d,w)}).catch(v=>{console.error("AIPKit Image Generation Error (Public):",v),s.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${d.error||"Error generating image:"} ${w(v.message||"Unknown error")}</p>`,u.disabled=!1,y&&(y.textContent=A),I&&(I.style.display="none")})}function a(o,r,s,u,p,c,d,_,f,w,h,m){let b=0;c&&(c.textContent=h.generatingVideo||"Generating Video..."),p.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span> Video generation in progress...</p>';function y(){if(b>=60){p.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Video generation timed out. Please try again.</p>',u.disabled=!1,c&&(c.textContent=_),d&&(d.style.display="none");return}b++;let I=Math.min(b/60*100,95);p.innerHTML=`<p class="aipkit_image_results_placeholder" style="text-align:center;">
        <span class="aipkit_spinner" style="display:inline-block;"></span> 
        Generating video... (${Math.round(I)}%)
      </p>`;let A=new FormData;A.append("action","aipkit_check_video_status"),A.append("_ajax_nonce",s),A.append("operation_name",o),A.append("model_id",r),A.append("prompt",w),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:A,credentials:"same-origin"}).then(S=>S.json()).then(S=>{if(S.success)if(S.data.status==="completed")t(S.data,u,p,c,d,_,f,w,h,m);else if(S.data.status==="processing")setTimeout(y,5e3);else throw new Error(`Unknown status: ${S.data.status}`);else throw new Error(S.data?.message||"Status check failed")}).catch(S=>{console.error("AIPKit Video Status Check Error:",S),p.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">Video generation failed: ${m(S.message||"Unknown error")}</p>`,u.disabled=!1,c&&(c.textContent=_),d&&(d.style.display="none")})}setTimeout(y,5e3)}function t(o,r,s,u,p,c,d,_,f,w){let h=o.images||o.videos||[];if(h.length>0)s.innerHTML="",h.forEach(m=>{let g=document.createElement("div");g.className=d?"aipkit_video_result":"aipkit_image_result";let k="",b=m.media_library_url||m.url||null,y=d?f.viewFullVideo||"Click to view full video":f.viewFullImage||"Click to view full image";if(d)if(m.url){let I=`<video controls preload="metadata" style="max-width: 100%; height: auto;">
              <source src="${w(m.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;b&&b!==m.url?k=`<a href="${w(b)}" target="_blank" rel="noopener noreferrer" title="${w(y)}">${I}</a>`:k=I}else k='<p class="aipkit_video_results_message aipkit_message-error">Error: No video data found.</p>';else{let I=m.url||(m.b64_json?`data:image/png;base64,${m.b64_json}`:null);if(I){let A=`<img src="${w(I)}" alt="${w(_)}">`;b?k=`<a href="${w(b)}" target="_blank" rel="noopener noreferrer" title="${w(y)}">${A}</a>`:k=A}else k='<p class="aipkit_image_results_message aipkit_message-error">Error: No image data found.</p>'}if(g.innerHTML=k,m.revised_prompt){let I=document.createElement("p");I.style.fontSize="11px",I.style.fontStyle="italic",I.style.marginTop="5px",I.textContent=`Revised: ${m.revised_prompt}`,g.appendChild(I)}s.appendChild(g)});else{let m=d?"videos":"images";s.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${f.initialPlaceholder||`No ${m} returned. Try a different prompt.`}</p>`}r.disabled=!1,u&&(u.textContent=c),p&&(p.style.display="none")}window.aipkit_handlePublicImageGeneration=i})();(function(){"use strict";function l(n){let e=n.currentTarget;if(e.disabled)return;let i=e.closest("#aipkit_public_image_generator");if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,o=i.querySelector("#aipkit_image_generator_public_nonce")?.value,r=i.querySelector(".aipkit-image-history-grid");if(!t||!o||!r){console.error("Image History Load More: Missing required elements or config.");return}let s=parseInt(e.dataset.currentPage,10)||1,u=parseInt(e.dataset.maxPages,10)||1,p=s+1;if(p>u)return;let c=e.querySelector(".aipkit_btn-icon-content"),d=e.querySelector(".aipkit_spinner");c&&(c.style.display="none"),d&&(d.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",o),_.append("page",p),fetch(t,{method:"POST",body:_,credentials:"same-origin"}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.data?.message||"Failed to load more images.");f.data.html&&r.insertAdjacentHTML("beforeend",f.data.html),e.dataset.currentPage=p,f.data.has_more||(e.style.display="none")}).catch(f=>{console.error("Image History Load More Error:",f)}).finally(()=>{c&&(c.style.display="inline-block"),d&&(d.style.display="none"),p<u?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=l})();(function(){"use strict";function l(){let n=document.getElementById("aipkit_public_image_generator");if(!n)return;let e=n.querySelector("#aipkit_public_generate_image_btn"),i=n.querySelector("#aipkit_public_image_results"),a=n.querySelector("#aipkit_public_image_provider"),t=n.querySelector("#aipkit_public_image_model"),o=n.dataset.allowedModels||"",r=n.querySelector(".aipkit-image-history-grid"),s=n.querySelector(".aipkit-image-history-load-more-btn");if(!e||!i){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),i&&(i.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Core UI elements missing.</p>'),i.style.display="grid";return}a&&t&&typeof window.aipkit_populatePublicModelsForProvider=="function"&&(window.aipkit_populatePublicModelsForProvider(a.value,t,o),a.addEventListener("change",()=>{window.aipkit_populatePublicModelsForProvider(a.value,t,o)})),e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",window.aipkit_handlePublicImageGeneration),e.dataset.listenerAttached="true"),r&&r.addEventListener("click",window.aipkit_handleDeleteImage),s&&s.addEventListener("click",window.aipkit_handleLoadMoreHistory),i&&(i.style.display="none",i.innerHTML="")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l(),window.aipkit_initPublicImageGenerator=l})();(function(){"use strict";function l(i,a,t,o){let r=window.aipkit_token_usage_config||{},s=r.text||{},u=document.createElement("div");u.className="aipkit-usage-details-table-container";let p=document.createElement("div");p.className="aipkit-usage-details-pagination-container",o.appendChild(u),o.appendChild(p),u.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${s.loadingDetails||"Loading details..."}</p>`;let c={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:i,context_id:a,page:t},d=new FormData;for(let _ in c)d.append(_,c[_]);fetch(r.ajaxUrl,{method:"POST",body:d,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");n(_.data.items,u),e(_.data.pagination,p,i,a,o)}).catch(_=>{console.error("Error fetching token usage details:",_),u.innerHTML=`<p style="color:red;text-align:center;">${s.errorLoading||"Error loading details."} (${_.message})</p>`})}function n(i,a){if(!i||i.length===0){a.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let t='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';i.forEach(o=>{let s=new Date(o.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});t+=`<tr><td>${s}</td><td>${o.tokens.toLocaleString()}</td></tr>`}),t+="</tbody></table>",a.innerHTML=t}function e(i,a,t,o,r){let{currentPage:s,totalPages:u}=i,p=window.aipkit_token_usage_config?.text||{};if(a.innerHTML="",u<=1)return;let c=document.createElement("button");c.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",c.textContent=p.previous||"Previous",c.disabled=s<=1,c.addEventListener("click",()=>l(t,o,s-1,r)),a.appendChild(c);let d=document.createElement("span");d.className="aipkit_pagination-current",d.textContent=`${p.pageLabel||"Page"} ${s} ${p.ofLabel||"of"} ${u}`,a.appendChild(d);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=p.next||"Next",_.disabled=s>=u,_.addEventListener("click",()=>l(t,o,s+1,r)),a.appendChild(_)}document.addEventListener("click",function(i){let a=i.target.closest(".aipkit-usage-details-btn");if(!a||a.disabled)return;let t=a.closest("tr.aipkit-usage-main-row");if(!t)return;let o=t.nextElementSibling,r=o&&o.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(s=>{if(s!==o){let u=s.previousElementSibling.querySelector(".aipkit-usage-details-btn");u&&u.classList.remove("aipkit-active"),s.remove()}}),r)o.remove(),a.classList.remove("aipkit-active");else{a.classList.add("aipkit-active");let s=document.createElement("tr");s.className="aipkit-usage-details-row";let u=document.createElement("td");u.colSpan=t.cells.length,u.className="aipkit-usage-details-cell";let p=document.createElement("div");p.className="aipkit-usage-details-content",u.appendChild(p),s.appendChild(u),t.parentNode.insertBefore(s,t.nextSibling);let c=a.dataset.module,d=a.dataset.contextId;l(c,d,1,p)}}),document.addEventListener("click",function(i){let a=i.target.closest(".aipkit_toggle_purchase_history");if(!a)return;i.preventDefault();let t=document.getElementById("aipkit_purchase_history_details");if(!t)return;a.getAttribute("aria-expanded")==="true"?(t.style.display="none",a.setAttribute("aria-expanded","false")):(t.style.display="block",a.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function l(e){e.preventDefault();let i=e.target,a=i.querySelector(".aipkit_semantic_search_input"),t=i.querySelector(".aipkit_semantic_search_button"),o=i.closest(".aipkit_semantic_search_wrapper"),r=o.querySelector(".aipkit_semantic_search_results");if(!a||!t||!o||!r){console.error("Semantic Search: Missing required form elements.");return}let s=a.value.trim();if(!s)return;let u=window.aipkit_semantic_search_config||{},p=u.text||{};t.disabled=!0;let c=t.querySelector(".aipkit_spinner");c&&(c.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let d={query:s};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",d,u).then(_=>{r.innerHTML=_.html||`<p>${u.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),r.innerHTML=`<p class="aipkit-search-error">${p.error||"An error occurred while searching."}</p>`}).finally(()=>{t.disabled=!1,c&&(c.style.display="none")})}function n(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(i=>{i.dataset.listenerAttached!=="true"&&(i.addEventListener("submit",l),i.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",n),document.addEventListener("aipkit:contentLoaded",n)})();(function(){"use strict";function l(n,e,i){if(!n)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let a=n.querySelector(".aipkit_consent_overlay");if(!a){a=document.createElement("div"),a.className="aipkit_consent_overlay",a.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `;let t=n.querySelector(".aipkit_chat_input");t?t.appendChild(a):n.appendChild(a);let o=a.querySelector(".aipkit_consent_agree_btn");o&&typeof i=="function"&&o.addEventListener("click",i)}return a.classList.remove("aipkit_hidden"),a}window.aipkit_chatUI_showConsentBox=l})();(function(){"use strict";function l(n){n&&n.classList.add("aipkit_hidden")}window.aipkit_chatUI_hideConsentBox=l})();(function(){"use strict";function l(n,e,i,a,t,o){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&o&&t(o);let r=a.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let s=a.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=l})();(function(){"use strict";function l(n,e,i,a){let t=e.botId,o=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(o)==="true";let r=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,o,a,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function u(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&u(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(u(),!0):!1,isConsentGiven:()=>i.consentGiven}}window.aipkit_initConsentUI=l})();(function(){"use strict";function l(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:a}=window.jspdf,t=new a,o=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",s=e.text.userPrefix||"User",u=e.text.errorPrefix||"Error",p=10,c=t.internal.pageSize.height,d=10,_=6,f=c-d*2,w=!1;if(t.setFontSize(16),t.text(`Chat Transcript - ${r}`,d,p),p+=_*2,t.setFontSize(12),o.forEach(m=>{let g=m.querySelector(".aipkit_chat_bubble");if(!g)return;let k=window.aipkit_chatUI_extractTextFromBubble(g),b="";if(m.classList.contains("aipkit_chat_message-user")?(b=`${s}:`,t.setFont(void 0,"bold")):m.classList.contains("aipkit_chat_message-bot")?(b=`${r}:`,t.setFont(void 0,"normal")):m.classList.contains("aipkit_chat_message-error")?(b=`${u}:`,t.setFont(void 0,"italic")):t.setFont(void 0,"normal"),b&&k){w=!0;let y=b,I=`${k}`;p+_>f+d&&(t.addPage(),p=d),t.text(y,d,p),p+=_,t.splitTextToSize(I,t.internal.pageSize.width-d*2).forEach(S=>{p+_>f+d&&(t.addPage(),p=d),t.text(S,d,p),p+=_}),p+=_/2,t.setFont(void 0,"normal")}}),!w){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let h=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{t.save(h)}catch(m){console.error("AIPKit Download PDF: Error calling doc.save()",m),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=l})();(function(){"use strict";function l(n){let i=n.currentTarget.closest(".aipkit-ai-form-wrapper"),a=i?i.querySelector(".aipkit-ai-form-results-content"):null,t=i?i.dataset.formId:"unknown";if(!a){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:o}=window.jspdf,r=new o,s=a.innerText||a.textContent||"";if(!s.trim()){alert("Nothing to export.");return}let u=r.internal.pageSize.height,p=10,c=6,d=u-p*2,_=p;r.setFontSize(12),r.splitTextToSize(s,r.internal.pageSize.width-p*2).forEach(g=>{_+c>d+p&&(r.addPage(),_=p),r.text(g,p,_),_+=c});let w=new Date,h=`${w.getFullYear()}${String(w.getMonth()+1).padStart(2,"0")}${String(w.getDate()).padStart(2,"0")}`,m=`aiform-${t}-result-${h}.pdf`;r.save(m)}window.aipkitForms_handleDownloadPdf=l})();(function(){"use strict";let l='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-volume"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8a5 5 0 0 1 0 8" /><path d="M17.7 5a9 9 0 0 1 0 14" /><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" /></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>',e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-alert-square-rounded"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>';function i(t,o,r=null){if(t)switch(t.classList.remove("is-connecting","is-listening","is-speaking","is-error"),t.innerHTML="",o){case"connecting":t.classList.add("is-connecting");let s=document.createElement("span");s.className="aipkit_spinner",s.style.display="inline-block",t.appendChild(s),t.title=r||"Connecting...",t.disabled=!0;break;case"listening":t.classList.add("is-listening"),t.innerHTML=n,t.title=r||"Listening... (Click to stop)",t.disabled=!1;break;case"speaking":t.classList.add("is-speaking"),t.innerHTML=l,t.title=r||"AI is speaking... (Click to stop)",t.disabled=!1;break;case"error":t.classList.add("is-error"),t.innerHTML=e,t.title=r||"Error. Click to retry.",t.disabled=!1;break;case"idle":default:t.innerHTML=l,t.title=r||"Start Voice Conversation",t.disabled=!1;break}}function a(t,o){t.inputField&&(t.inputField.disabled=o),t.actionButton&&(t.actionButton.disabled=o),t.inputActionButton&&(t.inputActionButton.disabled=o),t.voiceInputButton&&(t.voiceInputButton.disabled=o)}window.aipkit_realtimeUIHandler={setButtonState:i,toggleMainInputs:a}})();(function(){"use strict";async function l(i){try{let a=await navigator.mediaDevices.getUserMedia({audio:!0});return a.getTracks().forEach(t=>i.addTrack(t,a)),a}catch(a){throw console.error("Error getting user media:",a),a}}function n(i){let a=document.createElement("audio");return a.autoplay=!0,i.ontrack=t=>{t.streams&&t.streams[0]&&(a.srcObject=t.streams[0])},a}function e(i){i&&i.getTracks().forEach(a=>a.stop())}window.aipkit_realtimeAudioHandler={startLocalStream:l,setupRemoteStream:n,stopLocalStream:e}})();(function(){"use strict";async function l(n,e,i){let a=i.createDataChannel("aipkit-events"),t={userTranscript:"",botTranscript:""},o=async r=>{let s=r?.usage||null;if(!t.userTranscript&&!t.botTranscript)return;let u={user_transcript:t.userTranscript,bot_transcript:t.botTranscript,usage_data:s?JSON.stringify(s):null};try{await window.aipkit_frontendApiRequest("aipkit_log_realtime_session_turn",u,e)}catch(p){console.error("AIPKit Realtime: Failed to log session turn.",p)}finally{t={userTranscript:"",botTranscript:""}}};a.onopen=()=>console.log("AIPKit Realtime: Data channel opened."),a.onmessage=r=>{try{let s=JSON.parse(r.data);s.type==="input.transcription"&&s.transcription&&(t.userTranscript+=s.transcription.trim()+" "),s.type==="response.done"&&s.response&&(s.response.output&&s.response.output[0]&&s.response.output[0].content&&s.response.output[0].content[0]&&s.response.output[0].content[0].transcript&&(t.botTranscript=s.response.output[0].content[0].transcript),o(s.response))}catch(s){console.error("AIPKit Realtime: Error processing message from server:",r.data,s)}},a.onclose=()=>console.log("AIPKit Realtime: Data channel closed."),a.onerror=r=>console.error("AIPKit Realtime: Data channel error:",r);try{let r=await i.createOffer();await i.setLocalDescription(r);let s=e.realtimeModel||"gpt-4o-realtime-preview",u=await fetch(`https://api.openai.com/v1/realtime?model=${s}`,{method:"POST",body:r.sdp,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/sdp"}});if(!u.ok){let c=await u.text();throw new Error(`SDP exchange failed with status ${u.status}: ${c}`)}let p={type:"answer",sdp:await u.text()};return await i.setRemoteDescription(p),a}catch(r){throw console.error("AIPKit Realtime: WebRTC connection failed.",r),i&&i.connectionState!=="closed"&&i.close(),r}}window.aipkit_realtimeConnector={connect:l}})();(function(){"use strict";let l={peerConnection:null,localStream:null,remoteAudioElement:null,dataChannel:null,isSessionActive:!1,currentBotId:null,elements:null,config:null,mainUIState:null,uiInstance:null};async function n(t){t&&(t.preventDefault(),t.stopPropagation()),l.isSessionActive?i():await e()}async function e(){if(l.config.requireConsentCompliance&&!l.mainUIState.consentGiven&&!l.config.directVoiceMode){console.warn(`AIPKit Realtime (${l.config.botId}): Cannot start session, consent required. Opening popup.`),l.uiInstance&&typeof l.uiInstance.openPopup=="function"&&l.uiInstance.openPopup();return}if(!window.aipkit_current_conversation_uuid)if(typeof window.aipkit_regenerateConversationUUID=="function")window.aipkit_regenerateConversationUUID();else{console.error("AIPKit Realtime: Cannot start session, aipkit_regenerateConversationUUID function is missing.");let u=l.elements.triggerButton,p=l.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),c=l.config.directVoiceMode?u:p;window.aipkit_realtimeUIHandler.setButtonState(c,"error","Error: Cannot create session ID.");return}window.aipkit_is_fresh_session=!1;let t=l.elements.triggerButton,o=l.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),r=l.config.directVoiceMode?t:o,{...s}=l.elements;window.aipkit_realtimeUIHandler.setButtonState(r,"connecting"),l.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(s,!0);try{let p=(await window.aipkit_frontendApiRequest("aipkit_create_realtime_session",{bot_id:l.currentBotId},l.config))?.client_secret?.value;if(!p)throw new Error("Could not retrieve a session key from the server.");let c=new RTCPeerConnection;l.peerConnection=c,l.remoteAudioElement=window.aipkit_realtimeAudioHandler.setupRemoteStream(c),l.localStream=await window.aipkit_realtimeAudioHandler.startLocalStream(c);let d=await window.aipkit_realtimeConnector.connect(p,l.config,c);l.dataChannel=d,c.onconnectionstatechange=()=>{(c.connectionState==="disconnected"||c.connectionState==="closed"||c.connectionState==="failed")&&i("Connection lost.")},l.isSessionActive=!0,window.aipkit_realtimeUIHandler.setButtonState(r,"listening");let _=l.config.text?.initialGreeting;if(_&&typeof window.aipkit_handlePlayAction=="function"&&l.config.ttsEnabled){let f=document.createElement("button"),w='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>';f.className="aipkit_action_btn aipkit_play_btn",f.innerHTML=w;let h=document.createElement("div");h.setAttribute("data-raw-text",_);let m=document.createElement("div");m.appendChild(h),m.appendChild(f),window.aipkit_handlePlayAction(f)}}catch(u){console.error("AIPKit Realtime: Failed to start session.",u),i(`Error: ${u.message||"Could not connect."}`,!0)}}function i(t=null,o=!1){l.peerConnection&&(l.peerConnection.close(),l.peerConnection=null),l.localStream&&(window.aipkit_realtimeAudioHandler.stopLocalStream(l.localStream),l.localStream=null),l.remoteAudioElement&&(l.remoteAudioElement.srcObject=null,l.remoteAudioElement=null),l.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(),l.isSessionActive=!1;let r=l.elements.triggerButton,s=l.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),u=l.config.directVoiceMode?r:s,{...p}=l.elements;window.aipkit_realtimeUIHandler.setButtonState(u,o?"error":"idle",t),l.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(p,!1)}function a(t,o,r,s,u){let p=t.container.querySelector(".aipkit_realtime_voice_agent_btn"),c=t.container.closest(".aipkit_popup_wrapper"),d=c?c.querySelector(".aipkit_popup_trigger"):null;!p||!d&&o.popupEnabled||(l.uiInstance=u,l.mainUIState=r,l.config=o,l.elements={...t,triggerButton:d},l.currentBotId=o.botId,o.directVoiceMode&&d?(d.addEventListener("click",n),p.style.display="none"):p.addEventListener("click",n))}window.aipkit_initRealtimeVoiceAgent=a})();})();
