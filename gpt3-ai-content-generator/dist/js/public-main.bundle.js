(()=>{(function(){"use strict";function c(){typeof window.markdownit=="function"?(window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}),window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs}),console.log("AIPKit Chat Markdown: markdown-it initialized.")):(console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(o){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(o).replace(/\n/g,"<br>")}})}window.aipkit_initializeMarkdownParser=c})();(function(){"use strict";function c(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function o(e){return c(e)}window.aipkit_escapeHtml=c,window.aipkit_escapeAttribute=o})();(function(){"use strict";function c(o){let e=Number(o);if(!e||isNaN(e))return"";try{let t=new Date(e*1e3);if(isNaN(t.getTime()))return"";let n=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${n}:${i}:${a}`}catch(t){return console.error("Error formatting timestamp:",o,t),""}}window.aipkit_formatTimestamp=c})();(function(){"use strict";function c(o,e={},t={}){return new Promise((n,i)=>{if(!t.ajaxUrl)return i(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let a=new FormData;a.append("action",o),t.nonce?a.append("_ajax_nonce",t.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${o}".`),t.botId&&a.append("bot_id",t.botId),window.aipkit_guest_uuid&&a.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&a.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&a.append("post_id",window.aipkit_current_post_id),t.provider==="OpenAI"&&t.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&a.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&a.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&a.append("frontend_google_search_grounding_active","true"),t.activeFileContext?(t.activeFileContext.provider==="OpenAI"&&t.activeFileContext.vector_store_id&&(a.append("active_openai_vs_id",t.activeFileContext.vector_store_id),console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from config.activeFileContext: ${t.activeFileContext.vector_store_id}`)),t.activeFileContext.provider==="Pinecone"&&t.activeFileContext.index_name&&t.activeFileContext.namespace&&(a.append("active_pinecone_index_name",t.activeFileContext.index_name),a.append("active_pinecone_namespace",t.activeFileContext.namespace),console.log(`AIPKit frontendApiRequest: Sending Pinecone context from config.activeFileContext: Index: ${t.activeFileContext.index_name}, Namespace: ${t.activeFileContext.namespace}`)),t.activeFileContext.provider==="Qdrant"&&t.activeFileContext.collection_name&&t.activeFileContext.file_upload_context_id&&(a.append("active_qdrant_collection_name",t.activeFileContext.collection_name),a.append("active_qdrant_file_upload_context_id",t.activeFileContext.file_upload_context_id),console.log(`AIPKit frontendApiRequest: Sending Qdrant context from config.activeFileContext: Collection: ${t.activeFileContext.collection_name}, File Context ID: ${t.activeFileContext.file_upload_context_id}`))):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id&&console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&r!=="frontend_web_search_active"&&r!=="frontend_google_search_grounding_active"&&r!=="active_openai_vs_id"&&r!=="active_pinecone_index_name"&&r!=="active_pinecone_namespace"&&r!=="active_qdrant_collection_name"&&r!=="active_qdrant_file_upload_context_id"&&a.append(r,e[r]);fetch(t.ajaxUrl,{method:"POST",body:a,credentials:"same-origin"}).then(r=>r.json()).then(r=>{if(r.success)n(r.data);else{let s=r.data&&typeof r.data=="object"&&r.data.message?r.data.message:"Unknown frontend API error (data or data.message missing/invalid)";i(new Error(s))}}).catch(r=>{console.error(`AIPKit Frontend AJAX Error (Action: ${o}):`,r),i(r)})})}window.aipkit_frontendApiRequest=c})();(function(){"use strict";function c(o){return`aipkit-client-msg-${String(o||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=c})();(function(){"use strict";function c(o){if(!o||typeof o.style>"u")return;o.style.height="auto";let e=o.scrollHeight,t=window.getComputedStyle(o),n=parseInt(t.minHeight,10)||0,i=parseInt(t.maxHeight,10)||1/0,a=Math.max(n,e);a=Math.min(a,i),o.style.height=`${a}px`,a>=i?(o.style.overflowY="auto",o.classList.add("aipkit-textarea-scrollable")):(o.style.overflowY="hidden",o.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=c})();(function(){"use strict";function c(o,e,t){let{webSearchToggleButton:n}=o,i=e.allowWebSearchTool&&e.provider==="OpenAI";!n||!i||(t.webSearchToolActive=!t.webSearchToolActive,n.classList.toggle("aipkit_active",t.webSearchToolActive),n.title=t.webSearchToolActive?e.text?.webSearchActive||"Web Search Active":e.text?.webSearchInactive||"Web Search Inactive",n.setAttribute("aria-pressed",t.webSearchToolActive.toString()),console.log(`AIPKit Chat UI Main (${e.botId}): OpenAI Web Search tool toggled to: ${t.webSearchToolActive}`))}window.aipkit_toggleWebSearchAction=c})();(function(){"use strict";function c(o,e,t){let{googleSearchGroundingToggleButton:n}=o,i=e.allowGoogleSearchGrounding&&e.provider==="Google";!n||!i||(t.googleSearchGroundingActive=!t.googleSearchGroundingActive,n.classList.toggle("aipkit_active",t.googleSearchGroundingActive),n.title=t.googleSearchGroundingActive?e.text?.googleSearchGroundingActive||"Google Search Grounding Active":e.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",n.setAttribute("aria-pressed",t.googleSearchGroundingActive.toString()),console.log(`AIPKit Chat UI Main (${e.botId}): Google Search Grounding tool toggled to: ${t.googleSearchGroundingActive}`))}window.aipkit_toggleGoogleSearchGroundingAction=c})();(function(){"use strict";function c(o,e){let t=e.botId||"unknown",n=o.querySelector(".aipkit_chat_header"),i=o.querySelector(".aipkit_chat_main"),a=i?i.querySelector(".aipkit_chat_messages"):null,r=i?i.querySelector(".aipkit_chat_footer"):null,s=i?i.querySelector(".aipkit_chat_input"):null,p=s?s.querySelector(".aipkit_chat_input_field"):null,l=s?s.querySelector(".aipkit_chat_input_wrapper"):null,d=l?l.querySelector(".aipkit_chat_input_actions_bar"):null,u=o.querySelector(".aipkit_chat_image_preview_container"),_=o.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&s&&l){if(u||(u=document.createElement("div"),u.className="aipkit_chat_image_preview_container"),!l.contains(u)){let U=l.querySelector(".aipkit_chat_input_field");U?l.insertBefore(u,U):l.appendChild(u)}_||(_=document.createElement("input"),_.type="file",_.className="aipkit_chat_image_upload_input",_.style.display="none",_.setAttribute("aria-hidden","true"),s.appendChild(_))}let f=s?s.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&s&&(f||(f=document.createElement("input"),f.type="file",f.className="aipkit_chat_file_upload_input",f.style.display="none",f.setAttribute("aria-hidden","true"),s.appendChild(f)));let w=d?d.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,m=s?s.querySelector(".aipkit_input_action_menu"):null,g=d?d.querySelector(".aipkit_voice_input_btn"):null,h=d?d.querySelector(".aipkit_web_search_toggle"):null,I=d?d.querySelector(".aipkit_google_search_grounding_toggle"):null,b=d?d.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,k=b?b.querySelector(".aipkit_send_icon"):null,y=b?b.querySelector(".aipkit_clear_icon"):null,S=b?b.querySelector(".aipkit_spinner"):null,v=i?i.querySelector(".aipkit_conversation_starters"):null,A=n?n.querySelector(".aipkit_sidebar_toggle_btn"):null,P=n?n.querySelector(".aipkit_fullscreen_btn"):null,x=n?n.querySelector(".aipkit_download_btn"):null,E=n?n.querySelector(".aipkit_close_btn"):null,C=o.querySelector(".aipkit_chat_sidebar"),T=C?C.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!i||!a||!p||!b||!k||!y||!S?(console.error(`AIPKit Chat FindElements (${t}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!v&&console.warn(`AIPKit Chat FindElements (${t}): Starters enabled but container not found.`),e.enableSidebar&&(!C||!A)&&console.warn(`AIPKit Chat FindElements (${t}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!w&&console.warn(`AIPKit Chat FindElements (${t}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&e.provider==="OpenAI"&&!h&&console.warn(`AIPKit Chat FindElements (${t}): OpenAI Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!I&&console.warn(`AIPKit Chat FindElements (${t}): Google Search Grounding allowed but toggle button missing.`),{container:o,headerEl:n,mainContentEl:i,messagesEl:a,footerEl:r,inputArea:s,inputField:p,inputWrapper:l,actionsBar:d,imageUploadInput:_,imagePreviewContainer:u,fileUploadInput:f,inputActionButton:w,inputActionMenu:m,voiceInputButton:g,webSearchToggleButton:h,googleSearchGroundingToggleButton:I,actionButton:b,sendIcon:k,clearIcon:y,spinner:S,startersContainer:v,sidebarToggleBtn:A,fullscreenButton:P,downloadButton:x,closeButton:E,sidebarEl:C,newChatBtn:T})}window.aipkit_chatUI_findElements=c})();(function(){"use strict";function c(o,e=!1){o&&requestAnimationFrame(()=>{let t=o.scrollHeight-o.scrollTop-o.clientHeight<100;(e||t)&&(o.scrollTop=o.scrollHeight,setTimeout(()=>{o&&(o.scrollTop=o.scrollHeight)},50))})}window.aipkit_chatUI_scrollToBottom=c})();(function(){"use strict";function c(o,e=null){if(!o)return;if(e&&e.parentNode===o){try{o.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",r)}return}let n=`aipkit-typing-indicator-${o.closest(".aipkit_chat_container")?.dataset.botId||o.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,i=o.querySelector(`#${CSS.escape(n)}`);if(i)try{o.removeChild(i)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",r)}let a=o.querySelector(".aipkit_typing-indicator");if(a)try{o.removeChild(a)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeTypingIndicator=c})();(function(){"use strict";function c(o,e=null){if(!o)return;if(e&&e.parentNode===o){try{o.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",r)}return}let n=`aipkit-image-loading-indicator-${o.closest(".aipkit_chat_container")?.dataset.botId||o.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,i=o.querySelector(`#${CSS.escape(n)}`);if(i)try{o.removeChild(i)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",r)}let a=o.querySelector(".aipkit_image_loading_indicator");if(a)try{o.removeChild(a)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeImageLoadingIndicator=c})();(function(){"use strict";function c(o,e){if(!o||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(o);let n=`aipkit-typing-indicator-${e.botId||"default"}`,i=document.createElement("div");return i.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",i.id=n,i.innerHTML=`
            <div class="aipkit_chat_bubble">
                <span class="aipkit_typing-dot"></span>
                <span class="aipkit_typing-dot"></span>
                <span class="aipkit_typing-dot"></span>
            </div>`,o.appendChild(i),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),i}window.aipkit_chatUI_showTypingIndicator=c})();(function(){"use strict";function c(o,e){if(!o||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(o);let n=`aipkit-image-loading-indicator-${e.botId||"default"}`,i=document.createElement("div");return i.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",i.id=n,i.innerHTML=`
        <div class="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail">
            <span class="dashicons dashicons-format-image"></span>
        </div>`,o.appendChild(i),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),i}window.aipkit_chatUI_showImageLoadingIndicator=c})();(function(){"use strict";function c(o,e,t,n,i=!1,a=!1,r=null,s=!1,p=null){if(!o||!n)return;let l=window.aipkit_escapeHtml||function(w){return w},d=document.createElement("div"),u=t==="user"?"user":"bot";d.className=`aipkit_chat_message aipkit_chat_message-${u}`,i&&d.classList.add("aipkit_chat_message-error"),a&&d.classList.add("aipkit_initial_greeting"),r&&(d.id=r,d.setAttribute("data-message-id",r));let _=document.createElement("div");_.className="aipkit_chat_bubble";let f="";if(u==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let w=document.createElement("img");w.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,w.alt=e.text||"User uploaded image",w.className="aipkit_user_sent_image_thumbnail",_.appendChild(w)}if(e.text&&e.text.trim()!==""){let w=document.createElement("div");w.className="aipkit_user_message_text_content",w.textContent=e.text,_.appendChild(w),f=e.text}else!e.text&&e.user_image&&(f="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let w=e.images[0],m=e.prompt||"Generated image",g=w.revised_prompt,h="";if(w.media_library_url?h=`<a href="${l(w.media_library_url)}" target="_blank" rel="noopener noreferrer"><img src="${l(w.media_library_url)}" alt="${l(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.url?h=`<a href="${l(w.url)}" target="_blank" rel="noopener noreferrer"><img src="${l(w.url)}" alt="${l(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.b64_json?h=`<img src="data:image/png;base64,${w.b64_json}" alt="${l(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;">`:h=`<p style="font-style: italic;">${l(e.content||n.text?.noImageData||"Image data unavailable.")}</p>`,_.innerHTML=h,_.style.padding="5px",_.style.maxWidth="60%",_.title=`Prompt: ${l(m)}`,f=`Image generated for prompt: ${l(m)}`,g){let I=document.createElement("p");I.style.fontSize="11px",I.style.fontStyle="italic",I.style.marginTop="5px",I.style.textAlign="center",I.style.color="inherit",I.textContent=`Revised: ${l(g)}`,_.appendChild(I),f+=`. Revised prompt: ${l(g)}`}}else if(typeof e=="string")if(f=e,(u==="bot"||a)&&!i&&window.aipkit_md)_.innerHTML=window.aipkit_md.render(e);else{let w=e.split(`
`);w.forEach((m,g)=>{_.appendChild(document.createTextNode(m)),g<w.length-1&&_.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),_.textContent=l("[Invalid Content]"),f="Invalid Content";if(_.setAttribute("data-raw-text",f),d.appendChild(_),u==="bot"&&!a&&!i)if(d.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let w=window.aipkit_chatUI_createActionsContainerHTML(n);w&&d.insertAdjacentHTML("beforeend",w)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(u==="bot"&&!i&&p&&p.searchEntryPoint&&p.searchEntryPoint.renderedContent){let w=document.createElement("div");w.className="aipkit_grounding_widget",w.innerHTML=p.searchEntryPoint.renderedContent,d.appendChild(w)}o.appendChild(d),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,s)}window.aipkit_chatUI_appendMessage=c})();(function(){"use strict";function c(o,e){let t=o.querySelector(`.${e}`);t?t.parentNode&&t.parentNode.removeChild(t):(t=document.createElement("span"),t.className=e);let n=a=>{let r=Array.from(a.childNodes);for(let s=r.length-1;s>=0;s--){let p=r[s];if(p.nodeType===Node.TEXT_NODE&&p.textContent.trim()!==""){let l=document.createElement("span"),d=document.createTextNode(p.textContent);return l.appendChild(d),a.replaceChild(l,p),l.appendChild(t),!0}if(p.nodeType===Node.ELEMENT_NODE&&p.offsetParent!==null&&!p.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(p.tagName))return p.childNodes.length>0&&n(p)||(p.nextSibling?a.insertBefore(t,p.nextSibling):a.appendChild(t)),!0}return!1};n(o)||o.appendChild(t)}window.positionStreamingIndicator=c})();(function(){"use strict";function c(o,e,t,n,i,a=!1,r=!1,s=null){if(!o||!i||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:o,messageId:e,config:i});return}let p=window.aipkit_escapeHtml||function(w){return w},l=o.querySelector(`#${CSS.escape(e)}`),d,u="",_="aipkit_stream_indicator",f=n==="user"?"user":"bot";if(!l)l=document.createElement("div"),l.id=e,l.setAttribute("data-message-id",e),l.className=`aipkit_chat_message aipkit_chat_message-${f}`,r&&l.classList.add("aipkit_chat_message-error"),d=document.createElement("div"),d.className="aipkit_chat_bubble",d.dataset.aipkitFullContent="",d.setAttribute("data-raw-text",""),l.appendChild(d),o.appendChild(l);else{if(d=l.querySelector(".aipkit_chat_bubble"),!d)return;r&&!l.classList.contains("aipkit_chat_message-error")&&l.classList.add("aipkit_chat_message-error")}if(d.dataset.aipkitFullContent===void 0&&(d.dataset.aipkitFullContent=""),d.getAttribute("data-raw-text")===null&&d.setAttribute("data-raw-text",""),d.dataset.aipkitFullContent+=t,d.setAttribute("data-raw-text",d.getAttribute("data-raw-text")+t),u=d.dataset.aipkitFullContent,r?d.textContent=u:d.innerHTML=window.aipkit_md?window.aipkit_md.render(u):u.replace(/\n/g,"<br>"),l.classList.remove("aipkit_message_streaming"),!a&&!r){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(d,_);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let w=d.querySelector(`.${_}`);w||(w=document.createElement("span"),w.className=_,d.appendChild(w))}l.classList.add("aipkit_message_streaming")}else{let w=d.querySelector(`.${_}`);if(w&&w.parentNode&&w.parentNode.removeChild(w),a&&!r&&f==="bot"&&!l.querySelector(".aipkit_message_actions")){if(l.classList.remove("aipkit_message_streaming"),l.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let m=window.aipkit_chatUI_createActionsContainerHTML(i);m&&l.insertAdjacentHTML("beforeend",m)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(s&&s.searchEntryPoint&&s.searchEntryPoint.renderedContent){let m=document.createElement("div");m.className="aipkit_grounding_widget",m.innerHTML=s.searchEntryPoint.renderedContent,l.appendChild(m)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,a||r)}window.aipkit_chatUI_appendOrUpdateMessage=c})();(function(){"use strict";function c(o,e,t,n=null){if(!o||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let i=window.aipkit_escapeHtml||function(u){return u},a=t.botId||"default",r=document.createElement("div");if(r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",n)r.id=n,r.setAttribute("data-message-id",n);else{let u=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(a):`form-msg-${Date.now()}`;r.id=u,r.setAttribute("data-message-id",u)}let s=document.createElement("div");s.className="aipkit_chat_bubble";let p=document.createElement("div");if(p.className="aipkit_chat_form_wrapper",p.dataset.formId=e.form_id,e.title){let u=document.createElement("h5");u.className="aipkit_chat_form_title",u.textContent=i(e.title),p.appendChild(u)}let l=document.createElement("form");l.className="aipkit_chat_form",l.dataset.formId=e.form_id,e.elements.forEach(u=>{let _=document.createElement("div");_.className="aipkit_chat_form_element";let f;switch(u.type){case"text_input":case"textarea":if(u.label){let m=document.createElement("label");m.setAttribute("for",`form-${i(e.form_id)}-${i(u.id)}`),m.textContent=i(u.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=u.type==="textarea"?document.createElement("textarea"):document.createElement("input"),u.type==="text_input"&&(f.type="text"),u.type==="textarea"&&(f.rows=u.rows||3),f.id=`form-${i(e.form_id)}-${i(u.id)}`,f.name=i(u.id),f.className="aipkit_form-input",u.placeholder&&(f.placeholder=i(u.placeholder)),u.required&&(f.required=!0),u.default_value!==void 0&&(f.value=i(String(u.default_value))),_.appendChild(f);break;case"dropdown":if(u.label){let m=document.createElement("label");m.setAttribute("for",`form-${i(e.form_id)}-${i(u.id)}`),m.textContent=i(u.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=document.createElement("select"),f.id=`form-${i(e.form_id)}-${i(u.id)}`,f.name=i(u.id),f.className="aipkit_form-input",u.required&&(f.required=!0),Array.isArray(u.options)&&u.options.forEach(m=>{let g=document.createElement("option");g.value=i(m.value),g.textContent=i(m.text),u.default_value===m.value&&(g.selected=!0),f.appendChild(g)}),_.appendChild(f);break;case"checkbox_group":case"radio_group":let w=document.createElement("fieldset");if(u.label){let m=document.createElement("legend");m.textContent=i(u.label),m.className="aipkit_chat_form_label_text",w.appendChild(m)}Array.isArray(u.options)&&u.options.forEach(m=>{let g=document.createElement("div");g.className=u.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let h=document.createElement("input");h.type=u.type==="checkbox_group"?"checkbox":"radio",h.id=`form-${i(e.form_id)}-${i(u.id)}-${i(m.value)}`,h.name=i(u.id)+(u.type==="checkbox_group"?"[]":""),h.value=i(m.value),(u.type==="checkbox_group"&&Array.isArray(u.default_value)&&u.default_value.includes(m.value)||u.type==="radio_group"&&u.default_value===m.value)&&(h.checked=!0);let I=document.createElement("label");I.setAttribute("for",h.id),I.textContent=i(m.text),g.appendChild(h),g.appendChild(I),w.appendChild(g)}),_.appendChild(w);break;case"heading":f=document.createElement(u.level||"h5"),f.className="aipkit_chat_form_element_heading",f.textContent=i(u.label||""),_.appendChild(f);break;case"label":f=document.createElement("p"),f.className="aipkit_chat_form_element_label_only",f.textContent=i(u.label||""),_.appendChild(f);break}if(u.help_text){let w=document.createElement("p");w.className="aipkit_form_help_text",w.textContent=i(u.help_text),_.appendChild(w)}l.appendChild(_)});let d=document.createElement("button");d.type="submit",d.className="aipkit_btn aipkit_chat_form_submit_btn",d.textContent=i(e.submit_button_text||"Submit"),l.appendChild(d),l.addEventListener("submit",u=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let _=o.closest(".aipkit_chat_container")||o.closest(".aipkit_popup_wrapper"),f=null,w=null;_&&window.aipkitChatInstances&&window.aipkitChatInstances[_.id]?(f=window.aipkitChatInstances[_.id].elements,w=window.aipkitChatInstances[_.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(f=window.aipkit_chat_ui_elements,w=window.aipkit_chat_ui_actions),f&&w?window.aipkit_chatUI_handleChatFormSubmission(u,t,f,w):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),alert("Error submitting form: Chat context not found."))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),alert("Error submitting form: Submission handler missing.")}),p.appendChild(l),s.appendChild(p),r.appendChild(s),o.appendChild(r),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),console.log(`AIPKit RenderChatForm: Form ${e.form_id} rendered.`)}window.aipkit_chatUI_renderChatForm=c})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(c,o)=>{},onRecordingErrorCallback:c=>{}}})();(function(){"use strict";function c(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=c})();(function(){"use strict";function c(o,e,t){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof o=="function"?o:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof t=="function"?t:()=>{}}window.aipkit_setRecordingCallbacks=c})();(function(){"use strict";async function c(o={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("AIPKit STT Start: Microphone access granted.");let t=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],n="";for(let a of t)if(MediaRecorder.isTypeSupported(a)){n=a;break}if(!n&&MediaRecorder.isTypeSupported(""))n="";else if(!n)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let i=n?{mimeType:n}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,i),e.currentMimeType=e.mediaRecorder.mimeType||n||"application/octet-stream",console.log("AIPKit STT Start: Using mimeType:",e.currentMimeType),e.mediaRecorder.ondataavailable=a=>{a.data.size>0&&e.audioChunks.push(a.data)},e.mediaRecorder.onstop=()=>{if(console.log("AIPKit STT Start (onstop): Recording stopped."),e.audioChunks.length>0){let a=new Blob(e.audioChunks,{type:e.currentMimeType});console.log("AIPKit STT Start (onstop): Audio Blob created, size:",a.size,"type:",a.type),e.onRecordingStopCallback&&e.onRecordingStopCallback(a,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),console.log("AIPKit STT Start (onstop): Microphone stream stopped.")}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=a=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",a.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(a.error),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),console.log("AIPKit STT Start: Recording started."),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(t){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",t),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(t),e.audioStream&&(e.audioStream.getTracks().forEach(n=>n.stop()),e.audioStream=null)}}window.aipkit_startRecording=c})();(function(){"use strict";function c(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let o=window.aipkitSttState;o.mediaRecorder&&(o.mediaRecorder.state==="recording"||o.mediaRecorder.state==="paused")?(console.log("AIPKit STT Stop: Stopping recording..."),o.mediaRecorder.stop()):(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),o.audioStream&&(o.audioStream.getTracks().forEach(e=>e.stop()),o.audioStream=null))}window.aipkit_stopRecording=c})();(function(){"use strict";function c(o,e,t){let{elements:n,config:i,state:a,setButtonStateAction:r,sendMessageAction:s}=t,{inputField:p,voiceInputButton:l}=n;if(!o||!e||!n||!i||!a||!r||!s){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",t),alert("Failed to process audio: Configuration error."),l){l.disabled=i.requireConsentCompliance&&!a.consentGiven,l.classList.remove("aipkit_loading");let u=l.querySelector(".dashicons");u&&(u.style.display="")}return}let d=new FileReader;d.readAsDataURL(o),d.onloadend=function(){let u=d.result,_=e.split(";")[0].split("/")[1]||"webm";if(l){l.disabled=!0,l.classList.add("aipkit_loading");let w=l.querySelector(".dashicons");w&&(w.style.display="none")}let f={audio_data:u,audio_format:_};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",f,i).then(w=>{if(w&&w.transcription)p.value=w.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(p),r("send",!0,a),s(w.transcription);else throw new Error("Invalid transcription response from server.")}).catch(w=>{console.error(`AIPKit STT UI (${i.botId}): Transcription AJAX error:`,w),alert(`Transcription failed: ${w.message||"Unknown error"}`)}).finally(()=>{if(l){l.disabled=i.requireConsentCompliance&&!a.consentGiven,l.classList.remove("aipkit_loading");let w=l.querySelector(".dashicons");w&&(w.style.display="")}})},d.onerror=function(u){console.error("AIPKit STT UI: Error reading audio Blob as Data URL:",u),alert("Failed to process recorded audio."),l&&(l.disabled=i.requireConsentCompliance&&!a.consentGiven)}}window.aipkit_chatUI_transcribeAudio=c})();(function(){"use strict";function c(o,e,t,n,i){let{inputField:a,voiceInputButton:r,actionButton:s,inputActionButton:p}=o,l=e.botId;if(n&&typeof n.showConsentBoxIfNeeded=="function"&&n.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${l}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!t.consentGiven){console.warn(`AIPKit Chat UI Main (${l}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),alert("Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){let d=window.location.protocol==="https:",u=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";alert(!d&&!u?"Voice recording requires HTTPS connection for security. Please access this site using HTTPS or contact the administrator to enable SSL.":"Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}t.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{t.isRecording=!0,r.classList.add("aipkit_recording"),r.setAttribute("aria-label","Stop recording"),r.title="Stop recording",a.disabled=!0,s.disabled=!0,p&&(p.disabled=!0),console.log(`AIPKit STT (${l}): Recording started.`)},(d,u)=>{t.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",a.disabled=e.requireConsentCompliance&&!t.consentGiven,s.disabled=a.value.trim()==="",p&&(p.disabled=!1),console.log(`AIPKit STT (${l}): Recording stopped. Blob size: ${d.size}`),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(d,u,{elements:o,config:e,state:t,setButtonStateAction:i.setButtonStateAction,sendMessageAction:i.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),alert("Error processing recorded audio."))},d=>{t.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",a.disabled=e.requireConsentCompliance&&!t.consentGiven,s.disabled=a.value.trim()==="",p&&(p.disabled=!1),console.error(`AIPKit STT (${l}): Recording error:`,d),alert(`Recording failed: ${d.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=c})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function c(o){let e=window.aipkitImageUploadConstants;return e?o?e.ALLOWED_IMAGE_TYPES.includes(o.type)?o.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=c})();(function(){"use strict";function c(o){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>e(n.result),n.onerror=i=>t(i),n.readAsDataURL(o)})}window.aipkit_convertFileToBase64=c})();(function(){"use strict";function c(o){let e;o&&o.parentNode&&(e=o.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(t=>t.remove())}window.aipkit_clearImageUploadError=c})();(function(){"use strict";function c(o,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let t=document.createElement("div");if(t.className="chat-image-upload-error",t.textContent=o,e&&e.parentNode)e.parentNode.insertBefore(t,e.nextSibling);else{let n=document.querySelector(".aipkit_chat_input");n?n.appendChild(t):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=c})();(function(){"use strict";function c(o,e){let t=window.aipkitImageUploadState;if(!t){console.error("Image Upload Reset: State object not found.");return}t.currentImageFile=null,t.currentImageBase64=null,o&&(o.hasChildNodes()?(o.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{o&&(o.innerHTML="",o.style.display="none",o.classList.remove("aipkit-image-preview-fade-out"))},300)):(o.innerHTML="",o.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(o||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=c})();(function(){"use strict";function c(o,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let t=document.createElement("div");t.className="chat-image-thumbnail-wrapper";let n=document.createElement("img");n.src=o,n.alt="Image preview",n.className="chat-image-thumbnail";let i=document.createElement("button");i.className="chat-image-remove-button",i.innerHTML="\xD7",i.setAttribute("aria-label","Remove image"),i.type="button",i.onclick=()=>{let a=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,a):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},t.appendChild(n),t.appendChild(i),e.appendChild(t)}window.aipkit_renderImagePreview=c})();(function(){"use strict";function c(){let o=window.aipkitImageUploadState;return o?o.currentImageFile&&o.currentImageBase64?{mime_type:o.currentImageFile.type,base64_data:o.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=c})();(function(){"use strict";function c(){let o=window.aipkitImageUploadConstants;return o?o.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=c})();(function(){"use strict";function c(){let o=window.aipkitImageUploadConstants;return o?o.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=c})();(function(){"use strict";function c(o,e){let t=window.aipkitImageUploadState,n=window.aipkitImageUploadConstants;if(!t||!n){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!o||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}o.setAttribute("accept",n.ALLOWED_IMAGE_EXTENSIONS.join(",")),o.dataset.aipkitUploadListenerAttached!=="true"&&(o.addEventListener("change",async i=>{window.aipkit_clearImageUploadError(e);let a=i.target.files[0];if(!a){window.aipkit_resetImageUpload(e,o);return}let r=window.aipkit_validateImage(a);if(!r.isValid){window.aipkit_displayImageUploadError(r.error,e),window.aipkit_resetImageUpload(e,o),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:r.error}}));return}try{let s=await window.aipkit_convertFileToBase64(a);t.currentImageBase64=s,t.currentImageFile=a,window.aipkit_renderImagePreview(t.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:t.currentImageBase64.split(",")[1],mime_type:t.currentImageFile.type}}))}catch(s){console.error("Error processing image:",s),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,o),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),o.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:c,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(o,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(o,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:2,MAX_FILE_SIZE_BYTES:2*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function c(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=c;function o(e,t){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&t&&window.aipkit_clearChatFileUploadStatus(t),console.log("File Upload UI Reset.")}window.aipkit_resetChatFileUploadUI=o})();(function(){"use strict";function c(o){let e=window.aipkitFileUploadConstants;return e?o?e.ALLOWED_FILE_TYPES.includes(o.type)?o.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=c})();(function(){"use strict";function c(o){if(!o)return;let e=o.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=c})();(function(){"use strict";function c(o,e="info",t){if(!t)return;let n=t.querySelector(".aipkit_chat_file_upload_status");if(!n){n=document.createElement("div"),n.className="aipkit_chat_file_upload_status";let i=t.querySelector(".aipkit_chat_input_wrapper");i?t.insertBefore(n,i):t.appendChild(n)}n.textContent=o,n.className="aipkit_chat_file_upload_status",n.classList.add(`aipkit_status-${e}`),n.style.display="block"}window.aipkit_displayChatFileUploadStatus=c})();(function(){"use strict";function c(){let o=window.aipkitFileUploadConstants;return o?o.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=c})();(function(){"use strict";function c(){let o=window.aipkitFileUploadConstants;return o?o.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=c})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let c=window.aipkit_escapeHtml||function(e){return e};async function o(e,t,n,i){let a=window.aipkitFileUploadState,r=window.aipkitFileUploadConstants;if(!a||!r)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",n),null;let s=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let d of s)if(typeof window[d]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${d}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",n),null;window.aipkit_clearChatFileUploadStatus(n);let p=window.aipkit_validateChatFile(e);if(!p.isValid)return window.aipkit_displayChatFileUploadStatus(p.error,"error",n),window.aipkit_resetChatFileUploadUI(t,n),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;a.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${c(a.currentFile.name)}"...`,"processing",n);let l=new FormData;l.append("action","aipkit_frontend_chat_upload_file"),l.append("file_to_upload",a.currentFile),l.append("bot_id",i.botId),l.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&l.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&l.append("post_id",window.aipkit_current_post_id),l.append("upload_provider",i.vectorStoreProvider),l.append("_ajax_nonce",i.nonce);try{let d=await fetch(i.ajaxUrl,{method:"POST",body:l,credentials:"same-origin"}),u=await d.json();if(!d.ok||!u.success){let _=u.data?.message||u.message||"File upload failed on server.";throw new Error(_)}if(u.data&&u.data.file_context){let _=u.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(_)),console.log(`AIPKit File Upload: Stored file context for conv ${window.aipkit_current_conversation_uuid} in localStorage. Provider: ${_.provider}`)}catch(w){console.error("AIPKit File Upload: Error saving file context to localStorage:",w)}window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let f=(i.text?.fileContextActive||"Chatting with: %s").replace("%s",c(a.currentFile.name));return window.aipkit_displayChatFileUploadStatus(f,"success",n),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(d){return console.error("File Upload Processing Error:",d),window.aipkit_displayChatFileUploadStatus(`Error: ${d.message||"Upload failed."}`,"error",n),window.aipkit_resetChatFileUploadUI(t,n),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:o,resetUI:function(e,t){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,t)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function c(o,e,t,n,i=!1){let{inputField:a,actionButton:r,sendIcon:s,clearIcon:p,spinner:l,voiceInputButton:d,inputActionButton:u,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=e,w=t.text||{};if(!r||!s||!p||!l||!a)return console.error("AIPKit SetButtonState: Missing required elements."),null;l.style.display="none",s.style.display="none",p.style.display="none",r.disabled=!1,r.classList.remove("aipkit_btn-clear-state");let m=o;switch(o){case"sending":case"streaming":a.disabled=!0,r.disabled=!0,d&&(d.disabled=!0),u&&(u.disabled=!0),_&&(_.disabled=!0),f&&(f.disabled=!0),l.style.display="inline-block";let g=o==="streaming"?w.streaming||"Streaming...":w.sending||"Sending...";r.setAttribute("aria-label",g),r.setAttribute("title",g);break;case"clear":a.disabled=t.requireConsentCompliance&&!n.consentGiven,p.style.display="inline-block",r.classList.add("aipkit_btn-clear-state"),r.setAttribute("aria-label",w.clearChat||"Clear Chat"),r.setAttribute("title",w.clearChat||"Clear Chat"),r.disabled=!1,d&&(d.disabled=t.requireConsentCompliance&&!n.consentGiven),u&&(u.disabled=t.requireConsentCompliance&&!n.consentGiven),_&&(_.disabled=t.requireConsentCompliance&&!n.consentGiven),f&&(f.disabled=t.requireConsentCompliance&&!n.consentGiven);break;case"send":default:m="send",a.disabled=t.requireConsentCompliance&&!n.consentGiven,s.style.display="inline-block",r.setAttribute("aria-label",w.sendMessage||"Send Message"),r.setAttribute("title",w.sendMessage||"Send Message"),r.disabled=!i&&a.value.trim()==="",t.requireConsentCompliance&&!n.consentGiven&&(r.disabled=!0),d&&(d.disabled=t.requireConsentCompliance&&!n.consentGiven),u&&(u.disabled=t.requireConsentCompliance&&!n.consentGiven),_&&(_.disabled=t.requireConsentCompliance&&!n.consentGiven),f&&(f.disabled=t.requireConsentCompliance&&!n.consentGiven);break}return m}window.aipkit_chatUI_setButtonStateAction=c})();(function(){"use strict";function c(o,e,t){if(!o)return;let n=o.closest("#aipkit_admin_chat_preview_container"),i=window.innerWidth<=760;e.requireConsentCompliance&&!t.consentGiven||e.popupEnabled&&!t.isPopupOpen||((n||!i||t.userInitiatedAction)&&setTimeout(()=>{o&&typeof o.focus=="function"&&o.focus()},50),t.userInitiatedAction&&(t.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=c})();(function(){"use strict";function c(o,e,t,n,i,a){let{inputField:r,messagesEl:s,container:p,voiceInputButton:l,inputActionButton:d,webSearchToggleButton:u,googleSearchGroundingToggleButton:_}=t;i.isSending=!1,i.currentStreamId=null,i.currentStreamMessageId=null,r.disabled=n.requireConsentCompliance&&!i.consentGiven,l&&(l.disabled=n.requireConsentCompliance&&!i.consentGiven),d&&(d.disabled=n.requireConsentCompliance&&!i.consentGiven),u&&n.allowWebSearchTool&&n.provider==="OpenAI"&&(u.disabled=n.requireConsentCompliance&&!i.consentGiven),_&&n.allowGoogleSearchGrounding&&n.provider==="Google"&&(_.disabled=n.requireConsentCompliance&&!i.consentGiven);let f=r.value.trim()==="",w=s.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;i.buttonState=a.setButtonStateAction(f&&w?"clear":"send",!1,i),a.focusInputAction(),p.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:o,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),n.ttsEnabled&&n.ttsAutoPlay&&o&&setTimeout(()=>{let g=s.querySelector(`#${CSS.escape(o)}`)?.querySelector(".aipkit_play_btn");g&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(g):n.ttsEnabled&&n.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${n.botId}): Could not find play button for message ${o} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=c})();(function(){"use strict";function c(o,e,t=!0,n,i,a,r){let{messagesEl:s,inputField:p,container:l,voiceInputButton:d,inputActionButton:u,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=n,w=i.botId;a.isSending=!1,a.currentStreamId=null,a.currentStreamMessageId=null;let m=window.aipkit_generateClientMessageId(w);window.aipkit_chatUI_appendMessage(s,o,"bot",i,!0,!1,m,t),window.aipkit_chatUI_removeTypingIndicator(s),p.disabled=i.requireConsentCompliance&&!a.consentGiven,d&&(d.disabled=i.requireConsentCompliance&&!a.consentGiven),u&&(u.disabled=i.requireConsentCompliance&&!a.consentGiven),_&&i.allowWebSearchTool&&i.provider==="OpenAI"&&(_.disabled=i.requireConsentCompliance&&!a.consentGiven),f&&i.allowGoogleSearchGrounding&&i.provider==="Google"&&(f.disabled=i.requireConsentCompliance&&!a.consentGiven),a.buttonState=r.setButtonStateAction("send",!1,a),r.focusInputAction(),l.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:m,error:o}}))}window.aipkit_chatUI_handleError=c})();(function(){"use strict";function c(o){if(!o)return;o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{o.removeChild(t)}catch(n){n.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",n)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0)}window.aipkit_chatUI_clearMessages=c})();(function(){"use strict";function c(o,e,t,n){let{messagesEl:i,inputField:a,imagePreviewContainer:r,imageUploadInput:s,fileUploadInput:p,inputArea:l}=o;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(i),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(i);let d=i.querySelector(".aipkit_initial_greeting");if(!d&&typeof window.aipkit_chatUI_appendMessage=="function"){let _=e?.text?.initialGreeting||"Hello!";typeof window.aipkit_generateClientMessageId=="function"?(window.aipkit_chatUI_appendMessage(i,_,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)),console.log("AIPKit Clear Action: Re-appended initial greeting.")):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else d||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");a&&(a.value="",a.disabled=e.requireConsentCompliance&&!t.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(a)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?o.imagePreviewContainer&&o.imageUploadInput?(window.chatImageUpload.reset(o.imagePreviewContainer,o.imageUploadInput),console.log("AIPKit Clear Action: Image upload UI reset.")):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?o.fileUploadInput&&o.inputArea?(window.aipkitChatFileUpload.resetUI(o.fileUploadInput,o.inputArea),console.log("AIPKit Clear Action: File upload UI reset.")):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof n.setButtonStateAction=="function"?t.buttonState=n.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided."),t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof n.focusInputAction=="function"&&(!e.requireConsentCompliance||t.consentGiven)?n.focusInputAction():typeof n.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let u=i.closest(".aipkit_chat_container")||i.closest(".aipkit_popup_wrapper");u&&u.dispatchEvent(new CustomEvent("aipkit:chatCleared")),console.log(`AIPKit Chat (${e.botId}): Chat cleared.`)}window.aipkit_chatUI_clearChatAction=c})();(function(){"use strict";async function c(o,e,t,n,i=null){let{inputField:a,messagesEl:r,container:s,inputArea:p}=o,l=e.botId,d=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let k=!1,y=window.aipkit_active_file_context_data;(y.provider==="OpenAI"&&y.vector_store_id||y.provider==="Pinecone"&&y.index_name&&y.namespace||y.provider==="Qdrant"&&y.collection_name&&y.file_upload_context_id)&&(k=!0),k?(d={...y},console.log(`SendMessageAction (${l}): Using activeFileContext from window object:`,JSON.stringify(d))):(console.warn(`SendMessageAction (${l}): File context data found on window object, but missing required fields for provider: ${y.provider||"unknown"}. Context ignored. Data:`,y),d=null)}else console.log(`SendMessageAction (${l}): No valid activeFileContext found on window object for this message.`);let u=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(u=window.chatImageUpload.getImageData(),u&&o.imagePreviewContainer&&o.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(o.imagePreviewContainer,o.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&o.fileUploadInput&&p){let k=window.aipkitFileUploadState;(d||k&&k.currentFile)&&(console.log("SendMessageAction: Resetting general file upload UI because a file context was active or a file was pending."),window.aipkitChatFileUpload.resetUI(o.fileUploadInput,p))}let _=t.consentUIInstance;if(_&&typeof _.showConsentBoxIfNeeded=="function"&&_.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${l}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!t.consentGiven){console.warn(`AIPKit SendMessage (${l}): Consent required but not given.`);return}let f=i!==null?i.trim():a.value.trim();if(t.isSending||!f&&!u&&!d||i===null&&(t.buttonState!=="send"||o.actionButton.disabled))return;let w=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(d={...window.aipkit_active_file_context_data},console.log(`SendMessageAction (${l}): Re-captured activeFileContext after UUID regeneration for new chat + potential immediate file upload:`,JSON.stringify(d))))),w=!0);let m=window.aipkit_generateClientMessageId(l),g=f;u&&(g={text:f,user_image:u}),window.aipkit_chatUI_appendMessage(r,g,"user",e,!1,!1,m,!0),i===null&&(a.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(a)),w&&(window.aipkit_is_fresh_session=!1,console.log(`AIPKit SendMessageAction (${l}): Marked session as NOT fresh after initiating first message of new conversation.`));let h=(e.imageTriggers||"/image").toLowerCase().split(",").map(k=>k.trim()).filter(k=>k.length>0&&k.startsWith("/")),I=f.toLowerCase(),b=null;for(let k of h)if(I.startsWith(k+" ")||I===k){b=k;break}if(b){let k=f.substring(b.length).trim();if(!k&&I!==b){let y=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",b);n.handleError(y,!1,!0),i===null&&(t.buttonState=n.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(k,f,m,w,{state:t,elements:o,config:e,...n}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),n.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let k=window.aipkit_checkMessageModeration(f,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(k){let y=window.aipkit_generateClientMessageId(l);window.aipkit_chatUI_appendMessage(r,k.message,"bot",e,!0,!1,y),t.buttonState=n.setButtonStateAction("send",!1),n.focusInputAction(),s.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:y,reason:k.type,content:f,...k.word&&{word:k.word},...k.ip&&{ip:k.ip}}}));return}}if(t.isSending=!0,a.disabled=!0,o.voiceInputButton&&(o.voiceInputButton.disabled=!0),o.inputActionButton&&(o.inputActionButton.disabled=!0),o.webSearchToggleButton&&(o.webSearchToggleButton.disabled=!0),o.googleSearchGroundingToggleButton&&(o.googleSearchGroundingToggleButton.disabled=!0),t.buttonState=n.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),s.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:m}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")console.log(`SendMessageAction (${l}): Preparing for SSE stream. Passing activeFileContext:`,JSON.stringify(d)),window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_streamMessage(f,l,e,r,n.handleError,()=>n.handleCompletion(t.currentStreamMessageId,w),t.webSearchToolActive,t.googleSearchGroundingActive,u,d,m);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")console.log(`SendMessageAction (${l}): Preparing for AJAX call. Passing activeFileContext:`,JSON.stringify(d)),window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_sendMessage(f,l,e,o,(k,y,S,v)=>{window.aipkit_chatUI_removeTypingIndicator(r),window.aipkit_chatUI_appendMessage(r,k,"bot",e,!1,!1,y,!0,v),n.handleCompletion(y,w)},n.handleError,()=>{},t.webSearchToolActive,t.googleSearchGroundingActive,u,d,m);else{let k=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${l}): Required send function not available.`),n.handleError(k,!1)}}window.aipkit_chatUI_sendMessageAction=c})();(function(){"use strict";function c(o,e){if(!o||typeof e!="object"||Object.keys(e).length===0)return;let t=o.dataset.botId||"unknown",n=0;for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&e[i]!==""&&e[i]!==null){let a=`--aipkit-chat-${i.replace(/_/g,"-")}`,r=e[i];i==="container_max_height"||i==="popup_max_height"?r=e[i]+"vh":i==="container_max_width"||i==="popup_width"||i==="container_height"||i==="container_min_height"||i==="popup_height"||i==="popup_min_height"?r=e[i]+"px":(i==="bubble_border_radius"||i==="container_border_radius")&&typeof r=="number"?r=r===0?"0":`${r}px`:(i==="bubble_border_radius"||i==="container_border_radius")&&typeof r=="string"&&/^\d+$/.test(r)&&(r=r==="0"?"0":`${r}px`),o.style.setProperty(a,r),n++}console.log(`AIPKit Chat Theme (${t}): Applied ${n} custom theme variables.`)}window.aipkit_chatUI_applyCustomThemeStyles=c})();(function(){"use strict";function c(o){let t=`aipkit_chatbot_consent_given_${o.botId||"default"}`;return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:localStorage.getItem(t)==="true",isRecording:!1,webSearchToolActive:!1,googleSearchGroundingActive:!1}}window.aipkit_chatUI_initState=c})();(function(){"usegistrict";function c(o,e){if(!o||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let t=e.botId||"default";if(o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(i=>{try{o.removeChild(i)}catch{}}),!o.querySelector(".aipkit_initial_greeting")){let i=e.text.initialGreeting||"Hello!";if(typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(o,i,"bot",e,!1,!0,window.aipkit_generateClientMessageId(t));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let a=document.createElement("div");a.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",a.innerHTML=`<div class="aipkit_chat_bubble">${i.replace(/\n/g,"<br>")}</div>`,o.appendChild(a)}}}window.aipkit_chatUI_displayInitialMessage=c})();(function(){"use strict";function c(o,e,t,n){let{inputField:i,messagesEl:a,container:r}=o,s=e.botId;t.buttonState=n.setButtonStateAction("send",!1,t),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(i),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),i.disabled=e.requireConsentCompliance&&!t.consentGiven,o.voiceInputButton&&(o.voiceInputButton.disabled=e.requireConsentCompliance&&!t.consentGiven),o.inputActionButton&&(o.inputActionButton.disabled=e.requireConsentCompliance&&!t.consentGiven),o.webSearchToggleButton&&e.allowWebSearchTool&&e.provider==="OpenAI"&&(o.webSearchToggleButton.disabled=e.requireConsentCompliance&&!t.consentGiven),o.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(o.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!t.consentGiven),r.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:s}})),console.log(`AIPKit FinalizeSetup (${s}): Instance setup finalized.`)}window.aipkit_chatUI_finalizeSetup=c})();(function(){"use strict";function c(o,e,t,n){if(!o||!t||!n||n.isPopupOpen)return;o.classList.add("aipkit-popup-open"),o.setAttribute("aria-hidden","false"),n.isPopupOpen=!0,typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(e):console.error("AIPKit Popup Open: scrollToBottom function not found.");let i=o.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=760)||i)&&setTimeout(()=>{t&&typeof t.focus=="function"&&t.focus()},50)}window.aipkit_chatUI_openPopup=c})();(function(){"use strict";function c(o,e){!o||!e||!e.isPopupOpen||(o.classList.remove("aipkit-popup-open"),o.setAttribute("aria-hidden","true"),e.isPopupOpen=!1)}window.aipkit_chatUI_closePopup=c})();(function(){"use strict";function c(o,e,t,n,i,a,r){if(!o||!e||!a||!r){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, stateRef, or config).");return}if(t||console.warn("AIPKit Chat Popup Handlers: Close button not found. Popup cannot be closed via button."),r.directVoiceMode){console.log(`AIPKit Popup Handlers (${r.botId}): Direct Voice Mode is ON, skipping default popup toggle listener.`);return}if(typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}e.addEventListener("click",s=>{s.stopPropagation(),a.isPopupOpen?window.aipkit_chatUI_closePopup(o,a):window.aipkit_chatUI_openPopup(o,n,i,a)}),t&&t.addEventListener("click",s=>{s.stopPropagation(),window.aipkit_chatUI_closePopup(o,a)}),document.addEventListener("keydown",s=>{s.key==="Escape"&&a.isPopupOpen&&window.aipkit_chatUI_closePopup(o,a)})}window.aipkit_chatUI_setupPopupHandlers=c})();(function(){"use strict";function c(o,e){let t=new Date,n=`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${String(t.getHours()).padStart(2,"0")}${String(t.getMinutes()).padStart(2,"0")}`;return`chat-${o.botId||"transcript"}-${n}.${e}`}window.aipkit_chatUI_generateDownloadFilename=c})();(function(){"use strict";function c(o,e){let t=document.createElement("a");if(typeof t.download=="string")t.href=URL.createObjectURL(o),t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href),console.log("AIPKit Chat Download: Triggered download for",e);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let n=URL.createObjectURL(o);window.open(n,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=c})();(function(){"use strict";function c(o,e){let{messagesEl:t}=o;if(!t||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let n="",i=t.querySelectorAll(".aipkit_chat_message"),a=e?.headerName||"Bot",r=e.text.userPrefix||"User",s=e.text.errorPrefix||"Error";if(i.forEach(d=>{let u=d.querySelector(".aipkit_chat_bubble");if(!u)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),n+=`Error: Could not extract text.
`;return}let _=window.aipkit_chatUI_extractTextFromBubble(u),f="";d.classList.contains("aipkit_chat_message-user")?f=`[${r}]:`:d.classList.contains("aipkit_chat_message-bot")?f=`[${a}]:`:d.classList.contains("aipkit_chat_message-error")&&(f=`[${s}]:`),f&&_&&(n+=`${f}
${_}

`)}),n=n.trim(),!n){console.warn("AIPKit Chat Download TXT: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let p=new Blob([n],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),alert("Error: Could not prepare download.");return}let l=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(p,l)}window.aipkit_chatUI_downloadTranscriptActionTxt=c})();(function(){"use strict";let c="aipkit_sidebar_state_";function o(e){return`${c}${e||"default"}`}window.aipkit_sidebar_getStorageKey=o})();(function(){"use strict";function c(o,e){if(!e||!o)return;let t=o.querySelector(".aipkit_chat_footer");if(!t){e.style.display="none";return}if(window.getComputedStyle(t).display!=="none"&&window.getComputedStyle(t).visibility!=="hidden"&&t.offsetHeight>0){let i=t.offsetHeight;i>0&&(e.style.height=`${i}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=c})();(function(){"use strict";function o(e,t,n,i,a){let r=window.innerWidth<=760;a.mobileOverlayHandler&&(document.removeEventListener("click",a.mobileOverlayHandler,!0),a.mobileOverlayHandler=null),e&&r&&(a.mobileOverlayHandler=i,setTimeout(()=>{document.addEventListener("click",a.mobileOverlayHandler,{capture:!0,once:!1})},50))}window.aipkit_sidebar_manageMobileOverlayListener=o})();(function(){"use strict";function c(o,e,t,n,i,a,r,s,p,l){!e||!t||(e.classList.toggle("aipkit-sidebar-state-open",o),e.classList.toggle("aipkit-sidebar-state-closed",!o),t.setAttribute("aria-expanded",o.toString()),localStorage.setItem(n,o?"open":"closed"),typeof i=="function"&&r&&i(e,r.querySelector(".aipkit_sidebar_footer")),typeof a=="function"&&r&&a(o,r,t,p,s))}window.aipkit_sidebar_applyCurrentState=c})();(function(){"use strict";function c(o,e,t){let n=o.isSidebarOpen;o.isSidebarOpen=!o.isSidebarOpen,!n&&o.isSidebarOpen&&typeof t=="function"&&t()}window.aipkit_sidebar_toggleSidebar=c})();(function(){"use strict";function o(e,t,n,i){let a=e.config?.botId||"unknown";if(console.log(`AIPKit Sidebar (${a}): New Chat clicked.`),typeof e.clearChatAction=="function"){e.clearChatAction();let r=t?t.querySelector(".aipkit_conversation_item.aipkit_active"):null;r&&r.classList.remove("aipkit_active"),window.innerWidth<=760&&n.isSidebarOpen&&typeof i=="function"&&i()}else console.error(`AIPKit Sidebar (${a}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=o})();(function(){"use strict";function c(o,e,t){let n=e.botId||"unknown";if(!o||!e||!t){console.error(`AIPKit Sidebar (${n}): Missing elements or functions for fetchConversationList.`),o&&(o.innerHTML='<p style="text-align:center; color:red;">Error: Cannot load list.</p>');return}if(!e.nonce){o.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${e.text.historyGuests||"History unavailable."}</p>`;return}o.innerHTML='<p style="text-align:center; padding:10px;"><span class="aipkit_spinner" style="display:inline-block;width:16px;height:16px;"></span></p>',window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(i=>{typeof t=="function"?t(i.conversations||[]):(console.error(`AIPKit Sidebar (${n}): renderConversationListFunc is not a function.`),o.innerHTML='<p style="text-align:center; color:red;">Error: Cannot display list.</p>')}).catch(i=>{console.error(`AIPKit Sidebar (${n}): Error fetching conversation list:`,i),o.innerHTML=`<p style="text-align:center; color:red;">Error loading list: ${i.message||"Unknown error"}</p>`})}window.aipkit_sidebar_fetchConversationList=c})();(function(){"use strict";function o(e,t,n,i,a,r,s){let p=n.botId||"unknown";if(!t||!n||!i||typeof a!="function"||typeof r!="function"||typeof s!="function"){console.error(`AIPKit Sidebar (${p}): Missing elements or functions for renderConversationList.`),t&&(t.innerHTML='<p style="text-align:center; color:red;">Error: Cannot render list.</p>');return}if(!e||e.length===0){t.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${n.text.historyEmpty||"No past conversations."}</p>`;return}t.innerHTML="";let l=window.aipkit_current_conversation_uuid||null;e.forEach(d=>{let u=document.createElement("div");u.className="aipkit_conversation_item",u.setAttribute("data-conversation-id",d.id);let _=document.createElement("span");_.textContent=d.title||d.id.substring(0,8),_.title=`${d.title||d.id.substring(0,8)} (ID: ${d.id})`,u.appendChild(_);let f=document.createElement("button");f.type="button",f.className="aipkit_conversation_item_delete_btn",f.setAttribute("aria-label",`Delete conversation: ${_.title}`),f.innerHTML='<span class="dashicons dashicons-no-alt"></span>',f.title="Delete Conversation",u.appendChild(f);let w=document.createElement("span");w.className="aipkit_conversation_item_spinner aipkit_spinner",u.appendChild(w),l&&d.id===l&&u.classList.add("aipkit_active"),u.addEventListener("click",m=>{m.target.closest(".aipkit_conversation_item_delete_btn")||i.isDeletingId===d.id||(a(d.id),window.innerWidth<=760&&i.isSidebarOpen&&s())}),f.addEventListener("click",m=>{m.stopPropagation(),!i.isDeletingId&&r(d.id,u)}),t.appendChild(u)})}window.aipkit_sidebar_renderConversationList=o})();(function(){"use strict";function c(o,e,t,n,i,a){let r=n.botId||"unknown";if(i.isDeletingId)return;i.isDeletingId=o;let s=e.querySelector(".aipkit_conversation_item_delete_btn"),p=e.querySelector(".aipkit_conversation_item_spinner");s&&(s.style.display="none"),p&&(p.style.display="inline-block"),e.style.opacity="0.6";let l={bot_id:r,conversation_uuid:o};window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",l,n).then(d=>{e.style.transition="opacity 0.3s ease-out, max-height 0.3s ease-out",e.style.opacity="0",e.style.maxHeight="0",e.style.padding="0",e.style.marginBottom="0",e.style.overflow="hidden",setTimeout(()=>{e.parentNode&&e.remove(),t&&t.childElementCount===0&&(t.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${n.text.historyEmpty||"No past conversations."}</p>`)},300),window.aipkit_current_conversation_uuid===o&&(typeof a.clearChatAction=="function"?a.clearChatAction():console.error(`AIPKit Sidebar (${r}): clearChatAction is not a function in actions object.`))}).catch(d=>{alert(`Error deleting conversation: ${d.message||"Unknown error"}`),s&&(s.style.display="inline-flex"),p&&(p.style.display="none"),e.style.opacity="1"}).finally(()=>{i.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=c})();(function(){"use strict";function o(e,t,n,i,a,r,s){let p=i.botId||"unknown";if(!e||a.isDeletingId===e)return;console.log(`AIPKit Sidebar (${p}): Loading existing conversation: ${e}`),sessionStorage.setItem("aipkit_current_conversation_uuid",e),window.aipkit_current_conversation_uuid=e,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let d=localStorage.getItem(`aipkit_file_context_${e}`);if(d){let u=JSON.parse(d),_=!1;u&&u.provider&&(u.provider==="OpenAI"&&u.vector_store_id||u.provider==="Pinecone"&&u.index_name&&u.namespace||u.provider==="Qdrant"&&u.collection_name&&u.file_upload_context_id)&&(_=!0),_?(window.aipkit_active_file_context_provider=u.provider,window.aipkit_active_file_context_data=u,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:u})),console.log(`AIPKit Sidebar (${p}): Restored file context for conv ${e} from localStorage:`,u)):(console.warn(`AIPKit Sidebar (${p}): Invalid file context data in localStorage for conv ${e}. Clearing. Data:`,u),localStorage.removeItem(`aipkit_file_context_${e}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Sidebar (${p}): No file context found in localStorage for conv ${e}. Global context cleared.`)}catch(d){console.error("AIPKit Sidebar: Error handling localStorage for file context:",d),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(t?t.querySelectorAll(".aipkit_conversation_item"):[]).forEach(d=>{d.classList.remove("aipkit_active"),d.getAttribute("data-conversation-id")===e&&d.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"?(window.aipkit_chatUI_clearMessages(n),n.innerHTML='<div class="aipkit_detail_spinner" style="margin: 20px auto; display: block;"><span class="aipkit_spinner"></span></div>'):n.innerHTML="",window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},i).then(d=>{n.innerHTML="";let u=d.history||[];if(u.length===0)typeof window.aipkit_chatUI_appendMessage=="function"&&i.text.initialGreeting?typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(n,i.text.initialGreeting,"bot",i,!1,!0,window.aipkit_generateClientMessageId(p)):n.innerHTML=`<p style="text-align:center; font-style: italic; padding: 20px;">${i.text.historyEmpty||"No past messages."}</p>`;else{let f=null;u.forEach(w=>{let m=w.role==="assistant"||w.role==="bot"?"bot":"user",g=w.content||"";w.response_data&&w.response_data.type==="image"&&w.response_data.images&&w.response_data.images.length>0&&(g={type:"image",images:w.response_data.images,prompt:w.request_payload?.prompt||w.content}),w.response_data&&w.response_data.type==="user_image_upload"&&w.response_data.images&&w.response_data.images.length>0&&(g={text:w.content||"",user_image:w.response_data.images[0]}),window.aipkit_chatUI_appendMessage(n,g,m,i,w.role==="bot"&&(w.content||"").startsWith("Error:"),!1,w.message_id||null,!1,w.grounding_metadata||null),(m==="bot"||m==="assistant")&&w.openai_response_id&&(f=w.openai_response_id)}),f&&(window.aipkit_current_openai_response_id=f,sessionStorage.setItem("aipkit_current_openai_response_id",f),console.log(`AIPKit Sidebar (${p}): Set OpenAI Response ID from history: ${f}`)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1),typeof r.focusInputAction=="function"&&r.focusInputAction();let _=n.closest(".aipkit_chat_container");_&&_.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:e}}))}).catch(d=>{n.innerHTML=`<p style="color:red;text-align:center;">Error loading history: ${d.message||"Unknown error"}</p>`,typeof r.setButtonStateAction=="function"&&r.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=o})();(function(){"use strict";function o(e,t,n,i){let{sidebarToggleBtn:a,sidebarEl:r,newChatBtn:s}=t,p=e.querySelector(".aipkit_chat_messages"),l=e.querySelector(".aipkit_chat_main"),d=r?r.querySelector(".aipkit_sidebar_content"):null,u=r?r.querySelector(".aipkit_sidebar_footer"):null;if(!e||!a||!r||!d||!p||!l){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:a,sidebarEl:r,sidebarContentEl:d,messagesEl:p,mainContentEl:l});return}let _=n.botId;if(!_){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),a.disabled=!0,s&&(s.disabled=!0),d.innerHTML='<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">Configuration Error</p>';return}let f={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null},w=window.aipkit_sidebar_getStorageKey(_),m=localStorage.getItem(w);f.isSidebarOpen=m==="open";let g=v=>{f.isSidebarOpen&&window.innerWidth<=760&&!r.contains(v.target)&&!a.contains(v.target)&&y()},h=v=>window.aipkit_sidebar_applyCurrentState(f.isSidebarOpen,e,a,w,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,r,f,g,v),I=()=>window.aipkit_sidebar_fetchConversationList(d,n,v=>window.aipkit_sidebar_renderConversationList(v,d,n,f,b,k,y)),b=v=>window.aipkit_sidebar_loadConversation(v,d,p,n,f,i,y),k=(v,A)=>window.aipkit_sidebar_handleDeleteConversation(v,A,d,n,f,i),y=()=>{window.aipkit_sidebar_toggleSidebar(f,h,I),h(f.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,u),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,u)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),h(!1),a.addEventListener("click",y),s&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof i.clearChatAction=="function"?(s.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(i,d,f,y)),s.disabled=!1):s&&(s.disabled=!0,console.warn(`AIPKit Sidebar (${_}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{f.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(f.isSidebarOpen,r,a,g,f)}),(f.isSidebarOpen||!n.nonce)&&I();let S=v=>{v.detail&&v.detail.newConversation&&f.isSidebarOpen&&I()};e.addEventListener("aipkit:messageReceived",S),console.log(`AIPKit Sidebar (${_}): Orchestrator initialized. Initial state: ${f.isSidebarOpen?"open":"closed"}`)}window.aipkit_initConversationSidebar=o})();(function(){"use strict";function c(o){if(!o)return"";let e="",t=o.childNodes;function n(i){if(i.nodeType===Node.TEXT_NODE)return i.textContent;if(i.nodeName==="BR")return`
`;if(i.nodeType===Node.ELEMENT_NODE){let a="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(i.tagName)&&(a+=`
`),i.tagName==="LI"&&(a+="- "),i.childNodes.forEach(r=>{a+=n(r)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(i.tagName)&&(a+=`
`),a}return""}return t.forEach(i=>{e+=n(i)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=c})();(function(){"use strict";function c(o,e=1500){let t=o.querySelector(".dashicons");if(!t){console.warn("AIPKit showSuccessIcon: Icon element not found inside button:",o);return}o.dataset.originalIconClass||(o.dataset.originalIconClass=t.className);let n="dashicons dashicons-yes-alt";if(o.dataset.successTimeoutId||o.disabled||t.className===n)return;t.className=n,t.style.color="var(--aipkit_status-success, #38A169)",o.dataset.successTimeoutId&&clearTimeout(parseInt(o.dataset.successTimeoutId,10));let i=setTimeout(()=>{let a=o.querySelector(".dashicons"),r=o.dataset.originalIconClass;a&&a.className===n&&r&&(a.className=r,a.style.color="",delete o.dataset.originalIconClass),delete o.dataset.successTimeoutId},e);o.dataset.successTimeoutId=i.toString()}window.aipkit_chatUI_showSuccessIcon=c})();(function(){"use strict";function c(o,e){let t=o.target.closest(".aipkit_copy_btn");if(!t||t.disabled||t.dataset.successTimeoutId)return;let n=t.closest(".aipkit_chat_message"),i=n?n.querySelector(".aipkit_chat_bubble"):null;if(!n||!i){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let a=window.aipkit_chatUI_extractTextFromBubble(i);if(!a){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(a).then(()=>{window.aipkit_chatUI_showSuccessIcon(t)}).catch(r=>{console.error("AIPKit Message Actions: Clipboard API failed:",r)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let r=document.createElement("textarea");r.value=a,r.style.position="fixed",r.style.top="-9999px",r.style.left="-9999px",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select();let s=document.execCommand("copy");if(document.body.removeChild(r),s)window.aipkit_chatUI_showSuccessIcon(t);else throw new Error("execCommand failed")}catch(r){console.error("AIPKit Message Actions: Fallback copy method failed:",r)}}}window.aipkit_chatUI_handleCopyAction=c})();(function(){"use strict";function c(o,e){let t=o.target.closest(".aipkit_feedback_btn");if(!t||t.disabled||t.classList.contains("aipkit_feedback_selected"))return;let n=t.getAttribute("data-feedback"),i=t.closest(".aipkit_chat_message"),a=i?i.getAttribute("data-message-id"):null,r=t.closest(".aipkit_message_actions");if(!a||!n||!r){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}console.log(`AIPKit Feedback (${e.botId}): Type=${n}, MessageID=${a}`);let s=r.querySelectorAll(".aipkit_feedback_btn");if(s.forEach(l=>{l.disabled=!0,l===t?l.classList.add("aipkit_feedback_selected"):(l.classList.remove("aipkit_feedback_selected"),l.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),s.forEach(l=>{l.disabled=!1,l.classList.remove("aipkit_feedback_selected"),l.style.opacity="1"});return}let p={message_id:a,feedback_type:n};window.aipkit_frontendApiRequest("aipkit_store_feedback",p,e).then(l=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${a}.`,l)}).catch(l=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${a}:`,l),s.forEach(d=>{d.disabled=!1,d.classList.remove("aipkit_feedback_selected"),d.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=c})();(function(){"use strict";function c(o){let e="",t=o.text||{};if(o.ttsEnabled){let n=t.playActionLabel||"Play audio";e+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${n}" aria-label="${n}"><span class="dashicons dashicons-controls-play"></span></button>`}if(o.enableCopyButton){let n=t.copyActionLabel||"Copy response";e+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${n}" aria-label="${n}"><span class="dashicons dashicons-admin-page"></span></button>`}if(o.enableFeedback){let n=t.feedbackLikeLabel||"Like response",i=t.feedbackDislikeLabel||"Dislike response";e+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${n}" aria-label="${n}" data-feedback="up"><span class="dashicons dashicons-thumbs-up"></span></button>`,e+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${i}" aria-label="${i}" data-feedback="down"><span class="dashicons dashicons-thumbs-down"></span></button>`}return e?`<div class="aipkit_message_actions">${e}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=c})();(function(){"use strict";function c(o,e){if(!o){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}if(o.dataset.aipkitMessageActionsListenerAttached==="true"){console.log("AIPKit Init Message Actions: Listener already attached.");return}o.dataset.aipkitMessageActionsListenerAttached="true",o.addEventListener("click",function(t){if(t.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(t,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(t.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(t,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}),console.log("AIPKit Init Message Actions: Event listeners for copy/feedback attached to messages container.")}window.aipkit_chatUI_initMessageActions=c})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function c(o=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null,console.log("AIPKit TTS StopAudio: Audio stopped and resources released.")),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),console.log("AIPKit TTS StopAudio: Revoked Blob URL:",e.currentBlobUrl),e.currentBlobUrl=null),o&&e.currentlyPlayingButton){console.log("AIPKit TTS StopAudio: Resetting button state for:",e.currentlyPlayingButton),e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let t=e.currentlyPlayingButton.querySelector(".dashicons");if(t){let n=e.currentlyPlayingButton.getAttribute("data-original-icon-class");t.className=n||"dashicons dashicons-controls-play",e.currentlyPlayingButton.removeAttribute("data-original-icon-class")}e.currentlyPlayingButton=null}else!o&&e.currentlyPlayingButton&&console.log("AIPKit TTS StopAudio: Called without forcing button reset (button might be reset by error handler).")}window.aipkit_tts_stopCurrentAudio=c})();(function(){"use strict";function c(){let n=window.aipkitTtsState;if(!n||!n.currentAudio||!n.currentlyPlayingButton)return;console.log("AIPKit TTS Handler: Audio ready to play."),n.currentlyPlayingButton.classList.remove("aipkit_loading"),n.currentlyPlayingButton.classList.add("aipkit_playing"),n.currentlyPlayingButton.disabled=!1;let i=n.currentlyPlayingButton.querySelector(".dashicons");i&&(n.currentlyPlayingButton.hasAttribute("data-original-icon-class")||n.currentlyPlayingButton.setAttribute("data-original-icon-class",i.className),i.className="dashicons dashicons-controls-pause"),n.currentAudio.play().catch(a=>{console.error("AIPKit TTS Handler: Error starting playback:",a),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(a)})}function o(){console.log("AIPKit TTS Handler: Audio finished playing."),typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function e(){let n=window.aipkitTtsState;!n||!n.currentAudio||(console.log("AIPKit TTS Handler: Audio paused. Stopping."),typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function t(n){let i=window.aipkitTtsState;if(!i)return;console.error("AIPKit TTS Handler: Error playing audio.",n);let a=i.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),a){a.classList.remove("aipkit_loading","aipkit_playing"),a.classList.add("aipkit_error"),a.disabled=!1;let r=a.querySelector(".dashicons");if(r){let s=a.getAttribute("data-original-icon-class");r.className=s||"dashicons dashicons-controls-play",a.removeAttribute("data-original-icon-class")}}i.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=c,window.aipkit_tts_handleAudioEnded=o,window.aipkit_tts_handleAudioPaused=e,window.aipkit_tts_handleAudioError=t})();(function(){"use strict";function c(o,e,t){let n=window.aipkitTtsState;if(!n){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let i=atob(o),a=new Array(i.length);for(let p=0;p<i.length;p++)a[p]=i.charCodeAt(p);let r=new Uint8Array(a),s=new Blob([r],{type:e});n.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(n.currentBlobUrl),n.currentBlobUrl=URL.createObjectURL(s),console.log("AIPKit TTS PlayFromBase64: Created Blob URL:",n.currentBlobUrl),n.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),n.currentAudio=new Audio(n.currentBlobUrl),n.currentlyPlayingButton=t,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&n.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&n.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&n.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?n.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),console.log("AIPKit TTS PlayFromBase64: Loading audio source from Blob URL"),n.currentAudio.load()}catch(i){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",i),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(i)}}window.aipkit_tts_playAudioFromBase64=c})();(function(){"use strict";async function c(o){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),o&&(o.classList.remove("aipkit_loading"),o.classList.add("aipkit_error"),o.disabled=!1);return}let t=o.closest(".aipkit_chat_message"),n=t?t.querySelector(".aipkit_chat_bubble"):null,i=o.closest(".aipkit_chat_container[data-config]");i||(i=o.closest(".aipkit_popup_wrapper[data-config]"));let a=i?i.getAttribute("data-config"):null,r=null;if(!n||!i||!a){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),o&&(o.classList.remove("aipkit_loading"),o.classList.add("aipkit_error"),o.disabled=!1);return}try{r=JSON.parse(a)}catch(l){console.error("AIPKit TTS PlayAction: Failed to parse config.",l);return}let s=n.getAttribute("data-raw-text")||"",p=r.botId;if(!s){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!p){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(o===e.currentlyPlayingButton){console.log("AIPKit TTS PlayAction: Clicked the currently playing/loading button. Stopping."),typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),o.classList.remove("aipkit_error","aipkit_playing"),o.classList.add("aipkit_loading"),o.disabled=!0;try{let l={text:s};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let d=await window.aipkit_frontendApiRequest("aipkit_generate_speech",l,r);if(d&&d.audio_data_base64&&d.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(d.audio_data_base64,d.mime_type,o);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",d),new Error("Invalid response received from speech generation.")}catch(l){if(console.error("AIPKit TTS PlayAction: Error generating speech:",l),o){o.classList.remove("aipkit_loading","aipkit_playing"),o.classList.add("aipkit_error"),o.disabled=!1;let d=o.querySelector(".dashicons");if(d){let u=o.getAttribute("data-original-icon-class");d.className=u||"dashicons dashicons-controls-play",o.removeAttribute("data-original-icon-class")}}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=c})();(function(){"use strict";function c(o,e,t,n,i){return new Promise((a,r)=>{if(!e.ajaxUrl)return r(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return r(new Error("Missing nonce in config for SSE cache."));let s=new FormData;s.append("action","aipkit_cache_sse_message"),s.append("message",o),s.append("_ajax_nonce",e.nonce),t&&s.append("image_inputs",JSON.stringify([t])),i&&s.append("user_client_message_id",i);let p=n;if(!p&&window.aipkit_current_conversation_uuid)try{let l=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);l&&(p=JSON.parse(l),console.log(`CacheSSE: Loaded file context for conv ${window.aipkit_current_conversation_uuid} from localStorage to augment request:`,JSON.stringify(p)))}catch(l){console.error("CacheSSE: Error reading file context from localStorage:",l)}p&&(p.provider==="OpenAI"&&p.vector_store_id&&(s.append("active_openai_vs_id",p.vector_store_id),console.log(`AIPKit Cache SSE: Sending active_openai_vs_id: ${p.vector_store_id}`)),p.provider==="Pinecone"&&p.index_name&&p.namespace&&(s.append("active_pinecone_index_name",p.index_name),s.append("active_pinecone_namespace",p.namespace),console.log(`AIPKit Cache SSE: Sending Pinecone context: Index: ${p.index_name}, Namespace: ${p.namespace}`)),p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id&&(s.append("active_qdrant_collection_name",p.collection_name),s.append("active_qdrant_file_upload_context_id",p.file_upload_context_id),console.log(`AIPKit Cache SSE: Sending Qdrant context: Collection: ${p.collection_name}, File Context ID: ${p.file_upload_context_id}`))),fetch(e.ajaxUrl,{method:"POST",body:s}).then(l=>l.ok?l.json():l.json().then(d=>{throw new Error(d?.data?.message||`HTTP error ${l.status} caching message.`)}).catch(()=>{throw new Error(`HTTP error ${l.status} caching message (non-JSON response).`)})).then(l=>{l.success&&l.data?.cache_key?a(l.data.cache_key):r(new Error(l.data?.message||"Failed to cache message for streaming."))}).catch(l=>{console.error("AIPKit SSE Cache Request Error:",l),r(l)})})}window.aipkit_chatUI_cacheSseMessage=c})();(function(){"use strict";function c(o,e,t,n,i,a,r,s,p,l){if(!t.ajaxUrl||!t.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let d=new URL(t.ajaxUrl);d.searchParams.append("action","aipkit_frontend_chat_stream"),d.searchParams.append("cache_key",o),d.searchParams.append("bot_id",e),d.searchParams.append("session_id",n||""),d.searchParams.append("conversation_uuid",i),a>0&&d.searchParams.append("post_id",a),t.provider==="OpenAI"&&t.enableOpenAIConversationState&&r&&d.searchParams.append("previous_openai_response_id",r),s&&t.provider==="OpenAI"&&t.allowWebSearchTool&&d.searchParams.append("frontend_web_search_active","true"),p&&t.provider==="Google"&&t.allowGoogleSearchGrounding&&d.searchParams.append("frontend_google_search_grounding_active","true"),l&&(l.provider==="OpenAI"&&l.vector_store_id&&(d.searchParams.append("active_openai_vs_id",l.vector_store_id),console.log(`AIPKit CreateEventSource: Added active_openai_vs_id to stream URL: ${l.vector_store_id}`)),l.provider==="Pinecone"&&l.index_name&&l.namespace&&(d.searchParams.append("active_pinecone_index_name",l.index_name),d.searchParams.append("active_pinecone_namespace",l.namespace),console.log(`AIPKit CreateEventSource: Added Pinecone context to stream URL: Index: ${l.index_name}, Namespace: ${l.namespace}`)),l.provider==="Qdrant"&&l.collection_name&&l.file_upload_context_id&&(d.searchParams.append("active_qdrant_collection_name",l.collection_name),d.searchParams.append("active_qdrant_file_upload_context_id",l.file_upload_context_id),console.log(`AIPKit CreateEventSource: Added Qdrant context to stream URL: Collection: ${l.collection_name}, File Context ID: ${l.file_upload_context_id}`))),d.searchParams.append("_ajax_nonce",t.nonce);try{let u=new EventSource(d.toString());return console.log(`[AIPKit Stream CreateEventSource (${e})] EventSource created for URL: ${d.toString()}`),u}catch(u){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,u),u}}window.aipkit_chatUI_createEventSource=c})();(function(){"use strict";function c(o,e,t,n){try{let i=JSON.parse(o.data),a=i.message_id;if(a){if(t.currentStreamMessageId&&t.currentStreamMessageId!==a&&n){let r=n.querySelector(`#${CSS.escape(t.currentStreamMessageId)}`);if(r){let s=r.querySelector(".aipkit_chat_bubble");if(s){let p=s.querySelector(".aipkit_stream_indicator");p&&p.parentNode&&p.parentNode.removeChild(p)}r.classList.remove("aipkit_message_streaming"),r.classList.add("aipkit_message_complete"),console.log(`[AIPKit Stream HandleMessageStart] Cleaned up previous stream indicator for message ID: ${t.currentStreamMessageId}`)}}t.currentStreamMessageId=a,console.log(`[AIPKit Stream HandleMessageStart] Received message_start with ID: ${t.currentStreamMessageId}`)}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&i.openai_response_id&&(window.aipkit_current_openai_response_id=i.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",i.openai_response_id),console.log(`[AIPKit Stream HandleMessageStart] Stored new OpenAI Response ID: ${i.openai_response_id}`))}catch(i){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",o.data,i)}}window.aipkit_chatUI_handleMessageStartEvent=c})();(function(){"use strict";function c(o,e){try{let t=JSON.parse(o.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.id&&(window.aipkit_current_openai_response_id=t.id,sessionStorage.setItem("aipkit_current_openai_response_id",t.id),console.log(`[AIPKit Stream HandleOpenAIResponseId] Stored new OpenAI Response ID: ${t.id}`))}catch(t){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",o.data,t)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=c})();(function(){"use strict";function c(o,e){try{let t=JSON.parse(o.data);e.accumulatedGroundingMetadata=t,console.log("[AIPKit Stream HandleGroundingMetadata] Received event:",t)}catch(t){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",o.data,t)}}window.aipkit_chatUI_handleGroundingMetadataEvent=c})();(function(){"use strict";function c(o,e,t,n,i){try{let a=JSON.parse(o.data),r=a.delta;if(r!==void 0&&i.currentStreamMessageId)if(i.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(n,i.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(n,!0);else{i.dataReceived=!0;let s=`aipkit-typing-indicator-${e}`,p=n.querySelector(`#${CSS.escape(s)}`);if(p){let l=p.querySelector(".aipkit_chat_bubble");if(l){p.id=i.currentStreamMessageId,p.setAttribute("data-message-id",i.currentStreamMessageId),p.classList.remove("aipkit_typing-indicator"),l.dataset.aipkitFullContent=r,l.innerHTML=window.aipkit_md?window.aipkit_md.render(r):r.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(l,"aipkit_stream_indicator");let d=typeof window.createActionsContainerHTML=="function"?window.createActionsContainerHTML(t):"";d&&!p.querySelector(".aipkit_message_actions")&&p.insertAdjacentHTML("beforeend",d),window.aipkit_chatUI_scrollToBottom(n,!0)}else window.aipkit_chatUI_removeTypingIndicator(n,p),window.aipkit_chatUI_appendOrUpdateMessage(n,i.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(n,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(n,i.currentStreamMessageId,r,"bot",t,!1,!1,null),window.aipkit_chatUI_scrollToBottom(n,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,a)}catch(a){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,o.data,a)}}window.aipkit_chatUI_handleOnMessageEvent=c})();(function(){"use strict";function c(o,e,t,n,i,a,r){console.log(`[AIPKit Stream HandleDone (${e})] Received 'done' event.`),typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&r.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(n,r.currentStreamMessageId,"","bot",t,!0,!1,r.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),typeof i=="function"&&i(),a.current&&(a.current.close(),a.current=null)}window.aipkit_chatUI_handleDoneEvent=c})();(function(){"use strict";function c(o,e,t,n,i){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,o.data),i.dataReceived||(i.dataReceived=!0);try{let a=JSON.parse(o.data);a.error&&i.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(n,i.currentStreamMessageId,`

*${a.error}*`,"bot",t,!1,!0,null),window.aipkit_chatUI_scrollToBottom(n,!0))}catch(a){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,o.data,a)}}window.aipkit_chatUI_handleWarningEvent=c})();(function(){"use strict";function c(o,e,t,n,i,a,r){window.aipkit_chatUI_removeTypingIndicator(n);let s=t.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,o);let p=null;if(o.data)try{let d=JSON.parse(o.data);d.error&&(p=d.error)}catch{typeof o.data=="string"&&o.data.length>0&&o.data.length<200&&(p=o.data)}else o.target&&o.target.readyState===EventSource.CLOSED?p="Connection was closed.":o.message&&(p=o.message);let l="";p?l=`${s.errorPrefix||"Error:"} ${p}`:l=r.dataReceived?s.streamError||"Stream error. Please try again.":s.connError||"Connection error. Please check setup or try again.",typeof i=="function"&&i(l,!1,!0),r.currentStreamMessageId=null,a.current&&(a.current.close(),a.current=null)}window.aipkit_chatUI_handleErrorEvent=c})();(function(){"use strict";function c(o,e,t,n,i){console.log(`[AIPKit Stream HandleDisplayForm (${e})] Received 'display_form_event'. Data:`,o.data),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n);try{let r=JSON.parse(o.data).form_definition;if(typeof r!="object"||r===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let s=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(n,r,t,s);let p=n.closest(".aipkit_chat_container");p&&p.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:r.form_id,messageId:s}}))}catch(a){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,a,"Raw event data:",o.data)}}window.aipkit_chatUI_handleDisplayFormEvent=c})();(function(){"use strict";async function c(o,e,t,n,i,a,r,s,p,l,d){let u=t.text||{},_={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},f={current:null},w=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let y of w)if(typeof window[y]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${y}`),typeof i=="function"&&i(`${u.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n);return}let m=window.aipkit_current_conversation_uuid,g=window.aipkit_guest_uuid,h=window.aipkit_current_post_id,I=window.aipkit_current_openai_response_id;if(!m){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof i=="function"&&i(u.errorPrefix+" "+(u.connError||"Configuration error (Conv ID)."),!1);return}let b=null;try{console.log(`[AIPKit Stream Orchestrator (${e})] Caching message before starting stream... activeFileContext being passed to cache:`,JSON.stringify(l)),b=await window.aipkit_chatUI_cacheSseMessage(o,t,p,l,d),console.log(`[AIPKit Stream Orchestrator (${e})] Message cached successfully. Cache Key: ${b}`)}catch(y){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,y.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,y),typeof i=="function"){let S=`${u.errorPrefix||"Error:"} Failed to prepare message for streaming.`;y&&typeof y=="object"&&y.code?S+=` (Code: ${y.code})`:y&&y.message?S+=` (${y.message})`:S+=" (Unknown error)",i(S)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n);return}console.log(`[AIPKit Stream Orchestrator (${e})] Attempting connection... Guest: ${g||"N/A"}, Conversation: ${m}, PostID: ${h}, PrevOpenAIRespID: ${I||"N/A"}, OpenAIWebSearchActive: ${r}, GoogleGroundingActive: ${s}`),console.log(`[AIPKit Stream Orchestrator (${e})] Active File Context for EventSource:`,JSON.stringify(l));let k=window.aipkit_chatUI_createEventSource(b,e,t,g,m,h,I,r,s,l);if(k instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,k),typeof i=="function"&&i(u.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(n);return}f.current=k,f.current.onopen=function(y){console.log(`[AIPKit Stream Orchestrator (${e})] Connection opened.`,y)},f.current.addEventListener("message_start",y=>window.aipkit_chatUI_handleMessageStartEvent(y,t,_,n)),f.current.addEventListener("openai_response_id",y=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(y,t)),f.current.addEventListener("grounding_metadata",y=>window.aipkit_chatUI_handleGroundingMetadataEvent(y,_)),f.current.addEventListener("display_form_event",y=>window.aipkit_chatUI_handleDisplayFormEvent(y,e,t,n,_)),f.current.onmessage=y=>window.aipkit_chatUI_handleOnMessageEvent(y,e,t,n,_),f.current.addEventListener("done",y=>window.aipkit_chatUI_handleDoneEvent(y,e,t,n,a,f,_)),f.current.addEventListener("warning",y=>window.aipkit_chatUI_handleWarningEvent(y,e,t,n,_)),f.current.onerror=y=>window.aipkit_chatUI_handleErrorEvent(y,e,t,n,i,f,_)}window.aipkit_chatUI_streamMessage=c})();(function(){"use strict";async function c(o,e,t,n){o.preventDefault();let i=o.target;if(!i)return;let a=i.dataset.formId;if(!a){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let r=new FormData(i),s={};for(let[u,_]of r.entries())if(u.endsWith("[]")){let f=u.slice(0,-2);s[f]||(s[f]=[]),s[f].push(_)}else s[u]=_;console.log(`AIPKit Chat Form (${e.botId}): Form "${a}" submitted with data:`,s);let p=i.querySelector('button[type="submit"]');p&&(p.disabled=!0);let l=i.closest(".aipkit_chat_form_wrapper"),d={form_id:a,submitted_data:JSON.stringify(s)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let u=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",d,e);if(p&&(p.disabled=!1),u.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t.messagesEl,u.message_to_user,"bot",e,!1,!1,u.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):u.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(t.messagesEl,u.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),l){let _=l.closest(".aipkit_chat_message");_&&(_.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(t.messagesEl,!0))}}catch(u){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${a}":`,u),p&&(p.disabled=!1),typeof n.handleError=="function"?n.handleError(u.message||"Failed to submit form.",!1,!0):alert(u.message||"Failed to submit form.")}}window.aipkit_chatUI_handleChatFormSubmission=c})();(function(){"use strict";let c=!1,o=null,e=null;function t(){o&&(o.classList.remove("aipkit_active"),o=null,c=!1,e&&(document.removeEventListener("click",e),e=null))}window.aipkit_chatUI_closeActiveDownloadMenu=t,window.aipkit_chatUI_setActiveDownloadMenu=function(n,i,a){o=n,c=i,e=a},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:c,activeMenu:o,handler:e}}})();(function(){"use strict";function c(o,e){if(!o||!e)return;let{inputActionButton:t,inputActionMenu:n}=o;e.activeInputActionMenu&&e.activeInputActionTrigger&&(n&&(n.classList.remove("aipkit-action-menu-open"),n.setAttribute("aria-hidden","true"),setTimeout(()=>{n&&!n.classList.contains("aipkit-action-menu-open")&&(n.style.display="none")},200)),t&&(t.classList.remove("aipkit_active"),t.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=c})();(function(){"use strict";function c(o,e,t){let{inputActionButton:n,inputActionMenu:i,imageUploadInput:a,fileUploadInput:r}=o,{fileUploadEnabledUI:s,imageUploadEnabledUI:p}=e;if(!n){i&&(i.style.display="none");return}n.onclick=null;let l=window.aipkit_chatUI_closeActiveDownloadMenu,d=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof l!="function"||typeof d!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let u="dashicons-paperclip",_=e.text?.attachTools||"Attach or use tools",f="true";if(s&&!p)u="dashicons-media-document aipkit-icon-pdf",_=e.text?.uploadFile||"Upload File (TXT, PDF)",f="false";else if(!s&&p)u="dashicons-format-image aipkit-icon-image",_=e.text?.uploadImage||"Upload Image",f="false";else if(!s&&!p){n.style.display="none",i&&(i.style.display="none");return}let w=n.querySelector(".dashicons");w&&(w.className=`dashicons ${u}`),n.setAttribute("aria-label",_),f==="true"?(n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false")):(n.removeAttribute("aria-haspopup"),n.removeAttribute("aria-expanded")),s&&p?(i&&(i.style.display="none"),n.onclick=m=>{m.stopPropagation(),l(),!t.isActionMenuOpen?(i&&(i.style.display="flex",requestAnimationFrame(()=>{i&&i.classList.add("aipkit-action-menu-open")}),i.setAttribute("aria-hidden","false")),n.classList.add("aipkit_active"),n.setAttribute("aria-expanded","true"),t.isActionMenuOpen=!0,t.activeInputActionMenu=i,t.activeInputActionTrigger=n,setTimeout(()=>{t.closeActionMenuHandler=h=>{h.type==="click"&&(!t.activeInputActionMenu||!t.activeInputActionTrigger||t.activeInputActionMenu.contains(h.target)||t.activeInputActionTrigger.contains(h.target))||h.type==="keydown"&&h.key!=="Escape"||d(o,t)},document.addEventListener("click",t.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",t.closeActionMenuHandler,{capture:!0,once:!1})},0)):d(o,t)}):s?(i&&(i.style.display="none"),n.onclick=m=>{m.stopPropagation(),l(),r?r.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),alert("File upload feature not properly initialized."))}):p?(i&&(i.style.display="none"),n.onclick=m=>{m.stopPropagation(),l(),a?a.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),alert("Image upload feature not properly initialized."))}):(n.style.display="none",i&&(i.style.display="none"))}window.aipkit_chatUI_setupInputActionButton=c})();(function(){"use strict";function c(o,e,t,n){let{actionButton:i}=o;i&&i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",()=>{t.buttonState==="send"&&!i.disabled?n.sendMessageAction():t.buttonState==="clear"&&n.clearChatAction()}),i.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=c})();(function(){"use strict";function c(o,e,t,n){let{inputField:i,messagesEl:a,actionButton:r}=o;i&&i.dataset.listenerAttached!=="true"&&(i.addEventListener("keydown",s=>{s.key==="Enter"&&!t.isActionMenuOpen&&(s.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(i)},0):(s.preventDefault(),t.buttonState==="send"&&!r.disabled&&n.sendMessageAction()))}),i.addEventListener("input",()=>{let s=i.value.trim()==="",p=a.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;s?p&&t.buttonState!=="sending"&&t.buttonState!=="streaming"?t.buttonState=n.setButtonStateAction("clear",!1,t):t.buttonState!=="sending"&&t.buttonState!=="streaming"&&(t.buttonState=n.setButtonStateAction("send",!1,t)):t.buttonState=n.setButtonStateAction("send",!1,t),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(i)}),i.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=c})();(function(){"use strict";function c(o,e,t,n){let{fullscreenButton:i}=o;i&&typeof n.toggleFullscreenAction=="function"?i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",n.toggleFullscreenAction),i.dataset.listenerAttached="true"):i&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=c})();(function(){"use strict";function c(o,e,t,n){let{closeButton:i,container:a}=o;i?i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(o,t),t.isFullscreen?typeof n.toggleFullscreenAction=="function"?(n.toggleFullscreenAction(),e.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"&&!t.isPopupOpen&&setTimeout(()=>window.aipkit_chatUI_openPopup(a,o.messagesEl,o.inputField,t),50)):console.warn("AIPKit Chat Events: toggleFullscreen action missing for close button while in fullscreen."):e.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"&&window.aipkit_chatUI_closePopup(a,t)}),i.dataset.listenerAttached="true"):e.popupEnabled}window.aipkit_chatUI_attachCloseButtonListener=c})();(function(){"use strict";function c(o,e,t,n){let{webSearchToggleButton:i}=o,a=e.allowWebSearchTool&&e.provider==="OpenAI";i&&a?i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(o,t),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(o,e,t):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),i.dataset.listenerAttached="true"):i&&(i.style.display="none")}window.aipkit_chatUI_attachWebSearchToggleListener=c})();(function(){"use strict";function c(o,e,t,n){let{googleSearchGroundingToggleButton:i}=o,a=e.allowGoogleSearchGrounding&&e.provider==="Google";i&&a?i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(o,t),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(o,e,t):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),i.dataset.listenerAttached="true"):i&&(i.style.display="none")}window.aipkit_chatUI_attachGoogleGroundingToggleListener=c})();(function(){"use strict";function c(o,e,t,n){let{downloadButton:i}=o;if(i&&e.enableDownload){let a=i.closest(".aipkit_download_wrapper"),r=a?a.querySelector(".aipkit_download_menu"):null,s=e.pdfDownloadActive===!0;i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",p=>{if(p.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(o,t),s&&r){let l=window.aipkit_chatUI_getDownloadMenuState?window.aipkit_chatUI_getDownloadMenuState():{isOpen:!1,activeMenu:null};if(l.isOpen&&l.activeMenu===r)typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu();else if(typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),r.classList.add("aipkit_active"),typeof window.aipkit_chatUI_setActiveDownloadMenu=="function"){let d=u=>{a.contains(u.target)||typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()};window.aipkit_chatUI_setActiveDownloadMenu(r,!0,d),setTimeout(()=>{document.addEventListener("click",d,{once:!0})},0)}}else typeof n.downloadTranscriptTxtAction=="function"?n.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),i.dataset.listenerAttached="true"),r&&r.dataset.listenerAttached!=="true"&&(r.addEventListener("click",p=>{let l=p.target.closest(".aipkit_download_menu_item");if(l){let d=l.getAttribute("data-format");d==="txt"?typeof n.downloadTranscriptTxtAction=="function"?n.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):d==="pdf"&&(typeof n.downloadTranscriptPdfAction=="function"?n.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()}}),r.dataset.listenerAttached="true")}}window.aipkit_chatUI_attachDownloadMenuListeners=c})();(function(){"use strict";function c(o,e,t,n){let{inputActionMenu:i}=o;i&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&i.dataset.itemClickListenerAttached!=="true"&&(i.addEventListener("click",a=>{let r=a.target.closest(".aipkit_input_action_menu_item");if(!r)return;a.preventDefault();let s=r.getAttribute("aria-label");s&&s.toLowerCase().includes("image")?o.imageUploadInput?o.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),alert("Image upload feature not properly initialized.")):s&&(s.toLowerCase().includes("pdf")||s.toLowerCase().includes("file"))&&(o.fileUploadInput?o.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),alert("File upload feature not properly initialized."))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(o,t)}),i.dataset.itemClickListenerAttached="true")}window.aipkit_chatUI_attachInputActionMenuListener=c})();(function(){"use strict";function c(o,e,t,n){let{voiceInputButton:i}=o;i&&e.enableVoiceInputUI&&i.dataset.listenerAttached!=="true"&&(i.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(o,e,t,t.consentUIInstance,n):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),alert("Voice input unavailable (script error)."))}),i.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=c})();(function(){"use strict";function c(o,e,t,n){let{fileUploadInput:i}=o;i&&e.fileUploadEnabledUI&&i.dataset.listenerAttached!=="true"&&(i.addEventListener("change",async a=>{let r=a.target.files[0];if(r&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let s=o.inputArea||i.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(r,i,s,e)}else r&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",o.inputArea))}),i.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=c})();(function(){"use strict";function c(o,e,t,n){let{messagesEl:i}=o;i&&typeof n.handlePlayAction=="function"?i.dataset.playListenerAttached!=="true"&&(i.addEventListener("click",function(a){let r=a.target.closest(".aipkit_play_btn");r&&!r.disabled&&n.handlePlayAction(r)}),i.dataset.playListenerAttached="true"):i&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=c})();(function(){"use strict";function c(o,e,t,n){typeof t.isActionMenuOpen>"u"&&(t.isActionMenuOpen=!1,t.activeInputActionMenu=null,t.activeInputActionTrigger=null,t.closeActionMenuHandler=null);let i=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachCloseButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],a=!0;if(i.forEach(r=>{typeof window[r]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${r}.`),a=!1)}),!a){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(o,e,t,n),window.aipkit_chatUI_attachInputFieldListeners(o,e,t,n),window.aipkit_chatUI_attachFullscreenButtonListener(o,e,t,n),window.aipkit_chatUI_attachCloseButtonListener(o,e,t,n),window.aipkit_chatUI_attachWebSearchToggleListener(o,e,t,n),window.aipkit_chatUI_attachGoogleGroundingToggleListener(o,e,t,n),window.aipkit_chatUI_attachDownloadMenuListeners(o,e,t,n),window.aipkit_chatUI_attachInputActionMenuListener(o,e,t,n),window.aipkit_chatUI_attachVoiceInputButtonListener(o,e,t,n),window.aipkit_chatUI_attachFileUploadInputListener(o,e,t,n),window.aipkit_chatUI_attachPlayButtonListener(o,e,t,n),console.log(`AIPKit Chat Events Orchestrator (${e.botId}): All event listeners attached.`)}window.aipkit_chatUI_attachEventListeners=c})();(function(){"use strict";function c(o,e,t,n,i,a,r,s,p,l,d,u){console.log("AIPKit Chat AJAX (sender): Received activeFileContext:",JSON.stringify(d));let{messagesEl:_}=n,f=t.text||{};if(!t.ajaxUrl||!e||!t.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof a=="function"&&a(f.errorPrefix+" "+(f.connError||"Configuration error (API)."),!1),typeof r=="function"&&r();return}let w={message:o};s&&t.provider==="OpenAI"&&t.allowWebSearchTool&&(w.frontend_web_search_active=!0),p&&t.provider==="Google"&&t.allowGoogleSearchGrounding&&(w.frontend_google_search_grounding_active=!0),l&&(w.image_inputs=JSON.stringify([l]),console.log("AIPKit Chat AJAX: Sending image_inputs to backend."));let m={...t};if(d&&(m.activeFileContext=d,d.provider==="OpenAI"&&d.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${d.vector_store_id}`):d.provider==="Pinecone"&&d.index_name&&d.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${d.index_name}, Namespace: ${d.namespace}`):d.provider==="Qdrant"&&d.collection_name&&d.file_upload_context_id&&console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${d.collection_name}, Context ID: ${d.file_upload_context_id}`)),window.aipkit_chatUI_showTypingIndicator(_,t),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof a=="function"&&a("Internal script error.",!1),typeof r=="function"&&r();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",w,m).then(g=>{if(window.aipkit_chatUI_removeTypingIndicator(_),g?.reply)t.provider==="OpenAI"&&t.enableOpenAIConversationState&&g.openai_response_id&&(window.aipkit_current_openai_response_id=g.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",g.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${g.openai_response_id}`)),typeof i=="function"&&(i(g.reply,g.message_id||null,g.openai_response_id||null,g.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(_,!0));else{let h=g?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,h,g),typeof a=="function"&&a(`${f.errorPrefix||"Error:"} ${h}`,!1)}}).catch(g=>{window.aipkit_chatUI_removeTypingIndicator(_);let h=`${f.errorPrefix||"Error:"} ${f.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,g),typeof a=="function"&&a(h+(g.message?` (${g.message})`:""),!0)}).finally(()=>{typeof r=="function"&&r()})}window.aipkit_chatUI_sendMessage=c})();(function(){"use strict";function c(o,e,t){let{container:n,fullscreenButton:i,messagesEl:a,inputField:r}=o,s=t.text||{};if(!n||!i){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}if(e.isFullscreen=!e.isFullscreen,e.isFullscreen){if(!e.fullscreenPlaceholder){let d=document.createElement("div");d.id=`aipkit_fs_placeholder_${n.id}`,d.style.display="none",n.parentNode.insertBefore(d,n),e.fullscreenPlaceholder=d}document.body.appendChild(n),n.classList.add("aipkit-fullscreen")}else n.classList.remove("aipkit-fullscreen"),e.fullscreenPlaceholder&&e.fullscreenPlaceholder.parentNode?(e.fullscreenPlaceholder.parentNode.insertBefore(n,e.fullscreenPlaceholder),e.fullscreenPlaceholder.remove(),e.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position.");let p=n.closest(".aipkit_popup_wrapper");p&&p.classList.toggle("aipkit-fullscreen-wrapper",e.isFullscreen);let l=i.querySelector(".dashicons");l&&(l.className=e.isFullscreen?"dashicons dashicons-editor-contract":"dashicons dashicons-editor-expand"),i.title=e.isFullscreen?s.exitFullscreen||"Exit Fullscreen":s.fullscreen||"Fullscreen",i.setAttribute("aria-label",i.title),i.setAttribute("aria-expanded",e.isFullscreen.toString()),e.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),r&&setTimeout(()=>r.focus(),50),console.log("AIPKit Chat: Fullscreen toggled:",e.isFullscreen)}window.aipkit_chatUI_toggleFullscreen=c})();(function(){"use strict";function c(o,e,t,n,i){let{state:a,elements:r,config:s,setButtonStateAction:p,handleError:l,generateClientMessageId:d,focusInputAction:u}=i,{inputField:_,voiceInputButton:f,messagesEl:w,container:m}=r;a.isSending=!0,_.disabled=!0,f&&(f.disabled=!0),p("sending",!0,a);let g=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?g=window.aipkit_chatUI_showImageLoadingIndicator(w,s):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(w,s));let h={prompt:o,original_user_text:e,user_message_id:t};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),l("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(w,g),a.isSending=!1,_.disabled=s.requireConsentCompliance&&!a.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!a.consentGiven),p("send",!1,a),(!s.requireConsentCompliance||a.consentGiven)&&u();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",h,s).then(I=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,g):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),I?.type==="image"&&I.images&&I.images.length>0){let b={type:"image",images:I.images,prompt:o};window.aipkit_chatUI_appendMessage(w,b,"bot",s,!1,!1,I.message_id,!0),m?m.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:I.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:n}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let b=I?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${b}`,I),l(`Image generation failed: ${b}`,!1,!0)}}).catch(I=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,g):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),l("Image generation failed: "+(I.message||"Unknown error"),!1,!0)}).finally(()=>{a.isSending=!1,_.disabled=s.requireConsentCompliance&&!a.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!a.consentGiven),p("send",!1,a),(!s.requireConsentCompliance||a.consentGiven)&&u()})}window.aipkit_chatUI_handleImageGeneration=c})();(function(){"use strict";function c(o,e,t,n){let i=o.toLowerCase(),a=t&&t.ipsList?t.ipsList.split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(e&&a.length>0&&a.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:t.message||"Access from your IP address has been blocked."};let r=n&&n.wordsList?n.wordsList.toLowerCase().split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(r.length>0){let s=r.find(p=>i.includes(p));if(s)return console.warn(`AIPKit Moderation: Banned word detected: "${s}"`),{type:"banned_word",message:n.message||"Sorry, your message could not be sent as it contains prohibited words.",word:s}}return null}window.aipkit_checkMessageModeration=c})();(function(){"use strict";function c(n){return n?n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function o(n){n&&n.classList.add("aipkit_hidden")}function e(n){n&&n.classList.remove("aipkit_hidden")}function t(n,i,a,r,s,p){let{startersContainer:l,messagesEl:d,inputField:u}=a,_=i.botId,f=i.starters||[];if(!n||!i||!l||!d||!u){console.error(`AIPKit Starters (${_}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof r!="function"){console.error(`AIPKit Starters (${_}): sendMessageActionCallback is not a function.`),o(l);return}if(typeof p!="function"){console.error(`AIPKit Starters (${_}): isConsentGivenFunc is not a function.`),o(l);return}if(f.length===0){console.log(`AIPKit Starters (${_}): No starter prompts configured or found.`),o(l);return}l.innerHTML="",f.forEach(g=>{if(typeof g=="string"&&g.trim()!==""){let h=document.createElement("button");h.type="button",h.className="aipkit_starter_btn",h.textContent=g.trim(),h.addEventListener("click",I=>{if(I.preventDefault(),s&&!p()){console.warn(`AIPKit Starters (${_}): Starter clicked, but consent not given.`);return}let b=h.textContent;console.log(`AIPKit Starters (${_}): Starter clicked: "${b}"`),r(b),o(l)}),l.appendChild(h)}});let w=()=>{if(s&&!p()){o(l),console.log(`AIPKit Starters (${_}): Hiding starters because consent is required but not given.`);return}c(d)?e(l):o(l)},m=()=>o(l);n.addEventListener("aipkit:messageSent",m),n.addEventListener("aipkit:messageReceived",m),n.addEventListener("aipkit:messageError",m),n.addEventListener("aipkit:chatCleared",w),n.addEventListener("aipkit:chatLoaded",w),n.addEventListener("aipkit:consentGiven",()=>{console.log(`AIPKit Starters (${_}): Received consentGiven event. Checking visibility.`),w()}),w(),console.log(`AIPKit Starters (${_}): Initialized with ${f.length} starters. Consent Required: ${s}`)}window.aipkit_initConversationStarters=t})();function M(c,o){let e=window.aipkit_chatUI_findElements(c,o);if(!e){let r=c.querySelector(".aipkit_chat_container")||c;return r&&(r.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot UI error (DOM elements missing).</p>'),null}let t=o.botId,n=window.aipkit_chatUI_initState(o);n.consentUIInstance=null;let i={setButtonStateAction:(r,s=!1)=>window.aipkit_chatUI_setButtonStateAction(r,e,o,n,s),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,o,n),sendMessageAction:(r=null)=>window.aipkit_chatUI_sendMessageAction(e,o,n,i,r),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,o,n,i),handleError:(r,s,p=!0)=>window.aipkit_chatUI_handleError(r,s,p,e,o,n,i),handleCompletion:(r,s=!1)=>window.aipkit_chatUI_handleCompletion(r,s,e,o,n,i),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,n,o),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,o),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,o),handlePlayAction:r=>window.aipkit_handlePlayAction(r)};if(o.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?n.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,o,n,()=>{e.inputField.disabled=!1,i.setButtonStateAction("send",!1),i.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):o.requireConsentCompliance&&console.error(`AIPKit Chat Main (${t}): Consent required, but aipkit_initConsentUI function not found.`),o.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${t}): Image Upload UI enabled, but input or preview elements were not found/created by findElements.`):o.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${t}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,o,n):(console.error(`AIPKit Chat Main (${t}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.style.display="none"),e.inputActionMenu&&(e.inputActionMenu.style.display="none")),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,o,n,i):console.error(`AIPKit Chat Main (${t}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,o):console.warn(`AIPKit Chat Main (${t}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),o.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let r=n.consentUIInstance?n.consentUIInstance.isConsentGiven:()=>!o.requireConsentCompliance||n.consentGiven;window.aipkit_initConversationStarters(c,o,e,i.sendMessageAction,o.requireConsentCompliance,r)}else o.enableStarters&&console.warn(`AIPKit Chat Main (${t}): Starters enabled but container or init function missing.`);o.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(c,e,o,i):o.enableSidebar&&console.warn(`AIPKit Chat Main (${t}): Sidebar enabled but elements or init function missing.`);let a={openPopup:o.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(c,e.messagesEl,e.inputField,n):()=>{},closePopup:o.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(c,n):()=>{},setupPopupHandlers:o.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?(r,s)=>window.aipkit_chatUI_setupPopupHandlers(c,r,s,e.messagesEl,e.inputField,n,o):()=>{},isPopupOpen:()=>n.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:i.sendMessageAction,clearChat:i.clearChatAction,toggleFullscreen:i.toggleFullscreenAction};return o.enableRealtimeVoiceUI&&typeof window.aipkit_initRealtimeVoiceAgent=="function"?window.aipkit_initRealtimeVoiceAgent(e,o,n,i,a):o.enableRealtimeVoiceUI&&console.error(`AIPKit Chat Main (${t}): Realtime Voice enabled but aipkit_initRealtimeVoiceAgent function not found.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,o):console.error(`AIPKit Chat Main (${t}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,o,n,i):console.error(`AIPKit Chat Main (${t}): finalizeSetup function not found.`),{publicApi:a,internalElements:e,internalActions:i}}window.aipkit_setupChatInstanceUI=M;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let c=localStorage.getItem("aipkit_guest_uuid");c?console.log("AIPKit Chat Init: Using existing guest UUID:",c):(c=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",c),console.log("AIPKit Chat Init: Generated new guest UUID:",c)),window.aipkit_guest_uuid=c,window.aipkit_regenerateConversationUUID=function(){let t=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,n=>(n^crypto.getRandomValues(new Uint8Array(1))[0]&15>>n/4).toString(16));return console.log("AIPKit Chat Init: Regenerated conversation UUID:",t),sessionStorage.setItem("aipkit_current_conversation_uuid",t),window.aipkit_current_conversation_uuid=t,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),console.log("AIPKit Chat Init: OpenAI response ID reset for new chat."),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),console.log("AIPKit Chat Init (regenerateUUID): Active file context (window/session) reset for new chat."),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),t},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(t){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(i){return typeof i!="string"?"":i.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'\\"').replace(/'/g,"'")})(t).replace(/\n/g,"<br>")}});function o(t){if(!t||t.classList.contains("aipkit-initializing")||t.classList.contains("aipkit-initialized"))return;t.classList.add("aipkit-initializing");let n=t.getAttribute("data-bot-id"),i=t.getAttribute("data-config"),a=null;try{i&&(a=JSON.parse(i),n&&(a.botId=n))}catch(l){console.error(`AIPKit Chat Init (${n||"Unknown"}): Failed to parse configuration.`,l,i);let d=t.querySelector(".aipkit_chat_container")||t;d.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',t.classList.remove("aipkit-initializing");return}if(!a){console.error(`AIPKit Chat Init (${n||"Unknown"}): Config object is null after parse attempt.`,t);let l=t.querySelector(".aipkit_chat_container")||t;l.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot config load error.</p>',t.classList.remove("aipkit-initializing");return}if(!a.botId&&n&&(a.botId=n),window.aipkit_current_post_id=a.postId||0,a.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): Sidebar enabled. Resetting CURRENT conversation & file context state for this instance.`);else{let l=sessionStorage.getItem("aipkit_current_conversation_uuid"),d=sessionStorage.getItem("aipkit_current_openai_response_id");if(l){window.aipkit_current_conversation_uuid=l,window.aipkit_is_fresh_session=!1,console.log(`AIPKit Chat Init (${a.botId}): Sidebar disabled. Loaded conversation UUID from session: ${l}`),window.aipkit_current_openai_response_id=d||null,window.aipkit_current_openai_response_id&&console.log(`AIPKit Chat Init (${a.botId}): Loaded OpenAI Response ID from session: ${window.aipkit_current_openai_response_id}`);try{let u=localStorage.getItem(`aipkit_file_context_${l}`);if(u){let _=JSON.parse(u),f=!1;_&&_.provider&&(_.provider==="OpenAI"&&_.vector_store_id||_.provider==="Pinecone"&&_.index_name&&_.namespace||_.provider==="Qdrant"&&_.collection_name&&_.file_upload_context_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:_})),console.log(`AIPKit Chat Init (${a.botId}): Loaded file context for conv ${l} from localStorage:`,_)):(console.warn(`AIPKit Chat Init (${a.botId}): Invalid file context data in localStorage for conv ${l}. Clearing.`),localStorage.removeItem(`aipkit_file_context_${l}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): No file context in localStorage for conv ${l}.`)}catch(u){console.error("AIPKit Chat Init: Error loading file context from localStorage:",u),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),console.log(`AIPKit Chat Init (${a.botId}): Sidebar disabled. No conversation UUID in session. Starting fresh, file context reset.`)}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${a.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let l=t.querySelector(".aipkit_chat_container")||t;l.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot script error.</p>',t.classList.remove("aipkit-initializing");return}let r=t.classList.contains("aipkit_chat_container")?t:t.querySelector(".aipkit_chat_container");if(!r){console.error(`AIPKit Chat Init (${a.botId}): Chat container element not found within wrapper.`,t),t.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot structure error.</p>',t.classList.remove("aipkit-initializing");return}if(a.guestUUID=window.aipkit_guest_uuid,a.conversationUUID=window.aipkit_current_conversation_uuid,a.previousOpenAIResponseId=window.aipkit_current_openai_response_id,a.activeFileContextProvider=window.aipkit_active_file_context_provider,a.activeFileContextData=window.aipkit_active_file_context_data,!a.botId||!a.ajaxUrl||!a.text||!a.guestUUID){console.error(`AIPKit Chat Init (${a.botId||"Unknown"}): Missing essential configuration.`,a,t);let l=t.querySelector(".aipkit_chat_container")||t;l.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',t.classList.remove("aipkit-initializing");return}typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&a.theme==="custom"&&a.customThemeSettings&&Object.keys(a.customThemeSettings).length>0?window.aipkit_chatUI_applyCustomThemeStyles(r,a.customThemeSettings):a.theme==="custom"&&console.warn(`AIPKit Chat Init (${a.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let s=aipkit_setupChatInstanceUI(r,a);if(!s||!s.publicApi||!s.internalElements||!s.internalActions){console.error(`AIPKit Chat Init (${a.botId}): Failed to set up UI instance or get all necessary parts.`),t.classList.remove("aipkit-initializing");return}let p=s.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[r.id]={instance:p,elements:s.internalElements,actions:s.internalActions},a.popupEnabled){let l=t.querySelector(".aipkit_popup_trigger"),d=r.querySelector(".aipkit_chat_header"),u=d?d.querySelector(".aipkit_close_btn"):null;if(!l){console.error(`AIPKit Chat Init (${a.botId}): Popup trigger button not found.`),t.classList.remove("aipkit-initializing");return}if(p.setupPopupHandlers){p.setupPopupHandlers(l,u,a);let _=a.popupDelay;_>0&&!a.directVoiceMode&&!t.dataset.aipkitAutoOpened?(t.dataset.aipkitAutoOpened="true",setTimeout(()=>{p&&p.isPopupOpen&&!p.isPopupOpen()?(console.log(`AIPKit Chat Init (${n}): Auto-opening popup after ${_}s.`),p.openPopup()):console.log(`AIPKit Chat Init (${n}): Popup already open or instance unavailable, skipping auto-open.`)},_*1e3)):_>0&&a.directVoiceMode&&console.log(`AIPKit Chat Init (${n}): Auto-open timer of ${_}s skipped due to Direct Voice Mode being enabled.`)}else console.error(`AIPKit Chat Init (${a.botId}): setupPopupHandlers method missing in UI instance.`)}t.classList.remove("aipkit-initializing"),t.classList.add("aipkit-initialized"),console.log(`AIPKit Chat Init (${a.botId}): Initialized successfully. Sidebar: ${a.enableSidebar}, PostID: ${window.aipkit_current_post_id}, Fresh Session: ${window.aipkit_is_fresh_session}, ConvID: ${window.aipkit_current_conversation_uuid||"None"}, OpenAIRespID: ${window.aipkit_current_openai_response_id||"None"}. File Context Provider: ${window.aipkit_active_file_context_provider||"None"}`)}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(i=>{i.closest(".aipkit_popup_wrapper")||o(i)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(o)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let t=new MutationObserver(n=>{let i=!1;n.forEach(a=>{a.addedNodes&&a.addedNodes.forEach(r=>{r.nodeType===1&&(r.matches&&(r.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||r.matches(".aipkit_popup_wrapper"))||r.querySelector&&r.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper"))&&(i=!0)})}),i&&(t.scanTimeout&&clearTimeout(t.scanTimeout),t.scanTimeout=setTimeout(e,50))});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=o})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function c(o,e,t){let n=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:p=>p,i=new FormData;i.append("action","aipkit_cache_sse_message"),i.append("_ajax_nonce",t);let a={stream_context:"ai_forms",form_id:o,user_input_values:e};i.append("message",JSON.stringify(a));let r=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:i,credentials:"same-origin"});if(!r.ok){let p=await r.json().catch(()=>({}));throw new Error(p?.data?.message||`HTTP error ${r.status}`)}let s=await r.json();if(s.success&&s.data?.cache_key)return s.data.cache_key;throw new Error(s.data?.message||n("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=c})();(function(){"use strict";function c(o,e){let t=window.aipkitAIFormsPublicState,n=o?o.closest(".aipkit-ai-form-wrapper"):null,i=o?o.querySelector(".aipkit_btn-text"):null,a=o?o.querySelector(".aipkit_spinner"):null,r=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:d=>d,s=null,p=()=>{o&&(o.disabled=!1,o.classList.remove("aipkit_btn-danger"),o.classList.add("aipkit_btn-primary"),i&&(i.textContent=e),s&&(o.removeEventListener("click",s),s=null)),a&&(a.style.display="none")};return{restoreGenerateButton:p,setupStopButton:()=>{o&&(o.disabled=!1,o.classList.remove("aipkit_btn-primary"),o.classList.add("aipkit_btn-danger"),i&&(i.textContent=n.dataset.labelStopButton||r("Stop","gpt3-ai-content-generator")),s=d=>{d.preventDefault(),d.stopPropagation(),t.currentAIFormEventSource&&(t.currentAIFormEventSource.close(),t.currentAIFormEventSource=null),p()},o.addEventListener("click",s,{once:!0}))}}}window.aipkitForms_createSseUiManager=c})();(function(){"use strict";function c(o){let e=o.elements,t=!1,n=null,i={},a={};for(let r of e){if(!r.name)continue;let s=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!s||!s[1])continue;let p=s[1];s[2]==="[]"?(i[p]||(i[p]=[]),r.checked&&i[p].push(r.value)):r.type==="radio"?r.checked&&(i[p]=r.value):i[p]=r.value}for(let r of e){let s=r.closest("fieldset");if(s){let u=s.querySelector("legend");u&&(u.style.color="")}else r.style.borderColor="";if(!r.required)continue;let p=!1,l=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!l||!l[1])continue;let d=l[1];if(!a[d]&&(r.type==="checkbox"?(p=!i[d]||i[d].length===0,a[d]=!0):r.type==="radio"?(p=!i[d],a[d]=!0):(r.classList.contains("aipkit-file-hidden-content")||r.type!=="file"&&r.type!=="submit"&&r.type!=="button")&&(p=r.value.trim()===""),p)){t=!0;let u=r;if(r.type==="radio"||r.type==="checkbox"?u=r.closest("fieldset"):r.classList.contains("aipkit-file-hidden-content")&&(u=o.querySelector(`.aipkit-file-upload-input[data-field-id="${d}"]`)),n||(n=u),u?.type!=="checkbox"&&u?.type!=="radio"&&u)u.style.borderColor="red";else if(u){let _=u.querySelector("legend");_&&(_.style.color="red")}}}return{isValid:!t,userInputs:i,firstInvalidField:n}}window.aipkitForms_validateSseInputs=c})();(function(){"use strict";let c=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function o(e,t){let n=window.aipkitAIFormsPublicState,i="",a=!0,r='<div class="aipkit-ai-form-results-top-actions"></div>',s='<div class="aipkit-ai-form-results-footer-actions"></div>',p=_=>`<div class="aipkit-ai-form-results-content">${_}</div>`;return{onMessageHandler:_=>{a&&(e.style.display="block",e.innerHTML=r+p("")+s,a=!1);let f=JSON.parse(_.data),w=e.querySelector(".aipkit-ai-form-results-content");f.delta&&w&&(i+=f.delta,n.mdInstanceAIForms?w.innerHTML=n.mdInstanceAIForms.render(i):w.innerHTML=i.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:_=>{n.currentAIFormEventSource&&(n.currentAIFormEventSource.close(),n.currentAIFormEventSource=null),t();let f=e.querySelector(".aipkit-ai-form-results-content");n.mdInstanceAIForms&&f?f.innerHTML=n.mdInstanceAIForms.render(i):f&&(f.innerHTML=i.replace(/\n/g,"<br />"));let w=e.querySelector(".aipkit-ai-form-results-top-actions"),m=e.querySelector(".aipkit-ai-form-results-footer-actions");if(i.trim()!==""&&w&&m){let g=e.closest(".aipkit-ai-form-wrapper"),h=g.dataset.showSaveButton==="true",I=g.dataset.pdfDownloadEnabled==="true",b=g.dataset.showCopyButton==="true",k=window.aipkit_ai_forms_public_config||{},y=k.is_user_logged_in,S=document.createElement("button");if(S.type="button",S.className="aipkit-copy-results-btn",S.title=c("Copy Results","gpt3-ai-content-generator"),S.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&S.addEventListener("click",window.aipkitForms_handleCopyAction),w.appendChild(S),S.style.display="inline-flex",h&&y){let v=g.dataset.labelSaveButton||k.text?.saveAsPost||c("Save","gpt3-ai-content-generator"),A=document.createElement("button");A.type="button",A.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",A.innerHTML=`<span class="aipkit_btn-text">${v}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&A.addEventListener("click",window.aipkitForms_handleSaveAsPost),m.appendChild(A),A.style.display="inline-flex"}if(I&&typeof window.aipkitForms_handleDownloadPdf=="function"){let v=g.dataset.labelDownloadButton||c("Download","gpt3-ai-content-generator"),A=document.createElement("button");A.type="button",A.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",A.innerHTML=`<span class="aipkit_btn-text">${v}</span>`,A.addEventListener("click",window.aipkitForms_handleDownloadPdf),m.appendChild(A),A.style.display="inline-flex"}if(b){let v=g.dataset.labelCopyButton||c("Copy","gpt3-ai-content-generator"),A=document.createElement("button");A.type="button",A.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",A.innerHTML=`<span class="aipkit_btn-text">${v}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&A.addEventListener("click",window.aipkitForms_handleCopyAction),m.appendChild(A),A.style.display="inline-flex"}}},onErrorHandler:_=>{if(n.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",_);let f=c(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(_.data)try{let w=JSON.parse(_.data);w.error&&(f=w.error)}catch{}e.style.display="block",e.innerHTML=`<p style="color:red;">${f}</p>`,n.currentAIFormEventSource&&(n.currentAIFormEventSource.close(),n.currentAIFormEventSource=null),t()}}}window.aipkitForms_createSseEventHandlers=o})();(function(){"use strict";async function c(o,e,t,n,i){let a=window.aipkitAIFormsPublicState,r=await window.aipkit_cacheAIFormMessage(o,e,t),s=new URL(aipkit_ai_forms_public_config.ajaxUrl);s.searchParams.append("action","aipkit_frontend_chat_stream"),s.searchParams.append("cache_key",r),s.searchParams.append("_ajax_nonce",t),window.aipkit_guest_uuid&&s.searchParams.append("session_id",window.aipkit_guest_uuid),a.currentAIFormEventSource=new EventSource(s.toString());let{onMessageHandler:p,onDoneHandler:l,onErrorHandler:d}=window.aipkitForms_createSseEventHandlers(n,i);a.currentAIFormEventSource.onmessage=p,a.currentAIFormEventSource.addEventListener("done",l),a.currentAIFormEventSource.onerror=d}window.aipkitForms_setupAndStartEventSource=c})();(function(){"use strict";function c(t,n,i="info"){if(!t)return;let a=window.aipkit_escapeHtml||function(r){return r};t.innerHTML=a(n),t.className=`aipkit-file-upload-status aipkit-status-${i}`}function o(t){if(!t)return;let n=t.querySelector(".aipkit-file-upload-input"),i=t.querySelector(".aipkit-file-upload-status"),a=t.querySelector(".aipkit-file-remove-btn"),r=t.querySelector(".aipkit-file-hidden-content"),s=t.querySelector(".aipkit-file-status-wrapper");n&&(n.value="",n.style.display="block"),i&&(i.innerHTML="",i.className="aipkit-file-upload-status"),a&&(a.style.display="none"),s&&(s.style.display="none"),r&&(r.value="",r.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(t){let n=t.target,i=n.closest(".aipkit_form_group-file-upload");if(!i)return;let a=n.files[0],r=i.querySelector(".aipkit-file-status-wrapper"),s=i.querySelector(".aipkit-file-upload-status"),p=i.querySelector(".aipkit-file-remove-btn"),l=i.querySelector(".aipkit-file-hidden-content"),d=n.closest("form").querySelector('button[type="submit"]'),u=i.dataset.nonce,_=window.aipkit_ai_forms_public_config.ajaxUrl,f=window.wp?.i18n?.__||(h=>h),w=window.aipkit_escapeHtml||function(h){return h};if(!a){o(i);return}if(!["text/plain","application/pdf"].includes(a.type)){c(s,f("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),o(i);return}if(a.size>2*1024*1024){c(s,f("File is too large (max 2MB).","gpt3-ai-content-generator"),"error"),o(i);return}c(s,f("Uploading & processing...","gpt3-ai-content-generator"),"info"),r&&(r.style.display="flex"),d&&(d.disabled=!0);let g=new FormData;g.append("action","aipkit_ai_form_upload_and_parse_file"),g.append("_ajax_nonce",u),g.append("file",a);try{let h=await fetch(_,{method:"POST",body:g,credentials:"same-origin"}),I=await h.json();if(!h.ok||!I.success)throw new Error(I.data?.message||f("Failed to process file.","gpt3-ai-content-generator"));if(console.log("[AIPKit Debug] AI Forms Upload: Received response from server:",I),typeof I.data.text=="string")l.value=I.data.text,console.log(`[AIPKit Debug] AI Forms Upload: Extracted text length: ${I.data.text.length}. Setting hidden input value.`),l.dispatchEvent(new Event("change",{bubbles:!0})),c(s,`\u2705 ${w(a.name)}`,"success"),n.style.display="none",p&&(p.style.display="inline-flex"),r&&(r.style.display="flex"),d&&(d.disabled=!1);else throw new Error(f("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(h){c(s,h.message,"error"),o(i),d&&(d.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=o})();(function(){"use strict";function c(t){let n=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',t.disabled=!0,setTimeout(()=>{t.innerHTML=n,t.disabled=!1},1500)}function o(t){let n=t.currentTarget,i=n.closest(".aipkit-ai-form-results");if(!i)return;let a=i.cloneNode(!0),r=a.querySelector(".aipkit-copy-results-btn");r&&r.remove();let s=a.innerText||a.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s).then(()=>{c(n)}).catch(p=>{console.error("Failed to copy text using Clipboard API: ",p),e(s,n)}):e(s,n)}function e(t,n){let i=document.createElement("textarea");i.value=t,i.style.position="fixed",i.style.top="-9999px",i.style.left="-9999px",document.body.appendChild(i),i.focus(),i.select();try{document.execCommand("copy"),c(n)}catch(a){console.error("Fallback copy failed: ",a),alert("Failed to copy content.")}document.body.removeChild(i)}window.aipkitForms_handleCopyAction=o})();(function(){"use strict";async function c(o){let e=o.currentTarget,t=e.closest(".aipkit-ai-form-wrapper");if(!t)return;let n=t.querySelector(".aipkit-ai-form-results"),i=t.querySelector("h5.aipkit-ai-form-title"),a=t.dataset.saveAsPostNonce,r=n?n.querySelector(".aipkit-ai-form-results-content"):null;if(!r||!i){console.error("AI Forms Save: Missing results content container or title element.");return}let s=window.aipkit_ai_forms_public_config||{},p=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:f=>f,l=i.textContent.trim(),d=r.innerHTML,u=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let _={action:"aipkit_ai_form_save_as_post",_ajax_nonce:a,post_title:l,post_content:d};try{let f=new FormData;for(let h in _)f.append(h,_[h]);let w=await fetch(s.ajaxUrl,{method:"POST",body:f,credentials:"same-origin"}),m=await w.json();if(!w.ok||!m.success)throw new Error(m.data?.message||p("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let g=null;m.data.edit_link&&(g=document.createElement("a"),g.href=m.data.edit_link,g.innerHTML='<span class="dashicons dashicons-external"></span>',g.title=p("Edit Post","gpt3-ai-content-generator"),g.target="_blank",g.rel="noopener noreferrer",g.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),g.style.marginLeft="10px",e.parentNode.insertBefore(g,e.nextSibling)),setTimeout(()=>{e.innerHTML=u,e.disabled=!1,g&&g.parentNode&&g.remove()},5e3)}catch(f){console.error("Failed to save post:",f),alert(`${p("Error saving post:","gpt3-ai-content-generator")} ${f.message}`),e.innerHTML=u,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=c})();(function(){"use strict";async function c(o){o.preventDefault(),o.stopPropagation();let e=window.aipkitAIFormsPublicState,t=o.target,n=t.closest(".aipkit-ai-form-wrapper");if(!n)return;let i=n.dataset.formId,a=aipkit_ai_forms_public_config.ajaxNonce,r=n.querySelector(".aipkit-ai-form-results"),s=t.querySelector('button[type="submit"]'),p=s?s.querySelector(".aipkit_spinner"):null,l=s?s.querySelector(".aipkit_btn-text"):null,d=n.dataset.labelGenerateButton||"Generate",u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:m=>m;if(!i||!a||!r||!s){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),r&&(r.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:_,setupStopButton:f}=window.aipkitForms_createSseUiManager(s,d);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),r.innerHTML="",r.style.display="none",s&&(s.disabled=!0),p&&(p.style.display="inline-block");let w=window.aipkitForms_validateSseInputs(t);if(!w.isValid){if(w.firstInvalidField)if(w.firstInvalidField.type!=="checkbox")w.firstInvalidField.style.borderColor="red";else{let m=w.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");m&&(m.style.color="red")}r.style.display="block",r.innerHTML=`<p style="color:orange;">${u("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,s&&(s.disabled=!1),p&&(p.style.display="none");return}f();try{await window.aipkitForms_setupAndStartEventSource(i,w.userInputs,a,r,_)}catch(m){console.error("AI Form Submission Error (SSE Setup):",m),r.innerHTML=`<p style="color:red;">${m.message||u(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,_()}}window.aipkit_handleFormSubmitSSE=c})();(function(){"use strict";function c(t,n){let i=window.aipkit_ai_forms_models||{},a=window.aipkit_ai_forms_public_config||{},r=t.toLowerCase(),s=i[r]||[],p=n.dataset.currentValue||"";if(a.allowed_models&&a.allowed_models.trim()!==""){let d=new Set(a.allowed_models.split(",").map(u=>u.trim()));if(Array.isArray(s))s=s.filter(u=>d.has(u.id));else{let u={};for(let _ in s){let f=s[_].filter(w=>d.has(w.id));f.length>0&&(u[_]=f)}s=u}}if(n.innerHTML="",!s||Array.isArray(s)&&s.length===0||!Array.isArray(s)&&Object.keys(s).length===0){let d=new Option("No models available for this provider.","");n.appendChild(d);return}let l=!1;if(Array.isArray(s))s.forEach(d=>{let u=new Option(d.name,d.id);d.id===p&&(u.selected=!0,l=!0),n.appendChild(u)});else{let d=["GPT-4o","GPT-4 Turbo","GPT-4","GPT-3.5","Fine-tuned","Other"],u=Object.keys(s);d.filter(f=>u.includes(f)).concat(u.filter(f=>!d.includes(f)).sort()).forEach(f=>{let w=document.createElement("optgroup");w.label=f,s[f].forEach(m=>{let g=new Option(m.name,m.id);m.id===p&&(g.selected=!0,l=!0),w.appendChild(g)}),n.appendChild(w)})}if(!l&&p){let d=new Option(`${p} (Manual)`,p,!1,!0);n.insertBefore(d,n.firstChild)}if(n.selectedIndex===-1&&n.options.length>0){let d=n.querySelector("optgroup");d&&d.options.length>0?n.value=d.options[0].value:n.options[0].value&&(n.selectedIndex=0)}}function o(t){let n=t.querySelector(".aipkit_aiform_provider_select"),i=t.querySelector(".aipkit_aiform_model_select");if(i)if(n)c(n.value,i),n.addEventListener("change",function(){c(this.value,i)});else{let a=i.dataset.provider;a?c(a,i):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let t=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(i=>{o(i);let a=i.querySelector("form.aipkit-ai-form-main");a&&!a.dataset.sseInitialized&&(a.addEventListener("submit",window.aipkit_handleFormSubmitSSE),a.dataset.sseInitialized="true"),a&&!a.dataset.fileUploadInitialized&&(a.addEventListener("change",r=>{r.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(r)}),a.addEventListener("click",r=>{if(r.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let s=r.target.closest(".aipkit_form-group-file-upload");s&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(s)}}),a.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?t.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),t.mdInstanceAIForms={render:function(i){return(window.aipkit_escapeHtml||function(r){return r})(i).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function c(o,e,t){let n=o.querySelector(`#${e}`);if(n&&n.offsetParent!==null)return n.value;{let i=o.querySelector(`input[type="hidden"][name="${t}"]`);return i?i.value:null}}window.aipkit_getSettingValue=c})();(function(){"use strict";function c(o,e,t){if(!e)return;e.innerHTML="";let n=[],i=window.aipkit_image_generator_config_public||{},a=o.toLowerCase(),r=t?new Set(t.split(",").map(p=>p.trim().toLowerCase())):null;if(a==="openai"&&i.openai_models?n=i.openai_models||[]:a==="google"&&i.google_models?n=i.google_models||{}:a==="azure"&&i.azure_models?n=i.azure_models||[]:a==="replicate"&&i.replicate_models&&(n=i.replicate_models||[]),r&&!r.has(a))if(n.image||n.video){let p={};n.image&&Array.isArray(n.image)&&(p.image=n.image.filter(l=>r.has(l.id))),n.video&&Array.isArray(n.video)&&(p.video=n.video.filter(l=>r.has(l.id))),n=p}else Array.isArray(n)&&(n=n.filter(p=>r.has(p.id)));else r&&r.has(a);if(!(n.image&&n.image.length>0||n.video&&n.video.length>0||Array.isArray(n)&&n.length>0))e.appendChild(new Option("(No models available)","")),e.disabled=!0;else{if(a==="openai")n.sort((p,l)=>{let d={"gpt-image-1":1,"dall-e-3":2,"dall-e-2":3};return(d[p.id]||99)-(d[l.id]||99)}),n.forEach(p=>{e.appendChild(new Option(p.name,p.id))});else if(a==="azure")n.forEach(p=>{let l=p.name||p.id;e.appendChild(new Option(l,p.id))});else if(a==="google"){if(n.image&&n.image.length>0){let p=document.createElement("optgroup");p.label="Image Models",n.image.sort((l,d)=>{let u={"gemini-2.0-flash-preview-image-generation":1,"imagen-3.0-generate-002":2,"imagen-4.0-generate-preview-06-06":3,"imagen-4.0-ultra-generate-preview-06-06":4};return(u[l.id]||99)-(u[d.id]||99)}),n.image.forEach(l=>{p.appendChild(new Option(l.name,l.id))}),e.appendChild(p)}if(n.video&&n.video.length>0){let p=document.createElement("optgroup");p.label="Video Models",n.video.forEach(l=>{p.appendChild(new Option(l.name,l.id))}),e.appendChild(p)}}else if(a==="replicate"){let p={};n.forEach(d=>{if(d&&d.name){let u=d.name.split("/"),_=u.length>1?u[0]:"other";p[_]||(p[_]=[]),p[_].push(d)}}),Object.keys(p).sort().forEach(d=>{let u=document.createElement("optgroup");u.label=d,p[d].sort((_,f)=>(_.name||"").localeCompare(f.name||"")),p[d].forEach(_=>{let f=_.name.replace(d+"/",""),w=new Option(f,_.id);u.appendChild(w)}),e.appendChild(u)})}e.disabled=!1,e.selectedIndex===-1&&(e.selectedIndex=0)}}window.aipkit_populatePublicModelsForProvider=c})();(function(){"use strict";function c(o){let e=o.target.closest(".aipkit-image-history-delete-btn");if(!e)return;o.preventDefault(),o.stopPropagation();let t=e.dataset.attachmentId;if(!t)return;let i=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,a=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!i||!a){alert("Error: Cannot delete image. Configuration missing.");return}let r=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let s=new FormData;s.append("action","aipkit_delete_generated_image"),s.append("_ajax_nonce",a),s.append("attachment_id",t),fetch(i,{method:"POST",body:s,credentials:"same-origin"}).then(p=>p.json()).then(p=>{if(!p.success)throw new Error(p.data?.message||"Deletion failed.");let l=e.closest(".aipkit-image-history-item");l&&(l.style.transition="opacity 0.3s",l.style.opacity="0",setTimeout(()=>{l.remove();let d=document.querySelector(".aipkit-image-history-grid"),u=document.querySelector(".aipkit_image_history_section");if(d&&u&&d.children.length===0){let _=document.createElement("p");_.className="aipkit-image-history-empty",_.textContent="You have not generated any images yet.",u.appendChild(_),d.remove()}},300))}).catch(p=>{alert("Error deleting image: "+p.message),e.innerHTML=r,e.disabled=!1})}window.aipkit_handleDeleteImage=c})();(function(){"use strict";function c(){let t=document.getElementById("aipkit_public_image_generator");if(!t)return;let n=t.querySelector("#aipkit_public_image_prompt"),i=t.querySelector("#aipkit_public_image_results"),a=t.querySelector("#aipkit_public_generate_image_btn"),r=t.querySelector("#aipkit_image_generator_public_nonce"),s=window.aipkit_image_generator_config_public||{},p=s.text||{},l=s.ajaxUrl||window.aipkit_dashboard?.ajaxurl,d=r?r.value:null,u=window.aipkit_escapeHtml||function(k){return k};if(!n||!i||!a||!l||!d){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),i.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Configuration missing.</p>',i.style.display="grid";return}let _=window.aipkit_getSettingValue(t,"aipkit_public_image_provider","image_provider"),f=window.aipkit_getSettingValue(t,"aipkit_public_image_model","image_model"),w=n.value.trim(),m=f==="veo-3.0-generate-preview"||f.includes("veo");if(!w){console.log("AIPKit Image Gen (Public): Prompt is empty, doing nothing.");return}if(!_||!f){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:_,model:f}),i.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Missing required image generation settings.</p>',i.style.display="grid";return}a.disabled=!0;let g=a.querySelector(".aipkit_btn-text"),h=a.querySelector(".aipkit_spinner"),I=g?g.textContent:p.generateButton||(m?"Generate Video":"Generate Image");g&&(g.textContent=p.generating||(m?"Generating Video...":"Generating...")),h&&(h.style.display="inline-block"),i.style.display="grid",i.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span></p>';let b=new FormData;b.append("action","aipkit_generate_image"),b.append("_ajax_nonce",d),b.append("prompt",w),b.append("provider",_),b.append("model",f),_.toLowerCase()==="openai"?(f==="dall-e-3"?(b.append("quality","standard"),b.append("style","vivid")):f==="gpt-image-1"&&b.append("output_format","png"),f!=="gpt-image-1"&&b.append("response_format","url")):_.toLowerCase()==="google"&&m&&(b.append("aspect_ratio","16:9"),b.append("person_generation","allow_all")),fetch(l,{method:"POST",body:b,credentials:"same-origin"}).then(k=>k.json()).then(k=>{if(!k.success){let y=k.data&&k.data.message?k.data.message:"Unknown generation error";throw new Error(y)}if(k.data.status==="processing"&&k.data.operation_name){console.log("AIPKit: Starting video polling for operation:",k.data.operation_name),o(k.data.operation_name,f,d,a,i,g,h,I,m,w,p,u);return}e(k.data,a,i,g,h,I,m,w,p,u)}).catch(k=>{console.error("AIPKit Image Generation Error (Public):",k),i.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${p.error||"Error generating image:"} ${u(k.message||"Unknown error")}</p>`,a.disabled=!1,g&&(g.textContent=I),h&&(h.style.display="none")})}function o(t,n,i,a,r,s,p,l,d,u,_,f){let g=0;s&&(s.textContent=_.generatingVideo||"Generating Video..."),r.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span> Video generation in progress...</p>';function h(){if(g>=60){r.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Video generation timed out. Please try again.</p>',a.disabled=!1,s&&(s.textContent=l),p&&(p.style.display="none");return}g++,console.log(`AIPKit: Polling video status (attempt ${g}/60)`);let I=Math.min(g/60*100,95);r.innerHTML=`<p class="aipkit_image_results_placeholder" style="text-align:center;">
        <span class="aipkit_spinner" style="display:inline-block;"></span> 
        Generating video... (${Math.round(I)}%)
      </p>`;let b=new FormData;b.append("action","aipkit_check_video_status"),b.append("_ajax_nonce",i),b.append("operation_name",t),b.append("model_id",n),b.append("prompt",u),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:b,credentials:"same-origin"}).then(k=>k.json()).then(k=>{if(k.success)if(k.data.status==="completed")console.log("AIPKit: Video generation completed"),e(k.data,a,r,s,p,l,d,u,_,f);else if(k.data.status==="processing")setTimeout(h,5e3);else throw new Error(`Unknown status: ${k.data.status}`);else throw new Error(k.data?.message||"Status check failed")}).catch(k=>{console.error("AIPKit Video Status Check Error:",k),r.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">Video generation failed: ${f(k.message||"Unknown error")}</p>`,a.disabled=!1,s&&(s.textContent=l),p&&(p.style.display="none")})}setTimeout(h,5e3)}function e(t,n,i,a,r,s,p,l,d,u){let _=t.images||t.videos||[];if(_.length>0)i.innerHTML="",_.forEach(f=>{let w=document.createElement("div");w.className=p?"aipkit_video_result":"aipkit_image_result";let m="",g=f.media_library_url||f.url||null,h=p?d.viewFullVideo||"Click to view full video":d.viewFullImage||"Click to view full image";if(p)if(f.url){let I=`<video controls preload="metadata" style="max-width: 100%; height: auto;">
              <source src="${u(f.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;g&&g!==f.url?m=`<a href="${u(g)}" target="_blank" rel="noopener noreferrer" title="${u(h)}">${I}</a>`:m=I}else m='<p class="aipkit_video_results_message aipkit_message-error">Error: No video data found.</p>';else{let I=f.url||(f.b64_json?`data:image/png;base64,${f.b64_json}`:null);if(I){let b=`<img src="${u(I)}" alt="${u(l)}">`;g?m=`<a href="${u(g)}" target="_blank" rel="noopener noreferrer" title="${u(h)}">${b}</a>`:m=b}else m='<p class="aipkit_image_results_message aipkit_message-error">Error: No image data found.</p>'}if(w.innerHTML=m,f.revised_prompt){let I=document.createElement("p");I.style.fontSize="11px",I.style.fontStyle="italic",I.style.marginTop="5px",I.textContent=`Revised: ${f.revised_prompt}`,w.appendChild(I)}i.appendChild(w)});else{let f=p?"videos":"images";i.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${d.initialPlaceholder||`No ${f} returned. Try a different prompt.`}</p>`}n.disabled=!1,a&&(a.textContent=s),r&&(r.style.display="none")}window.aipkit_handlePublicImageGeneration=c})();(function(){"use strict";function c(o){let e=o.currentTarget;if(e.disabled)return;let t=e.closest("#aipkit_public_image_generator");if(!t)return;let i=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,a=t.querySelector("#aipkit_image_generator_public_nonce")?.value,r=t.querySelector(".aipkit-image-history-grid");if(!i||!a||!r){console.error("Image History Load More: Missing required elements or config.");return}let s=parseInt(e.dataset.currentPage,10)||1,p=parseInt(e.dataset.maxPages,10)||1,l=s+1;if(l>p)return;let d=e.querySelector(".aipkit_btn-icon-content"),u=e.querySelector(".aipkit_spinner");d&&(d.style.display="none"),u&&(u.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",a),_.append("page",l),fetch(i,{method:"POST",body:_,credentials:"same-origin"}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.data?.message||"Failed to load more images.");f.data.html&&r.insertAdjacentHTML("beforeend",f.data.html),e.dataset.currentPage=l,f.data.has_more||(e.style.display="none")}).catch(f=>{console.error("Image History Load More Error:",f)}).finally(()=>{d&&(d.style.display="inline-block"),u&&(u.style.display="none"),l<p?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=c})();(function(){"use strict";function c(){let o=document.getElementById("aipkit_public_image_generator");if(!o)return;console.log("AIPKit Image Generator: Initializing Public UI...");let e=o.querySelector("#aipkit_public_generate_image_btn"),t=o.querySelector("#aipkit_public_image_results"),n=o.querySelector("#aipkit_public_image_provider"),i=o.querySelector("#aipkit_public_image_model"),a=o.dataset.allowedModels||"",r=o.querySelector(".aipkit-image-history-grid"),s=o.querySelector(".aipkit-image-history-load-more-btn");if(!e||!t){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),t&&(t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Core UI elements missing.</p>'),t.style.display="grid";return}n&&i&&typeof window.aipkit_populatePublicModelsForProvider=="function"&&(window.aipkit_populatePublicModelsForProvider(n.value,i,a),n.addEventListener("change",()=>{window.aipkit_populatePublicModelsForProvider(n.value,i,a)})),e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",window.aipkit_handlePublicImageGeneration),e.dataset.listenerAttached="true"),r&&r.addEventListener("click",window.aipkit_handleDeleteImage),s&&s.addEventListener("click",window.aipkit_handleLoadMoreHistory),t&&(t.style.display="none",t.innerHTML=""),console.log("AIPKit Image Generator (Public): UI Initialized. Results container hidden.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c(),window.aipkit_initPublicImageGenerator=c})();(function(){"use strict";function c(t,n,i,a){let r=window.aipkit_token_usage_config||{},s=r.text||{},p=document.createElement("div");p.className="aipkit-usage-details-table-container";let l=document.createElement("div");l.className="aipkit-usage-details-pagination-container",a.appendChild(p),a.appendChild(l),p.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${s.loadingDetails||"Loading details..."}</p>`;let d={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:t,context_id:n,page:i},u=new FormData;for(let _ in d)u.append(_,d[_]);fetch(r.ajaxUrl,{method:"POST",body:u,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");o(_.data.items,p),e(_.data.pagination,l,t,n,a)}).catch(_=>{console.error("Error fetching token usage details:",_),p.innerHTML=`<p style="color:red;text-align:center;">${s.errorLoading||"Error loading details."} (${_.message})</p>`})}function o(t,n){if(!t||t.length===0){n.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let i='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';t.forEach(a=>{let s=new Date(a.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});i+=`<tr><td>${s}</td><td>${a.tokens.toLocaleString()}</td></tr>`}),i+="</tbody></table>",n.innerHTML=i}function e(t,n,i,a,r){let{currentPage:s,totalPages:p}=t,l=window.aipkit_token_usage_config?.text||{};if(n.innerHTML="",p<=1)return;let d=document.createElement("button");d.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",d.textContent=l.previous||"Previous",d.disabled=s<=1,d.addEventListener("click",()=>c(i,a,s-1,r)),n.appendChild(d);let u=document.createElement("span");u.className="aipkit_pagination-current",u.textContent=`${l.pageLabel||"Page"} ${s} ${l.ofLabel||"of"} ${p}`,n.appendChild(u);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=l.next||"Next",_.disabled=s>=p,_.addEventListener("click",()=>c(i,a,s+1,r)),n.appendChild(_)}document.addEventListener("click",function(t){let n=t.target.closest(".aipkit-usage-details-btn");if(!n||n.disabled)return;let i=n.closest("tr.aipkit-usage-main-row");if(!i)return;let a=i.nextElementSibling,r=a&&a.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(s=>{if(s!==a){let p=s.previousElementSibling.querySelector(".aipkit-usage-details-btn");p&&p.classList.remove("aipkit-active"),s.remove()}}),r)a.remove(),n.classList.remove("aipkit-active");else{n.classList.add("aipkit-active");let s=document.createElement("tr");s.className="aipkit-usage-details-row";let p=document.createElement("td");p.colSpan=i.cells.length,p.className="aipkit-usage-details-cell";let l=document.createElement("div");l.className="aipkit-usage-details-content",p.appendChild(l),s.appendChild(p),i.parentNode.insertBefore(s,i.nextSibling);let d=n.dataset.module,u=n.dataset.contextId;c(d,u,1,l)}}),document.addEventListener("click",function(t){let n=t.target.closest(".aipkit_toggle_purchase_history");if(!n)return;t.preventDefault();let i=document.getElementById("aipkit_purchase_history_details");if(!i)return;n.getAttribute("aria-expanded")==="true"?(i.style.display="none",n.setAttribute("aria-expanded","false")):(i.style.display="block",n.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function c(e){e.preventDefault();let t=e.target,n=t.querySelector(".aipkit_semantic_search_input"),i=t.querySelector(".aipkit_semantic_search_button"),a=t.closest(".aipkit_semantic_search_wrapper"),r=a.querySelector(".aipkit_semantic_search_results");if(!n||!i||!a||!r){console.error("Semantic Search: Missing required form elements.");return}let s=n.value.trim();if(!s)return;let p=window.aipkit_semantic_search_config||{},l=p.text||{};i.disabled=!0;let d=i.querySelector(".aipkit_spinner");d&&(d.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let u={query:s};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",u,p).then(_=>{r.innerHTML=_.html||`<p>${p.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),r.innerHTML=`<p class="aipkit-search-error">${l.error||"An error occurred while searching."}</p>`}).finally(()=>{i.disabled=!1,d&&(d.style.display="none")})}function o(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(t=>{t.dataset.listenerAttached!=="true"&&(t.addEventListener("submit",c),t.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",o),document.addEventListener("aipkit:contentLoaded",o)})();(function(){"use strict";function c(o,e,t){if(!o)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let n=o.querySelector(".aipkit_consent_overlay");if(!n){n=document.createElement("div"),n.className="aipkit_consent_overlay",n.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `;let i=o.querySelector(".aipkit_chat_input");i?o.insertBefore(n,i):o.appendChild(n);let a=n.querySelector(".aipkit_consent_agree_btn");a&&typeof t=="function"&&a.addEventListener("click",t)}return n.classList.remove("aipkit_hidden"),console.log(`AIPKit ShowConsentBox (${e.botId}): Showing consent box.`),n}window.aipkit_chatUI_showConsentBox=c})();(function(){"use strict";function c(o){o&&(o.classList.add("aipkit_hidden"),console.log("AIPKit HideConsentBox: Hiding consent box."))}window.aipkit_chatUI_hideConsentBox=c})();(function(){"use strict";function c(o,e,t,n,i,a){o.consentGiven=!0,localStorage.setItem(e,"true"),typeof i=="function"&&a&&i(a);let r=n.closest("[data-bot-id]")?.dataset.botId||"unknown";console.log(`AIPKit HandleConsentAgree (${r}): Consent given and stored.`),typeof t=="function"&&t();let s=n.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=c})();(function(){"use strict";function c(o,e,t,n){let i=e.botId,a=`aipkit_chatbot_consent_given_${i}`;t.consentGiven=localStorage.getItem(a)==="true";let r=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(t,a,n,o,l,r):console.error(`AIPKit Consent UI Init (${i}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function p(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(o,e,s):console.error(`AIPKit Consent UI Init (${i}): aipkit_chatUI_showConsentBox helper function not found.`)}function l(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${i}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!t.consentGiven&&p(),console.log(`AIPKit Consent UI Init (${i}): Initialized. Required: ${e.requireConsentCompliance}, Given: ${t.consentGiven}`),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!t.consentGiven?(p(),!0):!1,isConsentGiven:()=>t.consentGiven}}window.aipkit_initConsentUI=c})();(function(){"use strict";function c(o,e){let{messagesEl:t}=o;if(!t||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:n}=window.jspdf,i=new n,a=t.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",s=e.text.userPrefix||"User",p=e.text.errorPrefix||"Error",l=10,d=i.internal.pageSize.height,u=10,_=6,f=d-u*2,w=!1;if(i.setFontSize(16),i.text(`Chat Transcript - ${r}`,u,l),l+=_*2,i.setFontSize(12),a.forEach(g=>{let h=g.querySelector(".aipkit_chat_bubble");if(!h)return;let I=window.aipkit_chatUI_extractTextFromBubble(h),b="";if(g.classList.contains("aipkit_chat_message-user")?(b=`${s}:`,i.setFont(void 0,"bold")):g.classList.contains("aipkit_chat_message-bot")?(b=`${r}:`,i.setFont(void 0,"normal")):g.classList.contains("aipkit_chat_message-error")?(b=`${p}:`,i.setFont(void 0,"italic")):i.setFont(void 0,"normal"),b&&I){w=!0;let k=b,y=`${I}`;l+_>f+u&&(i.addPage(),l=u),i.text(k,u,l),l+=_,i.splitTextToSize(y,i.internal.pageSize.width-u*2).forEach(v=>{l+_>f+u&&(i.addPage(),l=u),i.text(v,u,l),l+=_}),l+=_/2,i.setFont(void 0,"normal")}}),!w){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let m=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{i.save(m),console.log("AIPKit Chat Download: PDF generated and download triggered for",m)}catch(g){console.error("AIPKit Download PDF: Error calling doc.save()",g),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=c})();(function(){"use strict";function c(o){let t=o.currentTarget.closest(".aipkit-ai-form-wrapper"),n=t?t.querySelector(".aipkit-ai-form-results-content"):null,i=t?t.dataset.formId:"unknown";if(!n){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:a}=window.jspdf,r=new a,s=n.innerText||n.textContent||"";if(!s.trim()){alert("Nothing to export.");return}let p=r.internal.pageSize.height,l=10,d=6,u=p-l*2,_=l;r.setFontSize(12),r.splitTextToSize(s,r.internal.pageSize.width-l*2).forEach(h=>{_+d>u+l&&(r.addPage(),_=l),r.text(h,l,_),_+=d});let w=new Date,m=`${w.getFullYear()}${String(w.getMonth()+1).padStart(2,"0")}${String(w.getDate()).padStart(2,"0")}`,g=`aiform-${i}-result-${m}.pdf`;r.save(g)}window.aipkitForms_handleDownloadPdf=c})();(function(){"use strict";function c(e,t,n=null){if(!e)return;e.classList.remove("is-connecting","is-listening","is-speaking","is-error");let i=e.querySelector(".dashicons, svg"),a=e.querySelector(".aipkit_spinner");switch(a&&a.remove(),i&&(i.style.display="block"),t){case"connecting":e.classList.add("is-connecting"),i&&(i.style.display="none");let r=document.createElement("span");r.className="aipkit_spinner",r.style.display="inline-block",e.appendChild(r),e.title=n||"Connecting...",e.disabled=!0;break;case"listening":e.classList.add("is-listening"),i&&i.classList.contains("dashicons")&&(i.className="dashicons dashicons-controls-pause"),e.title=n||"Listening... (Click to stop)",e.disabled=!1;break;case"speaking":e.classList.add("is-speaking"),i&&i.classList.contains("dashicons")&&(i.className="dashicons dashicons-controls-volumeon"),e.title=n||"AI is speaking... (Click to stop)",e.disabled=!1;break;case"error":e.classList.add("is-error"),i&&i.classList.contains("dashicons")&&(i.className="dashicons dashicons-warning"),e.title=n||"Error. Click to retry.",e.disabled=!1;break;case"idle":default:i&&i.classList.contains("dashicons")&&(i.className="dashicons dashicons-controls-volumeon"),e.title=n||"Start Voice Conversation",e.disabled=!1;break}}function o(e,t){e.inputField&&(e.inputField.disabled=t),e.actionButton&&(e.actionButton.disabled=t),e.inputActionButton&&(e.inputActionButton.disabled=t),e.voiceInputButton&&(e.voiceInputButton.disabled=t)}window.aipkit_realtimeUIHandler={setButtonState:c,toggleMainInputs:o}})();(function(){"use strict";async function c(t){try{let n=await navigator.mediaDevices.getUserMedia({audio:!0});return n.getTracks().forEach(i=>t.addTrack(i,n)),n}catch(n){throw console.error("Error getting user media:",n),n}}function o(t){let n=document.createElement("audio");return n.autoplay=!0,t.ontrack=i=>{i.streams&&i.streams[0]&&(n.srcObject=i.streams[0])},n}function e(t){t&&t.getTracks().forEach(n=>n.stop())}window.aipkit_realtimeAudioHandler={startLocalStream:c,setupRemoteStream:o,stopLocalStream:e}})();(function(){"use strict";async function c(o,e,t){let n=t.createDataChannel("aipkit-events"),i={userTranscript:"",botTranscript:""},a=async r=>{let s=r?.usage||null;if(console.log("AIPKit Realtime: logSessionTurn called. User:",i.userTranscript,"Bot:",i.botTranscript,"Usage:",s),!i.userTranscript&&!i.botTranscript){console.log("AIPKit Realtime: Skipping log for empty turn.");return}let p={user_transcript:i.userTranscript,bot_transcript:i.botTranscript,usage_data:s?JSON.stringify(s):null};try{await window.aipkit_frontendApiRequest("aipkit_log_realtime_session_turn",p,e),console.log("AIPKit Realtime: Session turn logged successfully.")}catch(l){console.error("AIPKit Realtime: Failed to log session turn.",l)}finally{i={userTranscript:"",botTranscript:""}}};n.onopen=()=>console.log("AIPKit Realtime: Data channel opened."),n.onmessage=r=>{try{let s=JSON.parse(r.data);console.log("AIPKit Realtime: Data channel event:",s),s.type==="input.transcription"&&s.transcription&&(i.userTranscript+=s.transcription.trim()+" ",console.log("AIPKit Realtime: Accumulated userTranscript:",i.userTranscript)),s.type==="response.done"&&s.response&&(s.response.output&&s.response.output[0]&&s.response.output[0].content&&s.response.output[0].content[0]&&s.response.output[0].content[0].transcript&&(i.botTranscript=s.response.output[0].content[0].transcript),console.log("AIPKit Realtime: response.done event, userTranscript:",i.userTranscript,"botTranscript:",i.botTranscript),a(s.response))}catch(s){console.error("AIPKit Realtime: Error processing message from server:",r.data,s)}},n.onclose=()=>console.log("AIPKit Realtime: Data channel closed."),n.onerror=r=>console.error("AIPKit Realtime: Data channel error:",r);try{let r=await t.createOffer();await t.setLocalDescription(r);let s=e.realtimeModel||"gpt-4o-realtime-preview",p=await fetch(`https://api.openai.com/v1/realtime?model=${s}`,{method:"POST",body:r.sdp,headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/sdp"}});if(!p.ok){let d=await p.text();throw new Error(`SDP exchange failed with status ${p.status}: ${d}`)}let l={type:"answer",sdp:await p.text()};return await t.setRemoteDescription(l),n}catch(r){throw console.error("AIPKit Realtime: WebRTC connection failed.",r),t&&t.connectionState!=="closed"&&t.close(),r}}window.aipkit_realtimeConnector={connect:c}})();(function(){"use strict";let c={peerConnection:null,localStream:null,remoteAudioElement:null,dataChannel:null,isSessionActive:!1,currentBotId:null,elements:null,config:null,mainUIState:null,uiInstance:null};async function o(i){i&&(i.preventDefault(),i.stopPropagation()),c.isSessionActive?t():await e()}async function e(){if(c.config.requireConsentCompliance&&!c.mainUIState.consentGiven&&!c.config.directVoiceMode){console.warn(`AIPKit Realtime (${c.config.botId}): Cannot start session, consent required. Opening popup.`),c.uiInstance&&typeof c.uiInstance.openPopup=="function"&&c.uiInstance.openPopup();return}if(!window.aipkit_current_conversation_uuid)if(typeof window.aipkit_regenerateConversationUUID=="function")window.aipkit_regenerateConversationUUID(),console.log(`AIPKit Realtime: Generated new conversation UUID for session: ${window.aipkit_current_conversation_uuid}`);else{console.error("AIPKit Realtime: Cannot start session, aipkit_regenerateConversationUUID function is missing.");let p=c.elements.triggerButton,l=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),d=c.config.directVoiceMode?p:l;window.aipkit_realtimeUIHandler.setButtonState(d,"error","Error: Cannot create session ID.");return}window.aipkit_is_fresh_session=!1;let i=c.elements.triggerButton,a=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),r=c.config.directVoiceMode?i:a,{...s}=c.elements;window.aipkit_realtimeUIHandler.setButtonState(r,"connecting"),c.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(s,!0);try{let l=(await window.aipkit_frontendApiRequest("aipkit_create_realtime_session",{bot_id:c.currentBotId},c.config))?.client_secret?.value;if(!l)throw new Error("Could not retrieve a session key from the server.");let d=new RTCPeerConnection;c.peerConnection=d,c.remoteAudioElement=window.aipkit_realtimeAudioHandler.setupRemoteStream(d),c.localStream=await window.aipkit_realtimeAudioHandler.startLocalStream(d);let u=await window.aipkit_realtimeConnector.connect(l,c.config,d);c.dataChannel=u,d.onconnectionstatechange=()=>{(d.connectionState==="disconnected"||d.connectionState==="closed"||d.connectionState==="failed")&&(console.log("AIPKit Realtime: Peer connection state changed to",d.connectionState),t("Connection lost."))},c.isSessionActive=!0,window.aipkit_realtimeUIHandler.setButtonState(r,"listening");let _=c.config.text?.initialGreeting;if(_&&typeof window.aipkit_handlePlayAction=="function"&&c.config.ttsEnabled){let f=document.createElement("button");f.className="aipkit_action_btn aipkit_play_btn",f.innerHTML='<span class="dashicons dashicons-controls-play"></span>';let w=document.createElement("div");w.setAttribute("data-raw-text",_);let m=document.createElement("div");m.appendChild(w),m.appendChild(f),window.aipkit_handlePlayAction(f)}}catch(p){console.error("AIPKit Realtime: Failed to start session.",p),t(`Error: ${p.message||"Could not connect."}`,!0)}}function t(i=null,a=!1){c.peerConnection&&(c.peerConnection.close(),c.peerConnection=null),c.localStream&&(window.aipkit_realtimeAudioHandler.stopLocalStream(c.localStream),c.localStream=null),c.remoteAudioElement&&(c.remoteAudioElement.srcObject=null,c.remoteAudioElement=null),c.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(),c.isSessionActive=!1;let r=c.elements.triggerButton,s=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),p=c.config.directVoiceMode?r:s,{...l}=c.elements;window.aipkit_realtimeUIHandler.setButtonState(p,a?"error":"idle",i),c.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(l,!1)}function n(i,a,r,s,p){let l=i.container.querySelector(".aipkit_realtime_voice_agent_btn"),d=i.container.closest(".aipkit_popup_wrapper"),u=d?d.querySelector(".aipkit_popup_trigger"):null;!l||!u&&a.popupEnabled||(c.uiInstance=p,c.mainUIState=r,c.config=a,c.elements={...i,triggerButton:u},c.currentBotId=a.botId,a.directVoiceMode&&u?(u.addEventListener("click",o),l.style.display="none"):l.addEventListener("click",o),console.log(`AIPKit Realtime Voice Agent: Initialized for bot ${a.botId}. Direct Voice Mode: ${a.directVoiceMode}`))}window.aipkit_initRealtimeVoiceAgent=n})();})();
