(()=>{(function(){"use strict";function d(){if(typeof window.markdownit=="function"){window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"});let n=window.aipkit_md.renderer.rules.link_open||function(e,i,a,t,o){return o.renderToken(e,i,a)};window.aipkit_md.renderer.rules.link_open=function(e,i,a,t,o){let r=e[i],c=r.attrIndex("target");c<0?r.attrPush(["target","_blank"]):r.attrs[c][1]="_blank";let _=r.attrIndex("rel");if(_<0)r.attrPush(["rel","noopener noreferrer"]);else{let l=(r.attrs[_][1]||"").split(/\s+/).filter(Boolean);l.includes("noopener")||l.push("noopener"),l.includes("noreferrer")||l.push("noreferrer"),r.attrs[_][1]=l.join(" ")}return n(e,i,a,t,o)},window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs})}else console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(n){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(i){return typeof i!="string"?"":i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(n).replace(/\n/g,"<br>")}}}window.aipkit_initializeMarkdownParser=d})();(function(){"use strict";function d(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function n(e){return d(e)}window.aipkit_escapeHtml=d,window.aipkit_escapeAttribute=n})();(function(){"use strict";function d(n){let e=Number(n);if(!e||isNaN(e))return"";try{let i=new Date(e*1e3);if(isNaN(i.getTime()))return"";let a=String(i.getHours()).padStart(2,"0"),t=String(i.getMinutes()).padStart(2,"0"),o=String(i.getSeconds()).padStart(2,"0");return`${a}:${t}:${o}`}catch(i){return console.error("Error formatting timestamp:",n,i),""}}window.aipkit_formatTimestamp=d})();(function(){"use strict";function d(n,e={},i={}){return new Promise((a,t)=>{if(!i.ajaxUrl)return t(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let o=new FormData;o.append("action",n),i.nonce?o.append("_ajax_nonce",i.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${n}".`),i.botId&&o.append("bot_id",i.botId),window.aipkit_guest_uuid&&o.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&o.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&o.append("post_id",window.aipkit_current_post_id),i.provider==="OpenAI"&&i.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&o.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&o.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&o.append("frontend_google_search_grounding_active","true"),i.activeFileContext?(i.activeFileContext.provider==="OpenAI"&&i.activeFileContext.vector_store_id&&o.append("active_openai_vs_id",i.activeFileContext.vector_store_id),i.activeFileContext.provider==="Pinecone"&&i.activeFileContext.index_name&&i.activeFileContext.namespace&&(o.append("active_pinecone_index_name",i.activeFileContext.index_name),o.append("active_pinecone_namespace",i.activeFileContext.namespace)),i.activeFileContext.provider==="Qdrant"&&i.activeFileContext.collection_name&&i.activeFileContext.file_upload_context_id&&(o.append("active_qdrant_collection_name",i.activeFileContext.collection_name),o.append("active_qdrant_file_upload_context_id",i.activeFileContext.file_upload_context_id)),i.activeFileContext.provider==="Claude"&&i.activeFileContext.file_id&&o.append("active_claude_file_id",i.activeFileContext.file_id)):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id?console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`):e.active_claude_file_id&&console.log(`AIPKit frontendApiRequest: Sending Claude file context from data object: File ID: ${e.active_claude_file_id}`);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&r!=="frontend_web_search_active"&&r!=="frontend_google_search_grounding_active"&&r!=="active_openai_vs_id"&&r!=="active_pinecone_index_name"&&r!=="active_pinecone_namespace"&&r!=="active_qdrant_collection_name"&&r!=="active_qdrant_file_upload_context_id"&&r!=="active_claude_file_id"&&(r==="audio_file"&&e[r]instanceof Blob?o.append(r,e[r],"speech."+(e.audio_format||"webm")):o.append(r,e[r]));fetch(i.ajaxUrl,{method:"POST",body:o,credentials:"same-origin"}).then(r=>r.json()).then(r=>{if(r.success)a(r.data);else{let c=r.data&&typeof r.data=="object"&&r.data.message?r.data.message:"Unknown frontend API error (data or data.message missing/invalid)";t(new Error(c))}}).catch(r=>{console.error(`AIPKit Frontend AJAX Error (Action: ${n}):`,r),t(r)})})}window.aipkit_frontendApiRequest=d})();(function(){"use strict";function d(n){return`aipkit-client-msg-${String(n||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=d})();(function(){"use strict";function d(n){if(!n||typeof n.style>"u")return;n.style.height="auto";let e=n.scrollHeight,i=window.getComputedStyle(n),a=parseInt(i.minHeight,10)||0,t=parseInt(i.maxHeight,10)||1/0,o=Math.max(a,e);o=Math.min(o,t),n.style.height=`${o}px`,o>=t?(n.style.overflowY="auto",n.classList.add("aipkit-textarea-scrollable")):(n.style.overflowY="hidden",n.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=d})();(function(){"use strict";function d(e,i,a,t){let{webSearchToggleButton:o}=e,r=i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter");a.webSearchToolActive=r&&!!t,!(!o||!r)&&(o.classList.toggle("aipkit_active",a.webSearchToolActive),o.title=a.webSearchToolActive?i.text?.webSearchActive||"Web Search Active":i.text?.webSearchInactive||"Web Search Inactive",o.setAttribute("aria-pressed",a.webSearchToolActive.toString()))}function n(e,i,a){d(e,i,a,!a.webSearchToolActive)}window.aipkit_syncWebSearchToggleState=d,window.aipkit_toggleWebSearchAction=n})();(function(){"use strict";function d(e,i,a,t){let{googleSearchGroundingToggleButton:o}=e,r=i.allowGoogleSearchGrounding&&i.provider==="Google";a.googleSearchGroundingActive=r&&!!t,!(!o||!r)&&(o.classList.toggle("aipkit_active",a.googleSearchGroundingActive),o.title=a.googleSearchGroundingActive?i.text?.googleSearchGroundingActive||"Google Search Grounding Active":i.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",o.setAttribute("aria-pressed",a.googleSearchGroundingActive.toString()))}function n(e,i,a){d(e,i,a,!a.googleSearchGroundingActive)}window.aipkit_syncGoogleSearchGroundingToggleState=d,window.aipkit_toggleGoogleSearchGroundingAction=n})();(function(){"use strict";let d="aipkit_chat_ui_notice",n="aipkit_chat_ui_notice--visible",e=new Set(["info","success","error","processing","warning"]),i=new WeakMap,a=new WeakMap;function t(p){if(!p)return null;if(p.inputArea&&p.inputArea.nodeType===1)return p.inputArea;if(p.elements&&p.elements.inputArea)return p.elements.inputArea;if(p.container&&p.container.nodeType===1)return p.container.querySelector(".aipkit_chat_input");let l=p.messagesEl?p.messagesEl:p.elements&&p.elements.messagesEl?p.elements.messagesEl:null;if(l&&l.nodeType===1){let u=l.closest(".aipkit_chat_container");if(u)return u.querySelector(".aipkit_chat_input")}return null}function o(p){let l=p.querySelector(`.${d}`);if(l)return l;l=document.createElement("div"),l.className=d,l.setAttribute("role","status"),l.setAttribute("aria-live","polite");let u=p.querySelector(".aipkit_chat_input_wrapper");return u?p.insertBefore(l,u):p.appendChild(l),l}function r(p){let l=i.get(p);l&&(clearTimeout(l),i.delete(p));let u=a.get(p);u&&(clearTimeout(u),a.delete(p))}function c(p,l=!0){if(!p)return;r(p);let u=()=>{p.textContent="",p.style.display="none",p.className=d,a.delete(p)};if(!l){u();return}p.classList.remove(n);let g=window.setTimeout(u,220);a.set(p,g)}function _(p,l="info",u={},g,s){let m=String(p||"").trim();if(!m)return;let f=e.has(l)?l:"info",w=t(u);if(!w){console.warn("AIPKit Inline Notice: Could not resolve input area for message:",m);return}let h=o(w);if(r(h),h.textContent=m,h.className=`${d} aipkit_status-${f}`,h.style.display="block",requestAnimationFrame(()=>{h.style.display!=="none"&&h.classList.add(n)}),!(typeof g=="boolean"?g:f!=="processing"))return;let I=Number.isFinite(s)?Math.max(1e3,s):f==="error"||f==="warning"?7e3:4500,b=window.setTimeout(()=>{c(h,!0)},I);i.set(h,b)}window.aipkit_chatUI_showInlineNotice=_})();(function(){"use strict";let d=new Set(["muted","info","error","loading"]);function n(i={}){let a=d.has(i.type)?i.type:"muted",t=String(i.message||"").trim(),o=i.scope==="messages"?"messages":"sidebar",r=!!i.showSpinner,c=document.createElement("div");if(c.className=`aipkit_ui_state aipkit_ui_state--${a} aipkit_ui_state--${o}`,r&&!t&&c.classList.add("aipkit_ui_state--spinner-only"),t){let _=document.createElement("p");_.className="aipkit_ui_state_text",_.textContent=t,c.appendChild(_)}if(r){let _=document.createElement("span");_.className="aipkit_ui_state_spinner";let p=document.createElement("span");p.className="aipkit_spinner",p.setAttribute("aria-hidden","true"),_.appendChild(p),c.appendChild(_)}return c}function e(i,a={}){i&&(i.innerHTML="",i.appendChild(n(a)))}window.aipkit_chatUI_createStateElement=n,window.aipkit_chatUI_renderUIState=e})();(function(){"use strict";function d(n,e){let i=e.botId||"unknown",a=n.querySelector(".aipkit_chat_header"),t=n.querySelector(".aipkit_chat_main"),o=t?t.querySelector(".aipkit_chat_messages"):null,r=t?t.querySelector(".aipkit_chat_footer"):null,c=t?t.querySelector(".aipkit_chat_input"):null,_=c?c.querySelector(".aipkit_chat_input_field"):null,p=c?c.querySelector(".aipkit_chat_input_wrapper"):null,l=p?p.querySelector(".aipkit_chat_input_actions_bar"):null,u=n.querySelector(".aipkit_chat_image_preview_container"),g=n.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&c&&p){if(u||(u=document.createElement("div"),u.className="aipkit_chat_image_preview_container"),!p.contains(u)){let C=p.querySelector(".aipkit_chat_input_field");C?p.insertBefore(u,C):p.appendChild(u)}g||(g=document.createElement("input"),g.type="file",g.className="aipkit_chat_image_upload_input",g.hidden=!0,g.setAttribute("aria-hidden","true"),c.appendChild(g))}let s=c?c.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&c&&(s||(s=document.createElement("input"),s.type="file",s.className="aipkit_chat_file_upload_input",s.hidden=!0,s.setAttribute("aria-hidden","true"),c.appendChild(s)));let m=l?l.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,f=c?c.querySelector(".aipkit_input_action_menu"):null,w=l?l.querySelector(".aipkit_voice_input_btn"):null,h=l?l.querySelector(".aipkit_web_search_toggle"):null,y=l?l.querySelector(".aipkit_google_search_grounding_toggle"):null,I=l?l.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,b=I?I.querySelector(".aipkit_send_icon"):null,v=I?I.querySelector(".aipkit_clear_icon"):null,U=I?I.querySelector(".aipkit_spinner"):null,x=t?t.querySelector(".aipkit_conversation_starters"):null,M=a?a.querySelector(".aipkit_sidebar_toggle_btn"):null,F=a?a.querySelector(".aipkit_fullscreen_btn"):null,k=a?a.querySelector(".aipkit_download_btn"):null,S=n.querySelector(".aipkit_chat_sidebar"),A=S?S.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!t||!o||!_||!I||!b||!v||!U?(console.error(`AIPKit Chat FindElements (${i}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!x&&console.warn(`AIPKit Chat FindElements (${i}): Starters enabled but container not found.`),e.enableSidebar&&(!S||!M)&&console.warn(`AIPKit Chat FindElements (${i}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!m&&console.warn(`AIPKit Chat FindElements (${i}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&!h&&console.warn(`AIPKit Chat FindElements (${i}): Provider Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!y&&console.warn(`AIPKit Chat FindElements (${i}): Google Search Grounding allowed but toggle button missing.`),{container:n,headerEl:a,mainContentEl:t,messagesEl:o,footerEl:r,inputArea:c,inputField:_,inputWrapper:p,actionsBar:l,imageUploadInput:g,imagePreviewContainer:u,fileUploadInput:s,inputActionButton:m,inputActionMenu:f,voiceInputButton:w,webSearchToggleButton:h,googleSearchGroundingToggleButton:y,actionButton:I,sendIcon:b,clearIcon:v,spinner:U,startersContainer:x,sidebarToggleBtn:M,fullscreenButton:F,downloadButton:k,sidebarEl:S,newChatBtn:A})}window.aipkit_chatUI_findElements=d})();(function(){"use strict";function d(n,e=!1){n&&requestAnimationFrame(()=>{let i=n.scrollHeight-n.scrollTop-n.clientHeight<100;(e||i)&&(n.scrollTop=n.scrollHeight,setTimeout(()=>{n&&(n.scrollTop=n.scrollHeight)},50)),typeof window.aipkit_chatUI_updateScrollToBottomButton=="function"&&window.aipkit_chatUI_updateScrollToBottomButton(n)})}window.aipkit_chatUI_scrollToBottom=d})();(function(){"use strict";function d(n){if(!n)return;let e=n.style.animation;n.style.animation="none",n.offsetHeight,e?n.style.animation=e:n.style.removeProperty("animation")}window.aipkit_chatUI_triggerMessageAnimation=d})();(function(){"use strict";let d="aipkit_scroll_to_bottom_btn",n="aipkit-scroll-visible",a=window.requestAnimationFrame||function(u){return window.setTimeout(u,16)};function t(u,g=48){return u?u.scrollHeight-u.scrollTop-u.clientHeight<=g:!0}function o(u){return u?u.scrollHeight>u.clientHeight+4:!1}function r(u){if(!u||!u._aipkitScrollToBottomButton)return;let g=u._aipkitScrollToBottomButton,s=o(u)&&!t(u);g.classList.toggle(n,s),g.setAttribute("aria-hidden",s?"false":"true")}function c(u,g,s){if(!u)return;let m=g?Math.round(g.getBoundingClientRect().height):0,f=s?Math.round(s.getBoundingClientRect().height):0,h=Math.max(96,m+f+12);u.style.setProperty("--aipkit-chat-scroll-button-bottom-offset",`${h}px`)}function _(u){let g=u.querySelector(`.${d}`);return g||(g=document.createElement("button"),g.type="button",g.className=d,g.setAttribute("aria-label","Scroll to bottom"),g.setAttribute("aria-hidden","true"),g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 13l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',u.appendChild(g),g)}function p(u){if(!u||!u.mainContentEl||!u.messagesEl||u.mainContentEl.dataset.aipkitScrollButtonInit==="1")return;u.mainContentEl.dataset.aipkitScrollButtonInit="1";let{mainContentEl:g,messagesEl:s,inputArea:m,footerEl:f}=u,w=_(g);s._aipkitScrollToBottomButton=w,s._aipkitScrollToBottomUpdate=()=>r(s);let h=()=>{a(()=>r(s))};if(s.addEventListener("scroll",h,{passive:!0}),typeof MutationObserver<"u"&&new MutationObserver(h).observe(s,{childList:!0,subtree:!0}),typeof ResizeObserver<"u"){let y=new ResizeObserver(()=>{c(g,m,f),h()});y.observe(s),m&&y.observe(m),f&&y.observe(f)}else window.addEventListener("resize",()=>{c(g,m,f),h()});w.addEventListener("click",()=>{typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(s,!0):s&&s.scrollTo({top:s.scrollHeight,behavior:"smooth"}),h()}),c(g,m,f),h()}function l(u){!u||!u._aipkitScrollToBottomUpdate||u._aipkitScrollToBottomUpdate()}window.aipkit_chatUI_initScrollToBottomButton=p,window.aipkit_chatUI_updateScrollToBottomButton=l})();(function(){"use strict";function d(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-typing-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_typing-indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeTypingIndicator=d})();(function(){"use strict";function d(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-image-loading-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_image_loading_indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeImageLoadingIndicator=d})();(function(){"use strict";function d(n,e){if(!n||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-typing-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",t.id=a;let o=(e.customTypingText||"").trim(),r=document.createElement("div");if(r.className="aipkit_chat_bubble",o!==""){let c=(window.aipkit_escapeHtml||(_=>String(_)))(o);r.innerHTML=`
        <span class="aipkit_typing-text">${c}</span>
        <span class="aipkit_typing-ellipsis-text" aria-hidden="true"><span>.</span><span>.</span><span>.</span></span>
      `}else r.innerHTML=`
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
      `;return t.appendChild(r),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showTypingIndicator=d})();(function(){"use strict";function d(n,e){if(!n||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-image-loading-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",t.id=a;let o=document.createElement("div");return o.className="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail",o.innerHTML='<span class="dashicons dashicons-format-image"></span>',t.appendChild(o),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showImageLoadingIndicator=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>';function n(o){if(!o)return"";let r=o.querySelector("code");return r?r.textContent:o.textContent}function e(o,r){if(o){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(o).then(r).catch(()=>{i(o,r)});return}i(o,r)}}function i(o,r){try{let c=document.createElement("textarea");c.value=o,c.setAttribute("readonly",""),c.style.position="absolute",c.style.left="-9999px",document.body.appendChild(c),c.select();let _=document.execCommand("copy");document.body.removeChild(c),_&&r()}catch(c){console.error("AIPKit Code Copy: Fallback copy failed.",c)}}function a(o,r){if(!o||r&&r.enableCopyButton===!1)return;let c=o.querySelectorAll("pre");if(!c.length)return;let _=r&&r.text&&r.text.copyCodeLabel||"Copy code";c.forEach(p=>{if(p.classList.contains("aipkit_code_block"))return;let l=document.createElement("button");l.type="button",l.className="aipkit_code_copy_btn",l.setAttribute("aria-label",_),l.setAttribute("title",_),l.innerHTML=d,p.classList.add("aipkit_code_block"),p.insertBefore(l,p.firstChild)})}function t(o){let r=o.target.closest(".aipkit_code_copy_btn");if(!r)return;o.preventDefault();let c=r.closest("pre"),_=n(c);_&&e(_,()=>{typeof window.aipkit_chatUI_showSuccessIcon=="function"&&window.aipkit_chatUI_showSuccessIcon(r)})}document.addEventListener("click",t),window.aipkit_chatUI_attachCodeCopyButtons=a})();(function(){"use strict";function d(n,e,i,a,t=!1,o=!1,r=null,c=!1,_=null){if(!n||!a)return;let p=window.aipkit_escapeHtml||function(m){return m};o||n.querySelectorAll(".aipkit_initial_greeting").forEach(f=>f.remove());let l=document.createElement("div"),u=i==="user"?"user":"bot";l.className=`aipkit_chat_message aipkit_chat_message-${u}`,t&&l.classList.add("aipkit_chat_message-error"),o&&l.classList.add("aipkit_initial_greeting"),r&&(l.id=r,l.setAttribute("data-message-id",r));let g=document.createElement("div");g.className="aipkit_chat_bubble";let s="";if(u==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let m=document.createElement("img");m.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,m.alt=e.text||"User uploaded image",m.className="aipkit_user_sent_image_thumbnail",g.appendChild(m)}if(e.text&&e.text.trim()!==""){let m=document.createElement("div");m.className="aipkit_user_message_text_content",m.textContent=e.text,g.appendChild(m),s=e.text}else!e.text&&e.user_image&&(s="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let m=e.images[0],f=String(e.prompt||"Generated image"),w=typeof m.revised_prompt=="string"?m.revised_prompt:"",h=({src:y,href:I,alt:b})=>{let v=document.createElement("img");if(v.src=y,v.alt=b,v.className="aipkit_bot_generated_image",I){let U=document.createElement("a");U.href=I,U.target="_blank",U.rel="noopener noreferrer",U.appendChild(v),g.appendChild(U);return}g.appendChild(v)};if(m.media_library_url)h({src:String(m.media_library_url),href:String(m.media_library_url),alt:f});else if(m.url)h({src:String(m.url),href:String(m.url),alt:f});else if(m.b64_json)h({src:`data:image/png;base64,${m.b64_json}`,alt:f});else{let y=e.content||a.text?.noImageData||"Image data unavailable.",I=document.createElement("p");I.className="aipkit_image_unavailable_text",I.textContent=y,g.appendChild(I)}if(g.classList.add("aipkit_chat_bubble--image"),g.title=`Prompt: ${f}`,s=`Image generated for prompt: ${f}`,w){let y=document.createElement("p");y.className="aipkit_image_revised_prompt",y.textContent=`Revised: ${w}`,g.appendChild(y),s+=`. Revised prompt: ${w}`}}else if(typeof e=="string")if(s=e,(u==="bot"||o)&&!t&&window.aipkit_md)g.innerHTML=window.aipkit_md.render(e),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(g,a);else{let m=e.split(`
`);m.forEach((f,w)=>{g.appendChild(document.createTextNode(f)),w<m.length-1&&g.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),g.textContent=p("[Invalid Content]"),s="Invalid Content";if(g.setAttribute("data-raw-text",s),l.appendChild(g),u==="bot"&&!o&&!t)if(l.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let m=window.aipkit_chatUI_createActionsContainerHTML(a);m&&(l.insertAdjacentHTML("beforeend",m),l.classList.add("aipkit_has_message_actions"))}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(u==="bot"&&!t&&_&&_.searchEntryPoint&&_.searchEntryPoint.renderedContent){let m=document.createElement("div");m.className="aipkit_grounding_widget",m.innerHTML=_.searchEntryPoint.renderedContent,l.appendChild(m)}n.appendChild(l),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(l),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,c)}window.aipkit_chatUI_appendMessage=d})();(function(){"use strict";function d(n,e){let i=n.querySelector(`.${e}`);i?i.parentNode&&i.parentNode.removeChild(i):(i=document.createElement("span"),i.className=e);let a=o=>{let r=Array.from(o.childNodes);for(let c=r.length-1;c>=0;c--){let _=r[c];if(_.nodeType===Node.TEXT_NODE&&_.textContent.trim()!==""){let p=document.createElement("span"),l=document.createTextNode(_.textContent);return p.appendChild(l),o.replaceChild(p,_),p.appendChild(i),!0}if(_.nodeType===Node.ELEMENT_NODE&&_.offsetParent!==null&&!_.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(_.tagName))return _.childNodes.length>0&&a(_)||(_.nextSibling?o.insertBefore(i,_.nextSibling):o.appendChild(i)),!0}return!1};a(n)||n.appendChild(i)}window.positionStreamingIndicator=d})();(function(){"use strict";function d(n,e,i,a,t,o=!1,r=!1,c=null){if(!n||!t||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:n,messageId:e,config:t});return}let _=window.aipkit_escapeHtml||function(m){return m},p=n.querySelector(`#${CSS.escape(e)}`),l,u="",g="aipkit_stream_indicator",s=a==="user"?"user":"bot";if(!p)n.querySelectorAll(".aipkit_initial_greeting").forEach(f=>f.remove()),p=document.createElement("div"),p.id=e,p.setAttribute("data-message-id",e),p.className=`aipkit_chat_message aipkit_chat_message-${s}`,r&&p.classList.add("aipkit_chat_message-error"),l=document.createElement("div"),l.className="aipkit_chat_bubble",l.dataset.aipkitFullContent="",l.setAttribute("data-raw-text",""),p.appendChild(l),n.appendChild(p),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(p);else{if(l=p.querySelector(".aipkit_chat_bubble"),!l)return;r&&!p.classList.contains("aipkit_chat_message-error")&&p.classList.add("aipkit_chat_message-error")}if(l.dataset.aipkitFullContent===void 0&&(l.dataset.aipkitFullContent=""),l.getAttribute("data-raw-text")===null&&l.setAttribute("data-raw-text",""),l.dataset.aipkitFullContent+=i,l.setAttribute("data-raw-text",l.getAttribute("data-raw-text")+i),u=l.dataset.aipkitFullContent,r?l.textContent=u:(l.innerHTML=window.aipkit_md?window.aipkit_md.render(u):u.replace(/\n/g,"<br>"),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(l,t)),p.classList.remove("aipkit_message_streaming"),!o&&!r){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(l,g);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let m=l.querySelector(`.${g}`);m||(m=document.createElement("span"),m.className=g,l.appendChild(m))}p.classList.add("aipkit_message_streaming")}else{let m=l.querySelector(`.${g}`);if(m&&m.parentNode&&m.parentNode.removeChild(m),o&&!r&&s==="bot"&&!p.querySelector(".aipkit_message_actions")){if(p.classList.remove("aipkit_message_streaming"),p.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let f=window.aipkit_chatUI_createActionsContainerHTML(t);f&&(p.insertAdjacentHTML("beforeend",f),p.classList.add("aipkit_has_message_actions"))}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(c&&c.searchEntryPoint&&c.searchEntryPoint.renderedContent){let f=document.createElement("div");f.className="aipkit_grounding_widget",f.innerHTML=c.searchEntryPoint.renderedContent,p.appendChild(f)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,o||r)}window.aipkit_chatUI_appendOrUpdateMessage=d})();(function(){"use strict";function d(n,e,i,a=null){if(!n||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let t=window.aipkit_escapeHtml||function(u){return u},o=i.botId||"default",r=document.createElement("div");if(r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",a)r.id=a,r.setAttribute("data-message-id",a);else{let u=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(o):`form-msg-${Date.now()}`;r.id=u,r.setAttribute("data-message-id",u)}let c=document.createElement("div");c.className="aipkit_chat_bubble";let _=document.createElement("div");if(_.className="aipkit_chat_form_wrapper",_.dataset.formId=e.form_id,e.title){let u=document.createElement("h5");u.className="aipkit_chat_form_title",u.textContent=t(e.title),_.appendChild(u)}let p=document.createElement("form");p.className="aipkit_chat_form",p.dataset.formId=e.form_id,e.elements.forEach(u=>{let g=document.createElement("div");g.className="aipkit_chat_form_element";let s;switch(u.type){case"text_input":case"textarea":if(u.label){let f=document.createElement("label");f.setAttribute("for",`form-${t(e.form_id)}-${t(u.id)}`),f.textContent=t(u.label),f.className="aipkit_chat_form_label_text",g.appendChild(f)}s=u.type==="textarea"?document.createElement("textarea"):document.createElement("input"),u.type==="text_input"&&(s.type="text"),u.type==="textarea"&&(s.rows=u.rows||3),s.id=`form-${t(e.form_id)}-${t(u.id)}`,s.name=t(u.id),s.className="aipkit_form-input",u.placeholder&&(s.placeholder=t(u.placeholder)),u.required&&(s.required=!0),u.default_value!==void 0&&(s.value=t(String(u.default_value))),g.appendChild(s);break;case"dropdown":if(u.label){let f=document.createElement("label");f.setAttribute("for",`form-${t(e.form_id)}-${t(u.id)}`),f.textContent=t(u.label),f.className="aipkit_chat_form_label_text",g.appendChild(f)}s=document.createElement("select"),s.id=`form-${t(e.form_id)}-${t(u.id)}`,s.name=t(u.id),s.className="aipkit_form-input",u.required&&(s.required=!0),Array.isArray(u.options)&&u.options.forEach(f=>{let w=document.createElement("option");w.value=t(f.value),w.textContent=t(f.text),u.default_value===f.value&&(w.selected=!0),s.appendChild(w)}),g.appendChild(s);break;case"checkbox_group":case"radio_group":let m=document.createElement("fieldset");if(u.label){let f=document.createElement("legend");f.textContent=t(u.label),f.className="aipkit_chat_form_label_text",m.appendChild(f)}Array.isArray(u.options)&&u.options.forEach(f=>{let w=document.createElement("div");w.className=u.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let h=document.createElement("input");h.type=u.type==="checkbox_group"?"checkbox":"radio",h.id=`form-${t(e.form_id)}-${t(u.id)}-${t(f.value)}`,h.name=t(u.id)+(u.type==="checkbox_group"?"[]":""),h.value=t(f.value),(u.type==="checkbox_group"&&Array.isArray(u.default_value)&&u.default_value.includes(f.value)||u.type==="radio_group"&&u.default_value===f.value)&&(h.checked=!0);let y=document.createElement("label");y.setAttribute("for",h.id),y.textContent=t(f.text),w.appendChild(h),w.appendChild(y),m.appendChild(w)}),g.appendChild(m);break;case"heading":s=document.createElement(u.level||"h5"),s.className="aipkit_chat_form_element_heading",s.textContent=t(u.label||""),g.appendChild(s);break;case"label":s=document.createElement("p"),s.className="aipkit_chat_form_element_label_only",s.textContent=t(u.label||""),g.appendChild(s);break}if(u.help_text){let m=document.createElement("p");m.className="aipkit_form_help_text",m.textContent=t(u.help_text),g.appendChild(m)}p.appendChild(g)});let l=document.createElement("button");l.type="submit",l.className="aipkit_btn aipkit_chat_form_submit_btn",l.textContent=t(e.submit_button_text||"Submit"),p.appendChild(l),p.addEventListener("submit",u=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let g=n.closest(".aipkit_chat_container")||n.closest(".aipkit_popup_wrapper"),s=null,m=null;g&&window.aipkitChatInstances&&window.aipkitChatInstances[g.id]?(s=window.aipkitChatInstances[g.id].elements,m=window.aipkitChatInstances[g.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(s=window.aipkit_chat_ui_elements,m=window.aipkit_chat_ui_actions),s&&m?window.aipkit_chatUI_handleChatFormSubmission(u,i,s,m):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice("Error submitting form: Chat context not found.","error",{messagesEl:n,config:i},!0,7e3))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice("Error submitting form: Submission handler missing.","error",{messagesEl:n,config:i},!0,7e3)}),_.appendChild(p),c.appendChild(_),r.appendChild(c),n.appendChild(r),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_renderChatForm=d})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(d,n)=>{},onRecordingErrorCallback:d=>{}}})();(function(){"use strict";function d(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=d})();(function(){"use strict";function d(n,e,i){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof n=="function"?n:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof i=="function"?i:()=>{}}window.aipkit_setRecordingCallbacks=d})();(function(){"use strict";async function d(n={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});let i=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],a="";for(let o of i)if(MediaRecorder.isTypeSupported(o)){a=o;break}if(!a&&MediaRecorder.isTypeSupported(""))a="";else if(!a)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let t=a?{mimeType:a}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,t),e.currentMimeType=e.mediaRecorder.mimeType||a||"application/octet-stream",e.mediaRecorder.ondataavailable=o=>{o.data.size>0&&e.audioChunks.push(o.data)},e.mediaRecorder.onstop=()=>{if(e.audioChunks.length>0){let o=new Blob(e.audioChunks,{type:e.currentMimeType});e.onRecordingStopCallback&&e.onRecordingStopCallback(o,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null)}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(o=>o.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=o=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",o.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(o.error),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(i){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",i),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(i),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null)}}window.aipkit_startRecording=d})();(function(){"use strict";function d(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let n=window.aipkitSttState;n.mediaRecorder&&(n.mediaRecorder.state==="recording"||n.mediaRecorder.state==="paused")?n.mediaRecorder.stop():(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),n.audioStream&&(n.audioStream.getTracks().forEach(e=>e.stop()),n.audioStream=null))}window.aipkit_stopRecording=d})();(function(){"use strict";function d(n,e,i){let{elements:a,config:t,state:o,setButtonStateAction:r,sendMessageAction:c}=i,{inputField:_,voiceInputButton:p}=a,l=(s,m="error",f=!0,w=7e3)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(s,m,{elements:a,config:t},f,w)};if(!n||!e||!a||!t||!o||!r||!c){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",i),l(t.text?.voiceConfigError||"Failed to process audio: Configuration error."),p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let s=p.querySelector(".dashicons");s&&(s.style.display="")}return}if(p){p.disabled=!0,p.classList.add("aipkit_loading");let s=p.querySelector(".dashicons");s&&(s.style.display="none")}let u=(e||"").split(";")[0].split("/")[1]||"webm",g={audio_file:n,audio_format:u};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",g,t).then(s=>{if(s&&s.transcription)_.value=s.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(_),r("send",!0,o),c(s.transcription);else throw new Error("Invalid transcription response from server.")}).catch(s=>{console.error(`AIPKit STT UI (${t.botId}): Transcription AJAX error:`,s),l(`${t.text?.voiceTranscriptionFailedPrefix||"Transcription failed"}: ${s.message||"Unknown error"}`)}).finally(()=>{if(p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let s=p.querySelector(".dashicons");s&&(s.style.display="")}})}window.aipkit_chatUI_transcribeAudio=d})();(function(){"use strict";function d(n,e,i,a,t){let{inputField:o,voiceInputButton:r,actionButton:c,inputActionButton:_}=n,p=e.botId,l=(u,g="error",s=!0,m=7e3)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(u,g,{elements:n,config:e},s,m)};if(a&&typeof a.showConsentBoxIfNeeded=="function"&&a.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${p}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit Chat UI Main (${p}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),l(e.text?.voiceUnavailableScriptError||"Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){let u=window.location.protocol==="https:",g=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";l(!u&&!g?e.text?.voiceRequiresHttps||"Voice recording requires HTTPS connection for security. Please access this site using HTTPS or contact the administrator to enable SSL.":e.text?.voiceBrowserUnsupported||"Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}i.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{i.isRecording=!0,r.classList.add("aipkit_recording"),r.setAttribute("aria-label","Stop recording"),r.title="Stop recording",o.disabled=!0,c.disabled=!0,_&&(_.disabled=!0)},(u,g)=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,c.disabled=o.value.trim()==="",_&&(_.disabled=!1),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(u,g,{elements:n,config:e,state:i,setButtonStateAction:t.setButtonStateAction,sendMessageAction:t.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),l(e.text?.voiceProcessingError||"Error processing recorded audio."))},u=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,c.disabled=o.value.trim()==="",_&&(_.disabled=!1),console.error(`AIPKit STT (${p}): Recording error:`,u),l(`${e.text?.voiceRecordingFailedPrefix||"Recording failed"}: ${u.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=d})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function d(n){let e=window.aipkitImageUploadConstants;return e?n?e.ALLOWED_IMAGE_TYPES.includes(n.type)?n.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=d})();(function(){"use strict";function d(n){return new Promise((e,i)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t=>i(t),a.readAsDataURL(n)})}window.aipkit_convertFileToBase64=d})();(function(){"use strict";function d(n){let e;n&&n.parentNode&&(e=n.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(i=>i.remove())}window.aipkit_clearImageUploadError=d})();(function(){"use strict";function d(n,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let i=document.createElement("div");if(i.className="chat-image-upload-error",i.textContent=n,e&&e.parentNode)e.parentNode.insertBefore(i,e.nextSibling);else{let a=document.querySelector(".aipkit_chat_input");a?a.appendChild(i):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=d})();(function(){"use strict";function d(n,e){let i=window.aipkitImageUploadState;if(!i){console.error("Image Upload Reset: State object not found.");return}i.currentImageFile=null,i.currentImageBase64=null,n&&(n.hasChildNodes()?(n.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{n&&(n.innerHTML="",n.style.display="none",n.classList.remove("aipkit-image-preview-fade-out"))},300)):(n.innerHTML="",n.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(n||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=d})();(function(){"use strict";function d(n,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let i=document.createElement("div");i.className="chat-image-thumbnail-wrapper";let a=document.createElement("img");a.src=n,a.alt="Image preview",a.className="chat-image-thumbnail";let t=document.createElement("button");t.className="chat-image-remove-button",t.innerHTML="\xD7",t.setAttribute("aria-label","Remove image"),t.type="button",t.onclick=()=>{let o=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,o):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},i.appendChild(a),i.appendChild(t),e.appendChild(i)}window.aipkit_renderImagePreview=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadState;return n?n.currentImageFile&&n.currentImageBase64?{mime_type:n.currentImageFile.type,base64_data:n.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadConstants;return n?n.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadConstants;return n?n.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=d})();(function(){"use strict";function d(n,e){let i=window.aipkitImageUploadState,a=window.aipkitImageUploadConstants;if(!i||!a){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!n||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}n.setAttribute("accept",a.ALLOWED_IMAGE_EXTENSIONS.join(",")),n.dataset.aipkitUploadListenerAttached!=="true"&&(n.addEventListener("change",async t=>{window.aipkit_clearImageUploadError(e);let o=t.target.files[0];if(!o){window.aipkit_resetImageUpload(e,n);return}let r=window.aipkit_validateImage(o);if(!r.isValid){window.aipkit_displayImageUploadError(r.error,e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:r.error}}));return}try{let c=await window.aipkit_convertFileToBase64(o);i.currentImageBase64=c,i.currentImageFile=o,window.aipkit_renderImagePreview(i.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:i.currentImageBase64.split(",")[1],mime_type:i.currentImageFile.type}}))}catch(c){console.error("Error processing image:",c),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),n.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:d,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(n,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(n,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:20,MAX_FILE_SIZE_BYTES:20*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function d(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=d;function n(e,i){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&i&&window.aipkit_clearChatFileUploadStatus(i)}window.aipkit_resetChatFileUploadUI=n})();(function(){"use strict";function d(n){let e=window.aipkitFileUploadConstants;return e?n?e.ALLOWED_FILE_TYPES.includes(n.type)?n.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=d})();(function(){"use strict";function d(n){if(!n)return;let e=n.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=d})();(function(){"use strict";function d(n,e="info",i){if(!i)return;let a=i.querySelector(".aipkit_chat_file_upload_status");if(!a){a=document.createElement("div"),a.className="aipkit_chat_file_upload_status";let t=i.querySelector(".aipkit_chat_input_wrapper");t?i.insertBefore(a,t):i.appendChild(a)}if(a.textContent=n,a.className="aipkit_chat_file_upload_status",a.classList.add(`aipkit_status-${e}`),a.style.display="block",e==="error")try{let t=i.closest(".aipkit_chat_container");if(!t)return;let o=window.aipkitChatInstances&&t.id?window.aipkitChatInstances[t.id]:null,r=null,c=null;if(o&&o.internalElements&&o.internalElements.messagesEl&&o.internalActions){r=o.internalElements.messagesEl;let s=t.getAttribute("data-config");if(s)try{c=JSON.parse(s)}catch{}}else{r=t.querySelector(".aipkit_chat_messages");let s=t.getAttribute("data-config");if(s)try{c=JSON.parse(s)}catch{}}if(!r)return;c||(c={botId:t.dataset.botId||"default",text:{errorPrefix:"Error:"}});let _=c.text&&c.text.errorPrefix?c.text.errorPrefix:"Error:",p=String(n||"").trim(),u=p.toLowerCase().startsWith(_.toLowerCase())?p:`${_} ${p}`,g=typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_generateClientMessageId(c.botId):null;typeof window.aipkit_chatUI_appendMessage=="function"&&window.aipkit_chatUI_appendMessage(r,u,"bot",c,!0,!1,g,!0)}catch(t){console.error("AIPKit Chat File Upload: Failed to append error to chat window:",t)}}window.aipkit_displayChatFileUploadStatus=d})();(function(){"use strict";function d(){let n=window.aipkitFileUploadConstants;return n?n.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=d})();(function(){"use strict";function d(){let n=window.aipkitFileUploadConstants;return n?n.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=d})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let d=window.aipkit_escapeHtml||function(e){return e};async function n(e,i,a,t){let o=window.aipkitFileUploadState,r=window.aipkitFileUploadConstants;if(!o||!r)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",a),null;let c=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let l of c)if(typeof window[l]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${l}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",a),null;window.aipkit_clearChatFileUploadStatus(a);let _=window.aipkit_validateChatFile(e);if(!_.isValid)return window.aipkit_displayChatFileUploadStatus(_.error,"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;if(t.vectorStoreProvider==="claude_files"&&t.provider!=="Claude")return window.aipkit_displayChatFileUploadStatus('Claude Files requires the chatbot "Provider" to be Claude.',"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;o.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${d(o.currentFile.name)}"...`,"processing",a);let p=new FormData;p.append("action","aipkit_frontend_chat_upload_file"),p.append("file_to_upload",o.currentFile),p.append("bot_id",t.botId),p.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&p.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&p.append("post_id",window.aipkit_current_post_id),p.append("upload_provider",t.vectorStoreProvider),p.append("_ajax_nonce",t.nonce);try{let l=await fetch(t.ajaxUrl,{method:"POST",body:p,credentials:"same-origin"}),u=await l.json();if(!l.ok||!u.success){let g=u.data?.message||u.message||"File upload failed on server.";throw new Error(g)}if(u.data&&u.data.file_context){let g=u.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(g))}catch(m){console.error("AIPKit File Upload: Error saving file context to localStorage:",m)}window.aipkit_active_file_context_provider=g.provider,window.aipkit_active_file_context_data=g,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let s=(t.text?.fileContextActive||"Chatting with: %s").replace("%s",d(o.currentFile.name));return window.aipkit_displayChatFileUploadStatus(s,"success",a),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(l){return console.error("File Upload Processing Error:",l),window.aipkit_displayChatFileUploadStatus(`Error: ${l.message||"Upload failed."}`,"error",a),window.aipkit_resetChatFileUploadUI(i,a),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:n,resetUI:function(e,i){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,i)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function d(n,e,i,a,t=!1){let{inputField:o,actionButton:r,sendIcon:c,clearIcon:_,spinner:p,voiceInputButton:l,inputActionButton:u,webSearchToggleButton:g,googleSearchGroundingToggleButton:s}=e,m=i.text||{},f=(h,y)=>{!h||typeof h.setAttribute!="function"||typeof h.removeAttribute!="function"||(y?h.setAttribute("hidden","hidden"):h.removeAttribute("hidden"))};if(!r||!c||!_||!p||!o)return console.error("AIPKit SetButtonState: Missing required elements."),null;f(p,!0),f(c,!0),f(_,!0),r.disabled=!1,r.classList.remove("aipkit_btn-clear-state");let w=n;switch(n){case"sending":case"streaming":o.disabled=!0,r.disabled=!0,l&&(l.disabled=!0),u&&(u.disabled=!0),g&&(g.disabled=!0),s&&(s.disabled=!0),f(p,!1);let h=n==="streaming"?m.streaming||"Streaming...":m.sending||"Sending...";r.setAttribute("aria-label",h),r.setAttribute("title",h);break;case"clear":o.disabled=i.requireConsentCompliance&&!a.consentGiven,f(_,!1),r.classList.add("aipkit_btn-clear-state"),r.setAttribute("aria-label",m.clearChat||"Clear Chat"),r.setAttribute("title",m.clearChat||"Clear Chat"),r.disabled=!1,l&&(l.disabled=i.requireConsentCompliance&&!a.consentGiven),u&&(u.disabled=i.requireConsentCompliance&&!a.consentGiven),g&&(g.disabled=i.requireConsentCompliance&&!a.consentGiven),s&&(s.disabled=i.requireConsentCompliance&&!a.consentGiven);break;case"send":default:w="send",o.disabled=i.requireConsentCompliance&&!a.consentGiven,f(c,!1),r.setAttribute("aria-label",m.sendMessage||"Send Message"),r.setAttribute("title",m.sendMessage||"Send Message"),r.disabled=!t&&o.value.trim()==="",i.requireConsentCompliance&&!a.consentGiven&&(r.disabled=!0),l&&(l.disabled=i.requireConsentCompliance&&!a.consentGiven),u&&(u.disabled=i.requireConsentCompliance&&!a.consentGiven),g&&(g.disabled=i.requireConsentCompliance&&!a.consentGiven),s&&(s.disabled=i.requireConsentCompliance&&!a.consentGiven);break}return w}window.aipkit_chatUI_setButtonStateAction=d})();(function(){"use strict";function d(n,e,i){if(!n)return;let a=n.closest("#aipkit_admin_chat_preview_container"),t=window.innerWidth<=760;e.requireConsentCompliance&&!i.consentGiven||e.popupEnabled&&!i.isPopupOpen||((a||!t||i.userInitiatedAction)&&setTimeout(()=>{n&&typeof n.focus=="function"&&n.focus()},50),i.userInitiatedAction&&(i.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=d})();(function(){"use strict";function d(n,e,i,a,t,o){let{inputField:r,messagesEl:c,container:_,voiceInputButton:p,inputActionButton:l,webSearchToggleButton:u,googleSearchGroundingToggleButton:g}=i;t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,r.disabled=a.requireConsentCompliance&&!t.consentGiven,p&&(p.disabled=a.requireConsentCompliance&&!t.consentGiven),l&&(l.disabled=a.requireConsentCompliance&&!t.consentGiven),u&&a.allowWebSearchTool&&(a.provider==="OpenAI"||a.provider==="Claude"||a.provider==="OpenRouter")&&(u.disabled=a.requireConsentCompliance&&!t.consentGiven),g&&a.allowGoogleSearchGrounding&&a.provider==="Google"&&(g.disabled=a.requireConsentCompliance&&!t.consentGiven);let s=r.value.trim()==="",m=c.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;t.buttonState=o.setButtonStateAction(s&&m?"clear":"send",!1,t),o.focusInputAction(),_.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:n,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),a.ttsEnabled&&a.ttsAutoPlay&&n&&setTimeout(()=>{let w=c.querySelector(`#${CSS.escape(n)}`)?.querySelector(".aipkit_play_btn");w&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(w):a.ttsEnabled&&a.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${a.botId}): Could not find play button for message ${n} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=d})();(function(){"use strict";function d(n,e,i=!0,a,t,o,r){let{messagesEl:c,inputField:_,container:p,voiceInputButton:l,inputActionButton:u,webSearchToggleButton:g,googleSearchGroundingToggleButton:s}=a,m=t.botId;o.isSending=!1,o.currentStreamId=null,o.currentStreamMessageId=null;let f=window.aipkit_generateClientMessageId(m);window.aipkit_chatUI_appendMessage(c,n,"bot",t,!0,!1,f,i),window.aipkit_chatUI_removeTypingIndicator(c),_.disabled=t.requireConsentCompliance&&!o.consentGiven,l&&(l.disabled=t.requireConsentCompliance&&!o.consentGiven),u&&(u.disabled=t.requireConsentCompliance&&!o.consentGiven),g&&t.allowWebSearchTool&&(t.provider==="OpenAI"||t.provider==="Claude"||t.provider==="OpenRouter")&&(g.disabled=t.requireConsentCompliance&&!o.consentGiven),s&&t.allowGoogleSearchGrounding&&t.provider==="Google"&&(s.disabled=t.requireConsentCompliance&&!o.consentGiven),o.buttonState=r.setButtonStateAction("send",!1,o),r.focusInputAction(),p.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:f,error:n}}))}window.aipkit_chatUI_handleError=d})();(function(){"use strict";function d(n){if(!n)return;n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(i=>{try{n.removeChild(i)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",a)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_clearMessages=d})();(function(){"use strict";function d(n,e,i,a){let{messagesEl:t,inputField:o,imagePreviewContainer:r,imageUploadInput:c,fileUploadInput:_,inputArea:p}=n;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(t),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(t);let l=t.querySelector(".aipkit_initial_greeting");if(!l&&typeof window.aipkit_chatUI_appendMessage=="function"){let s=(e?.text?.initialGreeting||"Hello there!").trim(),m=(e?.text?.initialSubgreeting||"").trim(),f=s;m&&(f=s?`${s}

${m}`:m),typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t,f,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else l||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");o&&(o.value="",o.disabled=e.requireConsentCompliance&&!i.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?n.imagePreviewContainer&&n.imageUploadInput?window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?n.fileUploadInput&&n.inputArea?window.aipkitChatFileUpload.resetUI(n.fileUploadInput,n.inputArea):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof a.setButtonStateAction=="function"?i.buttonState=a.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided.");let u=e.webToggleDefaultOn===!0;typeof window.aipkit_syncWebSearchToggleState=="function"&&window.aipkit_syncWebSearchToggleState(n,e,i,u),typeof window.aipkit_syncGoogleSearchGroundingToggleState=="function"&&window.aipkit_syncGoogleSearchGroundingToggleState(n,e,i,u),i.isSending=!1,i.currentStreamId=null,i.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof a.focusInputAction=="function"&&(!e.requireConsentCompliance||i.consentGiven)?a.focusInputAction():typeof a.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let g=t.closest(".aipkit_chat_container")||t.closest(".aipkit_popup_wrapper");g&&g.dispatchEvent(new CustomEvent("aipkit:chatCleared"))}window.aipkit_chatUI_clearChatAction=d})();(function(){"use strict";async function d(n,e,i,a,t=null){let{inputField:o,messagesEl:r,container:c,inputArea:_}=n,p=e.botId,l=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let b=!1,v=window.aipkit_active_file_context_data;(v.provider==="OpenAI"&&v.vector_store_id||v.provider==="Pinecone"&&v.index_name&&v.namespace||v.provider==="Qdrant"&&v.collection_name&&v.file_upload_context_id||v.provider==="Claude"&&v.file_id)&&(b=!0),b?l={...v}:(console.warn(`SendMessageAction (${p}): File context data found on window object, but missing required fields for provider: ${v.provider||"unknown"}. Context ignored. Data:`,v),l=null)}let u=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(u=window.chatImageUpload.getImageData(),u&&n.imagePreviewContainer&&n.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&n.fileUploadInput&&_){let b=window.aipkitFileUploadState;(l||b&&b.currentFile)&&window.aipkitChatFileUpload.resetUI(n.fileUploadInput,_)}let g=i.consentUIInstance;if(g&&typeof g.showConsentBoxIfNeeded=="function"&&g.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${p}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit SendMessage (${p}): Consent required but not given.`);return}let s=t!==null?t.trim():o.value.trim();if(i.isSending||!s&&!u&&!l||t===null&&(i.buttonState!=="send"||n.actionButton.disabled))return;let m=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(l={...window.aipkit_active_file_context_data}))),m=!0);let f=window.aipkit_generateClientMessageId(p),w=s;u&&(w={text:s,user_image:u}),window.aipkit_chatUI_appendMessage(r,w,"user",e,!1,!1,f,!0),t===null&&(o.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),m&&(window.aipkit_is_fresh_session=!1);let h=(e.imageTriggers||"/image").toLowerCase().split(",").map(b=>b.trim()).filter(b=>b.length>0&&b.startsWith("/")),y=s.toLowerCase(),I=null;for(let b of h)if(y.startsWith(b+" ")||y===b){I=b;break}if(I){let b=s.substring(I.length).trim();if(!b&&y!==I){let v=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",I);a.handleError(v,!1,!0),t===null&&(i.buttonState=a.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(b,s,f,m,{state:i,elements:n,config:e,...a}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),a.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let b=window.aipkit_checkMessageModeration(s,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(b){let v=window.aipkit_generateClientMessageId(p);window.aipkit_chatUI_appendMessage(r,b.message,"bot",e,!0,!1,v),i.buttonState=a.setButtonStateAction("send",!1),a.focusInputAction(),c.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:v,reason:b.type,content:s,...b.word&&{word:b.word},...b.ip&&{ip:b.ip}}}));return}}if(i.isSending=!0,o.disabled=!0,n.voiceInputButton&&(n.voiceInputButton.disabled=!0),n.inputActionButton&&(n.inputActionButton.disabled=!0),n.webSearchToggleButton&&(n.webSearchToggleButton.disabled=!0),n.googleSearchGroundingToggleButton&&(n.googleSearchGroundingToggleButton.disabled=!0),i.buttonState=a.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),c.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:f}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_streamMessage(s,p,e,r,a.handleError,()=>a.handleCompletion(i.currentStreamMessageId,m),i.webSearchToolActive,i.googleSearchGroundingActive,u,l,f);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_sendMessage(s,p,e,n,(b,v,U,x)=>{window.aipkit_chatUI_removeTypingIndicator(r),window.aipkit_chatUI_appendMessage(r,b,"bot",e,!1,!1,v,!0,x),a.handleCompletion(v,m)},a.handleError,()=>{},i.webSearchToolActive,i.googleSearchGroundingActive,u,l,f);else{let b=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${p}): Required send function not available.`),a.handleError(b,!1)}}window.aipkit_chatUI_sendMessageAction=d})();(function(){"use strict";let d=new Set(["primary_color","secondary_color","auto_text_contrast","accent_color","app_bg_color","surface_color","text_color","border_color"]),n=new Set(["font_family","bubble_border_radius","container_border_radius"]),e=new Set(["container_max_width","popup_width","container_height","container_min_height","container_max_height","popup_height","popup_min_height","popup_max_height"]),i=new Set([...d,...n,...e]);function a(w,h,y){return Number.isNaN(w)?h:Math.min(Math.max(w,h),y)}function t(w){if(!w||typeof w!="string")return null;let h=w.trim().toLowerCase();if(h==="transparent")return{r:0,g:0,b:0,a:0};if(h[0]==="#"){let F=h.slice(1);if(F.length===3&&(F=F.split("").map(S=>S+S).join("")),F.length!==6)return null;let k=parseInt(F,16);return Number.isNaN(k)?null:{r:k>>16&255,g:k>>8&255,b:k&255,a:1}}let y=h.match(/^rgba?\((.+)\)$/);if(!y)return null;let I=y[1].split(",").map(F=>F.trim());if(I.length<3)return null;let b=F=>{if(F.endsWith("%")){let S=parseFloat(F);return Number.isNaN(S)?null:a(Math.round(255*S/100),0,255)}let k=parseFloat(F);return Number.isNaN(k)?null:a(Math.round(k),0,255)},v=b(I[0]),U=b(I[1]),x=b(I[2]);if(v===null||U===null||x===null)return null;let M=1;if(I[3]!==void 0){let F=parseFloat(I[3]);Number.isNaN(F)||(M=a(F,0,1))}return{r:v,g:U,b:x,a:M}}function o(w){if(!w)return"";if(typeof w=="string")return w;let h=a(Math.round(w.r),0,255),y=a(Math.round(w.g),0,255),I=a(Math.round(w.b),0,255),b=w.a===void 0?1:a(w.a,0,1);if(b>=1)return`rgb(${h}, ${y}, ${I})`;let v=Math.round(b*1e3)/1e3;return`rgba(${h}, ${y}, ${I}, ${v})`}function r(w,h,y){let I=a(y,0,1);return{r:w.r*(1-I)+h.r*I,g:w.g*(1-I)+h.g*I,b:w.b*(1-I)+h.b*I,a:1}}function c(w,h){return{r:w.r,g:w.g,b:w.b,a:a(h,0,1)}}function _(w,h){if(!w||!h)return!1;let y=w.a===void 0?1:w.a,I=h.a===void 0?1:h.a;return Math.round(w.r)===Math.round(h.r)&&Math.round(w.g)===Math.round(h.g)&&Math.round(w.b)===Math.round(h.b)&&Math.abs(y-I)<.01}function p(w){let h=w/255;return h<=.03928?h/12.92:Math.pow((h+.055)/1.055,2.4)}function l(w){return .2126*p(w.r)+.7152*p(w.g)+.0722*p(w.b)}function u(w,h){let y=l(w),I=l(h),b=Math.max(y,I),v=Math.min(y,I);return(b+.05)/(v+.05)}function g(w,h,y){let I=u(w,h),b=u(w,y);return I>=b?h:y}function s(w){let h={primary:"#0F766E",secondary:"#ECFEFF",legacyAccent:"#111111",legacyAppBg:"#FFFFFF",legacySurface:"#FFFFFF",legacyText:"#111111",legacyBorder:"#E5E5E5",botBubble:"#F3F3F3"},y={primary:t(h.primary),secondary:t(h.secondary),legacyAccent:t(h.legacyAccent),legacyAppBg:t(h.legacyAppBg),legacySurface:t(h.legacySurface),legacyText:t(h.legacyText),legacyBorder:t(h.legacyBorder),botBubble:t(h.botBubble)},I=t(w.primary_color),b=t(w.secondary_color),v=t(w.accent_color),U=t(w.app_bg_color),x=t(w.surface_color),M=v&&!_(v,y.legacyAccent),F=x&&!_(x,y.legacySurface)||U&&!_(U,y.legacyAppBg),k=null;I&&(!_(I,y.primary)||!M)?k=I:M?k=v:I?k=I:k=y.primary;let S=null;b&&(!_(b,y.secondary)||!F)?S=b:x&&!_(x,y.legacySurface)?S=x:U&&!_(U,y.legacyAppBg)?S=U:b?S=b:S=y.secondary;let A=w.auto_text_contrast!=="0",C={r:255,g:255,b:255,a:1},E={r:17,g:17,b:17,a:1},T=t(w.text_color),q=T&&!_(T,y.legacyText),L=!A&&q?T:g(S,C,E),H=l(S)<.5,O=S,D=r(O,L,H?.12:.06),B=t(w.border_color),$=B&&!_(B,y.legacyBorder)?B:r(O,L,H?.22:.12),K=r(L,O,H?.35:.18),G=r(L,O,H?.5:.35),Q=t(w.bot_bubble_bg_color)||r(D,L,H?.18:.08),P=t(w.user_bubble_bg_color)||k,N=A?g(k,C,E):L,V=A&&u(k,D)>=3?k:L,z=A?g(Q,C,E):L,X=A?g(P,C,E):L,J=r(O,L,H?.18:.08),te=r(O,k,H?.22:.12),Y=r(O,L,H?.12:.04),j=r(L,O,H?.3:.12),ee=A?g(te,C,E):L,ie=O,ne=J,ae=A?g(ie,C,E):L,ce=A?g(ne,C,E):L,le=l(k)<.5,oe=r(k,le?C:E,.12),de=k,re=c(k,.2),se=r(O,k,H?.2:.12),pe=c(N,.3);return{container_bg_color:o(D),container_text_color:o(L),container_border_color:o($),border_color:o($),bg_color_secondary:o(O),bg_color_hover:o(J),text_color_link:o(j),primary_color_dark:o(L),header_bg_color:o(O),header_text_color:o(K),header_border_color:o($),messages_bg_color:o(D),messages_scrollbar_thumb_color:o($),messages_scrollbar_track_color:"transparent",greeting_text_color:o(V),bot_bubble_bg_color:o(Q),bot_bubble_text_color:o(z),user_bubble_bg_color:o(P),user_bubble_text_color:o(X),subgreeting_text_color:o(K),input_area_bg_color:o(D),input_area_border_color:o($),input_wrapper_bg_color:o(O),input_wrapper_border_color:o($),input_text_color:o(L),input_placeholder_color:o(G),input_focus_border_color:o(k),input_focus_shadow_color:o(re),send_button_bg_color:o(k),send_button_text_color:o(N),send_button_border_color:o(k),send_button_hover_bg_color:o(oe),send_button_hover_border_color:o(oe),send_button_disabled_bg_color:o(se),send_button_disabled_border_color:o(se),send_button_spinner_base_color:o(pe),send_button_spinner_accent_color:o(N),popup_trigger_bg_color:o(k),popup_trigger_hover_bg_color:o(oe),popup_trigger_icon_color:o(N),action_button_bg_color:o(O),action_button_color:o(K),action_button_border_color:o($),action_button_hover_bg_color:o(J),action_button_hover_color:o(L),action_button_hover_border_color:o(de),mic_hover_bg_color:o(J),footer_bg_color:o(O),footer_text_color:o(K),footer_border_color:o($),sidebar_bg_color:o(Y),sidebar_text_color:o(j),sidebar_border_color:o($),sidebar_active_bg_color:o(te),sidebar_active_text_color:o(ee),sidebar_hover_bg_color:o(J),sidebar_hover_text_color:o(L),action_menu_bg_color:o(O),action_menu_border_color:o($),action_menu_item_text_color:o(L),action_menu_item_hover_bg_color:o(J),action_menu_item_hover_text_color:o(L),starter_bg_color:o(ie),starter_text_color:o(ae),starter_border_color:o($),starter_hover_bg_color:o(ne),starter_hover_text_color:o(ce),pdf_icon_color:o(k),image_icon_color:o(K),consent_overlay_bg_color:o(c(D,.95)),consent_overlay_border_color:o($),consent_title_color:o(L),consent_message_color:o(K),consent_button_bg_color:o(k),consent_button_text_color:o(N),form_title_color:o(L),form_label_color:o(L),form_help_text_color:o(K),form_input_bg:o(O),form_input_text:o(L),form_input_border:o($),form_input_focus_border:o(k),form_input_focus_shadow:o(re),form_submit_button_bg:o(k),form_submit_button_text:o(N),form_submit_button_hover_bg:o(oe)}}function m(w,h={}){let y=s(w),I=Object.assign({},y),b=!!h.skipDimensionSync;return n.forEach(v=>{let U=w[v];U!==""&&U!==null&&U!==void 0&&(I[v]=U)}),b||e.forEach(v=>{let U=w[v];U!==""&&U!==null&&U!==void 0&&(I[v]=U)}),b||(I.container_height!==""&&I.container_height!==null&&I.container_height!==void 0&&(I.popup_height=I.container_height),I.container_min_height!==""&&I.container_min_height!==null&&I.container_min_height!==void 0&&(I.popup_min_height=I.container_min_height),I.container_max_height!==""&&I.container_max_height!==null&&I.container_max_height!==void 0&&(I.popup_max_height=I.container_max_height)),I}function f(w,h,y={}){if(!w||typeof h!="object"||Object.keys(h).length===0)return;let I=m(h,y),b=U=>{if(U)for(let x in I){if(!Object.prototype.hasOwnProperty.call(I,x)||I[x]===""||I[x]===null)continue;let M=`--aipkit-chat-${x.replace(/_/g,"-")}`,F=I[x];x==="container_max_height"||x==="popup_max_height"?F=I[x]+"vh":x==="container_max_width"||x==="popup_width"||x==="container_height"||x==="container_min_height"||x==="popup_height"||x==="popup_min_height"?F=I[x]+"px":(x==="bubble_border_radius"||x==="container_border_radius")&&typeof F=="number"?F=F===0?"0":`${F}px`:(x==="bubble_border_radius"||x==="container_border_radius")&&typeof F=="string"&&/^\d+$/.test(F)&&(F=F==="0"?"0":`${F}px`),U.style.setProperty(M,F)}};b(w);let v=w.closest(".aipkit_popup_wrapper");v&&b(v)}window.aipkit_chatUI_applyCustomThemeStyles=f})();(function(){"use strict";function d(n){let i=`aipkit_chatbot_consent_given_${n.botId||"default"}`,a=localStorage.getItem(i)==="true",t=n.webToggleDefaultOn===!0,o=n.allowWebSearchTool&&(n.provider==="OpenAI"||n.provider==="Claude"||n.provider==="OpenRouter"),r=n.allowGoogleSearchGrounding&&n.provider==="Google";return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:a,isRecording:!1,webSearchToolActive:t&&o,googleSearchGroundingActive:t&&r}}window.aipkit_chatUI_initState=d})();(function(){"use strict";function d(n,e){if(!n||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let i=e.botId||"default";if(n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{n.removeChild(t)}catch{}}),!n.querySelector(".aipkit_initial_greeting")){let t=(e.text.initialGreeting||"Hello there!").trim(),o=(e.text.initialSubgreeting||"").trim(),r=t;if(o&&(r=t?`${t}

${o}`:o),typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(n,r,"bot",e,!1,!0,window.aipkit_generateClientMessageId(i));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let c=document.createElement("div");c.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",c.innerHTML=`<div class="aipkit_chat_bubble">${r.replace(/\n/g,"<br>")}</div>`,n.appendChild(c),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(c)}}}window.aipkit_chatUI_displayInitialMessage=d})();(function(){"use strict";function d(n,e,i,a){let{inputField:t,messagesEl:o,container:r}=n,c=e.botId,_=e.webToggleDefaultOn===!0;i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),t.disabled=e.requireConsentCompliance&&!i.consentGiven,n.voiceInputButton&&(n.voiceInputButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.inputActionButton&&(n.inputActionButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.webSearchToggleButton&&e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&(n.webSearchToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(n.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),typeof window.aipkit_syncWebSearchToggleState=="function"&&window.aipkit_syncWebSearchToggleState(n,e,i,_),typeof window.aipkit_syncGoogleSearchGroundingToggleState=="function"&&window.aipkit_syncGoogleSearchGroundingToggleState(n,e,i,_),r.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:c}}))}window.aipkit_chatUI_finalizeSetup=d})();(function(){"use strict";function d(e,i,a){if(!e||!i)return;let t=!!a;e.classList.toggle("aipkit-popup-open",t),e.setAttribute("aria-hidden",t?"false":"true"),i.isPopupOpen=t;let o=e.closest(".aipkit_popup_wrapper");if(!o)return;o.classList.toggle("aipkit-popup-open",t);let r=o.querySelector(".aipkit_popup_trigger");if(!r)return;r.setAttribute("aria-expanded",t?"true":"false");let c=r.getAttribute("data-label-open")||"Open Chat",_=r.getAttribute("data-label-close")||"Close Chat",p=t?_:c;r.setAttribute("aria-label",p),r.setAttribute("title",p);let l=r.querySelector(".aipkit_popup_icon--open"),u=r.querySelector(".aipkit_popup_icon--close");l&&l.setAttribute("aria-hidden",t?"true":"false"),u&&u.setAttribute("aria-hidden",t?"false":"true")}function n(e,i,a,t){if(!e||!a||!t||t.isPopupOpen)return;try{e._aipkitHint&&(typeof e._aipkitHint.handlePopupOpen=="function"?e._aipkitHint.handlePopupOpen():typeof e._aipkitHint.hideHint=="function"&&e._aipkitHint.hideHint())}catch{}d(e,t,!0),typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(i):console.error("AIPKit Popup Open: scrollToBottom function not found.");let o=e.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=768)||o)&&setTimeout(()=>{a&&typeof a.focus=="function"&&a.focus()},50)}window.aipkit_chatUI_setPopupLauncherState=d,window.aipkit_chatUI_openPopup=n})();(function(){"use strict";function d(n,e){if(!n||!e||!e.isPopupOpen)return;if(typeof window.aipkit_chatUI_setPopupLauncherState=="function"){window.aipkit_chatUI_setPopupLauncherState(n,e,!1);return}n.classList.remove("aipkit-popup-open"),n.setAttribute("aria-hidden","true"),e.isPopupOpen=!1;let i=n.closest(".aipkit_popup_wrapper");i&&i.classList.remove("aipkit-popup-open")}window.aipkit_chatUI_closePopup=d})();(function(){"use strict";function d(n,e,i,a,t,o){if(!n||!e||!t||!o){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, stateRef, or config).");return}let r=!!n.closest("#aipkit_admin_chat_preview_container");try{let p=n.closest(".aipkit_popup_wrapper"),l=p?p.querySelector(".aipkit_popup_hint"):null,u=768,g=()=>window.innerWidth<=u,s=o.popupLabelVersion&&String(o.popupLabelVersion).trim()||"v1",m=`aipkit_popup_hint_seen_${o.botId}_${s}`,f=`aipkit_popup_hint_dismissed_${o.botId}_${s}`,h=["always","once_per_session","once_per_visitor"].includes(o.popupLabelFrequency)?o.popupLabelFrequency:"once_per_visitor",y=r?"always":h,b=["always","on_delay","until_open","until_dismissed"].includes(o.popupLabelMode)?o.popupLabelMode:"on_delay",v=(o.popupLabelDelaySeconds>0?o.popupLabelDelaySeconds:0)*1e3,U=(o.popupLabelAutoHideSeconds>0?o.popupLabelAutoHideSeconds:0)*1e3,x=!!o.popupLabelDismissible,M=y==="always"?null:y==="once_per_session"?window.sessionStorage:window.localStorage,F=P=>{if(!M)return null;try{return M.getItem(P)}catch{return null}},k=(P,N)=>{if(M)try{M.setItem(P,N)}catch{}},S=!1,A=!1,C=()=>S||F(m)==="1",E=()=>A||F(f)==="1",T=()=>b==="until_dismissed"?!E():b==="until_open"?!C():y==="always"?!0:!C(),q=()=>{S=!0,k(m,"1")},L=()=>{A=!0,k(f,"1")},H=null,O=null,D=()=>{H&&(clearTimeout(H),H=null)},B=()=>{O&&(clearTimeout(O),O=null)},R=()=>{l&&(l.removeAttribute("hidden"),l.classList.add("aipkit-visible"),l.setAttribute("aria-hidden","false"),(b==="on_delay"||b==="always")&&q(),U>0&&(B(),O=setTimeout($,U)))},$=()=>{l&&(l.classList.remove("aipkit-visible"),l.setAttribute("aria-hidden","true"),l.setAttribute("hidden",""),B())},K=()=>{let P=g();return!(P&&!o.popupLabelShowOnMobile||!P&&!o.popupLabelShowOnDesktop)},G=()=>{if(!l||!o.popupLabelEnabled||!o.popupLabelText||t.isPopupOpen||!K()||!T())return;D();let P=b==="always"?0:v;if(P<=0){R();return}H=setTimeout(R,P)},W=()=>{D(),$(),b==="until_open"&&q()},Q=()=>{G()},Z=()=>{D(),$(),b==="until_dismissed"?L():y!=="always"&&q()};if(l&&x){let P=l.querySelector(".aipkit_popup_hint_close");P&&P.addEventListener("click",N=>{N.stopPropagation(),Z()})}if(l)try{let P=window.getComputedStyle(n),N=n.querySelector(".aipkit_chat_header"),V=N?window.getComputedStyle(N):null,z="",X="";if(V){let j=V.getPropertyValue("background-color").trim(),ee=V.getPropertyValue("color").trim();j&&(z=j),ee&&(X=ee)}z||(z=P.getPropertyValue("--aipkit-chat-header-bg-color").trim()),z||(z=P.getPropertyValue("--aipkit_brand-primary").trim()),z||(z="#4a6fa5"),X||(X=P.getPropertyValue("--aipkit-chat-header-text-color").trim()),X||(X="#ffffff");let J=p||n;z&&J.style.setProperty("--aipkit-chat-popup-hint-bg",z);let te=P.getPropertyValue("--aipkit-chat-bot-bubble-text-color").trim(),Y="";if(te)Y=te;else if(X)Y=X;else if(z){let j=z.match(/rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);if(j){let ee=parseInt(j[1],10),ie=parseInt(j[2],10),ne=parseInt(j[3],10);Y=(ee*299+ie*587+ne*114)/1e3>200?"#2d3748":"#ffffff"}else Y="#2d3748"}else Y="#2d3748";Y&&J.style.setProperty("--aipkit-chat-popup-hint-text-color",Y)}catch{}$(),G(),n._aipkitHint={scheduleShow:G,hideHint:$,markSeen:q,markDismissed:L,handlePopupOpen:W,handlePopupClose:Q,dismissHintFromUser:Z,isDismissible:x,isVisible:()=>!!(l&&l.classList.contains("aipkit-visible"))}}catch(p){console.warn("AIPKit Popup Hint: setup error",p)}if(typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}typeof window.aipkit_chatUI_setPopupLauncherState=="function"&&window.aipkit_chatUI_setPopupLauncherState(n,t,!!t.isPopupOpen);let c=(p=!1)=>{window.aipkit_chatUI_closePopup(n,t),p&&typeof e.focus=="function"?e.focus():typeof e.blur=="function"&&e.blur(),n._aipkitHint&&typeof n._aipkitHint.handlePopupClose=="function"&&n._aipkitHint.handlePopupClose()};document.addEventListener("keydown",p=>{if(p.key==="Escape"){if(t.isPopupOpen){c(!0);return}!n._aipkitHint||!n._aipkitHint.isDismissible||n._aipkitHint.isVisible?.()&&(n._aipkitHint.dismissHintFromUser?.(),typeof e.focus=="function"&&e.focus())}});let _=n.querySelector(".aipkit_popup_close_btn");_&&_.addEventListener("click",p=>{p.stopPropagation(),t.isPopupOpen&&c()}),!o.directVoiceMode&&(e.addEventListener("click",p=>{p.stopPropagation(),t.isPopupOpen?c(!1):window.aipkit_chatUI_openPopup(n,i,a,t)}),document.addEventListener("click",p=>{t.isPopupOpen&&(r||n.contains(p.target)||e.contains(p.target)||c(!1))},!0))}window.aipkit_chatUI_setupPopupHandlers=d})();(function(){"use strict";function d(n,e){let i=new Date,a=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`;return`chat-${n.botId||"transcript"}-${a}.${e}`}window.aipkit_chatUI_generateDownloadFilename=d})();(function(){"use strict";function d(n,e){let i=document.createElement("a");if(typeof i.download=="string")i.href=URL.createObjectURL(n),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let a=URL.createObjectURL(n);window.open(a,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=d})();(function(){"use strict";function d(n,e){let{messagesEl:i}=n,a=(u,g="info",s=!0,m=4500)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(u,g,{elements:n,config:e,messagesEl:i},s,m)};if(!i||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let t="",o=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",c=e.text.userPrefix||"User",_=e.text.errorPrefix||"Error";if(o.forEach(u=>{let g=u.querySelector(".aipkit_chat_bubble");if(!g)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),t+=`Error: Could not extract text.
`;return}let s=window.aipkit_chatUI_extractTextFromBubble(g),m="";u.classList.contains("aipkit_chat_message-user")?m=`[${c}]:`:u.classList.contains("aipkit_chat_message-bot")?m=`[${r}]:`:u.classList.contains("aipkit_chat_message-error")&&(m=`[${_}]:`),m&&s&&(t+=`${m}
${s}

`)}),t=t.trim(),!t){console.warn("AIPKit Chat Download TXT: No transcript content found."),a(e.text.downloadEmpty||"Nothing to download.","info",!0);return}let p=new Blob([t],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),a(e.text?.downloadPrepareError||"Error: Could not prepare download.","error",!0,7e3);return}let l=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(p,l)}window.aipkit_chatUI_downloadTranscriptActionTxt=d})();(function(){"use strict";let d="aipkit_sidebar_state_";function n(e){return`${d}${e||"default"}`}window.aipkit_sidebar_getStorageKey=n})();(function(){"use strict";function d(n,e){if(!e||!n)return;let i=n.querySelector(".aipkit_chat_footer");if(!i){e.style.display="none";return}if(window.getComputedStyle(i).display!=="none"&&window.getComputedStyle(i).visibility!=="hidden"&&i.offsetHeight>0){let t=i.offsetHeight;t>0&&(e.style.height=`${t}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=d})();(function(){"use strict";function n(i,a){let t=i?i.closest(".aipkit_chat_container"):null;if(!t||t.closest("#aipkit_admin_chat_preview_container"))return null;let o=t.querySelector(".aipkit_sidebar_mobile_overlay");return o?o.setAttribute("aria-label",a):(o=document.createElement("button"),o.type="button",o.className="aipkit_sidebar_mobile_overlay",o.setAttribute("aria-label",a),o.setAttribute("aria-hidden","true"),o.tabIndex=-1,t.appendChild(o)),o}function e(i,a,t,o,r,c){if(!r)return;let _=c?.text?.sidebarOverlayClose||"Close conversation sidebar",p=window.innerWidth<=768,l=a?a.closest(".aipkit_chat_container"):null,u=p?n(a,_):l?l.querySelector(".aipkit_sidebar_mobile_overlay"):null;r.mobileOverlayHandler&&r.mobileOverlayTargetEl&&r.mobileOverlayTargetEl.removeEventListener("click",r.mobileOverlayHandler),u&&(u.classList.remove("aipkit-is-active"),u.setAttribute("aria-hidden","true")),r&&(r.mobileOverlayHandler=null,r.mobileOverlayTargetEl=null),i&&p&&u&&(r.mobileOverlayHandler=o,r.mobileOverlayTargetEl=u,u.classList.add("aipkit-is-active"),u.setAttribute("aria-hidden","false"),u.addEventListener("click",r.mobileOverlayHandler))}window.aipkit_sidebar_manageMobileOverlayListener=e})();(function(){"use strict";function d(n,e,i,a,t,o,r,c,_,p,l){!e||!i||(e.classList.toggle("aipkit-sidebar-state-open",n),e.classList.toggle("aipkit-sidebar-state-closed",!n),i.setAttribute("aria-expanded",n.toString()),r&&r.setAttribute("aria-hidden",(!n).toString()),localStorage.setItem(a,n?"open":"closed"),typeof t=="function"&&r&&t(e,r.querySelector(".aipkit_sidebar_footer")),typeof o=="function"&&r&&o(n,r,i,_,c,l))}window.aipkit_sidebar_applyCurrentState=d})();(function(){"use strict";function d(n,e,i){let a=n.isSidebarOpen;n.isSidebarOpen=!n.isSidebarOpen,!a&&n.isSidebarOpen&&typeof i=="function"&&i()}window.aipkit_sidebar_toggleSidebar=d})();(function(){"use strict";function n(e,i,a,t){let o=e.config?.botId||"unknown";if(typeof e.clearChatAction=="function"){e.clearChatAction();let r=i?i.querySelectorAll(".aipkit_conversation_item.aipkit_active"):[];r.length>0&&r.forEach(c=>c.classList.remove("aipkit_active")),window.innerWidth<=768&&a.isSidebarOpen&&typeof t=="function"&&t()}else console.error(`AIPKit Sidebar (${o}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=n})();(function(){"use strict";function d(n,e,i){let a=e.botId||"unknown",t=(o,r="muted",c=!1)=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(n,{message:o,type:r,showSpinner:c,scope:"sidebar"}):n&&(n.textContent=o)};if(!n||!e||!i){console.error(`AIPKit Sidebar (${a}): Missing elements or functions for fetchConversationList.`),n&&t(e.text?.historyLoadError||"Error: Cannot load list.","error");return}if(!e.nonce){t(e.text.historyGuests||"History unavailable.","muted");return}t(e.text?.historyLoading||"Loading conversations...","loading",!0),window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(o=>{typeof i=="function"?i(o.conversations||[]):(console.error(`AIPKit Sidebar (${a}): renderConversationListFunc is not a function.`),t(e.text?.historyRenderError||"Error: Cannot display list.","error"))}).catch(o=>{console.error(`AIPKit Sidebar (${a}): Error fetching conversation list:`,o),t(`${e.text?.historyLoadErrorPrefix||"Error loading list"}: ${o.message||"Unknown error"}`,"error")})}window.aipkit_sidebar_fetchConversationList=d})();(function(){"use strict";function n(e,i,a,t,o,r,c){let _=a.botId||"unknown",p='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>',l=(m,f="muted")=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(i,{message:m,type:f,scope:"sidebar"}):i&&(i.textContent=m)};if(!i||!a||!t||typeof o!="function"||typeof r!="function"||typeof c!="function"){console.error(`AIPKit Sidebar (${_}): Missing elements or functions for renderConversationList.`),i&&l(a.text?.historyRenderError||"Error: Cannot render list.","error");return}if(!e||e.length===0){l(a.text.historyEmpty||"No past conversations.","muted");return}i.innerHTML="";let u=window.aipkit_current_conversation_uuid||null,g=a.text?.openConversation||"Open conversation",s=a.text?.deleteConversation||"Delete conversation";e.forEach(m=>{let f=document.createElement("div");f.className="aipkit_conversation_item",f.setAttribute("data-conversation-id",m.id);let w=m.title||m.id.substring(0,8),h=document.createElement("span");h.className="aipkit_conversation_item_title",h.textContent=w;let y=document.createElement("button");y.type="button",y.className="aipkit_conversation_item_title_btn",y.setAttribute("aria-label",`${g}: ${w}`),y.title=`${w} (ID: ${m.id})`,y.appendChild(h),f.appendChild(y);let I=document.createElement("button");I.type="button",I.className="aipkit_conversation_item_delete_btn",I.setAttribute("aria-label",`${s}: ${w}`),I.innerHTML=p,I.title=s,f.appendChild(I);let b=document.createElement("span");b.className="aipkit_conversation_item_spinner aipkit_spinner",f.appendChild(b),u&&m.id===u&&f.classList.add("aipkit_active"),!!t.isDeletingId&&t.isDeletingId===m.id&&(f.classList.add("aipkit_conversation_item--deleting"),f.setAttribute("aria-busy","true"),y.disabled=!0,I.disabled=!0,I.setAttribute("aria-disabled","true")),y.addEventListener("click",()=>{t.isDeletingId!==m.id&&(o(m.id),window.innerWidth<=768&&t.isSidebarOpen&&c())}),I.addEventListener("click",U=>{U.stopPropagation(),!t.isDeletingId&&r(m.id,f)}),i.appendChild(f)})}window.aipkit_sidebar_renderConversationList=n})();(function(){"use strict";function d(e,i){if(!e||!i)return;let a=e.querySelector(".aipkit_sidebar_inline_state");a&&a.remove();let t=null;typeof window.aipkit_chatUI_createStateElement=="function"?t=window.aipkit_chatUI_createStateElement({message:i,type:"error",scope:"sidebar"}):(t=document.createElement("div"),t.className="aipkit_ui_state aipkit_ui_state--error aipkit_ui_state--sidebar",t.textContent=i),t.classList.add("aipkit_sidebar_inline_state"),t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),e.prepend(t),setTimeout(()=>{t.isConnected&&(t.classList.add("aipkit_sidebar_inline_state--hiding"),setTimeout(()=>{t.isConnected&&t.remove()},220))},5e3)}function n(e,i,a,t,o,r){let c=t.botId||"unknown";if(!i||o.isDeletingId)return;o.isDeletingId=e;let _=i.querySelector(".aipkit_conversation_item_delete_btn"),p=i.querySelector(".aipkit_conversation_item_title_btn");i.classList.add("aipkit_conversation_item--deleting"),i.setAttribute("aria-busy","true"),p&&(p.disabled=!0),_&&(_.disabled=!0,_.setAttribute("aria-disabled","true"));let l={bot_id:c,conversation_uuid:e},u=(()=>{let g=i.nextElementSibling;if(g){let f=g.querySelector(".aipkit_conversation_item_title_btn");if(f)return f}let s=i.previousElementSibling;if(s){let f=s.querySelector(".aipkit_conversation_item_title_btn");if(f)return f}let m=i.closest(".aipkit_chat_sidebar");if(m){let f=m.querySelector(".aipkit_sidebar_new_chat_btn");if(f)return f}return null})();window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",l,t).then(g=>{i.classList.add("aipkit_conversation_item--removing");let s=!1,m=()=>{if(s)return;s=!0,i.removeEventListener("transitionend",f),i.parentNode&&i.remove();let w=!!(a&&a.querySelector(".aipkit_conversation_item"));a&&!w?typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(a,{message:t.text.historyEmpty||"No past conversations.",type:"muted",scope:"sidebar"}):a.textContent=t.text.historyEmpty||"No past conversations.":u&&typeof u.focus=="function"&&u.focus()},f=w=>{w.target===i&&w.propertyName==="opacity"&&m()};i.addEventListener("transitionend",f),setTimeout(m,350),window.aipkit_current_conversation_uuid===e&&(typeof r.clearChatAction=="function"?r.clearChatAction():console.error(`AIPKit Sidebar (${c}): clearChatAction is not a function in actions object.`))}).catch(g=>{d(a,`${t.text?.historyDeleteErrorPrefix||"Error deleting conversation"}: ${g.message||"Unknown error"}`),i.classList.remove("aipkit_conversation_item--deleting"),i.classList.remove("aipkit_conversation_item--removing"),i.removeAttribute("aria-busy"),p&&(p.disabled=!1),_&&(_.disabled=!1,_.removeAttribute("aria-disabled"),typeof _.focus=="function"&&_.focus())}).finally(()=>{o.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=n})();(function(){"use strict";function d(n,e,i,a,t,o,r){let c=a.botId||"unknown",_=i?i.closest(".aipkit_chat_container"):null,p=_?_.querySelector(".aipkit_conversation_starters"):null,l=(g,s="muted",m=!1)=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(i,{message:g,type:s,showSpinner:m,scope:"messages"}):i&&(i.textContent=g)};if(!n||t.isDeletingId===n)return;p&&(p.classList.add("aipkit_hidden"),p.classList.remove("aipkit_starters_ready")),sessionStorage.setItem("aipkit_current_conversation_uuid",n),window.aipkit_current_conversation_uuid=n,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let g=localStorage.getItem(`aipkit_file_context_${n}`);if(g){let s=JSON.parse(g),m=!1;s&&s.provider&&(s.provider==="OpenAI"&&s.vector_store_id||s.provider==="Pinecone"&&s.index_name&&s.namespace||s.provider==="Qdrant"&&s.collection_name&&s.file_upload_context_id||s.provider==="Claude"&&s.file_id)&&(m=!0),m?(window.aipkit_active_file_context_provider=s.provider,window.aipkit_active_file_context_data=s,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:s}))):(console.warn(`AIPKit Sidebar (${c}): Invalid file context data in localStorage for conv ${n}. Clearing. Data:`,s),localStorage.removeItem(`aipkit_file_context_${n}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(g){console.error("AIPKit Sidebar: Error handling localStorage for file context:",g),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(e?e.querySelectorAll(".aipkit_conversation_item"):[]).forEach(g=>{g.classList.remove("aipkit_active"),g.getAttribute("data-conversation-id")===n&&g.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"&&window.aipkit_chatUI_clearMessages(i),l("","loading",!0),window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},a).then(g=>{i.innerHTML="";let s=g.history||[];if(s.length===0)if(typeof window.aipkit_chatUI_appendMessage=="function"&&a.text.initialGreeting){let m=(a.text.initialGreeting||"").trim(),f=(a.text.initialSubgreeting||"").trim(),w=m;f&&(w=m?`${m}

${f}`:f),typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i,w,"bot",a,!1,!0,window.aipkit_generateClientMessageId(c))}else l(a.text.historyEmpty||"No past messages.","muted");else{let m=null;s.forEach(f=>{let w=f.role==="assistant"||f.role==="bot"?"bot":"user",h=f.content||"";f.response_data&&f.response_data.type==="image"&&f.response_data.images&&f.response_data.images.length>0&&(h={type:"image",images:f.response_data.images,prompt:f.request_payload?.prompt||f.content}),f.response_data&&f.response_data.type==="user_image_upload"&&f.response_data.images&&f.response_data.images.length>0&&(h={text:f.content||"",user_image:f.response_data.images[0]}),window.aipkit_chatUI_appendMessage(i,h,w,a,f.role==="bot"&&(f.content||"").startsWith("Error:"),!1,f.message_id||null,!1,f.grounding_metadata||null),(w==="bot"||w==="assistant")&&f.openai_response_id&&(m=f.openai_response_id)}),m&&(window.aipkit_current_openai_response_id=m,sessionStorage.setItem("aipkit_current_openai_response_id",m)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0)}typeof o.setButtonStateAction=="function"&&o.setButtonStateAction("send",!1),typeof o.focusInputAction=="function"&&o.focusInputAction(),_&&_.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:n}}))}).catch(g=>{l(`${a.text?.historyLoadErrorPrefix||"Error loading history"}: ${g.message||"Unknown error"}`,"error"),typeof o.setButtonStateAction=="function"&&o.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=d})();(function(){"use strict";function n(e,i,a,t){let{sidebarToggleBtn:o,sidebarEl:r,newChatBtn:c}=i,_=e.querySelector(".aipkit_chat_messages"),p=e.querySelector(".aipkit_chat_main"),l=r?r.querySelector(".aipkit_sidebar_content"):null,u=r?r.querySelector(".aipkit_sidebar_footer"):null;if(!e||!o||!r||!l||!_||!p){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:o,sidebarEl:r,sidebarContentEl:l,messagesEl:_,mainContentEl:p});return}let g=a.botId;if(!g){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),o.disabled=!0,c&&(c.disabled=!0),typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(l,{message:a.text?.configurationError||"Configuration Error",type:"error",scope:"sidebar"}):l.textContent=a.text?.configurationError||"Configuration Error";return}let s={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null,mobileOverlayTargetEl:null},m=()=>{if(!l)return;l.querySelectorAll(".aipkit_conversation_item.aipkit_active").forEach(S=>S.classList.remove("aipkit_active"))},f=(k=null)=>{if(!l)return;let S=k||null,A=l.querySelectorAll(".aipkit_conversation_item"),C=!1;A.forEach(E=>{let T=!!S&&E.getAttribute("data-conversation-id")===S;E.classList.toggle("aipkit_active",T),T&&(C=!0)}),C||m()},w=window.aipkit_sidebar_getStorageKey(g),h=localStorage.getItem(w);if(s.isSidebarOpen=h==="open",!r.id){let k=String(g).replace(/[^a-zA-Z0-9_-]/g,"_");r.id=`aipkit_chat_sidebar_${k}`}o.setAttribute("aria-controls",r.id),o.setAttribute("aria-expanded",s.isSidebarOpen.toString()),r.setAttribute("aria-hidden",(!s.isSidebarOpen).toString());let y=k=>{s.isSidebarOpen&&window.innerWidth<=768&&(k.preventDefault(),x())},I=k=>window.aipkit_sidebar_applyCurrentState(s.isSidebarOpen,e,o,w,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,r,s,y,k,a),b=()=>window.aipkit_sidebar_fetchConversationList(l,a,k=>window.aipkit_sidebar_renderConversationList(k,l,a,s,v,U,x)),v=k=>window.aipkit_sidebar_loadConversation(k,l,_,a,s,t,x),U=(k,S)=>window.aipkit_sidebar_handleDeleteConversation(k,S,l,a,s,t),x=()=>{window.aipkit_sidebar_toggleSidebar(s,I,b),I(s.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,u),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,u)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),I(!1),o.addEventListener("click",x),c&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof t.clearChatAction=="function"?(c.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(t,l,s,x)),c.disabled=!1):c&&(c.disabled=!0,console.warn(`AIPKit Sidebar (${g}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{s.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(s.isSidebarOpen,r,o,y,s,a)}),(s.isSidebarOpen||!a.nonce)&&b();let M=k=>{k.detail&&(k.detail.conversationUUID&&f(k.detail.conversationUUID),k.detail.newConversation&&s.isSidebarOpen&&b())},F=()=>{m()};e.addEventListener("aipkit:messageReceived",M),e.addEventListener("aipkit:chatCleared",F)}window.aipkit_initConversationSidebar=n})();(function(){"use strict";function d(n){if(!n)return"";let e="",i=n.childNodes;function a(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent;if(t.nodeName==="BR")return`
`;if(t.nodeType===Node.ELEMENT_NODE){let o="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(t.tagName)&&(o+=`
`),t.tagName==="LI"&&(o+="- "),t.childNodes.forEach(r=>{o+=a(r)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(t.tagName)&&(o+=`
`),o}return""}return i.forEach(t=>{e+=a(t)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=d})();(function(){"use strict";function d(n,e=1500){let i=n;if(!i){console.warn("AIPKit showSuccessIcon: Button element not found:",n);return}i.dataset.originalIconHtml||(i.dataset.originalIconHtml=i.innerHTML);let a='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>';if(n.dataset.successTimeoutId||n.disabled)return;i.innerHTML=a;let t=i.querySelector("svg");t&&(t.style.color="var(--aipkit_status-success, #38A169)"),n.dataset.successTimeoutId&&clearTimeout(parseInt(n.dataset.successTimeoutId,10));let o=setTimeout(()=>{let r=i.dataset.originalIconHtml;r&&(i.innerHTML=r),delete i.dataset.originalIconHtml,delete n.dataset.successTimeoutId},e);n.dataset.successTimeoutId=o.toString()}window.aipkit_chatUI_showSuccessIcon=d})();(function(){"use strict";function d(n,e){let i=n.target.closest(".aipkit_copy_btn");if(!i||i.disabled||i.dataset.successTimeoutId)return;let a=i.closest(".aipkit_chat_message"),t=a?a.querySelector(".aipkit_chat_bubble"):null;if(!a||!t){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let o=window.aipkit_chatUI_extractTextFromBubble(t);if(!o){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(o).then(()=>{window.aipkit_chatUI_showSuccessIcon(i)}).catch(r=>{console.error("AIPKit Message Actions: Clipboard API failed:",r)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let r=document.createElement("textarea");r.value=o,r.style.position="fixed",r.style.top="-9999px",r.style.left="-9999px",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select();let c=document.execCommand("copy");if(document.body.removeChild(r),c)window.aipkit_chatUI_showSuccessIcon(i);else throw new Error("execCommand failed")}catch(r){console.error("AIPKit Message Actions: Fallback copy method failed:",r)}}}window.aipkit_chatUI_handleCopyAction=d})();(function(){"use strict";function d(n,e){let i=n.target.closest(".aipkit_feedback_btn");if(!i||i.disabled||i.classList.contains("aipkit_feedback_selected"))return;let a=i.getAttribute("data-feedback"),t=i.closest(".aipkit_chat_message"),o=t?t.getAttribute("data-message-id"):null,r=i.closest(".aipkit_message_actions");if(!o||!a||!r){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}let c=r.querySelectorAll(".aipkit_feedback_btn");if(c.forEach(p=>{p.disabled=!0,p===i?p.classList.add("aipkit_feedback_selected"):(p.classList.remove("aipkit_feedback_selected"),p.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),c.forEach(p=>{p.disabled=!1,p.classList.remove("aipkit_feedback_selected"),p.style.opacity="1"});return}let _={message_id:o,feedback_type:a};window.aipkit_frontendApiRequest("aipkit_store_feedback",_,e).then(p=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${o}.`,p)}).catch(p=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${o}:`,p),c.forEach(l=>{l.disabled=!1,l.classList.remove("aipkit_feedback_selected"),l.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=d})();(function(){"use strict";function d(n){let e='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>',i='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>',a='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3" /></svg>',t='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-down"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" /></svg>',o="",r=n.text||{};if(n.ttsEnabled){let c=r.playActionLabel||"Play audio";o+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${c}" aria-label="${c}">${e}</button>`}if(n.enableCopyButton){let c=r.copyActionLabel||"Copy response";o+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${c}" aria-label="${c}">${i}</button>`}if(n.enableFeedback){let c=r.feedbackLikeLabel||"Like response",_=r.feedbackDislikeLabel||"Dislike response";o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${c}" aria-label="${c}" data-feedback="up">${a}</button>`,o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${_}" aria-label="${_}" data-feedback="down">${t}</button>`}return o?`<div class="aipkit_message_actions">${o}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=d})();(function(){"use strict";function d(n,e){if(!n){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}n.dataset.aipkitMessageActionsListenerAttached!=="true"&&(n.dataset.aipkitMessageActionsListenerAttached="true",n.addEventListener("click",function(i){if(i.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(i,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(i.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(i,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}))}window.aipkit_chatUI_initMessageActions=d})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function d(n=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),e.currentBlobUrl=null),n&&e.currentlyPlayingButton){e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let i=e.currentlyPlayingButton.getAttribute("data-original-icon-html");i&&(e.currentlyPlayingButton.innerHTML=i),e.currentlyPlayingButton.removeAttribute("data-original-icon-html"),e.currentlyPlayingButton=null}}window.aipkit_tts_stopCurrentAudio=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>';function n(){let t=window.aipkitTtsState;!t||!t.currentAudio||!t.currentlyPlayingButton||(t.currentlyPlayingButton.classList.remove("aipkit_loading"),t.currentlyPlayingButton.classList.add("aipkit_playing"),t.currentlyPlayingButton.disabled=!1,t.currentlyPlayingButton.hasAttribute("data-original-icon-html")||t.currentlyPlayingButton.setAttribute("data-original-icon-html",t.currentlyPlayingButton.innerHTML),t.currentlyPlayingButton.innerHTML=d,t.currentAudio.play().catch(o=>{console.error("AIPKit TTS Handler: Error starting playback:",o),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(o)}))}function e(){typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function i(){let t=window.aipkitTtsState;!t||!t.currentAudio||(typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function a(t){let o=window.aipkitTtsState;if(!o)return;console.error("AIPKit TTS Handler: Error playing audio.",t);let r=o.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),r){r.classList.remove("aipkit_loading","aipkit_playing"),r.classList.add("aipkit_error"),r.disabled=!1;let c=r.getAttribute("data-original-icon-html");c&&(r.innerHTML=c),r.removeAttribute("data-original-icon-html")}o.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=n,window.aipkit_tts_handleAudioEnded=e,window.aipkit_tts_handleAudioPaused=i,window.aipkit_tts_handleAudioError=a})();(function(){"use strict";function d(n,e,i){let a=window.aipkitTtsState;if(!a){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let t=atob(n),o=new Array(t.length);for(let _=0;_<t.length;_++)o[_]=t.charCodeAt(_);let r=new Uint8Array(o),c=new Blob([r],{type:e});a.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(a.currentBlobUrl),a.currentBlobUrl=URL.createObjectURL(c),a.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),a.currentAudio=new Audio(a.currentBlobUrl),a.currentlyPlayingButton=i,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&a.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&a.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&a.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?a.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),a.currentAudio.load()}catch(t){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",t),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(t)}}window.aipkit_tts_playAudioFromBase64=d})();(function(){"use strict";async function d(n){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}let i=n.closest(".aipkit_chat_message"),a=i?i.querySelector(".aipkit_chat_bubble"):null,t=n.closest(".aipkit_chat_container[data-config]");t||(t=n.closest(".aipkit_popup_wrapper[data-config]"));let o=t?t.getAttribute("data-config"):null,r=null;if(!a||!t||!o){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}try{r=JSON.parse(o)}catch(p){console.error("AIPKit TTS PlayAction: Failed to parse config.",p);return}let c=a.getAttribute("data-raw-text")||"",_=r.botId;if(!c){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!_){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(n===e.currentlyPlayingButton){typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),n.classList.remove("aipkit_error","aipkit_playing"),n.classList.add("aipkit_loading"),n.disabled=!0;try{let p={text:c};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let l=await window.aipkit_frontendApiRequest("aipkit_generate_speech",p,r);if(l&&l.audio_data_base64&&l.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(l.audio_data_base64,l.mime_type,n);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",l),new Error("Invalid response received from speech generation.")}catch(p){if(console.error("AIPKit TTS PlayAction: Error generating speech:",p),n){n.classList.remove("aipkit_loading","aipkit_playing"),n.classList.add("aipkit_error"),n.disabled=!1;let l=n.getAttribute("data-original-icon-html");l&&(n.innerHTML=l),n.removeAttribute("data-original-icon-html")}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=d})();(function(){"use strict";function d(n,e,i,a,t){return new Promise((o,r)=>{if(!e.ajaxUrl)return r(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return r(new Error("Missing nonce in config for SSE cache."));let c=new FormData;c.append("action","aipkit_cache_sse_message"),c.append("message",n),c.append("_ajax_nonce",e.nonce),e.botId&&c.append("bot_id",e.botId),i&&c.append("image_inputs",JSON.stringify([i])),t&&c.append("user_client_message_id",t);let _=a;if(!_&&window.aipkit_current_conversation_uuid)try{let u=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);u&&(_=JSON.parse(u))}catch(u){console.error("CacheSSE: Error reading file context from localStorage:",u)}_&&(_.provider==="OpenAI"&&_.vector_store_id&&c.append("active_openai_vs_id",_.vector_store_id),_.provider==="Pinecone"&&_.index_name&&_.namespace&&(c.append("active_pinecone_index_name",_.index_name),c.append("active_pinecone_namespace",_.namespace)),_.provider==="Qdrant"&&_.collection_name&&_.file_upload_context_id&&(c.append("active_qdrant_collection_name",_.collection_name),c.append("active_qdrant_file_upload_context_id",_.file_upload_context_id)),_.provider==="Claude"&&_.file_id&&c.append("active_claude_file_id",_.file_id));let p=()=>fetch(e.ajaxUrl,{method:"POST",body:c}).then(u=>u.ok?u.json():u.text().then(g=>{try{let s=JSON.parse(g);if(s?.data?.code==="embed_not_available")throw new Error("The embed feature is not available with your current plan. Please upgrade to use embedded chatbots.");if(s?.data?.code==="cors_denied")throw new Error("This domain is not permitted to access the chatbot. Please check your embed settings.");if(s?.data?.code==="nonce_failure_cache_sse")return l(e).then(()=>(c.set&&c.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:c}))).then(m=>m.ok?m.json():m.text().then(f=>{throw new Error(f||`HTTP error ${m.status} caching message.`)}));throw new Error(s?.data?.message||`HTTP error ${u.status} caching message.`)}catch{if(u.status===403)return l(e).then(()=>(c.set&&c.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:c}))).then(m=>m.ok?m.json():m.text().then(f=>{throw new Error(f||`HTTP error ${m.status} caching message.`)}));throw new Error(`Failed to prepare message for streaming. Please check your internet connection and try again. (HTTP ${u.status})`)}})).then(u=>{u.success&&u.data?.cache_key?o(u.data.cache_key):r(new Error(u.data?.message||"Failed to cache message for streaming."))}).catch(u=>{console.error("AIPKit SSE Cache Request Error:",u),r(u)});function l(u){return new Promise((g,s)=>{try{if(!u||!u.ajaxUrl)return s(new Error("No ajaxUrl for nonce refresh"));let m=new FormData;m.append("action",typeof window.aipkit_getChatNonceAction=="string"&&window.aipkit_getChatNonceAction?window.aipkit_getChatNonceAction:"aipkit_get_frontend_chat_nonce"),u.botId&&m.append("bot_id",u.botId),fetch(u.ajaxUrl,{method:"POST",body:m,credentials:"same-origin"}).then(f=>f.json()).then(f=>{f&&f.success&&f.data&&f.data.nonce?(u.nonce=f.data.nonce,g(f.data.nonce)):s(new Error("Nonce refresh failed"))}).catch(()=>s(new Error("Nonce refresh network error")))}catch(m){s(m)}})}p()})}window.aipkit_chatUI_cacheSseMessage=d})();(function(){"use strict";function d(n,e,i,a,t,o,r,c,_,p){if(!i.ajaxUrl||!i.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let l=new URL(i.ajaxUrl);l.searchParams.append("action","aipkit_frontend_chat_stream"),l.searchParams.append("cache_key",n),l.searchParams.append("bot_id",e),l.searchParams.append("session_id",a||""),l.searchParams.append("conversation_uuid",t),o>0&&l.searchParams.append("post_id",o);try{l.searchParams.append("_ts",Date.now().toString())}catch{}i.provider==="OpenAI"&&i.enableOpenAIConversationState&&r&&l.searchParams.append("previous_openai_response_id",r),c&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&l.searchParams.append("frontend_web_search_active","true"),_&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&l.searchParams.append("frontend_google_search_grounding_active","true"),p&&(p.provider==="OpenAI"&&p.vector_store_id&&l.searchParams.append("active_openai_vs_id",p.vector_store_id),p.provider==="Pinecone"&&p.index_name&&p.namespace&&(l.searchParams.append("active_pinecone_index_name",p.index_name),l.searchParams.append("active_pinecone_namespace",p.namespace)),p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id&&(l.searchParams.append("active_qdrant_collection_name",p.collection_name),l.searchParams.append("active_qdrant_file_upload_context_id",p.file_upload_context_id)),p.provider==="Claude"&&p.file_id&&l.searchParams.append("active_claude_file_id",p.file_id)),l.searchParams.append("_ajax_nonce",i.nonce);try{return new EventSource(l.toString())}catch(u){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,u),u}}window.aipkit_chatUI_createEventSource=d})();(function(){"use strict";function d(n,e,i,a){try{let t=JSON.parse(n.data),o=t.message_id;if(o){if(i.currentStreamMessageId&&i.currentStreamMessageId!==o&&a){let r=a.querySelector(`#${CSS.escape(i.currentStreamMessageId)}`);if(r){let c=r.querySelector(".aipkit_chat_bubble");if(c){let _=c.querySelector(".aipkit_stream_indicator");_&&_.parentNode&&_.parentNode.removeChild(_)}r.classList.remove("aipkit_message_streaming"),r.classList.add("aipkit_message_complete")}}i.currentStreamMessageId=o}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.openai_response_id&&(window.aipkit_current_openai_response_id=t.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",t.openai_response_id))}catch(t){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",n.data,t)}}window.aipkit_chatUI_handleMessageStartEvent=d})();(function(){"use strict";function d(n,e){try{let i=JSON.parse(n.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&i.id&&(window.aipkit_current_openai_response_id=i.id,sessionStorage.setItem("aipkit_current_openai_response_id",i.id))}catch(i){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=d})();(function(){"use strict";function d(n,e){try{let i=JSON.parse(n.data);e.accumulatedGroundingMetadata=i}catch(i){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleGroundingMetadataEvent=d})();(function(){"use strict";function d(n,e,i,a,t){try{let o=JSON.parse(n.data),r=o.delta;if(r!==void 0&&t.currentStreamMessageId)if(t.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0);else{t.dataReceived=!0;let c=`aipkit-typing-indicator-${e}`,_=a.querySelector(`#${CSS.escape(c)}`);if(_){let p=_.querySelector(".aipkit_chat_bubble");if(p){_.id=t.currentStreamMessageId,_.setAttribute("data-message-id",t.currentStreamMessageId),_.classList.remove("aipkit_typing-indicator"),p.dataset.aipkitFullContent=r,p.innerHTML=window.aipkit_md?window.aipkit_md.render(r):r.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(p,"aipkit_stream_indicator");let l=typeof window.aipkit_chatUI_createActionsContainerHTML=="function"?window.aipkit_chatUI_createActionsContainerHTML(i):"";l&&!_.querySelector(".aipkit_message_actions")&&(_.insertAdjacentHTML("beforeend",l),_.classList.add("aipkit_has_message_actions")),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_removeTypingIndicator(a,_),window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,o)}catch(o){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,n.data,o)}}window.aipkit_chatUI_handleOnMessageEvent=d})();(function(){"use strict";function d(n,e,i,a,t,o,r){typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&r.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(a,r.currentStreamMessageId,"","bot",i,!0,!1,r.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),typeof t=="function"&&t(),o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleDoneEvent=d})();(function(){"use strict";function d(n,e,i,a,t){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,n.data),t.dataReceived||(t.dataReceived=!0);try{let o=JSON.parse(n.data);o.error&&t.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,`

*${o.error}*`,"bot",i,!1,!0,null),window.aipkit_chatUI_scrollToBottom(a,!0))}catch(o){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,n.data,o)}}window.aipkit_chatUI_handleWarningEvent=d})();(function(){"use strict";function d(n,e,i,a,t,o,r){window.aipkit_chatUI_removeTypingIndicator(a);let c=i.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,n);let _=null;if(n.data)try{let l=JSON.parse(n.data);l.error&&(_=l.error)}catch{typeof n.data=="string"&&n.data.length>0&&n.data.length<200&&(_=n.data)}else n.target&&n.target.readyState===EventSource.CLOSED?_="Connection was closed.":n.message&&(_=n.message);let p="";_?p=`${c.errorPrefix||"Error:"} ${_}`:p=r.dataReceived?c.streamError||"Stream error. Please try again.":c.connError||"Connection error. Please check setup or try again.",typeof t=="function"&&t(p,!1,!0),r.currentStreamMessageId=null,o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleErrorEvent=d})();(function(){"use strict";function d(n,e,i,a,t){typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);try{let r=JSON.parse(n.data).form_definition;if(typeof r!="object"||r===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let c=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(a,r,i,c);let _=a.closest(".aipkit_chat_container");_&&_.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:r.form_id,messageId:c}}))}catch(o){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,o,"Raw event data:",n.data)}}window.aipkit_chatUI_handleDisplayFormEvent=d})();(function(){"use strict";async function d(n,e,i,a,t,o,r,c,_,p,l){let u=i.text||{},g={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},s={current:null},m=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let v of m)if(typeof window[v]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${v}`),typeof t=="function"&&t(`${u.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let f=window.aipkit_current_conversation_uuid,w=window.aipkit_guest_uuid,h=window.aipkit_current_post_id,y=window.aipkit_current_openai_response_id;if(!f){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof t=="function"&&t(u.errorPrefix+" "+(u.connError||"Configuration error (Conv ID)."),!1);return}let I=null;try{I=await window.aipkit_chatUI_cacheSseMessage(n,i,_,p,l)}catch(v){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,v.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,v),typeof t=="function"){let U=`${u.errorPrefix||"Error:"} Failed to prepare message for streaming.`;v&&typeof v=="object"&&v.code?U+=` (Code: ${v.code})`:v&&v.message?U+=` (${v.message})`:U+=" (Unknown error)",t(U)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let b=window.aipkit_chatUI_createEventSource(I,e,i,w,f,h,y,r,c,p);if(b instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,b),typeof t=="function"&&t(u.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(a);return}s.current=b,s.current.addEventListener("message_start",v=>window.aipkit_chatUI_handleMessageStartEvent(v,i,g,a)),s.current.addEventListener("openai_response_id",v=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(v,i)),s.current.addEventListener("grounding_metadata",v=>window.aipkit_chatUI_handleGroundingMetadataEvent(v,g)),s.current.addEventListener("display_form_event",v=>window.aipkit_chatUI_handleDisplayFormEvent(v,e,i,a,g)),s.current.onmessage=v=>window.aipkit_chatUI_handleOnMessageEvent(v,e,i,a,g),s.current.addEventListener("done",v=>window.aipkit_chatUI_handleDoneEvent(v,e,i,a,o,s,g)),s.current.addEventListener("warning",v=>window.aipkit_chatUI_handleWarningEvent(v,e,i,a,g)),s.current.onerror=v=>window.aipkit_chatUI_handleErrorEvent(v,e,i,a,t,s,g)}window.aipkit_chatUI_streamMessage=d})();(function(){"use strict";async function d(n,e,i,a){n.preventDefault();let t=n.target;if(!t)return;let o=t.dataset.formId;if(!o){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let r=new FormData(t),c={};for(let[u,g]of r.entries())if(u.endsWith("[]")){let s=u.slice(0,-2);c[s]||(c[s]=[]),c[s].push(g)}else c[u]=g;let _=t.querySelector('button[type="submit"]');_&&(_.disabled=!0);let p=t.closest(".aipkit_chat_form_wrapper"),l={form_id:o,submitted_data:JSON.stringify(c)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let u=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",l,e);if(_&&(_.disabled=!1),u.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(i.messagesEl,u.message_to_user,"bot",e,!1,!1,u.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):u.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i.messagesEl,u.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),p){let g=p.closest(".aipkit_chat_message");g&&(g.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i.messagesEl,!0))}}catch(u){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${o}":`,u),_&&(_.disabled=!1),typeof a.handleError=="function"?a.handleError(u.message||"Failed to submit form.",!1,!0):typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(u.message||"Failed to submit form.","error",{elements:i,config:e},!0,7e3)}}window.aipkit_chatUI_handleChatFormSubmission=d})();(function(){"use strict";let d=!1,n=null,e=null,i=null,a=null;function t(){n&&(n.classList.remove("aipkit_active"),n.setAttribute("aria-hidden","true"),n=null,d=!1),e&&(e.setAttribute("aria-expanded","false"),e=null),i&&(document.removeEventListener("click",i,!0),document.removeEventListener("click",i,!1),i=null),a&&(document.removeEventListener("keydown",a,!0),document.removeEventListener("keydown",a,!1),a=null)}window.aipkit_chatUI_closeActiveDownloadMenu=t,window.aipkit_chatUI_setActiveDownloadMenu=function(o,r,c,_,p){n=o,d=r,i=c,e=_||null,a=p||null},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:d,activeMenu:n,activeTrigger:e,handler:i,keyHandler:a}}})();(function(){"use strict";function d(n,e){if(!n||!e)return;let{inputActionButton:i,inputActionMenu:a}=n;e.activeInputActionMenu&&e.activeInputActionTrigger&&(a&&(a.classList.remove("aipkit-action-menu-open"),a.setAttribute("aria-hidden","true"),setTimeout(()=>{a&&!a.classList.contains("aipkit-action-menu-open")&&a.setAttribute("hidden","hidden")},200)),i&&(i.classList.remove("aipkit_active"),i.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=d})();(function(){"use strict";function d(n,e,i){let{inputActionButton:a,inputActionMenu:t,imageUploadInput:o,fileUploadInput:r}=n,{fileUploadEnabledUI:c,imageUploadEnabledUI:_}=e,p=()=>{t&&(t.classList.remove("aipkit-action-menu-open"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden","hidden"))};if(!a){p();return}let l='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" /></svg>',u='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-photo-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8h.01" /><path d="M12.5 21h-6.5a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v6.5" /><path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l3.5 3.5" /><path d="M14 14l1 -1c.679 -.653 1.473 -.829 2.214 -.526" /><path d="M19 22v-6" /><path d="M22 19l-3 -3l-3 3" /></svg>',g='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-upload"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9.5 13.5l2.5 -2.5l2.5 2.5" /></svg>';a.onclick=null;let s=window.aipkit_chatUI_closeActiveDownloadMenu,m=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof s!="function"||typeof m!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let f=l,w=e.text?.attachTools||"Attach or use tools",h="true";if(c&&!_)f=g,w=e.text?.uploadFile||"Upload File (TXT, PDF)",h="false";else if(!c&&_)f=u,w=e.text?.uploadImage||"Upload Image",h="false";else if(!c&&!_){a.hidden=!0,p();return}a.hidden=!1,a.innerHTML=f,a.setAttribute("aria-label",w),h==="true"?(a.setAttribute("aria-haspopup","true"),a.setAttribute("aria-expanded","false")):(a.removeAttribute("aria-haspopup"),a.removeAttribute("aria-expanded")),c&&_?(p(),a.onclick=y=>{y.stopPropagation(),s(),!i.isActionMenuOpen?(t&&(t.removeAttribute("hidden"),requestAnimationFrame(()=>{t&&t.classList.add("aipkit-action-menu-open")}),t.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{let b=t.querySelector(".aipkit_input_action_menu_item:not(:disabled)");b&&typeof b.focus=="function"&&b.focus()})),a.classList.add("aipkit_active"),a.setAttribute("aria-expanded","true"),i.isActionMenuOpen=!0,i.activeInputActionMenu=t,i.activeInputActionTrigger=a,setTimeout(()=>{i.closeActionMenuHandler=b=>{b.type==="click"&&(!i.activeInputActionMenu||!i.activeInputActionTrigger||i.activeInputActionMenu.contains(b.target)||i.activeInputActionTrigger.contains(b.target))||b.type==="keydown"&&b.key!=="Escape"||(m(n,i),b.type==="keydown"&&b.key==="Escape"&&a&&typeof a.focus=="function"&&a.focus())},document.addEventListener("click",i.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",i.closeActionMenuHandler,{capture:!0,once:!1})},0)):m(n,i)}):c?(p(),a.onclick=y=>{y.stopPropagation(),s(),r?r.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.uploadInitError||"File upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))}):_?(p(),a.onclick=y=>{y.stopPropagation(),s(),o?o.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.imageUploadInitError||"Image upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))}):(a.hidden=!0,p())}window.aipkit_chatUI_setupInputActionButton=d})();(function(){"use strict";function d(n,e,i,a){let{actionButton:t}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{i.buttonState==="send"&&!t.disabled?a.sendMessageAction():i.buttonState==="clear"&&a.clearChatAction()}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{inputField:t,messagesEl:o,actionButton:r}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("keydown",c=>{c.key==="Enter"&&!i.isActionMenuOpen&&(c.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)},0):(c.preventDefault(),i.buttonState==="send"&&!r.disabled&&a.sendMessageAction()))}),t.addEventListener("input",()=>{let c=t.value.trim()==="",_=o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;c?_&&i.buttonState!=="sending"&&i.buttonState!=="streaming"?i.buttonState=a.setButtonStateAction("clear",!1,i):i.buttonState!=="sending"&&i.buttonState!=="streaming"&&(i.buttonState=a.setButtonStateAction("send",!1,i)):i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=d})();(function(){"use strict";function d(n,e,i,a){let{fullscreenButton:t}=n;t&&typeof a.toggleFullscreenAction=="function"?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a.toggleFullscreenAction),t.dataset.listenerAttached="true"):t&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{webSearchToggleButton:t}=n,o=e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter");t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.hidden=!0,t.setAttribute("aria-hidden","true"))}window.aipkit_chatUI_attachWebSearchToggleListener=d})();(function(){"use strict";function d(n,e,i,a){let{googleSearchGroundingToggleButton:t}=n,o=e.allowGoogleSearchGrounding&&e.provider==="Google";t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.hidden=!0,t.setAttribute("aria-hidden","true"))}window.aipkit_chatUI_attachGoogleGroundingToggleListener=d})();(function(){"use strict";function d(n,e,i,a){let{downloadButton:t}=n;if(!t||!e.enableDownload)return;let o=t.closest(".aipkit_download_wrapper"),r=o?o.querySelector(".aipkit_download_menu"):null,c=e.pdfDownloadActive===!0,_=window.aipkit_chatUI_closeActiveDownloadMenu,p=window.aipkit_chatUI_setActiveDownloadMenu,l=window.aipkit_chatUI_getDownloadMenuState;t.dataset.ariaSetup!=="true"&&(t.setAttribute("aria-haspopup",c&&r?"menu":"false"),t.setAttribute("aria-expanded","false"),r&&r.id&&t.setAttribute("aria-controls",r.id),t.dataset.ariaSetup="true"),r&&r.dataset.ariaSetup!=="true"&&(r.setAttribute("role","menu"),r.setAttribute("aria-hidden","true"),r.querySelectorAll(".aipkit_download_menu_item").forEach(h=>{h.hasAttribute("role")||h.setAttribute("role","menuitem")}),r.dataset.ariaSetup="true");let u=(w=!1)=>{typeof _=="function"&&_(),w&&typeof t.focus=="function"&&t.focus()},g=()=>r?Array.from(r.querySelectorAll(".aipkit_download_menu_item:not(:disabled)")):[],s=()=>{let w=g();w.length>0&&w[0].focus()},m=()=>{if(!(!r||!c)){if(u(!1),r.classList.add("aipkit_active"),r.setAttribute("aria-hidden","false"),t.setAttribute("aria-expanded","true"),typeof p=="function"){let w=y=>{(!o||!o.contains(y.target))&&u(!1)},h=y=>{y.key==="Escape"&&(y.preventDefault(),u(!0))};p(r,!0,w,t,h),document.addEventListener("click",w,!0),document.addEventListener("keydown",h,!0)}requestAnimationFrame(s)}},f=()=>{let w=typeof l=="function"?l():{isOpen:!1,activeMenu:null};w.isOpen&&w.activeMenu===r?u(!1):m()};t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",w=>{if(w.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),c&&r){f();return}typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),t.addEventListener("keydown",w=>{c&&r&&(w.key==="ArrowDown"?(w.preventDefault(),m()):w.key==="Escape"&&(w.preventDefault(),u(!0)))}),t.dataset.listenerAttached="true"),r&&r.dataset.listenerAttached!=="true"&&(r.addEventListener("click",w=>{let h=w.target.closest(".aipkit_download_menu_item");if(!h)return;let y=h.getAttribute("data-format");y==="txt"?typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):y==="pdf"&&(typeof a.downloadTranscriptPdfAction=="function"?a.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),u(!1)}),r.addEventListener("keydown",w=>{let h=g();if(w.key==="Escape"){w.preventDefault(),u(!0);return}if(w.key==="Tab"){u(!1);return}if(h.length===0)return;let y=document.activeElement,I=h.indexOf(y),b=I;if(w.key==="ArrowDown"||w.key==="ArrowRight")w.preventDefault(),b=I<0?0:(I+1)%h.length;else if(w.key==="ArrowUp"||w.key==="ArrowLeft")w.preventDefault(),b=I<=0?h.length-1:I-1;else if(w.key==="Home")w.preventDefault(),b=0;else if(w.key==="End")w.preventDefault(),b=h.length-1;else return;h[b]&&h[b].focus()}),r.dataset.listenerAttached="true")}window.aipkit_chatUI_attachDownloadMenuListeners=d})();(function(){"use strict";function d(n,e,i,a){let{inputActionMenu:t}=n;t&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&(t.dataset.itemClickListenerAttached!=="true"&&(t.addEventListener("click",o=>{let r=o.target.closest(".aipkit_input_action_menu_item");if(!r)return;o.preventDefault();let c=r.getAttribute("aria-label");c&&c.toLowerCase().includes("image")?n.imageUploadInput?n.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.imageUploadInitError||"Image upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3)):c&&(c.toLowerCase().includes("pdf")||c.toLowerCase().includes("file"))&&(n.fileUploadInput?n.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.uploadInitError||"File upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i)}),t.dataset.itemClickListenerAttached="true"),t.dataset.itemKeydownListenerAttached!=="true"&&(t.addEventListener("keydown",o=>{let r=Array.from(t.querySelectorAll(".aipkit_input_action_menu_item:not(:disabled)"));if(o.key==="Escape"){o.preventDefault(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),n.inputActionButton&&typeof n.inputActionButton.focus=="function"&&n.inputActionButton.focus();return}if(o.key==="Tab"){typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i);return}if(r.length===0)return;let c=r.indexOf(document.activeElement),_=c;if(o.key==="ArrowDown"||o.key==="ArrowRight")o.preventDefault(),_=c<0?0:(c+1)%r.length;else if(o.key==="ArrowUp"||o.key==="ArrowLeft")o.preventDefault(),_=c<=0?r.length-1:c-1;else if(o.key==="Home")o.preventDefault(),_=0;else if(o.key==="End")o.preventDefault(),_=r.length-1;else return;r[_]&&r[_].focus()}),t.dataset.itemKeydownListenerAttached="true"))}window.aipkit_chatUI_attachInputActionMenuListener=d})();(function(){"use strict";function d(n,e,i,a){let{voiceInputButton:t}=n;t&&e.enableVoiceInputUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(n,e,i,i.consentUIInstance,a):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.voiceUnavailableScriptError||"Voice input is currently unavailable (script error).","error",{elements:n,config:e},!0,7e3))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{fileUploadInput:t}=n;t&&e.fileUploadEnabledUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("change",async o=>{let r=o.target.files[0];if(r&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let c=n.inputArea||t.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(r,t,c,e)}else r&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",n.inputArea))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=d})();(function(){"use strict";function d(n,e,i,a){let{messagesEl:t}=n;t&&typeof a.handlePlayAction=="function"?t.dataset.playListenerAttached!=="true"&&(t.addEventListener("click",function(o){let r=o.target.closest(".aipkit_play_btn");r&&!r.disabled&&a.handlePlayAction(r)}),t.dataset.playListenerAttached="true"):t&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=d})();(function(){"use strict";function d(n,e,i,a){typeof i.isActionMenuOpen>"u"&&(i.isActionMenuOpen=!1,i.activeInputActionMenu=null,i.activeInputActionTrigger=null,i.closeActionMenuHandler=null);let t=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],o=!0;if(t.forEach(r=>{typeof window[r]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${r}.`),o=!1)}),!o){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(n,e,i,a),window.aipkit_chatUI_attachInputFieldListeners(n,e,i,a),window.aipkit_chatUI_attachFullscreenButtonListener(n,e,i,a),window.aipkit_chatUI_attachWebSearchToggleListener(n,e,i,a),window.aipkit_chatUI_attachGoogleGroundingToggleListener(n,e,i,a),window.aipkit_chatUI_attachDownloadMenuListeners(n,e,i,a),window.aipkit_chatUI_attachInputActionMenuListener(n,e,i,a),window.aipkit_chatUI_attachVoiceInputButtonListener(n,e,i,a),window.aipkit_chatUI_attachFileUploadInputListener(n,e,i,a),window.aipkit_chatUI_attachPlayButtonListener(n,e,i,a)}window.aipkit_chatUI_attachEventListeners=d})();(function(){"use strict";function d(n,e,i,a,t,o,r,c,_,p,l,u){let{messagesEl:g}=a,s=i.text||{};if(!i.ajaxUrl||!e||!i.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof o=="function"&&o(s.errorPrefix+" "+(s.connError||"Configuration error (API)."),!1),typeof r=="function"&&r();return}let m={message:n};c&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&(m.frontend_web_search_active=!0),_&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&(m.frontend_google_search_grounding_active=!0),p&&(m.image_inputs=JSON.stringify([p]));let f={...i};if(l&&(f.activeFileContext=l,l.provider==="OpenAI"&&l.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${l.vector_store_id}`):l.provider==="Pinecone"&&l.index_name&&l.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${l.index_name}, Namespace: ${l.namespace}`):l.provider==="Qdrant"&&l.collection_name&&l.file_upload_context_id?console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${l.collection_name}, Context ID: ${l.file_upload_context_id}`):l.provider==="Claude"&&l.file_id&&console.log(`AIPKit Chat AJAX (sender): Adding Claude file context to request config: File ID: ${l.file_id}`)),window.aipkit_chatUI_showTypingIndicator(g,i),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof o=="function"&&o("Internal script error.",!1),typeof r=="function"&&r();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",m,f).then(w=>{if(window.aipkit_chatUI_removeTypingIndicator(g),w?.reply)i.provider==="OpenAI"&&i.enableOpenAIConversationState&&w.openai_response_id&&(window.aipkit_current_openai_response_id=w.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",w.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${w.openai_response_id}`)),typeof t=="function"&&(t(w.reply,w.message_id||null,w.openai_response_id||null,w.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(g,!0));else{let h=w?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,h,w),typeof o=="function"&&o(`${s.errorPrefix||"Error:"} ${h}`,!1)}}).catch(w=>{window.aipkit_chatUI_removeTypingIndicator(g);let h=`${s.errorPrefix||"Error:"} ${s.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,w),typeof o=="function"&&o(h+(w.message?` (${w.message})`:""),!0)}).finally(()=>{typeof r=="function"&&r()})}window.aipkit_chatUI_sendMessage=d})();(function(){"use strict";function d(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t===0&&(i.dataset.aipkitScrollLockOverflow=i.style.overflow||"",i.dataset.aipkitScrollLockOverflowX=i.style.overflowX||"",i.dataset.aipkitScrollLockOverflowY=i.style.overflowY||"",i.dataset.aipkitScrollLockHtmlOverflow=a.style.overflow||"",i.dataset.aipkitScrollLockHtmlOverflowX=a.style.overflowX||"",i.dataset.aipkitScrollLockHtmlOverflowY=a.style.overflowY||"",i.style.overflow="hidden",i.style.overflowX="hidden",i.style.overflowY="hidden",a.style.overflow="hidden",a.style.overflowX="hidden",a.style.overflowY="hidden"),i.dataset.aipkitScrollLockCount=String(t+1)}function n(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t<=1?(i.style.overflow=i.dataset.aipkitScrollLockOverflow||"",i.style.overflowX=i.dataset.aipkitScrollLockOverflowX||"",i.style.overflowY=i.dataset.aipkitScrollLockOverflowY||"",a.style.overflow=i.dataset.aipkitScrollLockHtmlOverflow||"",a.style.overflowX=i.dataset.aipkitScrollLockHtmlOverflowX||"",a.style.overflowY=i.dataset.aipkitScrollLockHtmlOverflowY||"",delete i.dataset.aipkitScrollLockOverflow,delete i.dataset.aipkitScrollLockOverflowX,delete i.dataset.aipkitScrollLockOverflowY,delete i.dataset.aipkitScrollLockHtmlOverflow,delete i.dataset.aipkitScrollLockHtmlOverflowX,delete i.dataset.aipkitScrollLockHtmlOverflowY,delete i.dataset.aipkitScrollLockCount):i.dataset.aipkitScrollLockCount=String(t-1)}function e(i,a,t){let{container:o,fullscreenButton:r,messagesEl:c,inputField:_,startersContainer:p}=i,l=t.text||{};if(!o||!r){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}a.isFullscreen=!a.isFullscreen;let u=!!o.closest("#aipkit_admin_chat_preview_container");if(a.isFullscreen){if(!a.fullscreenPlaceholder){let f=document.createElement("div");f.id=`aipkit_fs_placeholder_${o.id}`,f.style.display="none",o.parentNode.insertBefore(f,o),a.fullscreenPlaceholder=f}document.body.appendChild(o),o.classList.add("aipkit-fullscreen"),u||d()}else o.classList.remove("aipkit-fullscreen"),a.fullscreenPlaceholder&&a.fullscreenPlaceholder.parentNode?(a.fullscreenPlaceholder.parentNode.insertBefore(o,a.fullscreenPlaceholder),a.fullscreenPlaceholder.remove(),a.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position."),u||n();let g=o.closest(".aipkit_popup_wrapper");g&&g.classList.toggle("aipkit-fullscreen-wrapper",a.isFullscreen);let s='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-maximize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 4l4 0l0 4" /><path d="M14 10l6 -6" /><path d="M8 20l-4 0l0 -4" /><path d="M4 20l6 -6" /><path d="M16 20l4 0l0 -4" /><path d="M14 14l6 6" /><path d="M8 4l-4 0l0 4" /><path d="M4 4l6 6" /></svg>',m='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-minimize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9l4 0l0 -4" /><path d="M3 3l6 6" /><path d="M5 15l4 0l0 4" /><path d="M3 21l6 -6" /><path d="M19 9l-4 0l0 -4" /><path d="M15 9l6 -6" /><path d="M19 15l-4 0l0 4" /><path d="M15 15l6 6" /></svg>';if(r.innerHTML=a.isFullscreen?m:s,r.title=a.isFullscreen?l.exitFullscreen||"Exit Fullscreen":l.fullscreen||"Fullscreen",r.setAttribute("aria-label",r.title),r.setAttribute("aria-expanded",a.isFullscreen.toString()),a.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(c,!0),_&&setTimeout(()=>_.focus(),50),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&c){let f=c.querySelector(".aipkit_initial_greeting");f&&window.aipkit_chatUI_triggerMessageAnimation(f)}typeof window.aipkit_chatUI_refreshStartersAnimation=="function"&&p&&window.aipkit_chatUI_refreshStartersAnimation(p)}window.aipkit_chatUI_toggleFullscreen=e})();(function(){"use strict";function d(n,e,i,a,t){let{state:o,elements:r,config:c,setButtonStateAction:_,handleError:p,generateClientMessageId:l,focusInputAction:u}=t,{inputField:g,voiceInputButton:s,messagesEl:m,container:f}=r;o.isSending=!0,g.disabled=!0,s&&(s.disabled=!0),_("sending",!0,o);let w=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?w=window.aipkit_chatUI_showImageLoadingIndicator(m,c):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(m,c));let h={prompt:n,original_user_text:e,user_message_id:i};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),p("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(m,w),o.isSending=!1,g.disabled=c.requireConsentCompliance&&!o.consentGiven,s&&(s.disabled=c.requireConsentCompliance&&!o.consentGiven),_("send",!1,o),(!c.requireConsentCompliance||o.consentGiven)&&u();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",h,c).then(y=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(m,w):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(m),y?.type==="image"&&y.images&&y.images.length>0){let I={type:"image",images:y.images,prompt:n};window.aipkit_chatUI_appendMessage(m,I,"bot",c,!1,!1,y.message_id,!0),f?f.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:y.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:a}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let I=y?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${I}`,y),p(`Image generation failed: ${I}`,!1,!0)}}).catch(y=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(m,w):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(m),p("Image generation failed: "+(y.message||"Unknown error"),!1,!0)}).finally(()=>{o.isSending=!1,g.disabled=c.requireConsentCompliance&&!o.consentGiven,s&&(s.disabled=c.requireConsentCompliance&&!o.consentGiven),_("send",!1,o),(!c.requireConsentCompliance||o.consentGiven)&&u()})}window.aipkit_chatUI_handleImageGeneration=d})();(function(){"use strict";function d(n,e,i,a){let t=n.toLowerCase(),o=i&&i.ipsList?i.ipsList.split(",").map(c=>c.trim()).filter(c=>c!==""):[];if(e&&o.length>0&&o.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:i.message||"Access from your IP address has been blocked."};let r=a&&a.wordsList?a.wordsList.toLowerCase().split(",").map(c=>c.trim()).filter(c=>c!==""):[];if(r.length>0){let c=r.find(_=>t.includes(_));if(c)return console.warn(`AIPKit Moderation: Banned word detected: "${c}"`),{type:"banned_word",message:a.message||"Sorry, your message could not be sent as it contains prohibited words.",word:c}}return null}window.aipkit_checkMessageModeration=d})();(function(){"use strict";function d(t){return t?t.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function n(t){t&&(t.classList.add("aipkit_hidden"),t.classList.remove("aipkit_starters_ready"))}function e(t){t&&(t.classList.remove("aipkit_hidden"),i(t))}function i(t){!t||t.classList.contains("aipkit_hidden")||(t.classList.remove("aipkit_starters_ready"),t.offsetHeight,requestAnimationFrame(()=>{t.classList.contains("aipkit_hidden")||t.classList.add("aipkit_starters_ready")}))}function a(t,o,r,c,_,p){let{startersContainer:l,messagesEl:u,inputField:g}=r,s=o.botId,m=o.starters||[];if(!t||!o||!l||!u||!g){console.error(`AIPKit Starters (${s}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof c!="function"){console.error(`AIPKit Starters (${s}): sendMessageActionCallback is not a function.`),n(l);return}if(typeof p!="function"){console.error(`AIPKit Starters (${s}): isConsentGivenFunc is not a function.`),n(l);return}if(m.length===0){n(l);return}l.innerHTML="",m.forEach((h,y)=>{if(typeof h=="string"&&h.trim()!==""){let I=document.createElement("button");I.type="button",I.className="aipkit_starter_btn",I.textContent=h.trim(),I.style.setProperty("--aipkit-starter-index",String(y)),I.addEventListener("click",b=>{if(b.preventDefault(),_&&!p()){console.warn(`AIPKit Starters (${s}): Starter clicked, but consent not given.`);return}let v=I.textContent;c(v),n(l)}),l.appendChild(I)}});let f=()=>{if(_&&!p()){n(l);return}d(u)?e(l):n(l)},w=()=>n(l);t.addEventListener("aipkit:messageSent",w),t.addEventListener("aipkit:messageReceived",w),t.addEventListener("aipkit:messageError",w),t.addEventListener("aipkit:chatCleared",f),t.addEventListener("aipkit:chatLoaded",f),t.addEventListener("aipkit:consentGiven",()=>{f()}),f()}window.aipkit_initConversationStarters=a,window.aipkit_chatUI_refreshStartersAnimation=i})();function ue(d,n){let e=window.aipkit_chatUI_findElements(d,n);if(!e){let r=d.querySelector(".aipkit_chat_container")||d;return r&&typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(r,{message:"Chatbot UI error (DOM elements missing).",type:"error",scope:"messages"}):r&&(r.textContent="Chatbot UI error (DOM elements missing)."),null}let i=n.botId,a=window.aipkit_chatUI_initState(n);a.consentUIInstance=null;let t={setButtonStateAction:(r,c=!1)=>window.aipkit_chatUI_setButtonStateAction(r,e,n,a,c),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,n,a),sendMessageAction:(r=null)=>window.aipkit_chatUI_sendMessageAction(e,n,a,t,r),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,n,a,t),handleError:(r,c,_=!0)=>window.aipkit_chatUI_handleError(r,c,_,e,n,a,t),handleCompletion:(r,c=!1)=>window.aipkit_chatUI_handleCompletion(r,c,e,n,a,t),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,a,n),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,n),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,n),handlePlayAction:r=>window.aipkit_handlePlayAction(r)};if(n.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?a.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,n,a,()=>{e.inputField.disabled=!1,t.setButtonStateAction("send",!1),t.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):n.requireConsentCompliance&&console.error(`AIPKit Chat Main (${i}): Consent required, but aipkit_initConsentUI function not found.`),n.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but input or preview elements were not found/created by findElements.`):n.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,n,a):(console.error(`AIPKit Chat Main (${i}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.hidden=!0),e.inputActionMenu&&(e.inputActionMenu.classList.remove("aipkit-action-menu-open"),e.inputActionMenu.setAttribute("aria-hidden","true"),e.inputActionMenu.setAttribute("hidden","hidden"))),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,n,a,t):console.error(`AIPKit Chat Main (${i}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,n):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),typeof window.aipkit_chatUI_initScrollToBottomButton=="function"?window.aipkit_chatUI_initScrollToBottomButton(e,n,a):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initScrollToBottomButton missing; scroll button won't render.`),n.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let r=a.consentUIInstance?a.consentUIInstance.isConsentGiven:()=>!n.requireConsentCompliance||a.consentGiven;window.aipkit_initConversationStarters(d,n,e,t.sendMessageAction,n.requireConsentCompliance,r)}else n.enableStarters&&console.warn(`AIPKit Chat Main (${i}): Starters enabled but container or init function missing.`);n.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(d,e,n,t):n.enableSidebar&&console.warn(`AIPKit Chat Main (${i}): Sidebar enabled but elements or init function missing.`);let o={openPopup:n.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(d,e.messagesEl,e.inputField,a):()=>{},closePopup:n.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(d,a):()=>{},setupPopupHandlers:n.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?r=>window.aipkit_chatUI_setupPopupHandlers(d,r,e.messagesEl,e.inputField,a,n):()=>{},isPopupOpen:()=>a.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:t.sendMessageAction,clearChat:t.clearChatAction,toggleFullscreen:t.toggleFullscreenAction};return n.enableRealtimeVoiceUI&&typeof window.aipkit_initRealtimeVoiceAgent=="function"?window.aipkit_initRealtimeVoiceAgent(e,n,a,t,o):n.enableRealtimeVoiceUI&&console.error(`AIPKit Chat Main (${i}): Realtime Voice enabled but aipkit_initRealtimeVoiceAgent function not found.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,n):console.error(`AIPKit Chat Main (${i}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,n,a,t):console.error(`AIPKit Chat Main (${i}): finalizeSetup function not found.`),{publicApi:o,internalElements:e,internalActions:t}}window.aipkit_setupChatInstanceUI=ue;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let d=localStorage.getItem("aipkit_guest_uuid");d||(d=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,i=>(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",d)),window.aipkit_guest_uuid=d,window.aipkit_regenerateConversationUUID=function(){let i=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16));return sessionStorage.setItem("aipkit_current_conversation_uuid",i),window.aipkit_current_conversation_uuid=i,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),i},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(i){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(i).replace(/\n/g,"<br>")}});function n(i){if(!i||i.classList.contains("aipkit-initializing")||i.classList.contains("aipkit-initialized"))return;i.classList.add("aipkit-initializing");let a=i.getAttribute("data-bot-id"),t=i.getAttribute("data-config"),o=null,r=(l,u)=>{if(l){if(typeof window.aipkit_chatUI_renderUIState=="function"){window.aipkit_chatUI_renderUIState(l,{message:u,type:"error",scope:"messages"});return}l.textContent=u}};try{t&&(o=JSON.parse(t),a&&(o.botId=a))}catch(l){console.error(`AIPKit Chat Init (${a||"Unknown"}): Failed to parse configuration.`,l,t);let u=i.querySelector(".aipkit_chat_container")||i;r(u,"Chatbot configuration error."),i.classList.remove("aipkit-initializing");return}if(!o){console.error(`AIPKit Chat Init (${a||"Unknown"}): Config object is null after parse attempt.`,i);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot config load error."),i.classList.remove("aipkit-initializing");return}if(!o.botId&&a&&(o.botId=a),window.aipkit_current_post_id=o.postId||0,o.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"));else{let l=sessionStorage.getItem("aipkit_current_conversation_uuid"),u=sessionStorage.getItem("aipkit_current_openai_response_id");if(l){if(window.aipkit_current_conversation_uuid=l,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=u||null,window.aipkit_current_openai_response_id)try{let g=localStorage.getItem(`aipkit_file_context_${l}`);if(g){let s=JSON.parse(g),m=!1;s&&s.provider&&(s.provider==="OpenAI"&&s.vector_store_id||s.provider==="Pinecone"&&s.index_name&&s.namespace||s.provider==="Qdrant"&&s.collection_name&&s.file_upload_context_id||s.provider==="Claude"&&s.file_id)&&(m=!0),m?(window.aipkit_active_file_context_provider=s.provider,window.aipkit_active_file_context_data=s,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:s}))):(console.warn(`AIPKit Chat Init (${o.botId}): Invalid file context data in localStorage for conv ${l}. Clearing. Data:`,s),localStorage.removeItem(`aipkit_file_context_${l}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(g){console.error("AIPKit Chat Init: Error loading file context from localStorage:",g),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${o.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot script error."),i.classList.remove("aipkit-initializing");return}let c=i.classList.contains("aipkit_chat_container")?i:i.querySelector(".aipkit_chat_container");if(!c){console.error(`AIPKit Chat Init (${o.botId}): Chat container element not found within wrapper.`,i),r(i,"Chatbot structure error."),i.classList.remove("aipkit-initializing");return}if(o.guestUUID=window.aipkit_guest_uuid,o.conversationUUID=window.aipkit_current_conversation_uuid,o.previousOpenAIResponseId=window.aipkit_current_openai_response_id,o.activeFileContextProvider=window.aipkit_active_file_context_provider,o.activeFileContextData=window.aipkit_active_file_context_data,!o.botId||!o.ajaxUrl||!o.text||!o.guestUUID){console.error(`AIPKit Chat Init (${o.botId||"Unknown"}): Missing essential configuration.`,o,i);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot configuration error."),i.classList.remove("aipkit-initializing");return}if(typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&o.theme==="custom"&&o.customThemeSettings&&Object.keys(o.customThemeSettings).length>0){let l={skipDimensionSync:!!o.customThemePresetKey};window.aipkit_chatUI_applyCustomThemeStyles(c,o.customThemeSettings,l)}else o.theme==="custom"&&console.warn(`AIPKit Chat Init (${o.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let _=aipkit_setupChatInstanceUI(c,o);if(!_||!_.publicApi||!_.internalElements||!_.internalActions){console.error(`AIPKit Chat Init (${o.botId}): Failed to set up UI instance or get all necessary parts.`),i.classList.remove("aipkit-initializing");return}let p=_.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[c.id]={instance:p,elements:_.internalElements,actions:_.internalActions},o.popupEnabled){let l=i.querySelector(".aipkit_popup_trigger");if(!l){console.error(`AIPKit Chat Init (${o.botId}): Popup trigger button not found.`),i.classList.remove("aipkit-initializing");return}if(p.setupPopupHandlers){p.setupPopupHandlers(l);let u=o.popupDelay;u>0&&!o.directVoiceMode&&!i.dataset.aipkitAutoOpened&&(i.dataset.aipkitAutoOpened="true",setTimeout(()=>{p&&p.isPopupOpen&&!p.isPopupOpen()&&p.openPopup()},u*1e3))}else console.error(`AIPKit Chat Init (${o.botId}): setupPopupHandlers method missing in UI instance.`)}i.classList.remove("aipkit-initializing"),i.classList.add("aipkit-initialized")}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(t=>{t.closest(".aipkit_popup_wrapper")||n(t)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(n)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let i=new MutationObserver(a=>{let t=!1;a.forEach(o=>{o.addedNodes&&o.addedNodes.forEach(r=>{r.nodeType===1&&(r.matches&&(r.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||r.matches(".aipkit_popup_wrapper")||r.matches('[id^="aipkit-chatbot-container-"]'))||r.querySelector&&r.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper, [id^='aipkit-chatbot-container-']"))&&(t=!0)})}),t&&(i.scanTimeout&&clearTimeout(i.scanTimeout),i.scanTimeout=setTimeout(e,50))});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=n})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function d(n,e,i){let a=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:_=>_,t=new FormData;t.append("action","aipkit_cache_sse_message"),t.append("_ajax_nonce",i);let o={stream_context:"ai_forms",form_id:n,user_input_values:e};t.append("message",JSON.stringify(o));let r=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"});if(!r.ok){let _=await r.json().catch(()=>({}));throw new Error(_?.data?.message||`HTTP error ${r.status}`)}let c=await r.json();if(c.success&&c.data?.cache_key)return c.data.cache_key;throw new Error(c.data?.message||a("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=d})();(function(){"use strict";function d(n,e){let i=window.aipkitAIFormsPublicState,a=n?n.closest(".aipkit-ai-form-wrapper"):null,t=n?n.querySelector(".aipkit_btn-text"):null,o=n?n.querySelector(".aipkit_spinner"):null,r=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:l=>l,c=null,_=()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-danger"),n.classList.add("aipkit_btn-primary"),t&&(t.textContent=e),c&&(n.removeEventListener("click",c),c=null)),o&&(o.style.display="none")};return{restoreGenerateButton:_,setupStopButton:()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-primary"),n.classList.add("aipkit_btn-danger"),t&&(t.textContent=a.dataset.labelStopButton||r("Stop","gpt3-ai-content-generator")),c=l=>{l.preventDefault(),l.stopPropagation(),i.currentAIFormEventSource&&(i.currentAIFormEventSource.close(),i.currentAIFormEventSource=null),_()},n.addEventListener("click",c,{once:!0}))}}}window.aipkitForms_createSseUiManager=d})();(function(){"use strict";function d(n){let e=n.elements,i=!1,a=null,t={},o={};for(let r of e){if(!r.name)continue;let c=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!c||!c[1])continue;let _=c[1];c[2]==="[]"?(t[_]||(t[_]=[]),r.checked&&t[_].push(r.value)):r.type==="radio"?r.checked&&(t[_]=r.value):t[_]=r.value}for(let r of e){let c=r.closest("fieldset");if(c){let g=c.querySelector("legend");g&&(g.style.color="")}else r.style.borderColor="";if(!(r.required||r.dataset&&r.dataset.isRequired==="true"))continue;let p=!1,l=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!l||!l[1])continue;let u=l[1];if(!o[u]&&(r.type==="checkbox"?(p=!t[u]||t[u].length===0,o[u]=!0):r.type==="radio"?(p=!t[u],o[u]=!0):(r.classList.contains("aipkit-file-hidden-content")||r.type!=="file"&&r.type!=="submit"&&r.type!=="button")&&(p=r.value.trim()===""),p)){i=!0;let g=r;if(r.type==="radio"||r.type==="checkbox"?g=r.closest("fieldset"):r.classList.contains("aipkit-file-hidden-content")&&(g=n.querySelector(`.aipkit-file-upload-input[data-field-id="${u}"]`)),a||(a=g),g?.type!=="checkbox"&&g?.type!=="radio"&&g)g.style.borderColor="red";else if(g){let s=g.querySelector("legend");s&&(s.style.color="red")}}}return{isValid:!i,userInputs:t,firstInvalidField:a}}window.aipkitForms_validateSseInputs=d})();(function(){"use strict";let d=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function n(e,i){let a=window.aipkitAIFormsPublicState,t="",o=!0,r='<div class="aipkit-ai-form-results-top-actions"></div>',c='<div class="aipkit-ai-form-results-footer-actions"></div>',_=g=>`<div class="aipkit-ai-form-results-content">${g}</div>`;return{onMessageHandler:g=>{o&&(e.style.display="block",e.innerHTML=r+_("")+c,o=!1);let s=JSON.parse(g.data),m=e.querySelector(".aipkit-ai-form-results-content");s.delta&&m&&(t+=s.delta,a.mdInstanceAIForms?m.innerHTML=a.mdInstanceAIForms.render(t):m.innerHTML=t.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:g=>{a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i();let s=e.querySelector(".aipkit-ai-form-results-content");a.mdInstanceAIForms&&s?s.innerHTML=a.mdInstanceAIForms.render(t):s&&(s.innerHTML=t.replace(/\n/g,"<br />"));let m=e.querySelector(".aipkit-ai-form-results-top-actions"),f=e.querySelector(".aipkit-ai-form-results-footer-actions");if(t.trim()!==""&&m&&f){let w=e.closest(".aipkit-ai-form-wrapper"),h=w.dataset.showSaveButton==="true",y=w.dataset.pdfDownloadEnabled==="true",I=w.dataset.showCopyButton==="true",b=window.aipkit_ai_forms_public_config||{},v=b.is_user_logged_in,U=document.createElement("button");if(U.type="button",U.className="aipkit-copy-results-btn",U.title=d("Copy Results","gpt3-ai-content-generator"),U.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&U.addEventListener("click",window.aipkitForms_handleCopyAction),m.appendChild(U),U.style.display="inline-flex",h&&v){let x=w.dataset.labelSaveButton||b.text?.saveAsPost||d("Save","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&M.addEventListener("click",window.aipkitForms_handleSaveAsPost),f.appendChild(M),M.style.display="inline-flex"}if(y&&typeof window.aipkitForms_handleDownloadPdf=="function"){let x=w.dataset.labelDownloadButton||d("Download","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span>`,M.addEventListener("click",window.aipkitForms_handleDownloadPdf),f.appendChild(M),M.style.display="inline-flex"}if(I){let x=w.dataset.labelCopyButton||d("Copy","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&M.addEventListener("click",window.aipkitForms_handleCopyAction),f.appendChild(M),M.style.display="inline-flex"}}},onErrorHandler:g=>{if(a.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",g);let s=d(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(g.data)try{let f=JSON.parse(g.data);f.error&&(s=f.error)}catch{}if(e.style.display="block",t.trim()!==""){let f=e.querySelector(".aipkit-ai-form-error");if(!f){f=document.createElement("div"),f.className="aipkit-ai-form-error";let w=e.querySelector(".aipkit-ai-form-results-footer-actions");w&&w.parentNode?w.parentNode.insertBefore(f,w.nextSibling):e.appendChild(f)}f.textContent=s}else e.innerHTML=`<p style="color:red;">${s}</p>`;a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i()}}}window.aipkitForms_createSseEventHandlers=n})();(function(){"use strict";async function d(n,e,i,a,t){let o=window.aipkitAIFormsPublicState,r=await window.aipkit_cacheAIFormMessage(n,e,i),c=new URL(aipkit_ai_forms_public_config.ajaxUrl);c.searchParams.append("action","aipkit_frontend_chat_stream"),c.searchParams.append("cache_key",r),c.searchParams.append("_ajax_nonce",i),window.aipkit_guest_uuid&&c.searchParams.append("session_id",window.aipkit_guest_uuid),o.currentAIFormEventSource=new EventSource(c.toString());let{onMessageHandler:_,onDoneHandler:p,onErrorHandler:l}=window.aipkitForms_createSseEventHandlers(a,t);o.currentAIFormEventSource.onmessage=_,o.currentAIFormEventSource.addEventListener("done",p),o.currentAIFormEventSource.onerror=l}window.aipkitForms_setupAndStartEventSource=d})();(function(){"use strict";function d(i,a,t="info"){if(!i)return;let o=window.aipkit_escapeHtml||function(r){return r};i.innerHTML=o(a),i.className=`aipkit-file-upload-status aipkit-status-${t}`}function n(i){if(!i)return;let a=i.querySelector(".aipkit-file-upload-input"),t=i.querySelector(".aipkit-file-upload-status"),o=i.querySelector(".aipkit-file-remove-btn"),r=i.querySelector(".aipkit-file-hidden-content"),c=i.querySelector(".aipkit-file-status-wrapper");a&&(a.value="",a.style.display="block"),t&&(t.innerHTML="",t.className="aipkit-file-upload-status"),o&&(o.style.display="none"),c&&(c.style.display="none"),r&&(r.value="",r.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(i){let a=i.target,t=a.closest(".aipkit_form_group-file-upload");if(!t)return;let o=a.files[0],r=t.querySelector(".aipkit-file-status-wrapper"),c=t.querySelector(".aipkit-file-upload-status"),_=t.querySelector(".aipkit-file-remove-btn"),p=t.querySelector(".aipkit-file-hidden-content"),l=a.closest("form").querySelector('button[type="submit"]'),u=t.dataset.nonce,g=window.aipkit_ai_forms_public_config.ajaxUrl,s=window.wp?.i18n?.__||(h=>h),m=window.aipkit_escapeHtml||function(h){return h};if(!o){n(t);return}if(!["text/plain","application/pdf"].includes(o.type)){d(c,s("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),n(t);return}if(o.size>20*1024*1024){d(c,s("File is too large (max 20MB).","gpt3-ai-content-generator"),"error"),n(t);return}d(c,s("Uploading & processing...","gpt3-ai-content-generator"),"info"),r&&(r.style.display="flex"),l&&(l.disabled=!0);let w=new FormData;w.append("action","aipkit_ai_form_upload_and_parse_file"),w.append("_ajax_nonce",u),w.append("file",o);try{let h=await fetch(g,{method:"POST",body:w,credentials:"same-origin"}),y=await h.json();if(!h.ok||!y.success)throw new Error(y.data?.message||s("Failed to process file.","gpt3-ai-content-generator"));if(typeof y.data.text=="string")p.value=y.data.text,p.dispatchEvent(new Event("change",{bubbles:!0})),d(c,`\u2705 ${m(o.name)}`,"success"),a.style.display="none",_&&(_.style.display="inline-flex"),r&&(r.style.display="flex"),l&&(l.disabled=!1);else throw new Error(s("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(h){d(c,h.message,"error"),n(t),l&&(l.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=n})();(function(){"use strict";function d(i){let a=i.innerHTML;i.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',i.disabled=!0,setTimeout(()=>{i.innerHTML=a,i.disabled=!1},1500)}function n(i){let a=i.currentTarget,t=a.closest(".aipkit-ai-form-results");if(!t)return;let o=t.cloneNode(!0),r=o.querySelector(".aipkit-copy-results-btn");r&&r.remove();let c=o.innerText||o.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(c).then(()=>{d(a)}).catch(_=>{console.error("Failed to copy text using Clipboard API: ",_),e(c,a)}):e(c,a)}function e(i,a){let t=document.createElement("textarea");t.value=i,t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),d(a)}catch(o){console.error("Fallback copy failed: ",o),alert("Failed to copy content.")}document.body.removeChild(t)}window.aipkitForms_handleCopyAction=n})();(function(){"use strict";async function d(n){let e=n.currentTarget,i=e.closest(".aipkit-ai-form-wrapper");if(!i)return;let a=i.querySelector(".aipkit-ai-form-results"),t=i.querySelector("h5.aipkit-ai-form-title"),o=i.dataset.saveAsPostNonce,r=a?a.querySelector(".aipkit-ai-form-results-content"):null;if(!r||!t){console.error("AI Forms Save: Missing results content container or title element.");return}let c=window.aipkit_ai_forms_public_config||{},_=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:s=>s,p=t.textContent.trim(),l=r.innerHTML,u=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let g={action:"aipkit_ai_form_save_as_post",_ajax_nonce:o,post_title:p,post_content:l};try{let s=new FormData;for(let h in g)s.append(h,g[h]);let m=await fetch(c.ajaxUrl,{method:"POST",body:s,credentials:"same-origin"}),f=await m.json();if(!m.ok||!f.success)throw new Error(f.data?.message||_("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let w=null;f.data.edit_link&&(w=document.createElement("a"),w.href=f.data.edit_link,w.innerHTML='<span class="dashicons dashicons-external"></span>',w.title=_("Edit Post","gpt3-ai-content-generator"),w.target="_blank",w.rel="noopener noreferrer",w.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),w.style.marginLeft="10px",e.parentNode.insertBefore(w,e.nextSibling)),setTimeout(()=>{e.innerHTML=u,e.disabled=!1,w&&w.parentNode&&w.remove()},5e3)}catch(s){console.error("Failed to save post:",s),alert(`${_("Error saving post:","gpt3-ai-content-generator")} ${s.message}`),e.innerHTML=u,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=d})();(function(){"use strict";async function d(n){n.preventDefault(),n.stopPropagation();let e=window.aipkitAIFormsPublicState,i=n.target,a=i.closest(".aipkit-ai-form-wrapper");if(!a)return;let t=a.dataset.formId,o=aipkit_ai_forms_public_config.ajaxNonce,r=a.querySelector(".aipkit-ai-form-results"),c=i.querySelector('button[type="submit"]'),_=c?c.querySelector(".aipkit_spinner"):null,p=c?c.querySelector(".aipkit_btn-text"):null,l=a.dataset.labelGenerateButton||"Generate",u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:f=>f;if(!t||!o||!r||!c){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),r&&(r.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:g,setupStopButton:s}=window.aipkitForms_createSseUiManager(c,l);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),r.innerHTML="",r.style.display="none",c&&(c.disabled=!0),_&&(_.style.display="inline-block");let m=window.aipkitForms_validateSseInputs(i);if(!m.isValid){if(m.firstInvalidField)if(m.firstInvalidField.type!=="checkbox")m.firstInvalidField.style.borderColor="red";else{let f=m.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");f&&(f.style.color="red")}r.style.display="block",r.innerHTML=`<p style="color:orange;">${u("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,c&&(c.disabled=!1),_&&(_.style.display="none");return}s();try{await window.aipkitForms_setupAndStartEventSource(t,m.userInputs,o,r,g)}catch(f){console.error("AI Form Submission Error (SSE Setup):",f),r.innerHTML=`<p style="color:red;">${f.message||u(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,g()}}window.aipkit_handleFormSubmitSSE=d})();(function(){"use strict";function d(i,a){let t=window.aipkit_ai_forms_models||{},o=window.aipkit_ai_forms_public_config||{},r=i.toLowerCase(),c=t[r]||[],_=a.dataset.currentValue||"";if(o.allowed_models&&o.allowed_models.trim()!==""){let l=new Set(o.allowed_models.split(",").map(u=>u.trim()));if(Array.isArray(c))c=c.filter(u=>l.has(u.id));else{let u={};for(let g in c){let s=c[g].filter(m=>l.has(m.id));s.length>0&&(u[g]=s)}c=u}}if(a.innerHTML="",!c||Array.isArray(c)&&c.length===0||!Array.isArray(c)&&Object.keys(c).length===0){let l=new Option("No models available for this provider.","");a.appendChild(l);return}let p=!1;if(Array.isArray(c))c.forEach(l=>{let u=new Option(l.name,l.id);l.id===_&&(u.selected=!0,p=!0),a.appendChild(u)});else{let l=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],u=Object.keys(c);l.filter(s=>u.includes(s)).concat(u.filter(s=>!l.includes(s)).sort()).forEach(s=>{let m=document.createElement("optgroup");m.label=s,c[s].forEach(f=>{let w=new Option(f.name,f.id);f.id===_&&(w.selected=!0,p=!0),m.appendChild(w)}),a.appendChild(m)})}if(!p&&_){let l=new Option(`${_} (Manual)`,_,!1,!0);a.insertBefore(l,a.firstChild)}if(a.selectedIndex===-1&&a.options.length>0){let l=a.querySelector("optgroup");l&&l.options.length>0?a.value=l.options[0].value:a.options[0].value&&(a.selectedIndex=0)}}function n(i){let a=i.querySelector(".aipkit_aiform_provider_select"),t=i.querySelector(".aipkit_aiform_model_select");if(t)if(a)d(a.value,t),a.addEventListener("change",function(){d(this.value,t)});else{let o=t.dataset.provider;o?d(o,t):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let i=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(t=>{n(t);let o=t.querySelector("form.aipkit-ai-form-main");o&&!o.dataset.sseInitialized&&(o.addEventListener("submit",window.aipkit_handleFormSubmitSSE),o.dataset.sseInitialized="true"),o&&!o.dataset.fileUploadInitialized&&(o.addEventListener("change",r=>{r.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(r)}),o.addEventListener("click",r=>{if(r.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let c=r.target.closest(".aipkit_form_group-file-upload");c&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(c)}}),o.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?i.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),i.mdInstanceAIForms={render:function(t){return(window.aipkit_escapeHtml||function(r){return r})(t).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function d(n,e,i){let a=n.querySelector(`#${e}`);if(a&&a.offsetParent!==null)return a.value;{let t=n.querySelector(`input[type="hidden"][name="${i}"]`);return t?t.value:null}}window.aipkit_getSettingValue=d})();(function(){"use strict";let d={image_input:!0,image_output:!0,image_generation:!0};function n(o){if(!o||typeof o!="object")return!1;let r=o.capabilities;if(!r||typeof r!="object")return!0;let c={...d,...r};return!!(c.image_output||c.image_generation)}function e(o){if(!o||typeof o!="object")return!1;let r=o.capabilities;if(!r||typeof r!="object")return!0;let c={...d,...r};return!!(c.image_input&&(c.image_output||c.image_generation))}function i(o){if(!o||typeof o!="object")return!1;let r=String(o.id||"").trim().toLowerCase();return r?!r.includes("veo")&&r.includes("gemini")&&r.includes("image-generation"):!1}function a(o){if(!o||typeof o!="object")return!1;let r=String(o.id||"").trim().toLowerCase();return r==="gpt-image-1.5"||r==="gpt-image-1"||r==="gpt-image-1-mini"}function t(o,r,c,_={}){if(!r)return;let p=String(r.value||"").trim().toLowerCase(),l=String(_?.preferredModel||"").trim().toLowerCase(),g=(String(_?.mode||"generate").trim().toLowerCase()==="edit"?"edit":"generate")==="edit";r.innerHTML="";let s=[],m=window.aipkit_image_generator_config_public||{},f=m.text||{},w=o.toLowerCase(),h=c?new Set(c.split(",").map(I=>I.trim().toLowerCase())):null;if(w==="openai"&&m.openai_models?s=m.openai_models||[]:w==="openrouter"&&m.openrouter_image_models?s=(m.openrouter_image_models||[]).filter(I=>n(I)):w==="google"&&m.google_models?s=m.google_models||{}:w==="azure"&&m.azure_models?s=m.azure_models||[]:w==="replicate"&&m.replicate_models&&(s=m.replicate_models||[]),g&&(w==="google"&&s&&typeof s=="object"?s={image:(Array.isArray(s.image)?s.image:[]).filter(b=>i(b)),video:[]}:w==="openai"&&Array.isArray(s)?s=s.filter(I=>a(I)):w==="openrouter"&&Array.isArray(s)?s=s.filter(I=>e(I)):s=[]),h&&!h.has(w))if(s.image||s.video){let I={};s.image&&Array.isArray(s.image)&&(I.image=s.image.filter(b=>h.has(b.id))),s.video&&Array.isArray(s.video)&&(I.video=s.video.filter(b=>h.has(b.id))),s=I}else Array.isArray(s)&&(s=s.filter(I=>h.has(I.id)));else h&&h.has(w);if(s.image&&s.image.length>0||s.video&&s.video.length>0||Array.isArray(s)&&s.length>0){if(w==="openai")s.sort((b,v)=>{let U={"gpt-image-1.5":1,"gpt-image-1":2,"gpt-image-1-mini":3,"dall-e-3":4,"dall-e-2":5};return(U[b.id]||99)-(U[v.id]||99)}),s.forEach(b=>{r.appendChild(new Option(b.name,b.id))});else if(w==="openrouter")s.sort((b,v)=>(b.name||b.id||"").localeCompare(v.name||v.id||"")),s.forEach(b=>{let v=new Option(b.name||b.id,b.id);b.capabilities&&typeof b.capabilities=="object"&&(v.dataset.capabilities=JSON.stringify(b.capabilities)),r.appendChild(v)});else if(w==="azure")s.forEach(b=>{let v=b.name||b.id;r.appendChild(new Option(v,b.id))});else if(w==="google"){if(s.image&&s.image.length>0){let b=document.createElement("optgroup");b.label=f.imageModelsGroup||"Image Models",s.image.sort((v,U)=>{let x=(v.name||v.id||"").toString().toLowerCase(),M=(U.name||U.id||"").toString().toLowerCase();return x.localeCompare(M)}),s.image.forEach(v=>{b.appendChild(new Option(v.name,v.id))}),r.appendChild(b)}if(s.video&&s.video.length>0){let b=document.createElement("optgroup");b.label=f.videoModelsGroup||"Video Models",s.video.forEach(v=>{b.appendChild(new Option(v.name,v.id))}),r.appendChild(b)}}else if(w==="replicate"){let b={};s.forEach(U=>{if(U&&U.name){let x=U.name.split("/"),M=x.length>1?x[0]:"other";b[M]||(b[M]=[]),b[M].push(U)}}),Object.keys(b).sort().forEach(U=>{let x=document.createElement("optgroup");x.label=U,b[U].sort((M,F)=>(M.name||"").localeCompare(F.name||"")),b[U].forEach(M=>{let F=M.name.replace(U+"/",""),k=new Option(F,M.id);x.appendChild(k)}),r.appendChild(x)})}r.disabled=!1;let I=l||p;if(I){let b=Array.from(r.options).find(v=>String(v.value||"").trim().toLowerCase()===I);b&&(r.value=b.value)}r.selectedIndex===-1&&(r.selectedIndex=0)}else{let I=g?f.noEditCapableModels||"(No edit-capable models available)":w==="openrouter"?f.noOpenRouterImageModels||"(No image-capable OpenRouter models found)":f.noModelsAvailable||"(No models available)";r.appendChild(new Option(I,"")),r.disabled=!0}}window.aipkit_populatePublicModelsForProvider=t})();(function(){"use strict";function d(n){let e=n.target.closest(".aipkit-image-history-delete-btn");if(!e)return;n.preventDefault(),n.stopPropagation();let i=e.dataset.attachmentId;if(!i)return;let a=window.aipkit_image_generator_config_public||{},t=a.text||{},o=a.ajaxUrl||window.aipkit_dashboard?.ajaxurl,r=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!o||!r){alert(t.deleteConfigMissing||"Error: Cannot delete image. Configuration missing.");return}let c=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let _=new FormData;_.append("action","aipkit_delete_generated_image"),_.append("_ajax_nonce",r),_.append("attachment_id",i),fetch(o,{method:"POST",body:_,credentials:"same-origin"}).then(p=>p.json()).then(p=>{if(!p.success)throw new Error(p.data?.message||"Deletion failed.");let l=e.closest(".aipkit-image-history-item");l&&(l.style.transition="opacity 0.3s",l.style.opacity="0",setTimeout(()=>{l.remove();let u=l.closest(".aipkit_image_history_section"),g=u?u.querySelector(".aipkit-image-history-grid"):null;if(g&&u&&g.children.length===0){let s=u.querySelector(".aipkit-image-history-load-more-btn"),m=!1;if(s){let f=parseInt(s.dataset.currentPage,10)||1,w=parseInt(s.dataset.maxPages,10)||1;m=!(s.style.display==="none")&&f<w}m||u.remove()}},300))}).catch(p=>{alert(`${t.deleteImageErrorPrefix||"Error deleting image:"} ${p.message}`),e.innerHTML=c,e.disabled=!1})}window.aipkit_handleDeleteImage=d})();(function(){"use strict";let d=["image/jpeg","image/png","image/webp","image/gif"],e={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp",gif:"image/gif"},i={"image/jpeg":"jpg","image/png":"png","image/webp":"webp","image/gif":"gif"};function a(s){let m=Array.isArray(s?.edit_upload_allowed_mime_types)?s.edit_upload_allowed_mime_types.map(w=>String(w||"").trim().toLowerCase()).filter(Boolean):d,f=Number(s?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(m),maxBytes:Number.isFinite(f)&&f>0?f:10485760}}function t(){return window.aipkit_escapeHtml||function(s){return String(s||"")}}function o(s,m,f="info"){if(!s)return;let w=t(),h=String(m||"").trim();if(!h)return;let y=f==="error"?"error":"info";s.innerHTML=`<p class="aipkit_image_results_message aipkit_message-${y}">${w(h)}</p>`,s.style.display="grid"}function r(s,m){let f=String(s||"").trim().toLowerCase();if(f&&Object.values(e).includes(f))return f;let w=String(m||"").trim().toLowerCase(),h=w.includes(".")?w.split(".").pop():"";return e[h]||""}function c(s,m){let f=String(s||"").trim().replace(/[^\w.\-]+/g,"-").replace(/-+/g,"-").replace(/^\.+/,"").replace(/^\-+/,"");return f?/\.[a-z0-9]+$/i.test(f)?f:`${f}.${i[m]||"png"}`:`aipkit-source-image.${i[m]||"png"}`}function _(s,m){if(!s)return;let f=s.querySelector(".dashicons"),w=s.querySelector(".aipkit_spinner");f&&(f.hidden=!!m),w&&(w.hidden=!m,w.classList.toggle("aipkit_spinner--visible",!!m)),s.disabled=!!m}function p(s,m){let f=s.querySelector("#aipkit_public_image_mode");if(String(f?.value||"").trim().toLowerCase()==="edit")return!0;let h=s.querySelector('.aipkit_image_generator_mode_btn[data-aipkit-image-mode="edit"]');if(h)return h.disabled?!1:(h.click(),String(f?.value||"").trim().toLowerCase()==="edit");if(String(s.dataset.imageMode||"generate").trim().toLowerCase()==="generate")return!1;f&&(f.value="edit");let I=s.querySelector("#aipkit_public_image_edit_upload_row");return I&&(I.hidden=!1),!0}async function l(s,m,f,w){let h=await fetch(s,{method:"GET",credentials:"same-origin"});if(!h.ok)throw new Error(w.editHistoryLoadFailed||"Could not load the selected image for editing.");let y=await h.blob(),I=r(y.type,m||s);if(!I||!f.allowedMimeTypes.has(I))throw new Error(w.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF.");if(Number(y.size||0)>f.maxBytes)throw new Error(w.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB.");let b=c(m,I);return new File([y],b,{type:I})}function u(s,m,f){if(!s||!m)return!1;if(typeof DataTransfer>"u")throw new Error(f.editDropUsePicker||"Could not attach selected image automatically. Click to choose file.");let w=new DataTransfer;return w.items.add(m),s.files=w.files,s.dispatchEvent(new Event("change",{bubbles:!0})),!0}async function g(s){let m=s.target.closest(".aipkit-image-history-edit-btn");if(!m)return;s.preventDefault(),s.stopPropagation();let f=m.closest("#aipkit_public_image_generator");if(!f)return;let w=window.aipkit_image_generator_config_public||{},h=w.text||{},y=f.querySelector("#aipkit_public_image_results"),I=f.querySelector("#aipkit_public_image_edit_source_file"),b=f.querySelector("#aipkit_public_image_prompt"),v=f.querySelector("#aipkit_public_image_edit_upload_row"),U=String(m.dataset.imageUrl||"").trim(),x=String(m.dataset.imageName||"").trim();if(!U||!I){o(y,h.editHistoryLoadFailed||"Could not load the selected image for editing.","error");return}if(!p(f,h)){o(y,h.editHistoryUnavailable||"Image editing is not available in the current setup.","error");return}_(m,!0);try{let M=a(w),F=await l(U,x,M,h);u(I,F,h),v&&v.hidden&&(v.hidden=!1),v&&typeof v.scrollIntoView=="function"&&v.scrollIntoView({behavior:"smooth",block:"center"}),b&&typeof b.focus=="function"&&b.focus(),o(y,h.editHistoryLoaded||"Source image loaded. Describe your edits and click Edit Image.","info")}catch(M){console.error("AIPKit Image History Edit Error:",M),o(y,M?.message||h.error||"Error loading image for editing.","error")}finally{_(m,!1)}}window.aipkit_handleEditHistoryImage=g})();(function(){"use strict";let d={image_input:!0,image_output:!0,image_generation:!0},n=["image/jpeg","image/png","image/webp","image/gif"],e=10*1024*1024,i=new Set(["gpt-image-1.5","gpt-image-1","gpt-image-1-mini"]);function a(s,m){let f=Array.isArray(s?.openrouter_image_models)?s.openrouter_image_models:[],w=String(m||"").trim().toLowerCase();if(!w)return d;let h=f.find(y=>(y&&y.id?String(y.id).trim().toLowerCase():"")===w);return!h||typeof h.capabilities!="object"?d:{...d,...h.capabilities}}function t(s,m){let f=a(s,m);return!!(f.image_output||f.image_generation)}function o(s,m){let f=a(s,m);return!!(f.image_input&&(f.image_output||f.image_generation))}function r(s){let m=Array.isArray(s?.edit_upload_allowed_mime_types)?s.edit_upload_allowed_mime_types.map(w=>String(w||"").trim().toLowerCase()).filter(Boolean):n,f=Number(s?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(m),maxBytes:Number.isFinite(f)&&f>0?f:e}}function c(s){let m=String(s||"").trim().toLowerCase();return i.has(m)}function _(s,m){s&&(s.hidden=!m)}function p(s,m="",f=!1){if(!s)return;let w=f?" aipkit_image_results_placeholder--with-message":"",h=m?` ${m}`:"";s.innerHTML=`<p class="aipkit_image_results_placeholder aipkit_image_results_placeholder--centered${w}"><span class="aipkit_spinner aipkit_spinner--visible"></span>${h}</p>`}function l(){let s=document.getElementById("aipkit_public_image_generator");if(!s)return;let m=s.querySelector("#aipkit_public_image_prompt"),f=s.querySelector("#aipkit_public_image_results"),w=s.querySelector("#aipkit_public_generate_image_btn"),h=s.querySelector("#aipkit_image_generator_public_nonce"),y=window.aipkit_image_generator_config_public||{},I=y.text||{},b=y.ajaxUrl||window.aipkit_dashboard?.ajaxurl,v=h?h.value:null,U=window.aipkit_escapeHtml||function(B){return B};if(!m||!f||!w||!b||!v){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.configurationMissing||"Error: Configuration missing."}</p>`,f.style.display="grid";return}let x=window.aipkit_getSettingValue(s,"aipkit_public_image_provider","image_provider"),M=window.aipkit_getSettingValue(s,"aipkit_public_image_model","image_model"),F=window.aipkit_getSettingValue(s,"aipkit_public_image_mode","image_mode")==="edit"?"edit":"generate",k=s.querySelector("#aipkit_public_image_edit_source_file"),S=F==="edit",A=m.value.trim(),C=String(x||"").trim().toLowerCase(),E=String(M||"").trim().toLowerCase(),T=!1,q=y.google_models&&typeof y.google_models=="object"?y.google_models:{};if(C==="google"&&q.video&&Array.isArray(q.video)?T=q.video.some(B=>B&&String(B.id||"").trim().toLowerCase()===E):T=E.includes("veo"),!A){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.noPrompt||"Please enter a prompt.")}</p>`,f.style.display="grid";return}if(S){let B=!!(k&&k.files&&k.files.length),R=s.dataset.editUploadRequired||I.editUploadRequired||"Please upload an image to edit.";if(!B){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(R)}</p>`,f.style.display="grid";return}let $=k.files[0],K=r(y);if(!K.allowedMimeTypes.has(String($.type||"").toLowerCase())){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF.")}</p>`,f.style.display="grid";return}if(Number($.size||0)>K.maxBytes){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB.")}</p>`,f.style.display="grid";return}}if(!x||!M){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:x,model:M}),f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.missingRequiredSettings||"Error: Missing required image generation settings."}</p>`,f.style.display="grid";return}if(!S&&C==="openrouter"&&!t(y,E)){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.openrouterModelUnsupported||"Selected OpenRouter model does not support image generation.")}</p>`,f.style.display="grid";return}if(S&&C!=="google"&&C!=="openai"&&C!=="openrouter"){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editProviderUnsupported||"Image editing is currently supported only for Google, OpenAI and OpenRouter providers.")}</p>`,f.style.display="grid";return}if(S&&(C==="google"&&T||C==="openai"&&!c(E)||C==="openrouter"&&!o(y,E))){f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editModelUnsupported||"Selected model does not support image editing.")}</p>`,f.style.display="grid";return}w.disabled=!0;let L=w.querySelector(".aipkit_btn-text"),H=w.querySelector(".aipkit_spinner"),O=L?L.textContent:I.generateButton||(T?"Generate Video":"Generate Image");L&&(S?L.textContent=I.editing||"Editing...":L.textContent=I.generating||(T?I.generatingVideo||"Generating Video...":"Generating...")),_(H,!0),f.style.display="grid",p(f);let D=new FormData;if(D.append("action","aipkit_generate_image"),D.append("_ajax_nonce",v),D.append("prompt",A),D.append("image_mode",F),D.append("provider",x),D.append("model",M),S&&k&&k.files&&k.files[0]&&D.append("source_image",k.files[0]),C==="openai"){let B=E.startsWith("gpt-image-1");E==="dall-e-3"?(D.append("quality","standard"),D.append("style","vivid")):B&&D.append("output_format","png"),B||D.append("response_format","url")}else C==="google"&&T&&(D.append("aspect_ratio","16:9"),D.append("person_generation","allow_all"));fetch(b,{method:"POST",body:D,credentials:"same-origin"}).then(B=>B.json()).then(B=>{if(!B.success){let R=B.data&&B.data.message?B.data.message:"Unknown generation error";throw new Error(R)}if(B.data.status==="processing"&&B.data.operation_name){u(B.data.operation_name,M,v,w,f,L,H,O,T,A,I,U);return}g(B.data,w,f,L,H,O,T,A,I,U)}).catch(B=>{console.error("AIPKit Image Generation Error (Public):",B),f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.error||"Error generating image:"} ${U(B.message||"Unknown error")}</p>`,w.disabled=!1,L&&(L.textContent=O),_(H,!1)})}function u(s,m,f,w,h,y,I,b,v,U,x,M){let S=0;y&&(y.textContent=x.generatingVideo||"Generating Video..."),p(h,x.videoGenerationInProgress||"Video generation in progress...",!0);function A(){if(S>=60){h.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${x.videoGenerationTimedOut||"Video generation timed out. Please try again."}</p>`,w.disabled=!1,y&&(y.textContent=b),_(I,!1);return}S++;let C=Math.min(S/60*100,95);p(h,`${x.generatingVideoProgress||"Generating video..."} (${Math.round(C)}%)`,!0);let E=new FormData;E.append("action","aipkit_check_video_status"),E.append("_ajax_nonce",f),E.append("operation_name",s),E.append("model_id",m),E.append("prompt",U),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:E,credentials:"same-origin"}).then(T=>T.json()).then(T=>{if(T.success)if(T.data.status==="completed")g(T.data,w,h,y,I,b,v,U,x,M);else if(T.data.status==="processing")setTimeout(A,5e3);else throw new Error(`Unknown status: ${T.data.status}`);else throw new Error(T.data?.message||"Status check failed")}).catch(T=>{console.error("AIPKit Video Status Check Error:",T),h.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${x.videoGenerationFailed||"Video generation failed:"} ${M(T.message||"Unknown error")}</p>`,w.disabled=!1,y&&(y.textContent=b),_(I,!1)})}setTimeout(A,5e3)}function g(s,m,f,w,h,y,I,b,v,U){let x=s.images||s.videos||[];if(x.length>0)f.innerHTML="",x.forEach(M=>{let F=document.createElement("div");F.className=I?"aipkit_video_result":"aipkit_image_result";let k="",S=M.media_library_url||M.url||null,A=I?v.viewFullVideo||"Click to view full video":v.viewFullImage||"Click to view full image";if(I)if(M.url){let C=`<video controls preload="metadata" class="aipkit_image_result_video">
              <source src="${U(M.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;S&&S!==M.url?k=`<a href="${U(S)}" target="_blank" rel="noopener noreferrer" title="${U(A)}">${C}</a>`:k=C}else k=`<p class="aipkit_video_results_message aipkit_message-error">${v.noVideoDataFound||"Error: No video data found."}</p>`;else{let C=M.url||(M.b64_json?`data:image/png;base64,${M.b64_json}`:null);if(C){let E=`<img src="${U(C)}" alt="${U(b)}">`;S?k=`<a href="${U(S)}" target="_blank" rel="noopener noreferrer" title="${U(A)}">${E}</a>`:k=E}else k=`<p class="aipkit_image_results_message aipkit_message-error">${v.noImageDataFound||"Error: No image data found."}</p>`}if(F.innerHTML=k,M.revised_prompt){let C=document.createElement("p");C.className="aipkit_image_result_revised_prompt",C.textContent=`${v.revisedPromptPrefix||"Revised:"} ${M.revised_prompt}`,F.appendChild(C)}f.appendChild(F)});else{let M=I?"videos":"images";f.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${v.initialPlaceholder||`No ${M} returned. Try a different prompt.`}</p>`}m.disabled=!1,w&&(w.textContent=y),_(h,!1)}window.aipkit_handlePublicImageGeneration=l})();(function(){"use strict";function d(n){let e=n.currentTarget;if(e.disabled)return;let i=e.closest("#aipkit_public_image_generator");if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,o=i.querySelector("#aipkit_image_generator_public_nonce")?.value,r=i.querySelector(".aipkit-image-history-grid");if(!t||!o||!r){console.error("Image History Load More: Missing required elements or config.");return}let c=parseInt(e.dataset.currentPage,10)||1,_=parseInt(e.dataset.maxPages,10)||1,p=c+1;if(p>_)return;let l=e.querySelector(".aipkit_btn-icon-content"),u=e.querySelector(".aipkit_spinner");l&&(l.style.display="none"),u&&(u.style.display="inline-block"),e.disabled=!0;let g=new FormData;g.append("action","aipkit_load_more_image_history"),g.append("_ajax_nonce",o),g.append("page",p),g.append("shortcode_mode",String(i.dataset.imageMode||"both").trim().toLowerCase()),fetch(t,{method:"POST",body:g,credentials:"same-origin"}).then(s=>s.json()).then(s=>{if(!s.success)throw new Error(s.data?.message||"Failed to load more images.");s.data.html&&r.insertAdjacentHTML("beforeend",s.data.html),e.dataset.currentPage=p,s.data.has_more||(e.style.display="none")}).catch(s=>{console.error("Image History Load More Error:",s)}).finally(()=>{l&&(l.style.display="inline-block"),u&&(u.style.display="none"),p<_?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=d})();(function(){"use strict";let d=["image/jpeg","image/png","image/webp","image/gif"],e=new Set(["gpt-image-1.5","gpt-image-1","gpt-image-1-mini"]),i={image_input:!0,image_output:!0,image_generation:!0};function a(k,S){let A=new Set(["generate","edit","both"]),C=new Set(["generate","edit"]),E=String(k?.dataset?.imageMode||"generate").trim().toLowerCase(),T=String(k?.dataset?.imageDefaultMode||"generate").trim().toLowerCase(),q=String(S?.value||"").trim().toLowerCase(),L=A.has(E)?E:"generate",H=C.has(T)?T:"generate",O=C.has(q)?q:"";return L==="both"?O||H:L==="edit"?"edit":"generate"}function t(k,S){if(!k)return;let A=S==="edit"?"edit":"generate",C=k.querySelector("#aipkit_public_image_mode"),E=k.querySelectorAll(".aipkit_image_generator_mode_btn"),T=k.querySelector("#aipkit_public_image_prompt"),q=k.querySelector("#aipkit_public_image_edit_upload_row"),L=k.querySelector("#aipkit_public_generate_image_btn"),H=L?L.querySelector(".aipkit_btn-text"):null,O=k.dataset.generatePlaceholder||"Describe the image you want to generate...",D=k.dataset.editPlaceholder||"Describe how you want to edit the uploaded image...",B=k.dataset.generateLabel||"Generate",R=k.dataset.editLabel||"Edit Image";C&&(C.value=A),T&&T.setAttribute("placeholder",A==="edit"?D:O),H&&(H.textContent=A==="edit"?R:B),q&&(q.hidden=A!=="edit"),E.forEach($=>{let G=(String($.getAttribute("data-aipkit-image-mode")||"").trim().toLowerCase()==="edit"?"edit":"generate")===A;$.classList.toggle("is-active",G),$.setAttribute("aria-pressed",G?"true":"false")})}function o(k,S,A){if(typeof window.aipkit_getSettingValue=="function"&&k)return window.aipkit_getSettingValue(k,S,A);let C=k?k.querySelector(`#${S}`):null;if(C&&typeof C.value<"u")return C.value;let E=k?k.querySelector(`[name="${A}"]`):null;return E&&typeof E.value<"u"?E.value:""}function r(k,S,A,C){let E=k?k.querySelector(`#${S}`):null;if(E&&typeof E.value<"u"){E.value=C;return}let T=k?k.querySelector(`[name="${A}"]`):null;T&&typeof T.value<"u"&&(T.value=C)}function c(k){let S=k.querySelector("#aipkit_public_image_mode");return String(S&&S.value?S.value:"generate").trim().toLowerCase()==="edit"?"edit":"generate"}function _(k){let S=Number(k||0);return!Number.isFinite(S)||S<=0?"0 B":S<1024?`${S} B`:S<1024*1024?`${(S/1024).toFixed(1)} KB`:`${(S/(1024*1024)).toFixed(1)} MB`}function p(k){let S=Array.isArray(k?.edit_upload_allowed_mime_types)?k.edit_upload_allowed_mime_types.map(C=>String(C||"").trim().toLowerCase()).filter(Boolean):d,A=Number(k?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(S),maxBytes:Number.isFinite(A)&&A>0?A:10485760}}function l(k,S){if(!k)return;let A=k.querySelector("#aipkit_public_image_edit_source_file"),C=k.querySelector("#aipkit_public_image_edit_dropzone"),E=k.querySelector("#aipkit_public_image_edit_file_summary"),T=k.querySelector("#aipkit_public_image_edit_file_preview"),q=k.querySelector("#aipkit_public_image_edit_file_name"),L=k.querySelector("#aipkit_public_image_edit_file_remove"),H=k.querySelector("#aipkit_public_image_edit_upload_feedback");if(!A||!C||C.dataset.dropzoneListenerAttached==="true")return;let O=S&&typeof S.text=="object"?S.text:{},D=p(S),B="",R=()=>{B&&typeof URL<"u"&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(B),B="",T&&(T.removeAttribute("src"),T.hidden=!0)},$=P=>{if(!H)return;let N=String(P||"").trim();if(!N){H.hidden=!0,H.textContent="",C.classList.remove("has-error");return}H.textContent=N,H.hidden=!1,C.classList.add("has-error")},K=()=>{A.value="",R(),E&&(E.hidden=!0),q&&(q.textContent=""),C.classList.remove("has-file"),$("")},G=P=>{P&&(E&&(E.hidden=!1),q&&(q.textContent=`${P.name} (${_(P.size)})`),T&&typeof URL<"u"&&typeof URL.createObjectURL=="function"&&(R(),B=URL.createObjectURL(P),T.src=B,T.hidden=!1),C.classList.add("has-file"),$(""))},W=P=>{if(!P)return{valid:!1,message:O.editUploadRequired||"Please upload an image to edit."};let N=String(P.type||"").trim().toLowerCase();return D.allowedMimeTypes.has(N)?Number(P.size||0)>D.maxBytes?{valid:!1,message:O.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB."}:{valid:!0,message:""}:{valid:!1,message:O.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF."}},Q=P=>{if(!P||typeof DataTransfer>"u")return!1;try{let N=new DataTransfer;return N.items.add(P),A.files=N.files,!0}catch{return!1}},Z=(P,N=!1)=>{let V=W(P);return V.valid?N&&!Q(P)?($(O.editDropUsePicker||"Could not attach dropped file automatically. Click to choose file."),!1):(G(P),!0):($(V.message),!1)};C.addEventListener("click",()=>{A.click()}),C.addEventListener("keydown",P=>{(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),A.click())}),["dragenter","dragover"].forEach(P=>{C.addEventListener(P,N=>{N.preventDefault(),N.stopPropagation(),C.classList.add("is-dragover")})}),["dragleave","drop"].forEach(P=>{C.addEventListener(P,N=>{N.preventDefault(),N.stopPropagation(),C.classList.remove("is-dragover")})}),C.addEventListener("drop",P=>{let N=P.dataTransfer&&P.dataTransfer.files&&P.dataTransfer.files.length>0?P.dataTransfer.files[0]:null;N&&Z(N,!0)}),A.addEventListener("change",()=>{let P=A.files&&A.files.length>0?A.files[0]:null;if(!P){K();return}Z(P,!1)}),L&&L.addEventListener("click",P=>{P.preventDefault(),K()}),A.files&&A.files.length>0?Z(A.files[0],!1):K(),C.dataset.dropzoneListenerAttached="true",window.addEventListener("beforeunload",R,{once:!0})}function u(k,S){let A=String(S||"").trim();if(!A)return!1;let C=k&&typeof k.google_models=="object"?k.google_models:{};return C.video&&Array.isArray(C.video)?C.video.some(E=>E&&E.id===A):A.toLowerCase().includes("veo")}function g(k,S){let A=String(S||"").trim().toLowerCase();return!A||u(k,A)?!1:A.includes("gemini")&&A.includes("image-generation")}function s(k){let S=String(k||"").trim().toLowerCase();return e.has(S)}function m(k,S){let A=Array.isArray(k?.openrouter_image_models)?k.openrouter_image_models:[],C=String(S||"").trim().toLowerCase();if(!C)return i;let E=A.find(T=>String(T?.id||"").trim().toLowerCase()===C);return!E||typeof E.capabilities!="object"?i:{...i,...E.capabilities}}function f(k,S){let A=m(k,S);return!!(A.image_input&&(A.image_output||A.image_generation))}function w(k){return k?new Set(String(k).split(",").map(S=>S.trim().toLowerCase()).filter(Boolean)):null}function h(k,S){let A=k&&typeof k.google_models=="object"?k.google_models:{},C=Array.isArray(A.image)?A.image:[],E=w(S);return C.filter(T=>{let q=String(T?.id||"").trim().toLowerCase();return!q||!g(k,q)?!1:!E||E.has("google")?!0:E.has(q)})}function y(k,S){let A=k&&Array.isArray(k.openai_models)?k.openai_models:[],C=w(S);return A.filter(E=>{let T=String(E?.id||"").trim().toLowerCase();return!T||!s(T)?!1:!C||C.has("openai")?!0:C.has(T)})}function I(k,S){let A=k&&Array.isArray(k.openrouter_image_models)?k.openrouter_image_models:[],C=w(S);return A.filter(E=>{let T=String(E?.id||"").trim().toLowerCase();return!T||!f(k,T)?!1:!C||C.has("openrouter")?!0:C.has(T)})}function b(k,S){let A=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim().toLowerCase(),C=String(o(k,"aipkit_public_image_model","image_model")||"").trim().toLowerCase();if(A!=="google"&&A!=="openai"&&A!=="openrouter")return{supported:!1,reason:"provider"};if(!C)return{supported:!1,reason:"model"};if(A==="google"){let E=g(S,C);return{supported:E,reason:E?null:"model"}}if(A==="openrouter"){let E=f(S,C);return{supported:E,reason:E?null:"model"}}return s(C)?{supported:!0,reason:null}:{supported:!1,reason:"model"}}function v(k,S){let A=k.querySelector("#aipkit_public_image_provider");if(!A)return;let C=S==="edit",E=new Set(["google","openai","openrouter"]),T=Array.from(A.options),q=T.filter(O=>E.has(String(O.value||"").trim().toLowerCase()));T.forEach(O=>{let D=String(O.value||"").trim().toLowerCase(),B=!C||E.has(D);O.hidden=!B,O.disabled=!B});let L=String(A.value||"").trim().toLowerCase(),H=q.some(O=>String(O.value||"").trim().toLowerCase()===L);C&&!H&&q.length>0&&(A.value=q[0].value)}function U(k,S,A){let C=k.querySelector("#aipkit_public_image_model");if(!C||typeof window.aipkit_populatePublicModelsForProvider!="function")return;let E=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim();if(window.aipkit_populatePublicModelsForProvider(E,C,S,{mode:A}),C.disabled){r(k,"aipkit_public_image_model","image_model","");return}r(k,"aipkit_public_image_model","image_model",C.value)}function x(k,S,A,C){if(C!=="edit")return;let E=k.querySelector("#aipkit_public_image_provider"),T=k.querySelector("#aipkit_public_image_model");if(E)return;let q=h(S,A),L=y(S,A),H=I(S,A),O=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim().toLowerCase(),D="",B=[];if(O==="google"&&q.length>0?(D="Google",B=q):O==="openai"&&L.length>0?(D="OpenAI",B=L):O==="openrouter"&&H.length>0?(D="OpenRouter",B=H):q.length>0?(D="Google",B=q):L.length>0?(D="OpenAI",B=L):H.length>0&&(D="OpenRouter",B=H),!(!D||B.length===0)&&(r(k,"aipkit_public_image_provider","image_provider",D),!T)){let R=String(o(k,"aipkit_public_image_model","image_model")||"").trim().toLowerCase();B.some(K=>String(K.id||"").trim().toLowerCase()===R)||r(k,"aipkit_public_image_model","image_model",B[0].id)}}function M(k,S,A){if(!k)return;let C=String(k.dataset.imageMode||"generate").trim().toLowerCase(),E=c(k),T=k.querySelector("#aipkit_public_image_edit_mode_notice"),q=k.querySelector("#aipkit_public_generate_image_btn"),L=k.querySelector('.aipkit_image_generator_mode_btn[data-aipkit-image-mode="edit"]'),H=h(S,A).length>0||y(S,A).length>0||I(S,A).length>0;if(v(k,E),x(k,S,A,E),U(k,A,E),C==="generate"){T&&(T.hidden=!0,T.textContent=""),q&&(q.disabled=!1);return}let O=b(k,S);L&&(L.disabled=!H,L.classList.toggle("is-disabled",!H),L.setAttribute("aria-disabled",H?"false":"true")),C==="both"&&!H&&E==="edit"&&t(k,"generate"),q&&E==="edit"?q.disabled=!O.supported:q&&(q.disabled=!1),T&&(T.hidden=!0,T.textContent="")}function F(){let k=document.getElementById("aipkit_public_image_generator");if(!k)return;let S=k.querySelector("#aipkit_public_generate_image_btn"),A=k.querySelector("#aipkit_public_image_results"),C=k.querySelector("#aipkit_public_image_provider"),E=k.querySelector("#aipkit_public_image_model"),T=window.aipkit_image_generator_config_public||{},q=k.dataset.allowedModels||"",L=k.querySelector(".aipkit-image-history-grid"),H=k.querySelector(".aipkit-image-history-load-more-btn");if(!S||!A){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),A&&(A.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${T?.text?.coreUiMissing||"Error: Core UI elements missing."}</p>`,A.style.display="grid");return}l(k,T),C&&C.addEventListener("change",()=>{M(k,T,q)}),E&&E.addEventListener("change",()=>{M(k,T,q)}),S.dataset.listenerAttached!=="true"&&(S.addEventListener("click",window.aipkit_handlePublicImageGeneration),S.dataset.listenerAttached="true");let O=k.querySelector("#aipkit_public_image_mode"),D=k.querySelectorAll(".aipkit_image_generator_mode_btn"),B=a(k,O);t(k,B),D.forEach(R=>{R.dataset.modeListenerAttached!=="true"&&(R.addEventListener("click",()=>{if(R.disabled)return;let $=c(k),K=String(R.getAttribute("data-aipkit-image-mode")||"").trim().toLowerCase()==="edit"?"edit":"generate";if($==="generate"&&K==="edit")k.dataset.lastGenerateProvider=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim(),k.dataset.lastGenerateModel=String(o(k,"aipkit_public_image_model","image_model")||"").trim();else if($==="edit"&&K==="generate"){let G=String(k.dataset.lastGenerateProvider||"").trim(),W=String(k.dataset.lastGenerateModel||"").trim();G&&r(k,"aipkit_public_image_provider","image_provider",G),W&&r(k,"aipkit_public_image_model","image_model",W)}t(k,K),M(k,T,q)}),R.dataset.modeListenerAttached="true")}),M(k,T,q),L&&(L.addEventListener("click",window.aipkit_handleEditHistoryImage),L.addEventListener("click",window.aipkit_handleDeleteImage)),H&&H.addEventListener("click",window.aipkit_handleLoadMoreHistory),A&&(A.style.display="none",A.innerHTML="")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",F):F(),window.aipkit_initPublicImageGenerator=F})();(function(){"use strict";function d(i,a,t,o){let r=window.aipkit_token_usage_config||{},c=r.text||{},_=document.createElement("div");_.className="aipkit-usage-details-table-container";let p=document.createElement("div");p.className="aipkit-usage-details-pagination-container",o.appendChild(_),o.appendChild(p),_.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${c.loadingDetails||"Loading details..."}</p>`;let l={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:i,context_id:a,page:t},u=new FormData;for(let g in l)u.append(g,l[g]);fetch(r.ajaxUrl,{method:"POST",body:u,credentials:"same-origin"}).then(g=>g.json()).then(g=>{if(!g.success)throw new Error(g.data?.message||"Failed to load data.");n(g.data.items,_),e(g.data.pagination,p,i,a,o)}).catch(g=>{console.error("Error fetching token usage details:",g),_.innerHTML=`<p style="color:red;text-align:center;">${c.errorLoading||"Error loading details."} (${g.message})</p>`})}function n(i,a){if(!i||i.length===0){a.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let t='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';i.forEach(o=>{let c=new Date(o.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});t+=`<tr><td>${c}</td><td>${o.tokens.toLocaleString()}</td></tr>`}),t+="</tbody></table>",a.innerHTML=t}function e(i,a,t,o,r){let{currentPage:c,totalPages:_}=i,p=window.aipkit_token_usage_config?.text||{};if(a.innerHTML="",_<=1)return;let l=document.createElement("button");l.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",l.textContent=p.previous||"Previous",l.disabled=c<=1,l.addEventListener("click",()=>d(t,o,c-1,r)),a.appendChild(l);let u=document.createElement("span");u.className="aipkit_pagination-current",u.textContent=`${p.pageLabel||"Page"} ${c} ${p.ofLabel||"of"} ${_}`,a.appendChild(u);let g=document.createElement("button");g.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",g.textContent=p.next||"Next",g.disabled=c>=_,g.addEventListener("click",()=>d(t,o,c+1,r)),a.appendChild(g)}document.addEventListener("click",function(i){let a=i.target.closest(".aipkit-usage-details-btn");if(!a||a.disabled)return;let t=a.closest("tr.aipkit-usage-main-row");if(!t)return;let o=t.nextElementSibling,r=o&&o.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(c=>{if(c!==o){let _=c.previousElementSibling.querySelector(".aipkit-usage-details-btn");_&&_.classList.remove("aipkit-active"),c.remove()}}),r)o.remove(),a.classList.remove("aipkit-active");else{a.classList.add("aipkit-active");let c=document.createElement("tr");c.className="aipkit-usage-details-row";let _=document.createElement("td");_.colSpan=t.cells.length,_.className="aipkit-usage-details-cell";let p=document.createElement("div");p.className="aipkit-usage-details-content",_.appendChild(p),c.appendChild(_),t.parentNode.insertBefore(c,t.nextSibling);let l=a.dataset.module,u=a.dataset.contextId;d(l,u,1,p)}}),document.addEventListener("click",function(i){let a=i.target.closest(".aipkit_toggle_purchase_history");if(!a)return;i.preventDefault();let t=document.getElementById("aipkit_purchase_history_details");if(!t)return;a.getAttribute("aria-expanded")==="true"?(t.style.display="none",a.setAttribute("aria-expanded","false")):(t.style.display="block",a.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function d(e){e.preventDefault();let i=e.target,a=i.querySelector(".aipkit_semantic_search_input"),t=i.querySelector(".aipkit_semantic_search_button"),o=i.closest(".aipkit_semantic_search_wrapper"),r=o.querySelector(".aipkit_semantic_search_results");if(!a||!t||!o||!r){console.error("Semantic Search: Missing required form elements.");return}let c=a.value.trim();if(!c)return;let _=window.aipkit_semantic_search_config||{},p=_.text||{};t.disabled=!0;let l=t.querySelector(".aipkit_spinner");l&&(l.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let u={query:c};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",u,_).then(g=>{r.innerHTML=g.html||`<p>${_.settings.no_results_text||"No results found."}</p>`}).catch(g=>{console.error("Semantic Search Error:",g),r.innerHTML=`<p class="aipkit-search-error">${p.error||"An error occurred while searching."}</p>`}).finally(()=>{t.disabled=!1,l&&(l.style.display="none")})}function n(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(i=>{i.dataset.listenerAttached!=="true"&&(i.addEventListener("submit",d),i.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",n),document.addEventListener("aipkit:contentLoaded",n)})();(function(){"use strict";function d(n,e,i){if(!n)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let a=n.querySelector(".aipkit_consent_overlay"),t=n.querySelector(".aipkit_chat_input");if(!a){a=document.createElement("div"),a.className="aipkit_consent_overlay",a.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `,t?t.appendChild(a):n.appendChild(a);let o=a.querySelector(".aipkit_consent_agree_btn");o&&typeof i=="function"&&o.addEventListener("click",i)}return t&&t.classList.add("aipkit-consent-active"),a.classList.remove("aipkit_hidden"),a}window.aipkit_chatUI_showConsentBox=d})();(function(){"use strict";function d(n){if(n){n.classList.add("aipkit_hidden");let e=n.closest(".aipkit_chat_input");e&&e.classList.remove("aipkit-consent-active")}}window.aipkit_chatUI_hideConsentBox=d})();(function(){"use strict";function d(n,e,i,a,t,o){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&o&&t(o);let r=a.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let c=a.closest(".aipkit_chat_container");c&&c.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=d})();(function(){"use strict";function d(n,e,i,a){let t=e.botId,o=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(o)==="true";let r=null;function c(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,o,a,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function _(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,c):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&_(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(_(),!0):!1,isConsentGiven:()=>i.consentGiven}}window.aipkit_initConsentUI=d})();(function(){"use strict";function d(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:a}=window.jspdf,t=new a,o=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",c=e.text.userPrefix||"User",_=e.text.errorPrefix||"Error",p=10,l=t.internal.pageSize.height,u=10,g=6,s=l-u*2,m=!1;if(t.setFontSize(16),t.text(`Chat Transcript - ${r}`,u,p),p+=g*2,t.setFontSize(12),o.forEach(w=>{let h=w.querySelector(".aipkit_chat_bubble");if(!h)return;let y=window.aipkit_chatUI_extractTextFromBubble(h),I="";if(w.classList.contains("aipkit_chat_message-user")?(I=`${c}:`,t.setFont(void 0,"bold")):w.classList.contains("aipkit_chat_message-bot")?(I=`${r}:`,t.setFont(void 0,"normal")):w.classList.contains("aipkit_chat_message-error")?(I=`${_}:`,t.setFont(void 0,"italic")):t.setFont(void 0,"normal"),I&&y){m=!0;let b=I,v=`${y}`;p+g>s+u&&(t.addPage(),p=u),t.text(b,u,p),p+=g,t.splitTextToSize(v,t.internal.pageSize.width-u*2).forEach(x=>{p+g>s+u&&(t.addPage(),p=u),t.text(x,u,p),p+=g}),p+=g/2,t.setFont(void 0,"normal")}}),!m){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let f=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{t.save(f)}catch(w){console.error("AIPKit Download PDF: Error calling doc.save()",w),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=d})();(function(){"use strict";function d(n){let i=n.currentTarget.closest(".aipkit-ai-form-wrapper"),a=i?i.querySelector(".aipkit-ai-form-results-content"):null,t=i?i.dataset.formId:"unknown";if(!a){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:o}=window.jspdf,r=new o,c=a.innerText||a.textContent||"";if(!c.trim()){alert("Nothing to export.");return}let _=r.internal.pageSize.height,p=10,l=6,u=_-p*2,g=p;r.setFontSize(12),r.splitTextToSize(c,r.internal.pageSize.width-p*2).forEach(h=>{g+l>u+p&&(r.addPage(),g=p),r.text(h,p,g),g+=l});let m=new Date,f=`${m.getFullYear()}${String(m.getMonth()+1).padStart(2,"0")}${String(m.getDate()).padStart(2,"0")}`,w=`aiform-${t}-result-${f}.pdf`;r.save(w)}window.aipkitForms_handleDownloadPdf=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-volume"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8a5 5 0 0 1 0 8" /><path d="M17.7 5a9 9 0 0 1 0 14" /><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" /></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>',e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-alert-square-rounded"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>';function i(t,o,r=null){if(t)switch(t.classList.remove("is-connecting","is-listening","is-speaking","is-error"),t.innerHTML="",o){case"connecting":t.classList.add("is-connecting");let c=document.createElement("span");c.className="aipkit_spinner",c.style.display="inline-block",t.appendChild(c),t.title=r||"Connecting...",t.disabled=!0;break;case"listening":t.classList.add("is-listening"),t.innerHTML=n,t.title=r||"Listening... (Click to stop)",t.disabled=!1;break;case"speaking":t.classList.add("is-speaking"),t.innerHTML=d,t.title=r||"AI is speaking... (Click to stop)",t.disabled=!1;break;case"error":t.classList.add("is-error"),t.innerHTML=e,t.title=r||"Error. Click to retry.",t.disabled=!1;break;case"idle":default:t.innerHTML=d,t.title=r||"Start Voice Conversation",t.disabled=!1;break}}function a(t,o){t.inputField&&(t.inputField.disabled=o),t.actionButton&&(t.actionButton.disabled=o),t.inputActionButton&&(t.inputActionButton.disabled=o),t.voiceInputButton&&(t.voiceInputButton.disabled=o)}window.aipkit_realtimeUIHandler={setButtonState:i,toggleMainInputs:a}})();(function(){"use strict";async function d(i){try{let a=await navigator.mediaDevices.getUserMedia({audio:!0});return a.getTracks().forEach(t=>i.addTrack(t,a)),a}catch(a){throw console.error("Error getting user media:",a),a}}function n(i){let a=document.createElement("audio");return a.autoplay=!0,i.ontrack=t=>{t.streams&&t.streams[0]&&(a.srcObject=t.streams[0])},a}function e(i){i&&i.getTracks().forEach(a=>a.stop())}window.aipkit_realtimeAudioHandler={startLocalStream:d,setupRemoteStream:n,stopLocalStream:e}})();(function(){"use strict";async function d(n,e,i){let a=i.createDataChannel("aipkit-events"),t={userTranscript:"",botTranscript:""},o=async r=>{let c=r?.usage||null;if(!t.userTranscript&&!t.botTranscript)return;let _={user_transcript:t.userTranscript,bot_transcript:t.botTranscript,usage_data:c?JSON.stringify(c):null};try{await window.aipkit_frontendApiRequest("aipkit_log_realtime_session_turn",_,e)}catch(p){console.error("AIPKit Realtime: Failed to log session turn.",p)}finally{t={userTranscript:"",botTranscript:""}}};a.onopen=()=>console.log("AIPKit Realtime: Data channel opened."),a.onmessage=r=>{try{let c=JSON.parse(r.data);c.type==="input.transcription"&&c.transcription&&(t.userTranscript+=c.transcription.trim()+" "),c.type==="response.done"&&c.response&&(c.response.output&&c.response.output[0]&&c.response.output[0].content&&c.response.output[0].content[0]&&c.response.output[0].content[0].transcript&&(t.botTranscript=c.response.output[0].content[0].transcript),o(c.response))}catch(c){console.error("AIPKit Realtime: Error processing message from server:",r.data,c)}},a.onclose=()=>console.log("AIPKit Realtime: Data channel closed."),a.onerror=r=>console.error("AIPKit Realtime: Data channel error:",r);try{let r=await i.createOffer();await i.setLocalDescription(r);let c=e.realtimeModel||"gpt-4o-realtime-preview",_=await fetch(`https://api.openai.com/v1/realtime?model=${c}`,{method:"POST",body:r.sdp,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/sdp"}});if(!_.ok){let l=await _.text();throw new Error(`SDP exchange failed with status ${_.status}: ${l}`)}let p={type:"answer",sdp:await _.text()};return await i.setRemoteDescription(p),a}catch(r){throw console.error("AIPKit Realtime: WebRTC connection failed.",r),i&&i.connectionState!=="closed"&&i.close(),r}}window.aipkit_realtimeConnector={connect:d}})();(function(){"use strict";let d={peerConnection:null,localStream:null,remoteAudioElement:null,dataChannel:null,isSessionActive:!1,currentBotId:null,elements:null,config:null,mainUIState:null,uiInstance:null};async function n(t){t&&(t.preventDefault(),t.stopPropagation()),d.isSessionActive?i():await e()}async function e(){if(d.config.requireConsentCompliance&&!d.mainUIState.consentGiven&&!d.config.directVoiceMode){console.warn(`AIPKit Realtime (${d.config.botId}): Cannot start session, consent required. Opening popup.`),d.uiInstance&&typeof d.uiInstance.openPopup=="function"&&d.uiInstance.openPopup();return}if(!window.aipkit_current_conversation_uuid)if(typeof window.aipkit_regenerateConversationUUID=="function")window.aipkit_regenerateConversationUUID();else{console.error("AIPKit Realtime: Cannot start session, aipkit_regenerateConversationUUID function is missing.");let _=d.elements.triggerButton,p=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),l=d.config.directVoiceMode?_:p;window.aipkit_realtimeUIHandler.setButtonState(l,"error","Error: Cannot create session ID.");return}window.aipkit_is_fresh_session=!1;let t=d.elements.triggerButton,o=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),r=d.config.directVoiceMode?t:o,{...c}=d.elements;window.aipkit_realtimeUIHandler.setButtonState(r,"connecting"),d.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(c,!0);try{let p=(await window.aipkit_frontendApiRequest("aipkit_create_realtime_session",{bot_id:d.currentBotId},d.config))?.client_secret?.value;if(!p)throw new Error("Could not retrieve a session key from the server.");let l=new RTCPeerConnection;d.peerConnection=l,d.remoteAudioElement=window.aipkit_realtimeAudioHandler.setupRemoteStream(l),d.localStream=await window.aipkit_realtimeAudioHandler.startLocalStream(l);let u=await window.aipkit_realtimeConnector.connect(p,d.config,l);d.dataChannel=u,l.onconnectionstatechange=()=>{(l.connectionState==="disconnected"||l.connectionState==="closed"||l.connectionState==="failed")&&i("Connection lost.")},d.isSessionActive=!0,window.aipkit_realtimeUIHandler.setButtonState(r,"listening");let g=d.config.text?.initialGreeting;if(g&&typeof window.aipkit_handlePlayAction=="function"&&d.config.ttsEnabled){let s=document.createElement("button"),m='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>';s.className="aipkit_action_btn aipkit_play_btn",s.innerHTML=m;let f=document.createElement("div");f.setAttribute("data-raw-text",g);let w=document.createElement("div");w.appendChild(f),w.appendChild(s),window.aipkit_handlePlayAction(s)}}catch(_){console.error("AIPKit Realtime: Failed to start session.",_),i(`Error: ${_.message||"Could not connect."}`,!0)}}function i(t=null,o=!1){d.peerConnection&&(d.peerConnection.close(),d.peerConnection=null),d.localStream&&(window.aipkit_realtimeAudioHandler.stopLocalStream(d.localStream),d.localStream=null),d.remoteAudioElement&&(d.remoteAudioElement.srcObject=null,d.remoteAudioElement=null),d.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(),d.isSessionActive=!1;let r=d.elements.triggerButton,c=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),_=d.config.directVoiceMode?r:c,{...p}=d.elements;window.aipkit_realtimeUIHandler.setButtonState(_,o?"error":"idle",t),d.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(p,!1)}function a(t,o,r,c,_){let p=t.container.querySelector(".aipkit_realtime_voice_agent_btn"),l=t.container.closest(".aipkit_popup_wrapper"),u=l?l.querySelector(".aipkit_popup_trigger"):null;!p||!u&&o.popupEnabled||(d.uiInstance=_,d.mainUIState=r,d.config=o,d.elements={...t,triggerButton:u},d.currentBotId=o.botId,o.directVoiceMode&&u?(u.addEventListener("click",n),p.style.display="none"):p.addEventListener("click",n))}window.aipkit_initRealtimeVoiceAgent=a})();})();
