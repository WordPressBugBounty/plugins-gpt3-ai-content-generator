(()=>{(function(){"use strict";let t=window.wp;if(!t||!t.richText||!t.components||!t.element||!t.i18n||!t.blockEditor||!t.data){console.error("AIPKit Block Editor Enhancer: One or more required WordPress script dependencies are missing.");return}let{registerFormatType:T,insert:y,getTextContent:h,slice:u,applyFormat:x}=t.richText,{ToolbarGroup:P,ToolbarDropdownMenu:C}=t.components,{BlockControls:D}=t.blockEditor,{__:o}=t.i18n,{createElement:i,Fragment:M}=t.element;async function I(r,d,_){let a=h(u(r));if(!a){t.data.dispatch("core/notices").createNotice("warning",o("Please select some text to process.","gpt3-ai-content-generator"),{isDismissible:!0});return}let c="aipkit-enhancer-processing";t.data.dispatch("core/notices").createNotice("info",o("Processing...","gpt3-ai-content-generator"),{id:c,isDismissible:!1});let l=window.aipkit_post_enhancer?.nonce_process_text;if(!l){t.data.dispatch("core/notices").removeNotice(c),t.data.dispatch("core/notices").createNotice("error",o("An error occurred: Security token missing.","gpt3-ai-content-generator"),{isDismissible:!0});return}let m=_.replace("%s",a);try{let N=function(n){if(n.nodeType===Node.TEXT_NODE){s+=n.nodeValue;return}if(n.nodeType===Node.ELEMENT_NODE){let p=s.length;for(let O of Array.from(n.childNodes))N(O);let A=s.length,b=B[n.tagName];b&&p!==A&&g.push({type:b,start:p,end:A});return}},e=await window.aipkit_apiRequest("aipkit_process_enhancer_text",{_ajax_nonce:l,text_to_process:a,final_prompt:m});if(!e.text)throw new Error("AI did not return any text.");let w=window.aipkit_post_enhancer?.parse_html_formats!==void 0?!!window.aipkit_post_enhancer.parse_html_formats:!0,E=document.createElement("div");E.innerHTML=e.text;let B={STRONG:"core/bold",B:"core/bold",EM:"core/italic",I:"core/italic",U:"core/text-highlight"},s="",g=[],F=/<\s*(strong|b|em|i|u)\b/i.test(e.text);if(w&&F)for(let n of Array.from(E.childNodes))N(n);else s=e.text.replace(/<[^>]+>/g,"");let k=r.start,f=y(r,s);w&&g.length&&g.forEach(n=>{try{f=x(f,{type:n.type},k+n.start,k+n.end)}catch(p){console.warn("AIPKit formatting apply failed",p)}}),d(f),t.data.dispatch("core/notices").createNotice("success",o("Text updated successfully!","gpt3-ai-content-generator"),{isDismissible:!0})}catch(e){console.error("AIPKit Block Editor Enhancer Error:",e),t.data.dispatch("core/notices").createNotice("error",o("An error occurred:","gpt3-ai-content-generator")+" "+e.message,{isDismissible:!0})}finally{t.data.dispatch("core/notices").removeNotice(c)}}T("aipkit/assistant-format",{title:o("Content Assistant","gpt3-ai-content-generator"),tagName:"span",className:"aipkit-assistant-placeholder-format",edit:({value:r,onChange:d,isActive:_})=>{let l=((window.aipkit_post_enhancer||{}).actions||[]).filter(e=>e.label&&e.prompt).map(e=>({title:o(e.label,"gpt3-ai-content-generator"),onClick:()=>{I(r,d,e.prompt)}})),m=[{title:"AIP Content Assistant",isDisabled:!0,className:"aipkit-menu-header"},...l];return i(M,null,i(D,null,i(P,null,i(C,{icon:()=>i("span",{style:{fontSize:"16px",display:"inline-block",lineHeight:"1"}},"\u270D\uFE0F"),label:o("AIP Content Assistant","gpt3-ai-content-generator"),controls:m,isDisabled:!h(u(r)),className:"aipkit-content-assistant-menu"}))))}})})();})();
